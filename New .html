<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="NA Recovery">
<meta name="theme-color" content="#1a1a2e">
<title>NA Recovery</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#0f0f1a;--surface:#1a1a2e;--surface2:#16213e;
  --accent:#e8c97a;--text:#f0ead6;--text-muted:#8a8090;
  --border:rgba(232,201,122,0.15);--step-done:#4a7c59;
  --radius:16px;--nav-h:72px;
  --safe-top:env(safe-area-inset-top,20px);--safe-bottom:env(safe-area-inset-bottom,0px);
}
.light-mode{--bg:#f5f0e8;--surface:#fff;--surface2:#f0ebe0;--text:#1a1a2e;--text-muted:#6b6070;--border:rgba(100,80,60,0.15);}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
html,body{height:100%;height:100dvh;}body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);overflow:hidden;width:100%;transition:background .3s,color .3s;}
body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse 80% 60% at 20% 10%,rgba(232,201,122,.06) 0%,transparent 60%),radial-gradient(ellipse 60% 80% at 80% 90%,rgba(100,80,160,.08) 0%,transparent 60%);pointer-events:none;z-index:0;}
#app{display:flex;flex-direction:column;height:100%;height:100dvh;overflow:hidden;position:relative;z-index:1;}
.screen{display:none;flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:calc(var(--safe-top) + 16px) 20px 20px;min-height:0;}
.screen.active{display:block;}
/* PIN */
#pin-overlay{position:fixed;inset:0;background:var(--bg);z-index:999;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:26px;padding:40px;}
#pin-overlay.hidden{display:none;}
.pin-title{font-family:'Cormorant Garamond',serif;font-size:2rem;font-weight:300;color:var(--accent);text-align:center;}
.pin-dots{display:flex;gap:16px;}
.pin-dot{width:14px;height:14px;border-radius:50%;border:2px solid var(--accent);background:transparent;transition:background .2s;}
.pin-dot.filled{background:var(--accent);}
.pin-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;width:100%;max-width:280px;}
.pin-btn{background:var(--surface);border:1px solid var(--border);border-radius:14px;color:var(--text);font-size:1.4rem;font-weight:300;padding:18px;cursor:pointer;transition:all .15s;text-align:center;}
.pin-btn:active{background:var(--accent);color:var(--bg);transform:scale(.95);}
.pin-error{color:#e74c3c;font-size:.8rem;min-height:20px;}
.pin-forgot{color:var(--accent);font-size:.8rem;cursor:pointer;text-decoration:underline;}
/* NAV */
nav{flex-shrink:0;height:calc(var(--nav-h) + env(safe-area-inset-bottom,0px));padding-bottom:env(safe-area-inset-bottom,0px);background:rgba(15,15,26,.92);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-top:1px solid var(--border);display:flex;z-index:100;position:relative;}
.light-mode nav{background:rgba(245,240,232,.95);}
.nav-item{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;cursor:pointer;color:var(--text-muted);font-size:.52rem;letter-spacing:.02em;text-transform:uppercase;transition:color .2s;-webkit-user-select:none;user-select:none;padding-bottom:4px;}
.nav-item.active{color:var(--accent);}
.nav-icon{font-size:1.15rem;line-height:1;}
/* TYPOGRAPHY */
.screen-title{font-family:'Cormorant Garamond',serif;font-size:2.1rem;font-weight:300;color:var(--accent);margin-bottom:4px;line-height:1.1;}
.screen-sub{color:var(--text-muted);font-size:.76rem;margin-bottom:22px;letter-spacing:.08em;text-transform:uppercase;}
.section-label{font-size:.7rem;text-transform:uppercase;letter-spacing:.1em;color:var(--text-muted);margin-bottom:8px;margin-top:18px;}
/* CARDS */
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:18px;margin-bottom:12px;}
.card-title{font-family:'Cormorant Garamond',serif;font-size:1.15rem;font-weight:400;color:var(--accent);margin-bottom:6px;}
.card-text{font-size:.86rem;color:var(--text-muted);line-height:1.6;}
/* HOME */
.home-hero{text-align:center;padding:20px 0 16px;}
.logo{font-family:'Cormorant Garamond',serif;font-size:3.2rem;font-weight:300;color:var(--accent);line-height:1;letter-spacing:-.02em;}
.tagline{color:var(--text-muted);font-size:.76rem;letter-spacing:.15em;text-transform:uppercase;margin-top:5px;}
.streak-card{background:linear-gradient(135deg,rgba(232,201,122,.12) 0%,rgba(100,80,160,.08) 100%);border:1px solid var(--border);border-radius:var(--radius);padding:18px;margin-bottom:14px;display:flex;align-items:center;gap:14px;}
.streak-num{font-family:'Cormorant Garamond',serif;font-size:3rem;font-weight:600;color:var(--accent);line-height:1;}
.streak-label{font-size:.68rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:.1em;}
.streak-sub{font-size:.8rem;color:var(--text);margin-top:3px;}
.quote-card{background:var(--surface2);border-left:3px solid var(--accent);border-radius:0 var(--radius) var(--radius) 0;padding:16px 18px;margin-bottom:14px;font-family:'Cormorant Garamond',serif;font-style:italic;font-size:1rem;line-height:1.6;color:var(--text);}
.quote-source{font-size:.7rem;color:var(--text-muted);font-style:normal;margin-top:5px;font-family:'DM Sans',sans-serif;}
.quick-actions{display:grid;grid-template-columns:1fr 1fr;gap:9px;margin-bottom:14px;}
.quick-btn{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:14px 10px;cursor:pointer;transition:all .2s;text-align:center;}
.quick-btn:active{transform:scale(.97);border-color:var(--accent);}
.quick-btn .qb-icon{font-size:1.6rem;margin-bottom:4px;}
.quick-btn .qb-label{font-size:.74rem;color:var(--text-muted);}
.crisis-banner{background:linear-gradient(135deg,rgba(192,57,43,.15),rgba(192,57,43,.05));border:1px solid rgba(192,57,43,.3);border-radius:var(--radius);padding:13px 16px;margin-bottom:14px;display:flex;align-items:center;gap:11px;}
.crisis-text{font-size:.81rem;line-height:1.5;}
.crisis-num{font-weight:500;color:#e74c3c;font-size:.92rem;}
/* MOOD */
.mood-row{display:flex;gap:7px;margin-bottom:12px;}
.mood-btn{flex:1;background:var(--surface2);border:1px solid var(--border);border-radius:11px;padding:10px 4px;text-align:center;cursor:pointer;transition:all .2s;}
.mood-btn.selected{border-color:var(--accent);background:rgba(232,201,122,.12);}
.mood-btn .mood-label{font-size:.58rem;color:var(--text-muted);margin-top:3px;display:block;}
.mood-history{display:flex;gap:6px;overflow-x:auto;padding-bottom:3px;}
.mood-pip{display:flex;flex-direction:column;align-items:center;gap:2px;flex-shrink:0;}
.mood-pip-date{font-size:.56rem;color:var(--text-muted);}
/* STEPS */
.step-item{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:15px 16px;margin-bottom:9px;cursor:pointer;display:flex;align-items:center;gap:13px;transition:all .2s;}
.step-item:active{transform:scale(.98);}
.step-num{font-family:'Cormorant Garamond',serif;font-size:1.6rem;font-weight:300;color:var(--accent);min-width:32px;text-align:center;line-height:1;}
.step-name{font-size:.86rem;font-weight:500;margin-bottom:2px;}
.step-preview{font-size:.74rem;color:var(--text-muted);}
.back-btn{display:flex;align-items:center;gap:7px;color:var(--accent);font-size:.83rem;cursor:pointer;margin-bottom:16px;background:none;border:none;-webkit-appearance:none;}
.step-full-title{font-family:'Cormorant Garamond',serif;font-size:1.65rem;font-weight:300;color:var(--accent);margin-bottom:13px;line-height:1.2;}
.prompts-title{font-size:.7rem;text-transform:uppercase;letter-spacing:.1em;color:var(--text-muted);margin-bottom:9px;margin-top:18px;}
.prompt-item{background:var(--surface2);border-radius:10px;padding:10px 12px;margin-bottom:6px;font-size:.82rem;color:var(--text);line-height:1.5;border-left:2px solid var(--accent);}
.journal-area{width:100%;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-family:'DM Sans',sans-serif;font-size:.86rem;line-height:1.6;padding:13px;resize:none;min-height:140px;margin-top:5px;outline:none;}
.journal-area:focus{border-color:var(--accent);}
.save-btn{width:100%;background:var(--accent);color:var(--bg);border:none;border-radius:var(--radius);padding:14px;font-family:'DM Sans',sans-serif;font-size:.86rem;font-weight:500;cursor:pointer;margin-top:9px;letter-spacing:.05em;transition:opacity .2s;}
.save-btn:active{opacity:.8;}
/* JOURNAL */
.journal-entry-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:15px 17px;margin-bottom:10px;cursor:pointer;}
.journal-date{font-size:.68rem;color:var(--text-muted);margin-bottom:4px;letter-spacing:.05em;}
.journal-preview{font-size:.84rem;line-height:1.5;color:var(--text);}
.new-entry-btn{position:fixed;bottom:calc(80px + 16px);right:20px;width:52px;height:52px;border-radius:50%;background:var(--accent);color:var(--bg);border:none;font-size:1.6rem;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 20px rgba(232,201,122,.3);z-index:50;transition:transform .2s;}
.new-entry-btn:active{transform:scale(.9);}
/* MEETINGS */
.filter-row{display:flex;gap:7px;margin-bottom:14px;overflow-x:auto;padding-bottom:3px;-webkit-overflow-scrolling:touch;}
.filter-chip{background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:6px 13px;font-size:.74rem;color:var(--text-muted);cursor:pointer;white-space:nowrap;transition:all .2s;flex-shrink:0;}
.filter-chip.active{background:var(--accent);color:var(--bg);border-color:var(--accent);}
.meeting-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:15px 17px;margin-bottom:10px;}
.meeting-name{font-size:.9rem;font-weight:500;margin-bottom:4px;}
.meeting-meta{font-size:.74rem;color:var(--text-muted);line-height:1.8;}
.meeting-tag{display:inline-block;background:rgba(232,201,122,.1);border:1px solid var(--border);border-radius:4px;padding:2px 7px;font-size:.66rem;color:var(--accent);margin-right:3px;margin-top:4px;}
.meeting-link{display:inline-block;margin-top:8px;color:var(--accent);font-size:.79rem;text-decoration:none;}
.event-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:14px;margin-bottom:10px;display:flex;gap:12px;}
.event-date-block{background:rgba(232,201,122,.1);border:1px solid var(--border);border-radius:10px;min-width:48px;height:52px;display:flex;flex-direction:column;align-items:center;justify-content:center;flex-shrink:0;}
.event-month{font-size:.58rem;text-transform:uppercase;letter-spacing:.1em;color:var(--accent);}
.event-day{font-family:'Cormorant Garamond',serif;font-size:1.4rem;font-weight:600;color:var(--text);line-height:1;}
.event-name{font-size:.86rem;font-weight:500;margin-bottom:3px;}
.event-loc{font-size:.74rem;color:var(--text-muted);}
/* SPONSOR */
.sponsor-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:18px;margin-bottom:12px;}
.sponsor-name{font-family:'Cormorant Garamond',serif;font-size:1.3rem;color:var(--accent);margin-bottom:3px;}
.sponsor-phone{font-size:.83rem;color:var(--text-muted);}
.msg-item{background:var(--surface2);border-radius:10px;padding:10px 12px;margin-bottom:6px;}
.msg-date{font-size:.66rem;color:var(--text-muted);margin-bottom:3px;}
.msg-text{font-size:.82rem;line-height:1.5;}
.text-input{width:100%;background:var(--surface);border:1px solid var(--border);border-radius:12px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:.86rem;padding:11px 13px;outline:none;}
.text-input:focus{border-color:var(--accent);}
/* RESOURCES */
.resource-section{margin-bottom:24px;}
.resource-section-title{font-family:'Cormorant Garamond',serif;font-size:1.2rem;color:var(--accent);margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid var(--border);}
.resource-link-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:13px 16px;margin-bottom:8px;display:flex;align-items:center;gap:11px;cursor:pointer;text-decoration:none;color:var(--text);transition:border-color .2s;}
.resource-link-card:active{border-color:var(--accent);}
.resource-icon{font-size:1.25rem;}
.resource-name{font-size:.86rem;font-weight:500;}
.resource-desc{font-size:.71rem;color:var(--text-muted);margin-top:2px;}
/* PRAYERS */
.prayer-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:18px;margin-bottom:10px;cursor:pointer;}
.prayer-title{font-family:'Cormorant Garamond',serif;font-size:1.05rem;color:var(--accent);}
.prayer-chevron{float:right;color:var(--text-muted);transition:transform .2s;}
.prayer-chevron.open{transform:rotate(180deg);}
.prayer-text{font-size:.83rem;color:var(--text);line-height:1.7;display:none;margin-top:12px;white-space:pre-line;}
.prayer-text.open{display:block;}
/* MILESTONES */
.milestone-card{background:linear-gradient(135deg,rgba(232,201,122,.12),rgba(100,80,160,.08));border:1px solid var(--border);border-radius:var(--radius);padding:18px;text-align:center;margin-bottom:10px;}
.milestone-num{font-family:'Cormorant Garamond',serif;font-size:2.3rem;color:var(--accent);font-weight:600;}
.milestone-label{font-size:.74rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:.1em;margin-top:3px;}
.milestone-achieved{display:inline-block;background:var(--step-done);color:white;border-radius:20px;padding:3px 10px;font-size:.68rem;margin-top:7px;}
.share-milestone-btn{background:var(--surface);border:1px solid var(--accent);color:var(--accent);border-radius:10px;padding:8px 16px;font-size:.78rem;cursor:pointer;margin-top:9px;font-family:'DM Sans',sans-serif;}
/* SETTINGS */
.toggle-row{display:flex;align-items:center;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--border);}
.toggle-row:last-child{border-bottom:none;}
.toggle-label{font-size:.84rem;}
.toggle-sub{font-size:.7rem;color:var(--text-muted);margin-top:2px;}
.toggle{width:44px;height:24px;background:var(--surface2);border-radius:12px;border:1px solid var(--border);cursor:pointer;position:relative;transition:background .2s;flex-shrink:0;}
.toggle.on{background:var(--accent);border-color:var(--accent);}
.toggle::after{content:'';position:absolute;width:18px;height:18px;border-radius:50%;background:white;top:2px;left:2px;transition:transform .2s;}
.toggle.on::after{transform:translateX(20px);}
/* MODAL */
.modal{position:fixed;inset:0;background:var(--bg);z-index:200;display:none;flex-direction:column;padding-top:var(--safe-top);}
.modal.open{display:flex;}
.modal-header{display:flex;align-items:center;gap:11px;padding:13px 18px;border-bottom:1px solid var(--border);flex-shrink:0;}
.modal-title{font-family:'Cormorant Garamond',serif;font-size:1.2rem;color:var(--accent);flex:1;}
.modal-body{flex:1;overflow-y:auto;padding:18px;-webkit-overflow-scrolling:touch;}
.modal-close{background:none;border:none;color:var(--text-muted);font-size:1.4rem;cursor:pointer;padding:4px;}
.delete-btn{background:none;border:none;color:#e74c3c;font-size:.81rem;cursor:pointer;padding:8px;}
.loading{text-align:center;padding:28px;color:var(--text-muted);font-size:.83rem;}
::-webkit-scrollbar{width:3px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}
@keyframes fadeIn{from{opacity:0;transform:translateY(7px);}to{opacity:1;transform:translateY(0);}}
.screen.active>*{animation:fadeIn .3s ease forwards;}
</style>
</head>
<body>

<div id="pin-overlay" class="hidden">
  <div class="pin-title">NA Recovery</div>
  <p style="color:var(--text-muted);font-size:.82rem;">Enter your PIN</p>
  <div class="pin-dots" id="pin-dots">
    <div class="pin-dot" id="d0"></div><div class="pin-dot" id="d1"></div>
    <div class="pin-dot" id="d2"></div><div class="pin-dot" id="d3"></div>
  </div>
  <div class="pin-grid" id="pin-grid"></div>
  <div class="pin-error" id="pin-error"></div>
  <span class="pin-forgot" onclick="resetApp()">Forgot PIN? Reset app</span>
</div>

<!-- journal modal removed -->

<!-- SHARE MODAL -->
<div class="modal" id="share-modal">
  <div class="modal-header">
    <button class="modal-close" onclick="document.getElementById('share-modal').classList.remove('open')">â†</button>
    <div class="modal-title">Share Milestone</div>
  </div>
  <div class="modal-body" id="share-modal-body" style="display:flex;flex-direction:column;align-items:center;gap:16px;"></div>
</div>

<div id="app">
  <!-- HOME -->
  <div class="screen active" id="screen-home">
    <div class="home-hero">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div style="width:28px;"></div>
        <div class="logo">NA</div>
        <div onclick="toggleTheme()" style="cursor:pointer;font-size:1.2rem;width:28px;text-align:right;" id="theme-icon">â˜€ï¸</div>
      </div>
      <div class="tagline">Just For Today</div>
    </div>

    <div class="streak-card">
      <div>
        <div class="streak-num" id="days-count">0</div>
        <div class="streak-label">Days Clean</div>
      </div>
      <div style="flex:1">
        <div class="streak-sub" id="clean-since-label">Set your clean date</div>
        <input type="date" style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:.78rem;padding:7px 10px;width:100%;margin-top:7px;outline:none;" id="clean-date-input" onchange="saveCleanDate(this.value)">
      </div>
    </div>

    <div class="card">
      <div class="card-title">Today's Check-In</div>
      <div class="mood-row" id="mood-row">
        <div class="mood-btn" onclick="setMood('ğŸ˜”','Low')" data-mood="ğŸ˜”"><div style="font-size:1.3rem;">ğŸ˜”</div><span class="mood-label">Low</span></div>
        <div class="mood-btn" onclick="setMood('ğŸ˜','Okay')" data-mood="ğŸ˜"><div style="font-size:1.3rem;">ğŸ˜</div><span class="mood-label">Okay</span></div>
        <div class="mood-btn" onclick="setMood('ğŸ™‚','Good')" data-mood="ğŸ™‚"><div style="font-size:1.3rem;">ğŸ™‚</div><span class="mood-label">Good</span></div>
        <div class="mood-btn" onclick="setMood('ğŸ˜Š','Great')" data-mood="ğŸ˜Š"><div style="font-size:1.3rem;">ğŸ˜Š</div><span class="mood-label">Great</span></div>
        <div class="mood-btn" onclick="setMood('ğŸŒŸ','Amazing')" data-mood="ğŸŒŸ"><div style="font-size:1.3rem;">ğŸŒŸ</div><span class="mood-label">Amazing</span></div>
      </div>
      <div class="section-label" style="margin-top:4px;">Recent moods</div>
      <div class="mood-history" id="mood-history"></div>
    </div>

    <div class="quote-card" id="daily-quote">Loading...</div>

    <div class="quick-actions">
      <div class="quick-btn" onclick="showScreen('steps')"><div class="qb-icon">ğŸ“–</div><div class="qb-label">Step Work</div></div>
      <div class="quick-btn" onclick="openNewJournalEntry()"><div class="qb-icon">âœï¸</div><div class="qb-label">Daily Journal</div></div>
      <div class="quick-btn" onclick="showScreen('meetings')"><div class="qb-icon">ğŸ—“</div><div class="qb-label">Meetings</div></div>
      <div class="quick-btn" onclick="showScreen('sponsor')"><div class="qb-icon">ğŸ¤</div><div class="qb-label">My Sponsor</div></div>
    </div>

    <div class="crisis-banner">
      <div style="font-size:1.2rem;">ğŸ†˜</div>
      <div class="crisis-text">
        ğŸ‡¬ğŸ‡§ UK Helpline: <span class="crisis-num">0300 999 1212</span><br>
        <span style="font-size:.72rem;color:var(--text-muted);">10amâ€“midnight daily</span><br>
        ğŸŒ NA Help Line: <span class="crisis-num">1-818-773-9999</span>
      </div>
    </div>
  </div>

  <!-- STEPS -->
  <div class="screen" id="screen-steps">
    <div id="steps-list-view">
      <div class="screen-title">Recovery Literature</div>
      <div class="screen-sub">Steps, Basic Text & daily reading</div>
      <!-- SPAD & Basic Text -->
      <div style="margin-bottom:18px;">

        <!-- SPAD -->
        <div style="font-size:.72rem;font-weight:800;color:var(--accent);text-transform:uppercase;letter-spacing:.07em;margin-bottom:10px;">âœ¨ A Spiritual Principle a Day</div>
        <a href="https://www.spadna.org" target="_blank"
           style="display:flex;align-items:center;gap:14px;background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:14px;text-decoration:none;margin-bottom:18px;">
          <div style="font-size:2rem;">ğŸ“–</div>
          <div style="flex:1;">
            <div style="font-weight:700;font-size:.9rem;color:var(--text);">Read Today's Entry</div>
            <div style="font-size:.76rem;color:var(--text-muted);margin-top:2px;">Daily spiritual principle, quote & reflection â€” spadna.org</div>
          </div>
          <div style="color:var(--text-muted);font-size:1.1rem;">â€º</div>
        </a>

        <!-- Basic Text Audio -->
        <div style="font-size:.72rem;font-weight:800;color:var(--accent);text-transform:uppercase;letter-spacing:.07em;margin-bottom:10px;">ğŸ”Š Basic Text â€” Audio</div>
        <div style="background:var(--surface);border:1px solid var(--border);border-radius:14px;overflow:hidden;margin-bottom:18px;">
          <button onclick="toggleBasicTextAudio()" id="bt-toggle-btn"
            style="width:100%;display:flex;align-items:center;justify-content:space-between;padding:14px 16px;background:transparent;border:none;cursor:pointer;">
            <div style="display:flex;align-items:center;gap:12px;">
              <div style="font-size:1.6rem;">ğŸ“»</div>
              <div style="text-align:left;">
                <div style="font-weight:700;font-size:.9rem;color:var(--text);">NA Basic Text, 6th Edition</div>
                <div style="font-size:.74rem;color:var(--text-muted);margin-top:1px;">17 chapters Â· tap to expand</div>
              </div>
            </div>
            <div id="bt-toggle-arrow" style="color:var(--accent);font-size:1rem;font-weight:700;">â–¾</div>
          </button>
          <div id="basic-text-audio" style="display:none;padding:0 16px 12px;">
            <div style="padding:10px 0;border-bottom:1px solid var(--border);">
              <div style="font-size:.8rem;font-weight:600;color:var(--text);margin-bottom:6px;">Our Symbol</div>
              <audio controls style="width:100%;height:36px;" src="https://archive.org/download/basictext1/03%20Our%20Symbol.mp3"></audio>
            </div>
            <div style="padding:10px 0;border-bottom:1px solid var(--border);">
              <div style="font-size:.8rem;font-weight:600;color:var(--text);margin-bottom:6px;">Preface</div>
              <audio controls style="width:100%;height:36px;" src="https://archive.org/download/basictext1/04%20Preface.mp3"></audio>
            </div>
            <div style="padding:10px 0;border-bottom:1px solid var(--border);">
              <div style="font-size:.8rem;font-weight:600;color:var(--text);margin-bottom:6px;">Introduction</div>
              <audio controls style="width:100%;height:36px;" src="https://archive.org/download/basictext1/05%20Book%201%20Introduction.mp3"></audio>
            </div>
            <div style="padding:10px 0;border-bottom:1px solid var(--border);">
              <div style="font-size:.8rem;font-weight:600;color:var(--text);margin-bottom:6px;">Ch.1 â€” Who Is an Addict?</div>
              <audio controls style="width:100%;height:36px;" src="https://archive.org/download/basictext1/07%20Chapter%201-%20Who%20is%20an%20Addict.mp3"></audio>
            </div>
            <div style="padding:10px 0;border-bottom:1px solid var(--border);">
              <div style="font-size:.8rem;font-weight:600;color:var(--text);margin-bottom:6px;">Ch.2 â€” What Is the NA Program?</div>
              <audio controls style="width:100%;height:36px;" src="https://archive.org/download/basictext1/08%20Chapter%202-%20What%20is%20the%20Narcotics%20Anonymous%20Program.mp3"></audio>
            </div>
            <div style="padding:10px 0;border-bottom:1px solid var(--border);">
              <div style="font-size:.8rem;font-weight:600;color:var(--text);margin-bottom:6px;">Ch.3 â€” Why Are We Here?</div>
              <audio controls style="width:100%;height:36px;" src="https://archive.org/download/basictext1/09%20Chapter%203-%20Why%20We%20Are%20Here.mp3"></audio>
            </div>
            <div style="padding:10px 0;border-bottom:1px solid var(--border);">
              <div style="font-size:.8rem;font-weight:600;color:var(--text);margin-bottom:6px;">Ch.4 â€” How It Works</div>
              <audio controls style="width:100%;height:36px;" src="https://nauca.us/wp-content/uploads/2016/08/BTCD2-02-Chapter-Four-How-It-Works.mp3"></audio>
            </div>
            <div style="padding:10px 0;border-bottom:1px solid var(--border);">
              <div style="font-size:.8rem;font-weight:600;color:var(--text);margin-bottom:6px;">Step One</div>
              <audio controls style="width:100%;height:36px;" src="https://nauca.us/wp-content/uploads/2016/08/BTCD2-03-Step-One.mp3"></audio>
            </div>
            <div style="padding:10px 0;border-bottom:1px solid var(--border);">
              <div style="font-size:.8rem;font-weight:600;color:var(--text);margin-bottom:6px;">Step Two</div>
              <audio controls style="width:100%;height:36px;" src="https://nauca.us/wp-content/uploads/2016/08/BTCD2-04-Step-Two.mp3"></audio>
            </div>
            <div style="padding:10px 0;border-bottom:1px solid var(--border);">
              <div style="font-size:.8rem;font-weight:600;color:var(--text);margin-bottom:6px;">Step Three</div>
              <audio controls style="width:100%;height:36px;" src="https://nauca.us/wp-content/uploads/2016/08/BTCD2-05-Step-Three.mp3"></audio>
            </div>
            <div style="padding:10px 0;border-bottom:1px solid var(--border);">
              <div style="font-size:.8rem;font-weight:600;color:var(--text);margin-bottom:6px;">Step Four</div>
              <audio controls style="width:100%;height:36px;" src="https://nauca.us/wp-content/uploads/2016/08/BTCD2-06-Step-Four.mp3"></audio>
            </div>
            <div style="padding:10px 0;border-bottom:1px solid var(--border);">
              <div style="font-size:.8rem;font-weight:600;color:var(--text);margin-bottom:6px;">Ch.5 â€” What Can I Do?</div>
              <audio controls style="width:100%;height:36px;" src="https://nauca.us/wp-content/uploads/2016/08/BTCD3-02-Chapter-Five-What-Can-I-Do.mp3"></audio>
            </div>
            <div style="padding:10px 0;border-bottom:1px solid var(--border);">
              <div style="font-size:.8rem;font-weight:600;color:var(--text);margin-bottom:6px;">Ch.6 â€” The Twelve Traditions</div>
              <audio controls style="width:100%;height:36px;" src="https://nauca.us/wp-content/uploads/2016/08/BTCD3-03-Chapter-Six-The-Twelve-Traditions-Of-Narcotics-Anonymous.mp3"></audio>
            </div>
            <div style="padding:10px 0;border-bottom:1px solid var(--border);">
              <div style="font-size:.8rem;font-weight:600;color:var(--text);margin-bottom:6px;">Ch.7 â€” Recovery and Relapse</div>
              <audio controls style="width:100%;height:36px;" src="https://nauca.us/wp-content/uploads/2016/08/BTCD3-16-Chapter-Seven-Recovery-And-Relapse.mp3"></audio>
            </div>
            <div style="padding:10px 0;border-bottom:1px solid var(--border);">
              <div style="font-size:.8rem;font-weight:600;color:var(--text);margin-bottom:6px;">Ch.8 â€” We Do Recover</div>
              <audio controls style="width:100%;height:36px;" src="https://nauca.us/wp-content/uploads/2016/08/BTCD3-17-Chapter-Eight-We-Do-Recover.mp3"></audio>
            </div>
            <div style="padding:10px 0;border-bottom:1px solid var(--border);">
              <div style="font-size:.8rem;font-weight:600;color:var(--text);margin-bottom:6px;">Ch.9 â€” Just for Today</div>
              <audio controls style="width:100%;height:36px;" src="https://nauca.us/wp-content/uploads/2016/08/BTCD4-02-Chapter-Nine-Just-For-Today-Living-The-Program.mp3"></audio>
            </div>
            <div style="padding:10px 0;border-bottom:1px solid var(--border);">
              <div style="font-size:.8rem;font-weight:600;color:var(--text);margin-bottom:6px;">Ch.10 â€” More Will Be Revealed</div>
              <audio controls style="width:100%;height:36px;" src="https://nauca.us/wp-content/uploads/2016/08/BTCD4-03-Chapter-Ten-More-Will-Be-Revealed.mp3"></audio>
            </div>
          </div>
        </div>

        <!-- Divider before the 12 Steps -->
        <div style="font-size:.72rem;font-weight:800;color:var(--accent);text-transform:uppercase;letter-spacing:.07em;margin-bottom:10px;">ğŸ“‹ The 12 Steps</div>
      </div>

      <div id="steps-container"></div>
    </div>
    <div id="step-detail-view" style="display:none;">
      <button class="back-btn" onclick="showStepsList()">â† All Steps</button>
      <div id="step-detail-content"></div>
    </div>
  </div>

  <!-- JOURNAL -->
  <div class="screen" id="screen-journal">
    <div class="screen-title">Journal</div>
    <div class="screen-sub">Your private reflections</div>

    <!-- Journal home â€” entry type chooser -->
    <div id="journal-home">
      <div style="font-size:.8rem;color:var(--text-muted);margin-bottom:16px;text-align:center;">What would you like to write today?</div>

      <div onclick="startJournalEntry('reflect')" class="card" style="margin-bottom:10px;display:flex;align-items:center;gap:14px;cursor:pointer;">
        <div style="font-size:2rem;flex-shrink:0;">ğŸ“</div>
        <div>
          <div style="font-weight:700;font-size:.92rem;color:var(--text);">Reflective Journal</div>
          <div style="font-size:.78rem;color:var(--text-muted);margin-top:2px;">Free writing with gentle prompts to guide you</div>
        </div>
        <div style="color:var(--text-muted);margin-left:auto;">â€º</div>
      </div>

      <div onclick="startJournalEntry('gratitude')" class="card" style="margin-bottom:10px;display:flex;align-items:center;gap:14px;cursor:pointer;">
        <div style="font-size:2rem;flex-shrink:0;">ğŸ™</div>
        <div>
          <div style="font-weight:700;font-size:.92rem;color:var(--text);">Gratitude List</div>
          <div style="font-size:.78rem;color:var(--text-muted);margin-top:2px;">Capture what you're thankful for today</div>
        </div>
        <div style="color:var(--text-muted);margin-left:auto;">â€º</div>
      </div>

      <div onclick="startJournalEntry('stepwork')" class="card" style="margin-bottom:10px;display:flex;align-items:center;gap:14px;cursor:pointer;">
        <div style="font-size:2rem;flex-shrink:0;">ğŸ“–</div>
        <div>
          <div style="font-weight:700;font-size:.92rem;color:var(--text);">Step Work</div>
          <div style="font-size:.78rem;color:var(--text-muted);margin-top:2px;">Write about your step journey</div>
        </div>
        <div style="color:var(--text-muted);margin-left:auto;">â€º</div>
      </div>

      <div onclick="startJournalEntry('spotcheck')" class="card" style="margin-bottom:10px;display:flex;align-items:center;gap:14px;cursor:pointer;">
        <div style="font-size:2rem;flex-shrink:0;">âš¡</div>
        <div>
          <div style="font-weight:700;font-size:.92rem;color:var(--text);">Spot Check Inventory</div>
          <div style="font-size:.78rem;color:var(--text-muted);margin-top:2px;">A quick pause to check in with yourself right now</div>
        </div>
        <div style="color:var(--text-muted);margin-left:auto;">â€º</div>
      </div>

      <div onclick="startJournalEntry('step10')" class="card" style="margin-bottom:18px;display:flex;align-items:center;gap:14px;cursor:pointer;">
        <div style="font-size:2rem;flex-shrink:0;">ğŸ”Ÿ</div>
        <div>
          <div style="font-weight:700;font-size:.92rem;color:var(--text);">Step 10 Daily Inventory</div>
          <div style="font-size:.78rem;color:var(--text-muted);margin-top:2px;">Full end-of-day review â€” all 36 questions</div>
        </div>
        <div style="color:var(--text-muted);margin-left:auto;">â€º</div>
      </div>

      <div class="section-label">Previous Entries</div>
      <div id="journal-entries-container"></div>
    </div>

    <!-- Journal writing view -->
    <div id="journal-write-view" style="display:none;">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px;">
        <button onclick="backToJournalHome()" style="background:var(--surface2);border:none;border-radius:50%;width:34px;height:34px;font-size:1rem;cursor:pointer;color:var(--text);">â†</button>
        <div>
          <div id="journal-write-title" style="font-weight:700;font-size:.95rem;color:var(--text);"></div>
          <div id="journal-write-date" style="font-size:.74rem;color:var(--text-muted);"></div>
        </div>
      </div>
      <div id="journal-prompts-area"></div>
      <textarea id="journal-write-text" class="journal-area" placeholder="Start writing here..." style="min-height:180px;margin-bottom:12px;"></textarea>
      <div style="display:flex;gap:8px;">
        <button class="save-btn" style="flex:1;" onclick="saveJournalWrite()">Save Entry</button>
        <button id="journal-delete-write-btn" onclick="deleteCurrentEntry()" style="padding:13px 16px;border:1px solid #e05;border-radius:var(--radius);background:transparent;color:#e05;font-size:.82rem;cursor:pointer;display:none;">Delete</button>
      </div>
    </div>
  </div>

  <!-- MEETINGS -->
  <div class="screen" id="screen-meetings">
    <div class="screen-title">Meetings & Events</div>
    <div class="screen-sub">Find your people</div>

    <!-- Tab switcher -->
    <div style="display:flex;background:var(--surface2);border-radius:12px;padding:4px;margin-bottom:16px;gap:4px;">
      <button id="tab-btn-meetings" onclick="switchMeetingTab('meetings')" style="flex:1;padding:10px;border:none;border-radius:9px;font-size:.85rem;font-weight:600;cursor:pointer;background:var(--accent);color:#1a1208;transition:all .2s;">ğŸ—“ Meetings</button>
      <button id="tab-btn-events" onclick="switchMeetingTab('events')" style="flex:1;padding:10px;border:none;border-radius:9px;font-size:.85rem;font-weight:600;cursor:pointer;background:transparent;color:var(--text-muted);transition:all .2s;">ğŸ“… Events</button>
    </div>

    <!-- MEETINGS TAB -->
    <div id="tab-meetings">
      <div class="card" style="margin-bottom:14px;">
        <div class="card-title">ğŸ” In-Person Meetings</div>
        <div class="card-text" style="margin-bottom:10px;">Find meetings near you via the official NA finder.</div>
        <a href="https://www.na.org/meetingsearch/" target="_blank" class="save-btn" style="display:block;text-decoration:none;text-align:center;margin-bottom:8px;">Open NA Meeting Finder</a>
        <a href="https://meetings.ukna.org/meeting/search" target="_blank" style="display:block;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:13px;text-decoration:none;text-align:center;color:var(--accent);font-size:.86rem;font-weight:500;">ğŸ‡¬ğŸ‡§ Find UK Meetings (ukna.org)</a>
      </div>
      <div class="section-label">Virtual NA Meetings (Live from virtual-na.org)</div>
      <div class="filter-row" id="day-filters">
        <div class="filter-chip active" onclick="filterMeetings('all',this)">All Days</div>
        <div class="filter-chip" onclick="filterMeetings('1',this)">Sun</div>
        <div class="filter-chip" onclick="filterMeetings('2',this)">Mon</div>
        <div class="filter-chip" onclick="filterMeetings('3',this)">Tue</div>
        <div class="filter-chip" onclick="filterMeetings('4',this)">Wed</div>
        <div class="filter-chip" onclick="filterMeetings('5',this)">Thu</div>
        <div class="filter-chip" onclick="filterMeetings('6',this)">Fri</div>
        <div class="filter-chip" onclick="filterMeetings('7',this)">Sat</div>
      </div>
      <div id="virtual-meetings-container"><div class="loading">Loading virtual meetings...</div></div>
    </div>

    <!-- EVENTS TAB -->
    <div id="tab-events" style="display:none;">
      <div class="card" style="margin-bottom:14px;">
        <div class="card-title">ğŸ‡¬ğŸ‡§ UK NA Events</div>
        <div class="card-text" style="margin-bottom:10px;">Conventions, speaker jams and fellowship events across the UK.</div>
        <a href="https://ukna.org/events" target="_blank" class="save-btn" style="display:block;text-decoration:none;text-align:center;">View UK Events Calendar</a>
      </div>
      <div class="card" style="margin-bottom:14px;">
        <div class="card-title">ğŸŒ NA Local Recovery Events</div>
        <div class="card-text" style="margin-bottom:10px;">Search for conventions, speaker jams and recovery events near you â€” powered by NA World Services.</div>
        <a href="https://na.org/local-recovery-events/" target="_blank" class="save-btn" style="display:block;text-decoration:none;text-align:center;">Search Events Near Me</a>
      </div>
      <div class="section-label">European NA Events (edmna.org)</div>
      <div id="events-container"></div>
    </div>
  </div>

  <!-- FOOD & NUTRITION -->
  <div class="screen" id="screen-food">
    <div class="screen-title">Nutrition</div>
    <div class="screen-sub">Nourish your recovery</div>

    <!-- Food sub-tabs -->
    <div style="display:flex;background:var(--surface2);border-radius:12px;padding:4px;margin-bottom:16px;gap:3px;">
      <button id="ftab-btn-meals" onclick="switchFoodTab('meals')" style="flex:1;padding:7px 2px;border:none;border-radius:9px;font-size:.65rem;font-weight:600;cursor:pointer;background:var(--accent);color:#1a1208;">ğŸ½ Meals</button>
      <button id="ftab-btn-planner" onclick="switchFoodTab('planner')" style="flex:1;padding:7px 2px;border:none;border-radius:9px;font-size:.65rem;font-weight:600;cursor:pointer;background:transparent;color:var(--text-muted);">ğŸ“‹ Planner</button>
      <button id="ftab-btn-shopping" onclick="switchFoodTab('shopping')" style="flex:1;padding:7px 2px;border:none;border-radius:9px;font-size:.65rem;font-weight:600;cursor:pointer;background:transparent;color:var(--text-muted);">ğŸ›’ Shop</button>
      <button id="ftab-btn-progress" onclick="switchFoodTab('progress')" style="flex:1;padding:7px 2px;border:none;border-radius:9px;font-size:.65rem;font-weight:600;cursor:pointer;background:transparent;color:var(--text-muted);">ğŸ“ˆ Progress</button>
      <button id="ftab-btn-tips" onclick="switchFoodTab('tips')" style="flex:1;padding:7px 2px;border:none;border-radius:9px;font-size:.65rem;font-weight:600;cursor:pointer;background:transparent;color:var(--text-muted);">ğŸ’š Tips</button>
    </div>

    <!-- MEALS TAB -->
    <div id="ftab-meals">
      <!-- Filter chips -->
      <div style="display:flex;gap:6px;overflow-x:auto;padding-bottom:8px;margin-bottom:10px;scrollbar-width:none;">
        <div class="filter-chip active" onclick="filterMealIdeas('all',this)" style="white-space:nowrap;font-size:.72rem;flex-shrink:0;">âœ¨ All</div>
        <div class="filter-chip" onclick="filterMealIdeas('ğŸ’ª High Protein',this)" style="white-space:nowrap;font-size:.72rem;flex-shrink:0;">ğŸ’ª High Protein</div>
        <div class="filter-chip" onclick="filterMealIdeas('ğŸ¥— Low Carb',this)" style="white-space:nowrap;font-size:.72rem;flex-shrink:0;">ğŸ¥— Low Carb</div>
        <div class="filter-chip" onclick="filterMealIdeas('ğŸŒ± Plant-Based',this)" style="white-space:nowrap;font-size:.72rem;flex-shrink:0;">ğŸŒ± Plant-Based</div>
        <div class="filter-chip" onclick="filterMealIdeas('âš¡ Quick',this)" style="white-space:nowrap;font-size:.72rem;flex-shrink:0;">âš¡ Quick</div>
        <div class="filter-chip" onclick="filterMealIdeas('ğŸ¥£ Prep Ahead',this)" style="white-space:nowrap;font-size:.72rem;flex-shrink:0;">ğŸ¥£ Prep Ahead</div>
        <div class="filter-chip" onclick="filterMealIdeas('ğŸŒ¿ Mediterranean',this)" style="white-space:nowrap;font-size:.72rem;flex-shrink:0;">ğŸŒ¿ Mediterranean</div>
      </div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
        <div class="section-label" style="margin:0;">Today's Meal Ideas</div>
        <div style="display:flex;align-items:center;gap:6px;">
          <span style="font-size:.72rem;color:var(--text-muted);">Portions:</span>
          <div style="display:flex;gap:3px;">
            <button onclick="setPortions(1)" id="p1" style="width:28px;height:28px;border-radius:6px;border:1px solid var(--border);font-size:.72rem;font-weight:700;cursor:pointer;background:transparent;color:var(--text-muted);">1</button>
            <button onclick="setPortions(2)" id="p2" style="width:28px;height:28px;border-radius:6px;border:1px solid var(--border);font-size:.72rem;font-weight:700;cursor:pointer;background:transparent;color:var(--text-muted);">2</button>
            <button onclick="setPortions(4)" id="p4" style="width:28px;height:28px;border-radius:6px;border:1px solid var(--border);font-size:.72rem;font-weight:700;cursor:pointer;background:var(--accent);color:#1a1208;">4</button>
            <button onclick="setPortions(6)" id="p6" style="width:28px;height:28px;border-radius:6px;border:1px solid var(--border);font-size:.72rem;font-weight:700;cursor:pointer;background:transparent;color:var(--text-muted);">6</button>
          </div>
        </div>
      </div>
      <div style="font-size:.75rem;color:var(--text-muted);margin-bottom:12px;">Tap â• to add to planner & shopping list. Tap ğŸ”„ for swap options.</div>
      <div id="daily-meals-container"></div>
    </div>

    <!-- PLANNER TAB -->
    <div id="ftab-planner" style="display:none;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
        <div class="section-label" style="margin:0;">Weekly Planner</div>
        <button onclick="clearWeekPlan()" style="background:none;border:1px solid var(--border);border-radius:8px;color:var(--text-muted);padding:5px 10px;font-size:.72rem;cursor:pointer;">Clear week</button>
      </div>
      <!-- Day selector strip -->
      <div style="display:flex;gap:6px;overflow-x:auto;padding-bottom:8px;margin-bottom:14px;scrollbar-width:none;" id="day-strip"></div>
      <!-- Meal slots for selected day -->
      <div id="planner-day-view"></div>
      <!-- Meal picker modal overlay -->
      <div id="meal-picker-overlay" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);z-index:200;overflow-y:auto;">
        <div style="background:var(--surface);margin:60px 16px 40px;border-radius:20px;padding:20px;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
            <div style="font-weight:700;font-size:1rem;color:var(--text);" id="picker-title">Choose a meal</div>
            <button onclick="closeMealPicker()" style="background:var(--surface2);border:none;border-radius:50%;width:32px;height:32px;font-size:1.1rem;cursor:pointer;color:var(--text);">âœ•</button>
          </div>
          <div id="meal-picker-list"></div>
        </div>
      </div>
    </div>

    <!-- SHOPPING LIST TAB -->
    <div id="ftab-shopping" style="display:none;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
        <div class="section-label" style="margin:0;">Shopping List</div>
        <button onclick="clearCheckedItems()" style="background:none;border:1px solid var(--border);border-radius:8px;color:var(--text-muted);padding:5px 10px;font-size:.72rem;cursor:pointer;">Clear ticked</button>
      </div>
      <div style="font-size:.78rem;color:var(--text-muted);margin-bottom:12px;">Generated from your meal plan. Tick items as you shop.</div>
      <div id="shopping-list-container"></div>
      <button class="save-btn" style="margin-top:12px;background:var(--surface2);color:var(--text-muted);border:1px solid var(--border);" onclick="clearAllShopping()">Clear Entire List</button>
    </div>

    <!-- PROGRESS TAB -->
    <div id="ftab-progress" style="display:none;">
      <div class="section-label">Today's Food Log</div>
      <div style="font-size:.78rem;color:var(--text-muted);margin-bottom:12px;">Log what you've eaten today to track your calories.</div>
      <div id="food-log-input-area">
        <div style="display:flex;gap:8px;margin-bottom:10px;">
          <input type="text" class="text-input" id="food-log-name" placeholder="What did you eat?" style="flex:1;margin:0;padding:10px 12px;font-size:.84rem;">
          <input type="number" class="text-input" id="food-log-cals" placeholder="kcal" style="width:80px;margin:0;padding:10px 12px;font-size:.84rem;">
        </div>
        <button class="save-btn" onclick="addFoodLog()">Add to Log</button>
      </div>
      <div id="food-log-container" style="margin-top:14px;"></div>
      <div class="section-label" style="margin-top:18px;">This Week</div>
      <div id="calorie-chart-container"></div>
    </div>

    <!-- TIPS TAB -->
    <div id="ftab-tips" style="display:none;">
      <div class="section-label">Nutrition in Recovery</div>
      <div id="tips-container"></div>
    </div>
  </div>

  <!-- SPONSOR -->
  <div class="screen" id="screen-sponsor">
    <div class="screen-title">My Sponsor</div>
    <div class="screen-sub">Your support network</div>
    <div id="sponsor-setup" style="display:none;">
      <div class="card">
        <div class="card-title">Add Your Sponsor</div>
        <div class="section-label" style="margin-top:0;">Name</div>
        <input type="text" class="text-input" id="sponsor-name-input" placeholder="Sponsor's name" style="margin-bottom:10px;">
        <div class="section-label" style="margin-top:0;">Phone</div>
        <input type="tel" class="text-input" id="sponsor-phone-input" placeholder="+1 555 000 0000" style="margin-bottom:10px;">
        <div class="section-label" style="margin-top:0;">Notes</div>
        <textarea class="journal-area" id="sponsor-notes-input" placeholder="Meeting times, notes..." style="min-height:80px;"></textarea>
        <button class="save-btn" onclick="saveSponsor()">Save Sponsor</button>
      </div>
    </div>
    <div id="sponsor-view" style="display:none;">
      <div class="sponsor-card">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;">
          <div><div class="sponsor-name" id="sponsor-name-display"></div><div class="sponsor-phone" id="sponsor-phone-display"></div></div>
          <button onclick="editSponsor()" style="background:none;border:1px solid var(--border);border-radius:8px;color:var(--text-muted);padding:5px 11px;font-size:.74rem;cursor:pointer;">Edit</button>
        </div>
        <div style="margin-top:8px;font-size:.8rem;color:var(--text-muted);" id="sponsor-notes-display"></div>
        <a id="sponsor-call-btn" href="" class="save-btn" style="display:block;text-decoration:none;text-align:center;margin-top:10px;">ğŸ“ Call Sponsor</a>
      </div>
      <div class="card">
        <div class="card-title">Contact Log</div>
        <div class="section-label" style="margin-top:0;">Log a contact</div>
        <textarea class="journal-area" id="new-msg-input" placeholder="Notes from this contact..." style="min-height:70px;"></textarea>
        <button class="save-btn" onclick="logContact()">Log Contact</button>
        <div id="msg-log-container" style="margin-top:12px;"></div>
      </div>
    </div>
    <div class="section-label">Clean Time Milestones</div>
    <div id="milestones-container"></div>
  </div>

  <!-- MOVEMENT -->
  <div class="screen" id="screen-movement">
    <div class="screen-title">Movement</div>
    <div class="screen-sub">Mind, body & breath</div>

    <!-- Sub tabs -->
    <div style="display:flex;background:var(--surface2);border-radius:12px;padding:4px;margin-bottom:16px;gap:3px;">
      <button id="mvtab-btn-yoga" onclick="switchMovementTab('yoga')" style="flex:1;padding:8px 4px;border:none;border-radius:9px;font-size:.72rem;font-weight:600;cursor:pointer;background:var(--accent);color:#1a1208;">ğŸ§˜ Yoga</button>
      <button id="mvtab-btn-meditation" onclick="switchMovementTab('meditation')" style="flex:1;padding:8px 4px;border:none;border-radius:9px;font-size:.72rem;font-weight:600;cursor:pointer;background:transparent;color:var(--text-muted);">ğŸŒ¿ Meditate</button>
      <button id="mvtab-btn-soundbath" onclick="switchMovementTab('soundbath')" style="flex:1;padding:8px 4px;border:none;border-radius:9px;font-size:.72rem;font-weight:600;cursor:pointer;background:transparent;color:var(--text-muted);">ğŸµ Sound</button>
      <button id="mvtab-btn-breathwork" onclick="switchMovementTab('breathwork')" style="flex:1;padding:8px 4px;border:none;border-radius:9px;font-size:.72rem;font-weight:600;cursor:pointer;background:transparent;color:var(--text-muted);">ğŸ’¨ Breath</button>
    </div>

    <!-- YOGA TAB -->
    <div id="mvtab-yoga">
      <div class="card" style="margin-bottom:12px;">
        <div style="font-size:2rem;margin-bottom:8px;">ğŸ§˜</div>
        <div class="card-title">Yoga on YouTube</div>
        <div class="card-text" style="margin-bottom:12px;">YouTube has hundreds of free yoga classes for all levels â€” from gentle beginners sessions to flowing vinyasa. Search "beginner yoga" or "gentle yoga for anxiety" to find something that suits you.</div>
        <a href="https://www.youtube.com/results?search_query=beginner+yoga+for+anxiety" target="_blank" class="save-btn" style="display:block;text-decoration:none;text-align:center;margin-bottom:8px;">Search Yoga on YouTube â†—</a>
      </div>
      <div class="card" style="margin-bottom:12px;">
        <div style="font-size:2rem;margin-bottom:8px;">ğŸŒ…</div>
        <div class="card-title">Morning Yoga</div>
        <div class="card-text" style="margin-bottom:12px;">Starting the day with gentle movement can bring real structure to recovery. Even 10 minutes of morning yoga helps ground you before the day begins.</div>
        <a href="https://www.youtube.com/results?search_query=morning+yoga+gentle+10+minutes" target="_blank" class="save-btn" style="display:block;text-decoration:none;text-align:center;margin-bottom:8px;">Search Morning Yoga â†—</a>
      </div>
      <div class="card" style="margin-bottom:12px;">
        <div style="font-size:2rem;margin-bottom:8px;">ğŸŒ™</div>
        <div class="card-title">Yoga for Sleep & Stress</div>
        <div class="card-text" style="margin-bottom:12px;">Restorative yoga before bed can help quiet the mind and ease the body into rest â€” something many people in recovery find especially helpful.</div>
        <a href="https://www.youtube.com/results?search_query=yoga+for+sleep+stress+relief" target="_blank" class="save-btn" style="display:block;text-decoration:none;text-align:center;">Search Bedtime Yoga â†—</a>
      </div>
    </div>

    <!-- MEDITATION TAB -->
    <div id="mvtab-meditation" style="display:none;">
      <div class="card" style="margin-bottom:12px;">
        <div style="font-size:2rem;margin-bottom:8px;">ğŸŒ¿</div>
        <div class="card-title">Guided Meditation Apps</div>
        <div class="card-text" style="margin-bottom:12px;">Free meditation apps are widely available and can be a gentle way to start a practice. Search your app store for "free meditation" or "guided meditation" and try a few to see what feels right for you.</div>
        <a href="https://www.youtube.com/results?search_query=free+guided+meditation+for+beginners" target="_blank" class="save-btn" style="display:block;text-decoration:none;text-align:center;margin-bottom:8px;">Try Guided Meditation â†—</a>
      </div>
      <div class="card" style="margin-bottom:12px;">
        <div style="font-size:2rem;margin-bottom:8px;">ğŸ§ </div>
        <div class="card-title">Meditation for Anxiety</div>
        <div class="card-text" style="margin-bottom:12px;">Many people in recovery find that a short daily meditation practice helps with anxiety, cravings and emotional regulation. Even 5 minutes a day can make a difference.</div>
        <a href="https://www.youtube.com/results?search_query=meditation+for+anxiety+recovery" target="_blank" class="save-btn" style="display:block;text-decoration:none;text-align:center;margin-bottom:8px;">Search on YouTube â†—</a>
      </div>
      <div class="card" style="margin-bottom:12px;">
        <div style="font-size:2rem;margin-bottom:8px;">ğŸ˜´</div>
        <div class="card-title">Sleep Meditation</div>
        <div class="card-text" style="margin-bottom:12px;">Poor sleep is common in early recovery. A guided sleep meditation or body scan before bed can help settle a restless mind and improve sleep quality over time.</div>
        <a href="https://www.youtube.com/results?search_query=guided+sleep+meditation+relaxation" target="_blank" class="save-btn" style="display:block;text-decoration:none;text-align:center;">Search Sleep Meditation â†—</a>
      </div>
    </div>

    <!-- SOUND BATH TAB -->
    <div id="mvtab-soundbath" style="display:none;">
      <div class="card" style="margin-bottom:12px;">
        <div style="font-size:2rem;margin-bottom:8px;">ğŸµ</div>
        <div class="card-title">What is a Sound Bath?</div>
        <div class="card-text" style="margin-bottom:12px;">A sound bath uses instruments like singing bowls, gongs and chimes to create a deeply relaxing experience. You simply lie down and listen â€” no experience needed. Many people in recovery find them profoundly calming.</div>
        <a href="https://www.youtube.com/results?search_query=sound+bath+singing+bowls+relaxation" target="_blank" class="save-btn" style="display:block;text-decoration:none;text-align:center;margin-bottom:8px;">Try a Sound Bath â†—</a>
      </div>
      <div class="card" style="margin-bottom:12px;">
        <div style="font-size:2rem;margin-bottom:8px;">ğŸ””</div>
        <div class="card-title">Tibetan Singing Bowls</div>
        <div class="card-text" style="margin-bottom:12px;">The resonance of Tibetan singing bowls is often used for deep relaxation and stress relief. Freely available on YouTube â€” try listening with headphones for the best experience.</div>
        <a href="https://www.youtube.com/results?search_query=tibetan+singing+bowls+meditation" target="_blank" class="save-btn" style="display:block;text-decoration:none;text-align:center;margin-bottom:8px;">Search on YouTube â†—</a>
      </div>
      <div class="card" style="margin-bottom:12px;">
        <div style="font-size:2rem;margin-bottom:8px;">ğŸŒŠ</div>
        <div class="card-title">Healing Frequencies</div>
        <div class="card-text" style="margin-bottom:12px;">432Hz and 528Hz tones, binaural beats and nature sounds are widely used for relaxation and sleep. Search YouTube freely to explore what resonates with you.</div>
        <a href="https://www.youtube.com/results?search_query=healing+frequency+432hz+sleep" target="_blank" class="save-btn" style="display:block;text-decoration:none;text-align:center;">Search Healing Frequencies â†—</a>
      </div>
    </div>

    <!-- BREATHWORK TAB -->
    <div id="mvtab-breathwork" style="display:none;">
      <div class="card" style="margin-bottom:12px;">
        <div style="font-size:2rem;margin-bottom:8px;">ğŸ’¨</div>
        <div class="card-title">Breathwork for Recovery</div>
        <div class="card-text" style="margin-bottom:12px;">Conscious breathing techniques can help regulate the nervous system, reduce anxiety and manage cravings. Many different approaches exist â€” explore what works for you on YouTube.</div>
        <a href="https://www.youtube.com/results?search_query=breathwork+anxiety+stress+relief" target="_blank" class="save-btn" style="display:block;text-decoration:none;text-align:center;margin-bottom:8px;">Explore Breathwork â†—</a>
      </div>
      <div class="card" style="margin-bottom:12px;">
        <div style="font-size:2rem;margin-bottom:8px;">ğŸŒ¬</div>
        <div class="card-title">Deep Breathing for Calm</div>
        <div class="card-text" style="margin-bottom:12px;">Simple deep breathing â€” slow inhale, slow exhale â€” activates the body's natural calming response. A few minutes of slow, controlled breathing can noticeably reduce stress and anxious feelings.</div>
        <a href="https://www.youtube.com/results?search_query=deep+breathing+exercise+calm+anxiety" target="_blank" class="save-btn" style="display:block;text-decoration:none;text-align:center;margin-bottom:8px;">Try Deep Breathing â†—</a>
      </div>
      <div class="card" style="margin-bottom:12px;">
        <div style="font-size:2rem;margin-bottom:8px;">â¤ï¸</div>
        <div class="card-title">Box Breathing (4-4-4-4)</div>
        <div class="card-text" style="margin-bottom:12px;">Used by the military for stress and anxiety. Breathe in for 4 counts, hold for 4, out for 4, hold for 4. Repeat. Instant calm â€” no app needed.</div>
        <div style="background:var(--surface2);border-radius:12px;padding:14px;margin-bottom:10px;">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;text-align:center;">
            <div style="background:rgba(232,201,122,0.1);border:1px solid rgba(232,201,122,0.25);border-radius:10px;padding:12px;">
              <div style="font-size:1.4rem;">ğŸ˜®â€ğŸ’¨</div>
              <div style="font-size:.72rem;color:var(--accent);font-weight:700;margin-top:4px;">INHALE</div>
              <div style="font-size:1.2rem;font-weight:700;color:var(--text);">4</div>
              <div style="font-size:.65rem;color:var(--text-muted);">counts</div>
            </div>
            <div style="background:rgba(232,201,122,0.1);border:1px solid rgba(232,201,122,0.25);border-radius:10px;padding:12px;">
              <div style="font-size:1.4rem;">â¸</div>
              <div style="font-size:.72rem;color:var(--accent);font-weight:700;margin-top:4px;">HOLD</div>
              <div style="font-size:1.2rem;font-weight:700;color:var(--text);">4</div>
              <div style="font-size:.65rem;color:var(--text-muted);">counts</div>
            </div>
            <div style="background:rgba(232,201,122,0.1);border:1px solid rgba(232,201,122,0.25);border-radius:10px;padding:12px;">
              <div style="font-size:1.4rem;">ğŸŒ¬</div>
              <div style="font-size:.72rem;color:var(--accent);font-weight:700;margin-top:4px;">EXHALE</div>
              <div style="font-size:1.2rem;font-weight:700;color:var(--text);">4</div>
              <div style="font-size:.65rem;color:var(--text-muted);">counts</div>
            </div>
            <div style="background:rgba(232,201,122,0.1);border:1px solid rgba(232,201,122,0.25);border-radius:10px;padding:12px;">
              <div style="font-size:1.4rem;">â¸</div>
              <div style="font-size:.72rem;color:var(--accent);font-weight:700;margin-top:4px;">HOLD</div>
              <div style="font-size:1.2rem;font-weight:700;color:var(--text);">4</div>
              <div style="font-size:.65rem;color:var(--text-muted);">counts</div>
            </div>
          </div>
        </div>
        <a href="https://www.youtube.com/results?search_query=box+breathing+guided" target="_blank" class="save-btn" style="display:block;text-decoration:none;text-align:center;">Find Guided Sessions â†—</a>
      </div>
      <div class="card" style="margin-bottom:12px;">
        <div style="font-size:2rem;margin-bottom:8px;">ğŸ“±</div>
        <div class="card-title">Breathwork Apps</div>
        <div class="card-text" style="margin-bottom:12px;">There are many free breathwork apps available â€” search "breathwork" or "breathing exercises" in your app store and explore what works for you. The best one is simply the one you'll actually use.</div>
        <a href="https://www.youtube.com/results?search_query=guided+breathwork+session+beginners" target="_blank" class="save-btn" style="display:block;text-decoration:none;text-align:center;">Try Guided Breathwork â†—</a>
      </div>
    </div>
  </div>

  <!-- RESOURCES -->
  <div class="screen" id="screen-resources">
    <div class="screen-title">Resources</div>
    <div class="screen-sub">Literature & support</div>
    <div class="crisis-banner">
      <div style="font-size:1.2rem;">ğŸ“</div>
      <div class="crisis-text">
        ğŸ‡¬ğŸ‡§ UK Helpline: <span class="crisis-num">0300 999 1212</span><br>
        <span style="font-size:.7rem;color:var(--text-muted);">10amâ€“midnight daily Â· low-cost from all phones</span><br>
        ğŸŒ NA Help Line: <span class="crisis-num">1-818-773-9999</span><br>
        <span style="font-size:.7rem;color:var(--text-muted);">Available 24/7</span>
      </div>
    </div>
    <div class="resource-section">
      <div class="resource-section-title">ğŸ™ Prayers & Traditions</div>
      <div id="prayers-container"></div>
    </div>
    <div class="resource-section">
      <div class="resource-section-title">ğŸ› NA Shop</div>
      <a href="https://www.na.org/shop/" target="_blank" class="resource-link-card">
        <div class="resource-icon">ğŸ“š</div><div><div class="resource-name">NA Literature Shop</div><div class="resource-desc">Basic Text, Step Working Guides, Keytags & more</div></div><div style="color:var(--text-muted);">â€º</div>
      </a>
      <a href="https://www.na.org/shop/" target="_blank" class="resource-link-card">
        <div class="resource-icon">ğŸ”‘</div><div><div class="resource-name">Recovery Keytags</div><div class="resource-desc">Celebrate milestones with official NA keytags</div></div><div style="color:var(--text-muted);">â€º</div>
      </a>
    </div>
    <div class="resource-section">
      <div class="resource-section-title">ğŸ“– Literature</div>
      <a href="https://www.na.org/?ID=daily-meditation" target="_blank" class="resource-link-card">
        <div class="resource-icon">ğŸŒ…</div><div><div class="resource-name">Just for Today</div><div class="resource-desc">Daily meditation from NA World Services</div></div><div style="color:var(--text-muted);">â€º</div>
      </a>

      <a href="https://www.na.org/?ID=ips-index" target="_blank" class="resource-link-card">
        <div class="resource-icon">ğŸ“„</div><div><div class="resource-name">IP Library</div><div class="resource-desc">Informational pamphlets on recovery topics</div></div><div style="color:var(--text-muted);">â€º</div>
      </a>
    <div class="resource-section">
      <div class="resource-section-title">ğŸŒ Online</div>
      <a href="https://ukna.org" target="_blank" class="resource-link-card">
        <div class="resource-icon">ğŸ‡¬ğŸ‡§</div><div><div class="resource-name">UK NA (ukna.org)</div><div class="resource-desc">Official UK NA â€” meetings, events & helpline</div></div><div style="color:var(--text-muted);">â€º</div>
      </a>
      <a href="https://helpline.ukna.org" target="_blank" class="resource-link-card">
        <div class="resource-icon">ğŸ“</div><div><div class="resource-name">UK Helpline</div><div class="resource-desc">0300 999 1212 Â· 10amâ€“midnight daily</div></div><div style="color:var(--text-muted);">â€º</div>
      </a>
      <a href="https://na.org/local-recovery-events/" target="_blank" class="resource-link-card">
        <div class="resource-icon">ğŸ“…</div><div><div class="resource-name">NA Local Recovery Events</div><div class="resource-desc">Find conventions & events near you worldwide</div></div><div style="color:var(--text-muted);">â€º</div>
      </a>
      <a href="https://www.na.org" target="_blank" class="resource-link-card">
        <div class="resource-icon">ğŸŒ</div><div><div class="resource-name">NA World Services</div><div class="resource-desc">Official â€” na.org</div></div><div style="color:var(--text-muted);">â€º</div>
      </a>
      <a href="https://virtual-na.org/meetings/" target="_blank" class="resource-link-card">
        <div class="resource-icon">ğŸ’»</div><div><div class="resource-name">Virtual NA</div><div class="resource-desc">Online meetings worldwide â€” virtual-na.org</div></div><div style="color:var(--text-muted);">â€º</div>
      </a>
      <div class="section-label" style="margin-top:16px;">NA History & Speaker Recordings</div>
      <a href="https://www.nalongtimers.org" target="_blank" class="resource-link-card" style="flex-direction:column;align-items:flex-start;gap:10px;">
        <div style="display:flex;align-items:center;gap:12px;width:100%;">
          <div class="resource-icon">ğŸ™ï¸</div>
          <div style="flex:1;">
            <div class="resource-name">NA Long-Timers Online Meeting</div>
            <div class="resource-desc">Speaker recordings & NA history from members with 30+ years clean</div>
          </div>
          <div style="color:var(--text-muted);">â€º</div>
        </div>
        <div style="background:rgba(232,201,122,0.08);border:1px solid var(--border);border-radius:10px;padding:10px 12px;width:100%;box-sizing:border-box;">
          <div style="font-size:.72rem;color:var(--accent);font-weight:600;margin-bottom:4px;">ğŸ“… Weekly Online Meetings</div>
          <div style="font-size:.75rem;color:var(--text-muted);line-height:1.6;" id="lol-times">Calculating your local times...</div>
          <a href="https://zoom.us/j/97488174579?pwd=UXpYUkRqZ1F6YWhMOVlmTFkybWk3Zz09" target="_blank"
             style="display:inline-block;margin-top:8px;background:var(--accent);color:#1a1208;font-size:.75rem;font-weight:700;padding:6px 14px;border-radius:20px;text-decoration:none;">
            Join Zoom Meeting â†—
          </a>
        </div>
      </a>
      <a href="https://www.inaorg.net" target="_blank" class="resource-link-card">
        <div class="resource-icon">ğŸ–¥</div><div><div class="resource-name">Internet NA (iNA)</div><div class="resource-desc">Online NA community</div></div><div style="color:var(--text-muted);">â€º</div>
      </a>
    </div>
    <div class="resource-section">
      <div class="resource-section-title">âš™ï¸ Settings</div>
      <div class="card">
        <div class="toggle-row">
          <div><div class="toggle-label">PIN Lock</div><div class="toggle-sub">Protect app with a 4-digit PIN</div></div>
          <div class="toggle" id="pin-toggle" onclick="togglePinLock()"></div>
        </div>
        <div id="pin-change-section" style="display:none;padding-top:12px;">
          <div class="section-label" style="margin-top:0;">Set PIN</div>
          <input type="number" id="new-pin-input" placeholder="4-digit PIN" class="text-input" style="-webkit-appearance:none;margin-bottom:8px;">
          <button class="save-btn" onclick="saveNewPin()">Save PIN</button>
        </div>
        <div class="toggle-row">
          <div><div class="toggle-label">Dark Mode</div><div class="toggle-sub">Toggle light / dark theme</div></div>
          <div class="toggle" id="theme-toggle" onclick="toggleTheme()"></div>
        </div>
      </div>
    </div>
  </div>

  <nav>
    <div class="nav-item active" id="nav-home" onclick="showScreen('home')"><div class="nav-icon">ğŸ </div><div>Home</div></div>
    <div class="nav-item" id="nav-steps" onclick="showScreen('steps')"><div class="nav-icon">ğŸ“–</div><div>Literature</div></div>
    <div class="nav-item" id="nav-journal" onclick="showScreen('journal')"><div class="nav-icon">âœï¸</div><div>Journal</div></div>
    <div class="nav-item" id="nav-meetings" onclick="showScreen('meetings')"><div class="nav-icon">ğŸ—“</div><div>Meetings</div></div>
    <div class="nav-item" id="nav-food" onclick="showScreen('food')"><div class="nav-icon">ğŸ¥—</div><div>Nutrition</div></div>
    <div class="nav-item" id="nav-movement" onclick="showScreen('movement')"><div class="nav-icon">ğŸ§˜</div><div>Movement</div></div>
    <div class="nav-item" id="nav-resources" onclick="showScreen('resources')"><div class="nav-icon">ğŸ“¦</div><div>Resources</div></div>
  </nav>
</div>

<canvas id="share-canvas" style="display:none;"></canvas>

<script>
const STEPS=[
{num:1,name:"Admitted powerlessness",short:"We admitted we were powerless over our addiction",full:"We admitted we were powerless over our addiction, that our lives had become unmanageable.",
sections:[
{title:"Powerlessness",qs:[
"What substances or behaviours have I tried to control, and failed?",
"Can I think of times I kept using even when I desperately did not want to? What happened?",
"What have I lost because of my addiction â€” relationships, jobs, health, trust?",
"How did my addiction take over my thinking, even when I was not using?",
"What does the word powerless genuinely mean to me, not as a concept but in my own lived experience?"
]},
{title:"Unmanageability",qs:[
"In what ways did my life fall apart because of my addiction â€” at home, at work, financially, emotionally?",
"How did I behave during my addiction that I am not proud of?",
"How did my addiction affect the people closest to me?",
"What did I do to hide the chaos my addiction was causing?",
"Looking back, what signs of unmanageability was I ignoring or explaining away?"
]},
{title:"Honesty",qs:[
"Have I been fully honest with myself about how bad things really got?",
"What excuses or stories did I tell myself to justify carrying on?",
"Who did I deceive during my addiction, and how?",
"What is the single hardest truth about my addiction that I have struggled to admit?"
]},
{title:"Surrender",qs:[
"What does surrender mean to me â€” does it feel like defeat, or relief, or something else?",
"What finally broke through my denial and brought me to this point?",
"Is there anything I am still holding on to that I have not fully let go of?",
"What would complete surrender look like for me in everyday life?",
"In my own words, what is my understanding of Step One?"
]}
]},
{num:2,name:"Came to believe",short:"Came to believe in a Power greater than ourselves",full:"We came to believe that a Power greater than ourselves could restore us to sanity.",
sections:[
{title:"Hope",qs:[
"When I first came into recovery, what gave me even a small glimmer of hope?",
"What do I have genuine hope about in my life today?",
"Have I seen recovery work for others? What did witnessing that show me?"
]},
{title:"Sanity",qs:[
"Looking back honestly, what behaviours or thought patterns would I now call insane?",
"How did my addiction distort the way I saw myself and the world?",
"What would a sane life actually feel like to me?",
"In what small ways is sanity already returning in my life?"
]},
{title:"A Higher Power",qs:[
"Do I have resistance to the idea of a Power greater than myself? Where does that resistance come from?",
"What could a Power greater than myself mean to me â€” it does not have to be religious?",
"What qualities would I want that Power to have?",
"Have I seen something at work in my recovery that feels bigger than human willpower alone?"
]},
{title:"Coming to Believe",qs:[
"Do I feel I have to force belief, or can I simply stay open to the possibility?",
"What small changes in my life might suggest something greater is at work?",
"What would it mean for my recovery if I genuinely believed help was available to me?",
"In my own words, what is my understanding of Step Two?"
]}
]},
{num:3,name:"Made a decision",short:"Made a decision to turn our will over",full:"We made a decision to turn our will and our lives over to the care of God as we understood Him.",
sections:[
{title:"The Decision",qs:[
"What does deciding to turn my will over actually mean in day-to-day life?",
"What makes this decision difficult for me?",
"Can I make this decision just for today, without worrying about forever?",
"What one concrete action today would reflect this decision?"
]},
{title:"Self-Will",qs:[
"What does self-will look like in my own life â€” what does it drive me to do?",
"When have I forced an outcome and made things worse?",
"Where do I most struggle to let go of control?",
"What is the difference between healthy effort and trying to manage everything?"
]},
{title:"My Understanding of a Higher Power",qs:[
"What does the care of God as I understand Him mean to me personally?",
"How do I try to communicate with my Higher Power?",
"How do I try to listen for guidance from something greater than myself?",
"How has my understanding of a Higher Power developed since I came into recovery?"
]},
{title:"Turning It Over",qs:[
"What does turning it over look like day to day â€” what do I actually do?",
"Which parts of my life am I most reluctant to hand over? Why?",
"Have there been times I let go and things worked out better than if I had tried to control them?",
"In my own words, what is my understanding of Step Three?"
]}
]},
{num:4,name:"Made a searching inventory",short:"Made a searching and fearless moral inventory",full:"We made a searching and fearless moral inventory of ourselves.",
sections:[
{title:"Getting Started",qs:[
"What does searching and fearless mean to me when it comes to looking at myself?",
"What am I most afraid of finding when I look honestly inward?",
"How have I prepared for this step, and am I working it with my sponsor?"
]},
{title:"Resentments",qs:[
"Who am I holding resentments towards, and what happened?",
"How have these resentments shaped my behaviour and my relationships?",
"What was my own part in each situation I feel resentful about?",
"What organisations, systems, or principles do I resent, and why?"
]},
{title:"Fears",qs:[
"What am I afraid of? Can I make as honest and complete a list as possible?",
"How have my fears shaped my decisions and actions over the years?",
"Which fears have caused the most harm in my life?",
"Where do I think my deepest fears originally come from?"
]},
{title:"Harms to Others",qs:[
"Where have I been selfish or self-seeking, and how did that affect people around me?",
"Where have I been dishonest, and who was hurt by it?",
"Have I been thoughtless or inconsiderate? What were the consequences?",
"Have I taken things from others that were not mine to take?"
]},
{title:"Patterns",qs:[
"What patterns do I notice running through my inventory?",
"What has this process revealed about myself that I had not fully seen before?",
"In my own words, what is my understanding of Step Four?"
]}
]},
{num:5,name:"Admitted wrongs to God",short:"Admitted the exact nature of our wrongs",full:"We admitted to God, to ourselves, and to another human being the exact nature of our wrongs.",
sections:[
{title:"Preparing",qs:[
"Why do I need to share this with another person â€” why is keeping it private not enough?",
"Who have I chosen to hear my Fifth Step, and why do I trust them?",
"Is there anything I am tempted to leave out? Why?"
]},
{title:"The Experience",qs:[
"How did it feel to say these things out loud to another person?",
"Was there anything harder to share than I expected?",
"Was anything left unsaid that still needs to be spoken?"
]},
{title:"Afterwards",qs:[
"How do I feel now that I have completed this step?",
"Did I sit quietly afterwards and reflect? What came up for me?",
"What patterns or character defects became clearest through this process?",
"Do I feel any freer, or more connected, after doing this work?",
"In my own words, what is my understanding of Step Five?"
]}
]},
{num:6,name:"Ready to have defects removed",short:"Were entirely ready to have our defects removed",full:"We were entirely ready to have God remove all these defects of character.",
sections:[
{title:"Identifying Defects",qs:[
"What character defects have become clear to me through Steps Four and Five?",
"Which ones have caused the most harm to myself and to others?",
"Are there any I was not aware of before going through this process?"
]},
{title:"Becoming Ready",qs:[
"Which defects am I most reluctant to let go of, and honestly why?",
"What have these defects given me? How have they protected or served me?",
"What would my life look and feel like if these defects were genuinely removed?",
"Am I entirely ready, or are there defects I am quietly hoping to keep?",
"What does entirely ready really mean to me?"
]},
{title:"Willingness",qs:[
"How do I cultivate willingness when I do not naturally feel it?",
"How do I become ready to let go of something I am afraid to lose?",
"In my own words, what is my understanding of Step Six?"
]}
]},
{num:7,name:"Humbly asked God",short:"Humbly asked Him to remove our shortcomings",full:"We humbly asked Him to remove our shortcomings.",
sections:[
{title:"Humility",qs:[
"What does humility genuinely mean to me?",
"How is humility different from humiliation, weakness, or low self-worth?",
"How has my understanding of humility changed since coming into recovery?",
"In what ways does pride or ego still get in the way of my recovery?"
]},
{title:"Asking",qs:[
"Have I actually asked my Higher Power to remove my shortcomings, or just thought about it?",
"Do I believe I deserve help with the parts of myself I am least proud of?",
"What does it feel like to genuinely ask for help with my own character?"
]},
{title:"Results",qs:[
"Have I noticed any shortcomings beginning to ease or lessen? Which ones?",
"Which shortcomings keep returning despite my efforts?",
"How has my behaviour or thinking shifted through working this step?",
"In my own words, what is my understanding of Step Seven?"
]}
]},
{num:8,name:"Made a list of those harmed",short:"Made a list of all persons we had harmed",full:"We made a list of all persons we had harmed, and became willing to make amends to them all.",
sections:[
{title:"The List",qs:[
"What does harm mean to me â€” physical, emotional, financial, relational, spiritual?",
"Who have I hurt through my addiction and my behaviour?",
"Have I included myself on this list?",
"Is there anyone I have left off because I am afraid, or because I feel they wronged me first?",
"Have I worked through this list honestly with my sponsor?"
]},
{title:"Becoming Willing",qs:[
"Am I genuinely willing to make amends to everyone on my list?",
"Is there anyone I am not yet willing to approach? What would help me get there?",
"What is the difference between writing the list and actually becoming willing?",
"How do I cultivate willingness when I do not naturally feel it?"
]},
{title:"Reflection",qs:[
"What does making this list bring up for me emotionally?",
"In my own words, what is my understanding of Step Eight?"
]}
]},
{num:9,name:"Made direct amends",short:"Made direct amends wherever possible",full:"We made direct amends to such people wherever possible, except when to do so would injure them or others.",
sections:[
{title:"Making Amends",qs:[
"What is the difference between making amends and simply saying sorry?",
"Have I talked through each amends with my sponsor before approaching anyone?",
"Are there amends where reaching out could cause further harm? How will I handle those?",
"What does a genuine amends actually look and sound like?"
]},
{title:"Working Through the List",qs:[
"Which amends have I made so far, and what happened?",
"How did I feel before, during, and after each one?",
"Which amends am I putting off, and what is really stopping me?",
"Are there financial amends I need to make? What is my honest plan for those?"
]},
{title:"Living Amends",qs:[
"What does a living amends mean â€” how am I changing my actual behaviour?",
"How are my relationships shifting as I work through this step?",
"Have any amends been poorly received? How did I handle that?",
"In my own words, what is my understanding of Step Nine?"
]}
]},
{num:10,name:"Continued personal inventory",short:"Continued to take personal inventory",full:"We continued to take personal inventory and when we were wrong, promptly admitted it.",
sections:[
{title:"Daily Inventory",qs:[
"What does a continuing daily inventory look like for me in practice?",
"When during the day do I pause and take stock of my thoughts, feelings and actions?",
"Am I honest in my ongoing inventory, or do I still minimise and rationalise?",
"What questions do I ask myself at the end of each day?"
]},
{title:"Promptly Admitting Wrongs",qs:[
"When I am wrong, how quickly do I admit it?",
"What gets in the way of admitting things promptly â€” pride, shame, fear?",
"How do I put things right when I have harmed someone during the day?",
"Am I carrying any resentments that have quietly built up and need addressing?"
]},
{title:"Patterns and Growth",qs:[
"What patterns keep showing up when I take honest inventory?",
"Where have I seen genuine growth and change in myself?",
"Where am I still struggling and need to keep working?",
"In my own words, what is my understanding of Step Ten?"
]}
]},
{num:11,name:"Sought spiritual contact",short:"Sought to improve our conscious contact with God",full:"We sought through prayer and meditation to improve our conscious contact with God as we understood Him, praying only for knowledge of His will for us and the power to carry that out.",
sections:[
{title:"Prayer",qs:[
"What does prayer mean to me, and what does it actually look like in my life?",
"Do I pray when things are going well, or mainly when I am struggling?",
"What do I pray for? Has this changed since I came into recovery?",
"How do I recognise when something I have prayed about has shifted?"
]},
{title:"Meditation",qs:[
"What does meditation mean to me, and what forms have I tried?",
"What gets in the way of a consistent meditation practice?",
"How does quieting my mind help me connect with something greater than myself?"
]},
{title:"Conscious Contact",qs:[
"What does conscious contact with a Higher Power feel like to me?",
"How has that sense of contact grown since I began working the steps?",
"What do I do when I feel cut off or disconnected from my Higher Power?",
"How does my Higher Power seem to guide or communicate with me?"
]},
{title:"Guidance",qs:[
"What does knowledge of God's will mean to me in ordinary everyday terms?",
"How do I tell the difference between my own will and something that feels like genuine guidance?",
"How do I seek direction when facing an important or difficult decision?",
"In my own words, what is my understanding of Step Eleven?"
]}
]},
{num:12,name:"Spiritual awakening",short:"Having had a spiritual awakening â€” carry the message",full:"Having had a spiritual awakening as a result of these steps, we tried to carry this message to addicts, and to practise these principles in all our affairs.",
sections:[
{title:"Spiritual Awakening",qs:[
"What does a spiritual awakening mean to me personally?",
"How is my life genuinely different today compared to when I first came into NA?",
"What specific shifts have I noticed in how I think, feel, and behave?",
"Do I feel a sense of purpose or meaning today that I did not have before?"
]},
{title:"Carrying the Message",qs:[
"How do I carry the message to other addicts in my day-to-day life?",
"What service commitments do I have, and why do they matter to my own recovery?",
"Have I sponsored anyone, or considered it? What holds me back if not?",
"What is the difference between carrying the message and giving advice or trying to control someone?"
]},
{title:"Practising the Principles",qs:[
"What does practising these principles in all our affairs look like in real life for me?",
"In which areas of my life do I find it hardest to live out what I have learned in recovery?",
"How have the steps changed my relationships with family, friends, and colleagues?",
"How do I apply what I have learned when life gets genuinely difficult?"
]},
{title:"Gratitude and Growth",qs:[
"What am I most genuinely grateful for in my recovery?",
"What would I say to someone walking through the door of NA for the very first time?",
"How do I keep growing spiritually on an ongoing basis?",
"In my own words, what is my understanding of Step Twelve?"
]}
]}
]

const QUOTES=[{text:"We admitted we were powerless over our addiction â€” that our lives had become unmanageable.",source:"Step One, NA"},{text:"Just for today, I will try to live through this day only.",source:"Just for Today"},{text:"The foundation of recovery is honesty.",source:"NA Basic Text"},{text:"Recovery is a process, not an event.",source:"NA Fellowship"},{text:"Keep coming back â€” it works if you work it.",source:"NA Fellowship"},{text:"One day at a time.",source:"NA Fellowship"},{text:"We come to know happiness, joy, and freedom.",source:"Narcotics Anonymous"},{text:"We do not have to be alone anymore.",source:"NA Basic Text"},{text:"The most important thing I can do for my recovery today is to not use, no matter what.",source:"NA Fellowship"},{text:"Pain is inevitable; suffering is optional.",source:"NA Fellowship"}];

const PRAYERS=[{title:"Serenity Prayer",text:"God, grant me the serenity to accept the things I cannot change,\nCourage to change the things I can,\nAnd wisdom to know the difference."},{title:"Third Step Prayer",text:"Take my will and my life. Guide me in my recovery. Show me how to live."},{title:"Seventh Step Prayer",text:"My Creator, I am now willing that you should have all of me, good and bad. I pray that you now remove from me every single defect of character which stands in the way of my usefulness to you and my fellows. Grant me strength, as I go out from here, to do your bidding. Amen."},{title:"Just for Today (Full)",text:"Just for today, my thoughts will be on my recovery, living and enjoying life without the use of drugs.\nJust for today, I will have faith in someone in NA who believes in me and wants to help me in my recovery.\nJust for today, I will have a program. I will try to follow it to the best of my ability.\nJust for today, through NA, I will try to get a better perspective on my life.\nJust for today, I will be unafraid. My thoughts will be on my new associations, people who are not using and who have found a new way of life."},{title:"The 12 Traditions",text:"1. Our common welfare should come first.\n2. Our leaders are but trusted servants.\n3. The only requirement for membership is a desire to stop using.\n4. Each group should be autonomous.\n5. Each group has but one primary purpose â€” to carry the message.\n6. NA ought never endorse, finance, or lend the NA name to any outside enterprise.\n7. Every NA group ought to be fully self-supporting.\n8. NA should remain forever nonprofessional.\n9. NA, as such, ought never be organized.\n10. NA has no opinion on outside issues.\n11. Our public relations policy is based on attraction rather than promotion.\n12. Anonymity is the spiritual foundation of all our traditions."},{title:"Acceptance Prayer",text:"Nothing, absolutely nothing, happens in God's world by mistake.\nUntil I could accept my addiction, I could not stay clean.\nUnless I accept life completely on life's terms, I cannot be happy.\nI need to concentrate not so much on what needs to be changed in the world,\nas on what needs to be changed in me and my attitudes."}];

const MILESTONES=[
  {days:1,label:"24 Hours",unit:"hours"},{days:7,label:"1 Week",unit:"days"},{days:30,label:"30 Days",unit:"days"},
  {days:60,label:"60 Days",unit:"days"},{days:90,label:"90 Days",unit:"days"},{days:180,label:"6 Months",unit:"months"},
  {days:270,label:"9 Months",unit:"months"},{days:365,label:"1 Year",unit:"years"},{days:547,label:"18 Months",unit:"months"},
  {days:730,label:"2 Years",unit:"years"},{days:1095,label:"3 Years",unit:"years"},{days:1460,label:"4 Years",unit:"years"},
  {days:1825,label:"5 Years",unit:"years"},{days:2190,label:"6 Years",unit:"years"},{days:2555,label:"7 Years",unit:"years"},
  {days:2920,label:"8 Years",unit:"years"},{days:3285,label:"9 Years",unit:"years"},{days:3650,label:"10 Years",unit:"years"},
  {days:4015,label:"11 Years",unit:"years"},{days:4380,label:"12 Years",unit:"years"},{days:4745,label:"13 Years",unit:"years"},
  {days:5110,label:"14 Years",unit:"years"},{days:5475,label:"15 Years",unit:"years"},{days:5840,label:"16 Years",unit:"years"},
  {days:6205,label:"17 Years",unit:"years"},{days:6570,label:"18 Years",unit:"years"},{days:6935,label:"19 Years",unit:"years"},
  {days:7300,label:"20 Years",unit:"years"},{days:7665,label:"21 Years",unit:"years"},{days:8030,label:"22 Years",unit:"years"},
  {days:8395,label:"23 Years",unit:"years"},{days:8760,label:"24 Years",unit:"years"},{days:9125,label:"25 Years",unit:"years"},
  {days:10950,label:"30 Years",unit:"years"},{days:12775,label:"35 Years",unit:"years"},{days:14600,label:"40 Years",unit:"years"},
  {days:16425,label:"45 Years",unit:"years"},{days:18250,label:"50 Years",unit:"years"},{days:20075,label:"55 Years",unit:"years"},
  {days:21900,label:"60 Years",unit:"years"}
];

const EVENTS=[
  {name:"NA Group Assembly â€” The Power of Sponsorship",month:"FEB",day:"27",dates:"Feb 27 â€“ Mar 1, 2026",location:"Starachowice, Poland",type:"Assembly",maps:"https://maps.app.goo.gl/k6LqFPkCNpQQ5p4m6"},
  {name:"Ski & Recovery Norway",month:"MAR",day:"9",dates:"Mar 9â€“14, 2026",location:"Trysil, Norway",type:"Convention",link:"https://edmna.org/wp-content/uploads/2026/02/NA_Sky_and_Recovery.pdf"},
  {name:"NA Czecho-Slovak Convention",month:"MAY",day:"22",dates:"May 22â€“24, 2026",location:"Theatre X10, Prague, Czech Republic",type:"Convention",maps:"https://maps.app.goo.gl/YcawY7MvcaQaUD6m7"},
  {name:"NA UK Convention",month:"JUL",day:"2",dates:"Jul 2â€“5, 2026",location:"Hilton Birmingham Metropol, B40 1PP",type:"Convention",maps:"https://maps.app.goo.gl/Wuhuga3541NZhcbw5"},
  {name:"ECCNA 41",month:"JUL",day:"10",dates:"Jul 10â€“12, 2026",location:"Imi Forum, Stavanger, Norway",type:"Convention",maps:"https://maps.app.goo.gl/CEnmBfBpg5As7SSAA"},
  {name:"NA Youth Convention",month:"AUG",day:"14",dates:"Aug 14â€“16, 2026",location:"Ellertshaar, The Netherlands",type:"Convention",maps:"https://maps.app.goo.gl/kRGDx5U1KXiFA9YCA"},
  {name:"CENA 2026",month:"AUG",day:"28",dates:"Aug 28â€“30, 2026",location:"Up Event Space, Budapest, Hungary",type:"Convention",maps:"https://maps.app.goo.gl/FiGwhX8UMPWApqUv7"}
];

const DAYS={1:"Sunday",2:"Monday",3:"Tuesday",4:"Wednesday",5:"Thursday",6:"Friday",7:"Saturday"};

// STATE
let journalEntries=JSON.parse(localStorage.getItem('na_journal')||'[]');
let stepJournals=JSON.parse(localStorage.getItem('na_step_journals')||'{}');
let pinEnabled=localStorage.getItem('na_pin_enabled')==='true';
let savedPin=localStorage.getItem('na_pin')||'';
let cleanDate=localStorage.getItem('na_clean_date')||'';
let moodLog=JSON.parse(localStorage.getItem('na_moods')||'[]');
let sponsor=JSON.parse(localStorage.getItem('na_sponsor')||'null');
let contactLog=JSON.parse(localStorage.getItem('na_contacts')||'[]');
let isDark=localStorage.getItem('na_theme')!=='light';
let currentJournalId=null;
let currentJournalType='reflect';
let allMeetings=[];
let dayFilter='all';
let pinInput='';

// THEME
function applyTheme(){
  document.body.classList.toggle('light-mode',!isDark);
  document.getElementById('theme-icon').textContent=isDark?'â˜€ï¸':'ğŸŒ™';
  const tt=document.getElementById('theme-toggle');
  if(tt)tt.classList.toggle('on',isDark);
}
function toggleTheme(){isDark=!isDark;localStorage.setItem('na_theme',isDark?'dark':'light');applyTheme();}

// PIN
function buildPinGrid(){
  const g=document.getElementById('pin-grid');
  [1,2,3,4,5,6,7,8,9,'',0,'âŒ«'].forEach(n=>{
    const b=document.createElement('button');
    b.className='pin-btn';b.textContent=n;
    if(n===''){b.style.opacity='0';b.style.pointerEvents='none';}
    b.onclick=()=>handlePinInput(n);g.appendChild(b);
  });
}
function handlePinInput(v){
  if(v==='âŒ«')pinInput=pinInput.slice(0,-1);
  else if(pinInput.length<4&&v!=='')pinInput+=v;
  updatePinDots();if(pinInput.length===4)setTimeout(checkPin,100);
}
function updatePinDots(){for(let i=0;i<4;i++)document.getElementById('d'+i).classList.toggle('filled',i<pinInput.length);}
function checkPin(){
  if(pinInput===savedPin){document.getElementById('pin-error').textContent='';document.getElementById('pin-overlay').classList.add('hidden');}
  else{document.getElementById('pin-error').textContent='Incorrect PIN. Try again.';pinInput='';updatePinDots();}
}
function resetApp(){if(confirm('This will clear ALL your data. Are you sure?')){localStorage.clear();location.reload();}}
function togglePinLock(){
  pinEnabled=!pinEnabled;
  document.getElementById('pin-toggle').classList.toggle('on',pinEnabled);
  document.getElementById('pin-change-section').style.display=pinEnabled?'block':'none';
  if(!pinEnabled){localStorage.setItem('na_pin_enabled','false');localStorage.removeItem('na_pin');savedPin='';}
}
function saveNewPin(){
  const v=document.getElementById('new-pin-input').value;
  if(v.length!==4||isNaN(v)){alert('Please enter a valid 4-digit PIN');return;}
  savedPin=v;localStorage.setItem('na_pin',v);localStorage.setItem('na_pin_enabled','true');
  document.getElementById('pin-change-section').style.display='none';showToast('PIN saved âœ“');
}

// NAV
function showScreen(name){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.getElementById('screen-'+name).classList.add('active');
  const nav=document.getElementById('nav-'+name);if(nav)nav.classList.add('active');
  if(name==='journal'){
    document.getElementById('journal-home').style.display='block';
    document.getElementById('journal-write-view').style.display='none';
    renderJournalList();
  }
  if(name==='steps')showStepsList();
  if(name==='meetings'){renderEvents();loadVirtualMeetings();}
  if(name==='sponsor')renderSponsorScreen();
  if(name==='resources')renderLOLTimes();
  if(name==='food'){renderDailyMeals();}
  if(name==='movement'){switchMovementTab('yoga');}
}

// HOME
function initHome(){
  if(cleanDate){document.getElementById('clean-date-input').value=cleanDate;updateDaysCount();}
  const q=QUOTES[new Date().getDate()%QUOTES.length];
  document.getElementById('daily-quote').innerHTML=`"${q.text}"<div class="quote-source">â€” ${q.source}</div>`;
  renderMoodHistory();markTodayMood();
}
function saveCleanDate(v){cleanDate=v;localStorage.setItem('na_clean_date',v);updateDaysCount();renderMilestones();}
function updateDaysCount(){
  if(!cleanDate)return;
  const diff=Math.floor((Date.now()-new Date(cleanDate).getTime())/86400000);
  document.getElementById('days-count').textContent=Math.max(0,diff);
  document.getElementById('clean-since-label').textContent=diff>=0?`Since ${new Date(cleanDate).toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'})}`:'Invalid date';
}

// MOOD
function setMood(emoji,label){
  const today=new Date().toDateString();
  moodLog=moodLog.filter(m=>m.date!==today);
  moodLog.push({date:today,emoji,label});
  if(moodLog.length>30)moodLog=moodLog.slice(-30);
  localStorage.setItem('na_moods',JSON.stringify(moodLog));
  markTodayMood();renderMoodHistory();showToast('Mood logged '+emoji);
}
function markTodayMood(){
  const today=new Date().toDateString();
  const tm=moodLog.find(m=>m.date===today);
  document.querySelectorAll('.mood-btn').forEach(b=>b.classList.toggle('selected',tm&&b.dataset.mood===tm.emoji));
}
function renderMoodHistory(){
  const c=document.getElementById('mood-history');
  const r=[...moodLog].slice(-14).reverse();
  if(!r.length){c.innerHTML='<span style="color:var(--text-muted);font-size:.76rem;">No moods logged yet</span>';return;}
  c.innerHTML=r.map(m=>{const d=new Date(m.date);return`<div class="mood-pip"><div style="font-size:1.1rem;">${m.emoji}</div><div class="mood-pip-date">${d.toLocaleDateString('en-US',{month:'numeric',day:'numeric'})}</div></div>`;}).join('');
}

// STEPS
function renderStepsList(){
  const c=document.getElementById('steps-container');c.innerHTML='';
  STEPS.forEach(s=>{
    const d=document.createElement('div');d.className='step-item';d.onclick=()=>showStepDetail(s.num);
    d.innerHTML=`<div class="step-num">${s.num}</div><div style="flex:1"><div class="step-name">${s.name}</div><div class="step-preview">${s.short}</div></div><div style="color:var(--text-muted);">â€º</div>`;
    c.appendChild(d);
  });
}
function showStepsList(){document.getElementById('steps-list-view').style.display='block';document.getElementById('step-detail-view').style.display='none';renderStepsList();}
function showStepDetail(num){
  const s=STEPS[num-1];const saved=stepJournals[num]||'';
  const PAGE=[2,8,14,20,28,33,37,41,46,54,58,63][num-1];
  document.getElementById('steps-list-view').style.display='none';
  document.getElementById('step-detail-view').style.display='block';
  document.getElementById('step-detail-content').innerHTML=`
    <div class="step-full-title">Step ${s.num}: ${s.full}</div>
    <div style="background:rgba(232,201,122,0.07);border:1px solid var(--border);border-radius:14px;padding:18px;margin:16px 0;text-align:center;">
      <div style="font-size:2.2rem;margin-bottom:8px;">ğŸ“–</div>
      <div style="font-size:.95rem;font-weight:600;color:var(--text);margin-bottom:8px;">NA Step Working Guide</div>
      <div style="font-size:.8rem;color:var(--text-muted);margin-bottom:16px;line-height:1.6;">
        The official questions for Step ${s.num} are in the NA Step Working Guide.<br>
        Tap below to open it, then work through the questions with your sponsor.
      </div>
      <a href="https://www.nwnjna.org/wp-content/uploads/2020/03/NARCOTICS-ANONYMOUS-STEP-WRITING-GUIDE.pdf#page=${PAGE}"
         target="_blank"
         style="display:inline-block;background:var(--accent);color:#1a1208;font-weight:700;font-size:.95rem;padding:13px 28px;border-radius:25px;text-decoration:none;letter-spacing:.02em;">
        Open Step ${s.num} Questions &nbsp;â†—
      </a>
      <div style="font-size:.7rem;color:var(--text-muted);margin-top:12px;opacity:.8;">Official NA Step Working Guide PDF &nbsp;Â·&nbsp; Page ${PAGE}</div>
    </div>
    <div class="prompts-title" style="margin-top:4px;">Your Journal for Step ${s.num}</div>
    <div style="font-size:.78rem;color:var(--text-muted);margin-bottom:10px;line-height:1.5;">Write your answers and reflections here as you work through the guide with your sponsor.</div>
    <textarea class="journal-area" id="step-journal-${num}" placeholder="Write your reflections here...">${saved}</textarea>
    <button class="save-btn" onclick="saveStepJournal(${num})">Save Journal</button>`;
}
function saveStepJournal(num){
  stepJournals[num]=document.getElementById('step-journal-'+num).value;
  localStorage.setItem('na_step_journals',JSON.stringify(stepJournals));showToast('Saved âœ“');
}

// FOOD & NUTRITION DATA
const MEAL_IDEAS = [
  {meal:"Breakfast",ideas:[
    {name:"Classic Overnight Oats",desc:"Rolled oats soaked in almond milk with banana and honey. Zero morning effort, ready to grab and go.",emoji:"ğŸ¥£",cals:380,protein:"12g",carbs:"58g",fat:"8g",tags:["ğŸŒ± Plant-Based","ğŸ¥£ Prep Ahead"],time:"5 mins + overnight",serves:"1",
     ingredients:["80g rolled oats","200ml almond milk","1 banana, sliced","1 tbsp honey","Â½ tsp cinnamon","Pinch of salt"],
     steps:["Mix oats, milk, honey, cinnamon and salt in a jar. Stir well.","Seal and refrigerate overnight (at least 6 hours).","In the morning stir again, top with banana and eat cold."]},

    {name:"High-Protein Overnight Oats",desc:"Oats blended with Greek yogurt, vanilla protein powder and chia seeds. 37g protein to fuel your morning.",emoji:"ğŸ’ª",cals:371,protein:"37g",carbs:"41g",fat:"8g",tags:["ğŸ’ª High Protein","ğŸ¥£ Prep Ahead"],time:"5 mins + overnight",serves:"1",
     ingredients:["60g rolled oats","120ml almond milk","120g Greek yogurt","1 scoop vanilla protein powder","1 tbsp chia seeds","1 tsp honey"],
     steps:["Combine all ingredients in a jar and stir thoroughly.","Refrigerate overnight.","Stir well in the morning. Add fresh fruit if desired."]},

    {name:"Chocolate PB Overnight Oats",desc:"Chocolate protein powder, peanut butter powder and oats soaked overnight. Tastes like dessert, built like a recovery meal.",emoji:"ğŸ«",cals:364,protein:"30g",carbs:"46g",fat:"8g",tags:["ğŸ’ª High Protein","ğŸ¥£ Prep Ahead"],time:"5 mins + overnight",serves:"1",
     ingredients:["60g rolled oats","200ml oat milk","1 scoop chocolate protein powder","1 tbsp peanut butter powder","1 tsp cocoa powder","1 tsp maple syrup","Pinch of salt"],
     steps:["Mix all ingredients in a jar until fully combined.","Refrigerate overnight.","Top with a drizzle of nut butter or banana slices before eating."]},

    {name:"Apple Cinnamon Overnight Oats",desc:"Vanilla protein oats with cinnamon and diced apple. 34g protein, naturally sweet.",emoji:"ğŸ",cals:384,protein:"34g",carbs:"48g",fat:"7g",tags:["ğŸ’ª High Protein","ğŸ¥£ Prep Ahead"],time:"5 mins + overnight",serves:"1",
     ingredients:["60g rolled oats","150ml almond milk","100g Greek yogurt","1 scoop vanilla protein powder","1 tsp cinnamon","1 apple, finely diced","1 tbsp walnuts, chopped"],
     steps:["Combine oats, milk, yogurt, protein powder and cinnamon in a jar.","Fold in half the apple. Refrigerate overnight.","Top with remaining apple and walnuts before serving."]},

    {name:"Banana Bread Overnight Oats",desc:"Mashed banana, oats, chia seeds and Greek yogurt with a hint of nutmeg. Like banana bread in a jar.",emoji:"ğŸŒ",cals:426,protein:"40g",carbs:"51g",fat:"8g",tags:["ğŸ’ª High Protein","ğŸ¥£ Prep Ahead"],time:"5 mins + overnight",serves:"1",
     ingredients:["60g rolled oats","1 ripe banana, mashed","120g Greek yogurt","1 scoop vanilla protein powder","1 tbsp chia seeds","Â½ tsp cinnamon","Pinch of nutmeg","150ml almond milk"],
     steps:["Mash the banana well in a jar.","Add all remaining ingredients and mix thoroughly.","Refrigerate overnight. Stir before eating."]},

    {name:"Strawberry & Cream Overnight Oats",desc:"Vanilla oats layered with fresh strawberries and Greek yogurt. Prep Sunday for the whole week.",emoji:"ğŸ“",cals:402,protein:"25g",carbs:"50g",fat:"13g",tags:["ğŸ’ª High Protein","ğŸ¥£ Prep Ahead"],time:"5 mins + overnight",serves:"1",
     ingredients:["60g rolled oats","200ml almond milk","80g Greek yogurt","1 tbsp chia seeds","1 tsp vanilla extract","1 tsp honey","100g fresh strawberries, sliced"],
     steps:["Mix oats, milk, yogurt, chia seeds, vanilla and honey.","Layer half the strawberries into the jar, pour oat mixture on top.","Refrigerate overnight. Top with remaining strawberries before eating."]},

    {name:"No-Powder Protein Overnight Oats",desc:"High protein oats using only Greek yogurt, chia seeds and almond butter â€” no protein powder needed. 29g protein.",emoji:"ğŸ¥›",cals:402,protein:"24g",carbs:"50g",fat:"13g",tags:["ğŸ’ª High Protein","ğŸ¥£ Prep Ahead"],time:"5 mins + overnight",serves:"1",
     ingredients:["70g rolled oats","200ml semi-skimmed milk","150g Greek yogurt","1 tbsp chia seeds","1 tbsp almond butter","1 tsp honey","Handful of mixed berries"],
     steps:["Combine oats, milk, yogurt, chia seeds, almond butter and honey in a jar.","Stir very well so almond butter is distributed.","Refrigerate overnight. Top with berries to serve."]},

    {name:"Protein AÃ§aÃ­ Bowl",desc:"Frozen aÃ§aÃ­, banana, berries, Greek yogurt and protein powder blended thick. 34g protein.",emoji:"ğŸ«",cals:376,protein:"34g",carbs:"35g",fat:"7g",tags:["ğŸ’ª High Protein","âš¡ Quick"],time:"10 mins",serves:"1",
     ingredients:["100g frozen aÃ§aÃ­ purÃ©e","1 frozen banana","80g frozen mixed berries","120g Greek yogurt","1 scoop vanilla protein powder","50ml almond milk","Granola, fresh berries and honey to top"],
     steps:["Blend aÃ§aÃ­, banana, berries, yogurt, protein powder and milk until very thick.","Spoon (not pour) into a chilled bowl.","Top with granola, fresh berries and a drizzle of honey."]},

    {name:"Green Smoothie Bowl",desc:"Frozen mango, banana and spinach blended with protein milk and yogurt. Topped with coconut flakes and kiwi.",emoji:"ğŸ¥¬",cals:404,protein:"9g",carbs:"74g",fat:"10g",tags:["ğŸŒ± Plant-Based","âš¡ Quick"],time:"10 mins",serves:"1",
     ingredients:["1 frozen banana","150g frozen mango","Large handful of spinach","100g coconut yogurt","100ml oat milk","Kiwi, granola and toasted coconut to top"],
     steps:["Blend banana, mango, spinach, yogurt and milk until completely smooth and very thick.","Pour into a bowl and smooth the top.","Arrange kiwi slices, granola and toasted coconut on top."]},

    {name:"Tropical Smoothie Bowl",desc:"Mango, pineapple, banana and coconut milk blended thick, topped with seeds and kiwi.",emoji:"ğŸŒ´",cals:350,protein:"8g",carbs:"62g",fat:"9g",tags:["ğŸŒ± Plant-Based","âš¡ Quick"],time:"10 mins",serves:"1",
     ingredients:["150g frozen mango","100g frozen pineapple","1 frozen banana","100ml coconut milk","Kiwi, mixed seeds, desiccated coconut and lime to top"],
     steps:["Blend mango, pineapple, banana and coconut milk until thick and smooth.","Spoon into a wide bowl.","Top with kiwi, seeds, coconut flakes and a squeeze of lime."]},

    {name:"Berry Protein Smoothie Bowl",desc:"Frozen berries, banana, almond butter and vanilla protein blended thick. 21g protein, eat with a spoon.",emoji:"ğŸ“",cals:291,protein:"21g",carbs:"24g",fat:"6g",tags:["ğŸ’ª High Protein","âš¡ Quick"],time:"10 mins",serves:"1",
     ingredients:["200g frozen mixed berries","1 frozen banana","1 scoop vanilla protein powder","1 tbsp almond butter","80ml almond milk","Sliced banana, granola and chia seeds to top"],
     steps:["Blend berries, banana, protein powder, almond butter and milk â€” use minimal liquid to keep thick.","Pour into a bowl.","Top with sliced banana, a handful of granola and a sprinkle of chia seeds."]},

    {name:"Green Protein Smoothie",desc:"Spinach, banana, vanilla protein powder and chia seeds blended smooth. 17g protein, 268 calories.",emoji:"ğŸ¥¦",cals:268,protein:"17g",carbs:"38g",fat:"8g",tags:["ğŸ’ª High Protein","ğŸŒ± Plant-Based","âš¡ Quick"],time:"5 mins",serves:"1",
     ingredients:["2 large handfuls of spinach","1 frozen banana","1 scoop vanilla protein powder","1 tbsp chia seeds","200ml almond milk","Â½ tsp vanilla extract","Ice"],
     steps:["Add all ingredients to a blender.","Blend on high until completely smooth. Add more milk if too thick.","Drink immediately or refrigerate for up to 4 hours."]},

    {name:"Greek Yogurt Parfait",desc:"Full-fat Greek yogurt layered with mixed berries and a handful of granola.",emoji:"ğŸ“",cals:320,protein:"18g",carbs:"38g",fat:"9g",tags:["ğŸ’ª High Protein","âš¡ Quick"],time:"5 mins",serves:"1",
     ingredients:["200g full-fat Greek yogurt","100g mixed fresh berries","30g granola","1 tsp honey","Â½ tsp vanilla extract"],
     steps:["Mix yogurt with vanilla extract.","Layer yogurt, berries and granola in a glass or bowl, repeating layers.","Drizzle with honey and serve immediately."]},

    {name:"Avocado & Egg Toast",desc:"Smashed avocado on wholegrain toast with two poached eggs and chilli flakes.",emoji:"ğŸ¥‘",cals:420,protein:"20g",carbs:"32g",fat:"22g",tags:["ğŸ’ª High Protein"],time:"10 mins",serves:"1",
     ingredients:["2 slices wholegrain bread","1 ripe avocado","2 eggs","Juice of Â½ lemon","Chilli flakes","Salt and pepper","Fresh coriander or parsley (optional)"],
     steps:["Toast the bread. Bring a pan of water to a gentle simmer.","Mash the avocado with lemon juice, salt and pepper.","Poach the eggs for 3 minutes (whites set, yolk runny).","Spread avocado on toast, top with poached eggs and chilli flakes."]},

    {name:"Savoury Cottage Cheese Bowl",desc:"Cottage cheese with cherry tomatoes, cucumber and everything bagel seasoning.",emoji:"ğŸ¥›",cals:220,protein:"24g",carbs:"8g",fat:"8g",tags:["ğŸ’ª High Protein","ğŸ¥— Low Carb","âš¡ Quick"],time:"5 mins",serves:"1",
     ingredients:["200g low-fat cottage cheese","6 cherry tomatoes, halved","Â¼ cucumber, diced","1 tsp everything bagel seasoning","Drizzle of olive oil","Fresh chives or dill"],
     steps:["Spoon cottage cheese into a bowl.","Arrange tomatoes and cucumber on top.","Sprinkle with everything bagel seasoning, drizzle with olive oil and scatter herbs."]},

    {name:"Veggie Omelette",desc:"Three-egg omelette with spinach, mushrooms, peppers and a sprinkle of feta.",emoji:"ğŸ³",cals:310,protein:"24g",carbs:"8g",fat:"20g",tags:["ğŸ’ª High Protein","ğŸ¥— Low Carb","âš¡ Quick"],time:"10 mins",serves:"1",
     ingredients:["3 large eggs","Handful of spinach","4 mushrooms, sliced","Â½ red pepper, diced","30g feta cheese, crumbled","1 tsp olive oil","Salt and pepper"],
     steps:["Whisk eggs with salt and pepper.","SautÃ© mushrooms and pepper in olive oil for 3 minutes. Add spinach until wilted. Remove from pan.","Pour eggs into the same pan over medium heat. As the edges set, lift and tilt.","When almost set, add veg and feta to one half. Fold and serve."]},

    {name:"Breakfast Quesadilla",desc:"Wholegrain tortilla with scrambled egg, low-fat cheese and salsa. Done in 5 minutes.",emoji:"ğŸ«”",cals:380,protein:"24g",carbs:"36g",fat:"14g",tags:["ğŸ’ª High Protein","âš¡ Quick"],time:"8 mins",serves:"1",
     ingredients:["1 large wholegrain tortilla","2 eggs, beaten","30g reduced-fat cheddar, grated","2 tbsp salsa","Handful of spinach","Salt and pepper"],
     steps:["Scramble eggs in a pan with salt and pepper until just cooked.","Lay tortilla flat, add eggs, cheese, salsa and spinach to one half.","Fold in half and cook in a dry pan 1-2 minutes each side until golden and cheese melts.","Slice and serve."]},

    {name:"Strawberry Banana Protein Smoothie",desc:"Blended strawberries, banana, protein powder and flaxseed. 39g protein, ready in 5 minutes.",emoji:"ğŸ“",cals:415,protein:"39g",carbs:"45g",fat:"10g",tags:["ğŸ’ª High Protein","âš¡ Quick"],time:"5 mins",serves:"1",
     ingredients:["150g frozen strawberries","1 banana","1 scoop vanilla protein powder","1 tbsp ground flaxseed","200ml semi-skimmed milk","3â€“4 ice cubes"],
     steps:["Add all ingredients to a blender.","Blend on high for 60 seconds until completely smooth.","Pour into a large glass and drink immediately."]},

    {name:"Blueberry Baked Oats",desc:"Oats baked like a cake with blueberries, banana and vanilla protein. Warm, filling and meal-preppable.",emoji:"ğŸ«",cals:360,protein:"22g",carbs:"52g",fat:"7g",tags:["ğŸ’ª High Protein","ğŸ¥£ Prep Ahead"],time:"30 mins",serves:"2",
     ingredients:["120g rolled oats","1 ripe banana, mashed","1 scoop vanilla protein powder","1 egg","200ml almond milk","100g blueberries","1 tsp baking powder","1 tsp cinnamon","1 tbsp maple syrup"],
     steps:["Preheat oven to 180Â°C. Grease a small baking dish.","Mix mashed banana, egg, milk and maple syrup together.","Stir in oats, protein powder, baking powder and cinnamon.","Fold in blueberries and pour into dish.","Bake 22â€“25 minutes until set. Serve warm or refrigerate for up to 4 days."]},

    {name:"Chia Seed Pudding",desc:"Chia seeds soaked overnight in coconut milk with vanilla. Topped with mango and toasted coconut.",emoji:"ğŸ¥¥",cals:310,protein:"8g",carbs:"34g",fat:"16g",tags:["ğŸŒ± Plant-Based","ğŸ¥£ Prep Ahead"],time:"5 mins + overnight",serves:"1",
     ingredients:["3 tbsp chia seeds","200ml coconut milk","Â½ tsp vanilla extract","1 tsp maple syrup","1 mango, diced","1 tbsp toasted desiccated coconut"],
     steps:["Whisk chia seeds, coconut milk, vanilla and maple syrup together.","After 5 minutes, whisk again to prevent clumping.","Refrigerate overnight.","Serve topped with mango and toasted coconut."]}
  ]},

  {meal:"Lunch",ideas:[
    {name:"Classic Buddha Bowl",desc:"Brown rice, edamame, roasted sweet potato, avocado and carrots with a carrot-ginger dressing.",emoji:"ğŸ¥—",cals:372,protein:"13g",carbs:"43g",fat:"18g",tags:["ğŸŒ± Plant-Based","ğŸ¥£ Prep Ahead"],time:"35 mins",serves:"2",
     ingredients:["200g brown rice, cooked","1 sweet potato, cubed and roasted","100g edamame (frozen, thawed)","1 avocado, sliced","2 carrots, grated","1 cucumber, sliced","2 tbsp carrot-ginger dressing (or tahini + lemon + ginger)","Sesame seeds"],
     steps:["Roast sweet potato at 200Â°C with olive oil and salt for 25 minutes.","Cook rice according to packet instructions.","Divide rice into bowls and arrange sweet potato, edamame, avocado, carrots and cucumber in sections.","Drizzle with dressing and scatter sesame seeds."]},

    {name:"Thai Peanut Sweet Potato Buddha Bowl",desc:"Spicy roasted sweet potato and crispy chickpeas over quinoa with Thai peanut sauce. 21g protein.",emoji:"ğŸ¥œ",cals:482,protein:"21g",carbs:"58g",fat:"19g",tags:["ğŸŒ± Plant-Based","ğŸ¥£ Prep Ahead"],time:"40 mins",serves:"2",
     ingredients:["200g quinoa, cooked","2 sweet potatoes, cubed","400g tin chickpeas, drained","2 tbsp olive oil","1 tsp smoked paprika","3 tbsp peanut butter","2 tbsp soy sauce","1 tbsp lime juice","1 tsp sriracha","1 tsp grated ginger","Warm water to thin","Coriander and spring onion to serve"],
     steps:["Preheat oven 200Â°C. Toss sweet potato and chickpeas in oil and paprika. Roast 30 minutes.","Cook quinoa according to packet. Make peanut sauce: whisk peanut butter, soy, lime, sriracha, ginger and enough water to make a drizzleable sauce.","Divide quinoa into bowls, top with sweet potato and chickpeas.","Drizzle generously with peanut sauce. Top with coriander and spring onion."]},

    {name:"Thai Tempeh Buddha Bowl",desc:"Marinated tempeh over freekeh with greens, avocado, cabbage and a cashew curry sauce.",emoji:"ğŸŒ¿",cals:275,protein:"20g",carbs:"40g",fat:"10g",tags:["ğŸŒ± Plant-Based","ğŸ¥— Low Carb"],time:"30 mins",serves:"2",
     ingredients:["200g tempeh, cubed","150g freekeh or brown rice","2 tbsp soy sauce","1 tbsp sesame oil","1 tsp grated ginger","1 garlic clove, minced","Handful of spinach","Â¼ red cabbage, shredded","1 avocado","2 tbsp cashew butter","1 tbsp curry powder","Juice of 1 lime"],
     steps:["Marinate tempeh in soy, sesame oil, ginger and garlic for 10 minutes.","Cook freekeh per packet. Pan-fry tempeh 3-4 minutes each side until golden.","Make sauce: whisk cashew butter, curry powder, lime juice and 2 tbsp warm water.","Build bowls: freekeh, spinach, cabbage, avocado and tempeh. Drizzle with sauce."]},

    {name:"Korean Crispy Tofu Bowl",desc:"Gochujang-glazed crispy tofu over steamed rice with pickled cucumber, edamame and sesame.",emoji:"ğŸŒ¶ï¸",cals:420,protein:"22g",carbs:"52g",fat:"14g",tags:["ğŸŒ± Plant-Based","ğŸ¥£ Prep Ahead"],time:"35 mins",serves:"2",
     ingredients:["400g firm tofu, pressed and cubed","200g jasmine rice, cooked","1 tbsp gochujang paste","2 tbsp soy sauce","1 tbsp sesame oil","1 tbsp honey","Â½ cucumber, thinly sliced","2 tbsp rice vinegar","100g edamame","Sesame seeds and spring onion to serve"],
     steps:["Mix gochujang, soy, sesame oil and honey. Toss tofu in half the sauce.","Air-fry or bake tofu at 200Â°C for 20â€“25 minutes until crispy.","Quick-pickle cucumber in rice vinegar with a pinch of salt for 15 minutes.","Serve rice topped with tofu, pickled cucumber and edamame. Drizzle with remaining sauce."]},

    {name:"Mediterranean Buddha Bowl",desc:"Falafel, hummus, tabbouleh, roasted peppers and tzatziki over brown rice.",emoji:"ğŸ«’",cals:490,protein:"18g",carbs:"62g",fat:"18g",tags:["ğŸŒ± Plant-Based","ğŸŒ¿ Mediterranean"],time:"30 mins",serves:"2",
     ingredients:["200g brown rice, cooked","6 shop-bought falafels (or homemade)","4 tbsp hummus","Â½ cucumber, diced","2 tomatoes, diced","Small bunch flat-leaf parsley, chopped","Juice of 1 lemon","1 roasted red pepper, sliced","4 tbsp tzatziki","Olive oil and salt"],
     steps:["Make quick tabbouleh: combine cucumber, tomatoes, parsley, lemon juice and olive oil. Season.","Warm falafels in the oven at 180Â°C for 10 minutes.","Divide rice into bowls. Add falafel, a spoonful each of hummus and tzatziki.","Top with tabbouleh and roasted pepper. Drizzle with olive oil."]},

    {name:"Miso Mushroom Bowl",desc:"Brown rice topped with soy-glazed mushrooms, avocado, cabbage, edamame and miso-ginger dressing.",emoji:"ğŸ„",cals:380,protein:"14g",carbs:"52g",fat:"14g",tags:["ğŸŒ± Plant-Based","ğŸ¥£ Prep Ahead"],time:"25 mins",serves:"2",
     ingredients:["200g brown rice, cooked","400g mixed mushrooms (shiitake, chestnut)","2 tbsp soy sauce","1 tbsp mirin","1 avocado, sliced","Â¼ white cabbage, shredded","100g edamame","2 tbsp white miso paste","1 tsp grated ginger","1 tbsp rice vinegar","1 tbsp sesame oil"],
     steps:["SautÃ© mushrooms in soy and mirin over high heat for 5â€“6 minutes until golden.","Make dressing: whisk miso, ginger, rice vinegar, sesame oil and 2 tbsp warm water.","Divide rice into bowls. Add mushrooms, avocado, cabbage and edamame in sections.","Drizzle with miso-ginger dressing."]},

    {name:"Wagamama-Style Chicken Ramen Bowl",desc:"Rich soy-ginger broth with ramen noodles, sliced chicken, soft-boiled egg, pak choi and spring onion.",emoji:"ğŸœ",cals:480,protein:"38g",carbs:"52g",fat:"10g",tags:["ğŸ’ª High Protein","âš¡ Quick"],time:"25 mins",serves:"2",
     ingredients:["2 chicken breasts","150g ramen or egg noodles","1 litre chicken stock","2 tbsp soy sauce","1 tbsp mirin","1 tsp sesame oil","1 tsp grated fresh ginger","2 garlic cloves, minced","2 pak choi, halved","2 eggs","Spring onion, sesame seeds, nori to serve"],
     steps:["Soft-boil eggs 6Â½ minutes, peel and halve. Poach chicken in stock 12 minutes, slice.","Return stock to the pan, add soy, mirin, sesame oil, ginger and garlic. Simmer 5 minutes.","Cook noodles per packet. Blanch pak choi in the broth 2 minutes.","Divide noodles into bowls. Ladle over broth, add chicken, pak choi and egg. Top with spring onion, sesame seeds and nori."]},

    {name:"Thai Chicken Peanut Rice Bowl",desc:"Jasmine rice with coconut-marinated chicken, shredded carrots, cucumber and Thai peanut sauce.",emoji:"ğŸ¥œ",cals:460,protein:"36g",carbs:"48g",fat:"14g",tags:["ğŸ’ª High Protein","ğŸ¥£ Prep Ahead"],time:"30 mins",serves:"2",
     ingredients:["200g jasmine rice, cooked","2 chicken breasts","2 tbsp coconut milk","1 tbsp soy sauce","1 tsp lime zest","3 tbsp peanut butter","2 tbsp soy sauce (for sauce)","1 tbsp sweet chilli sauce","Juice of 1 lime","2 carrots, julienned","Â½ cucumber, sliced","Fresh coriander and crushed peanuts"],
     steps:["Marinate chicken in coconut milk, soy and lime zest for 15 minutes. Grill or pan-fry 5â€“6 minutes each side.","Make sauce: whisk peanut butter, soy, sweet chilli and lime juice. Add water to thin.","Slice chicken. Divide rice into bowls, top with chicken, carrots and cucumber.","Drizzle generously with peanut sauce. Scatter coriander and crushed peanuts."]},

    {name:"Teriyaki Salmon Rice Bowl",desc:"Glazed teriyaki salmon over steamed rice with edamame, pickled ginger and cucumber.",emoji:"ğŸŸ",cals:510,protein:"38g",carbs:"54g",fat:"14g",tags:["ğŸ’ª High Protein","ğŸ¥£ Prep Ahead"],time:"25 mins",serves:"2",
     ingredients:["2 salmon fillets","200g sushi or jasmine rice, cooked","3 tbsp soy sauce","2 tbsp mirin","1 tbsp honey","1 tsp sesame oil","100g edamame","Â½ cucumber, sliced","Pickled ginger","Sesame seeds and spring onion"],
     steps:["Mix soy, mirin, honey and sesame oil for the teriyaki glaze.","Pan-fry salmon skin-side up 3 minutes, flip and brush glaze over. Cook 3 more minutes, basting.","Divide rice into bowls. Flake or slice salmon on top.","Add edamame, cucumber and pickled ginger. Scatter sesame seeds and spring onion."]},

    {name:"Thai Shrimp Noodle Bowl",desc:"Rice noodles with prawns, beansprouts, chilli, lime and a fish sauce-sesame dressing.",emoji:"ğŸ¤",cals:380,protein:"28g",carbs:"46g",fat:"8g",tags:["ğŸ’ª High Protein","âš¡ Quick"],time:"20 mins",serves:"2",
     ingredients:["150g rice noodles","300g raw king prawns, peeled","100g beansprouts","2 spring onions, sliced","1 red chilli, sliced","2 tbsp fish sauce","1 tbsp sesame oil","Juice of 2 limes","1 tsp sugar","Handful of fresh coriander","Crushed peanuts"],
     steps:["Soak noodles in boiling water 8 minutes. Drain and rinse cold.","Stir-fry prawns in sesame oil 2â€“3 minutes until pink.","Make dressing: mix fish sauce, lime juice and sugar until sugar dissolves.","Toss noodles with prawns, beansprouts, spring onion and dressing. Top with chilli, coriander and peanuts."]},

    {name:"Wagamama-Style Firecracker Tofu Bowl",desc:"Crispy tofu in a spicy firecracker sauce over steamed rice with pickled slaw and spring onion.",emoji:"ğŸ”¥",cals:410,protein:"20g",carbs:"56g",fat:"12g",tags:["ğŸŒ± Plant-Based"],time:"35 mins",serves:"2",
     ingredients:["400g firm tofu, pressed and cubed","200g jasmine rice, cooked","2 tbsp sriracha","1 tbsp soy sauce","1 tbsp rice vinegar","1 tbsp tomato purÃ©e","1 tsp sesame oil","1 tsp honey","Â¼ red cabbage, shredded","1 carrot, julienned","2 tbsp rice vinegar (for slaw)","Spring onion and sesame seeds"],
     steps:["Toss tofu in 1 tbsp soy sauce. Bake at 200Â°C for 25 minutes until crispy.","Make sauce: mix sriracha, remaining soy, rice vinegar, tomato purÃ©e, sesame oil and honey.","Quick pickle slaw: toss cabbage and carrot with rice vinegar and a pinch of sugar.","Toss hot tofu in firecracker sauce. Serve over rice with slaw, spring onion and sesame seeds."]},

    {name:"Japanese Zen Buddha Bowl",desc:"Soba noodles with sesame tofu, fresh cucumber, avocado, edamame and ponzu dressing.",emoji:"ğŸ±",cals:420,protein:"26g",carbs:"48g",fat:"12g",tags:["ğŸŒ¿ Mediterranean","ğŸ¥£ Prep Ahead"],time:"25 mins",serves:"2",
     ingredients:["150g soba noodles","300g firm tofu, cubed","2 tbsp sesame seeds","1 tbsp soy sauce","1 avocado, sliced","Â½ cucumber, sliced","100g edamame","3 tbsp ponzu sauce (or soy + lemon juice)","1 tsp sesame oil","Nori strips"],
     steps:["Cook soba noodles per packet. Rinse cold immediately.","Coat tofu in sesame seeds and soy. Pan-fry 3 minutes each side until golden.","Make dressing: mix ponzu sauce with sesame oil.","Divide noodles into bowls. Arrange tofu, avocado, cucumber and edamame. Drizzle with dressing. Top with nori."]},

    {name:"Chicken & Quinoa Bowl",desc:"Grilled chicken breast over quinoa with roasted veg and lemon tahini dressing.",emoji:"ğŸ¥—",cals:450,protein:"38g",carbs:"42g",fat:"12g",tags:["ğŸ’ª High Protein","ğŸ¥£ Prep Ahead"],time:"35 mins",serves:"2",
     ingredients:["2 chicken breasts","200g quinoa, cooked","1 courgette, sliced and grilled","1 red pepper, roasted","Handful of cherry tomatoes","3 tbsp tahini","Juice of 1 lemon","1 garlic clove, minced","2 tbsp water","Salt and pepper"],
     steps:["Season and grill chicken 5â€“6 minutes each side until cooked.","Make tahini dressing: whisk tahini, lemon, garlic, water and salt.","Grill courgette and roast peppers at 200Â°C for 20 minutes.","Divide quinoa into bowls. Slice chicken and arrange with veg. Drizzle tahini dressing."]},

    {name:"Tuna Rice Bowl",desc:"Brown rice, tinned tuna, cucumber, edamame and a soy-sesame dressing.",emoji:"ğŸš",cals:420,protein:"34g",carbs:"48g",fat:"8g",tags:["ğŸ’ª High Protein","ğŸ¥£ Prep Ahead"],time:"15 mins",serves:"2",
     ingredients:["200g brown rice, cooked","2 tins tuna in spring water, drained","Â½ cucumber, diced","100g edamame","2 spring onions, sliced","2 tbsp soy sauce","1 tbsp sesame oil","1 tsp rice vinegar","Sesame seeds"],
     steps:["Cook rice per packet or use pre-cooked pouches.","Make dressing: mix soy sauce, sesame oil and rice vinegar.","Flake tuna into bowls over rice.","Top with cucumber, edamame and spring onion. Drizzle with dressing and scatter sesame seeds."]},

    {name:"Italian Shrimp Salad",desc:"Cooked prawns with celery, olives, red onion, parsley and a lemon-olive oil dressing. Only 198 calories.",emoji:"ğŸ¤",cals:198,protein:"20g",carbs:"5g",fat:"11g",tags:["ğŸ¥— Low Carb","âš¡ Quick","ğŸ’ª High Protein"],time:"10 mins",serves:"2",
     ingredients:["300g cooked king prawns","2 sticks celery, sliced","50g mixed olives, halved","Â¼ red onion, finely sliced","Handful flat-leaf parsley, chopped","Juice of 1 lemon","3 tbsp extra virgin olive oil","Salt and pepper"],
     steps:["Combine prawns, celery, olives, red onion and parsley in a bowl.","Whisk lemon juice and olive oil. Season well.","Pour dressing over salad and toss to coat.","Serve immediately or chill for up to 2 hours."]},

    {name:"Autumn Kale & Chicken Salad",desc:"Massaged kale with roasted chicken, cranberries, pecans and apple cider vinaigrette.",emoji:"ğŸ¥¬",cals:380,protein:"30g",carbs:"22g",fat:"16g",tags:["ğŸ’ª High Protein","ğŸ¥£ Prep Ahead"],time:"30 mins",serves:"2",
     ingredients:["2 chicken breasts","200g kale, stems removed","40g dried cranberries","40g pecans, roughly chopped","1 apple, thinly sliced","3 tbsp apple cider vinegar","2 tbsp olive oil","1 tsp honey","1 tsp Dijon mustard","Salt and pepper"],
     steps:["Season and roast chicken at 200Â°C for 22 minutes. Rest and slice.","Massage kale with a pinch of salt and a drizzle of olive oil for 2 minutes until tender.","Make dressing: whisk vinegar, oil, honey and mustard.","Toss kale with dressing. Top with chicken, cranberries, pecans and apple."]},

    {name:"Spring Roll Salad",desc:"Romaine, red cabbage, cucumber, carrots and seasoned prawns with Thai peanut dressing.",emoji:"ğŸ¥—",cals:353,protein:"30g",carbs:"18g",fat:"12g",tags:["ğŸ¥— Low Carb","ğŸ’ª High Protein","âš¡ Quick"],time:"15 mins",serves:"2",
     ingredients:["300g cooked prawns","1 romaine lettuce, shredded","Â¼ red cabbage, shredded","2 carrots, julienned","Â½ cucumber, ribboned","Handful of fresh mint and coriander","3 tbsp peanut butter","2 tbsp soy sauce","1 tbsp lime juice","1 tsp sriracha","Warm water to thin"],
     steps:["Make peanut dressing: whisk peanut butter, soy, lime juice and sriracha with enough warm water to make a pourable sauce.","Arrange lettuce, cabbage, carrots and cucumber in bowls.","Top with prawns and herbs.","Drizzle generously with peanut dressing."]},

    {name:"Turkey Lettuce Wraps",desc:"Lean turkey mince with garlic, ginger and soy in crispy lettuce cups.",emoji:"ğŸ¥¬",cals:280,protein:"28g",carbs:"10g",fat:"10g",tags:["ğŸ¥— Low Carb","âš¡ Quick","ğŸ’ª High Protein"],time:"20 mins",serves:"2",
     ingredients:["400g lean turkey mince","2 garlic cloves, minced","1 tsp grated ginger","2 tbsp soy sauce","1 tbsp hoisin sauce","1 tsp sesame oil","1 carrot, finely diced","1 head butter lettuce, leaves separated","Spring onion and sesame seeds"],
     steps:["Brown turkey mince in a pan over high heat, breaking up lumps.","Add garlic and ginger, cook 1 minute.","Add carrot, soy, hoisin and sesame oil. Stir-fry 3â€“4 minutes.","Spoon into lettuce cups. Top with spring onion and sesame seeds."]},

    {name:"Black Bean Burrito Bowl",desc:"Brown rice, black beans, corn, avocado, salsa and lime chicken.",emoji:"ğŸŒ¯",cals:490,protein:"32g",carbs:"58g",fat:"12g",tags:["ğŸŒ± Plant-Based","ğŸ¥£ Prep Ahead"],time:"30 mins",serves:"2",
     ingredients:["200g brown rice, cooked","400g tin black beans, drained","100g frozen sweetcorn, thawed","1 avocado, diced","100ml fresh salsa","2 chicken breasts (optional)","Juice of 1 lime","1 tsp cumin","1 tsp smoked paprika","Fresh coriander","Greek yogurt to serve"],
     steps:["Season chicken with cumin and paprika and grill 5â€“6 mins each side. Slice.","Warm black beans with a pinch of cumin and salt.","Divide rice into bowls. Top with chicken, beans, corn and avocado.","Finish with salsa, a squeeze of lime, coriander and a dollop of yogurt."]},

    {name:"Spinach & Feta Stuffed Chicken",desc:"Chicken breast stuffed with wilted spinach and feta, baked golden. 40g protein.",emoji:"ğŸ«•",cals:340,protein:"40g",carbs:"4g",fat:"16g",tags:["ğŸ’ª High Protein","ğŸ¥— Low Carb"],time:"40 mins",serves:"2",
     ingredients:["2 large chicken breasts","100g fresh spinach","60g feta cheese, crumbled","1 garlic clove, minced","1 tbsp olive oil","Salt, pepper and paprika"],
     steps:["Preheat oven to 200Â°C. Wilt spinach in a pan with garlic, drain excess liquid.","Mix spinach with feta. Cut a deep pocket in each chicken breast.","Stuff chicken with spinach-feta mixture. Secure with a toothpick if needed.","Rub with olive oil, paprika, salt and pepper. Bake 25â€“30 minutes until cooked through."]}
  ]},

  {meal:"Dinner",ideas:[
    {name:"Salmon & Roasted Veg",desc:"Baked salmon fillet with roasted broccoli, sweet potato and a squeeze of lemon.",emoji:"ğŸŸ",cals:520,protein:"38g",carbs:"35g",fat:"22g",tags:["ğŸ’ª High Protein","ğŸŒ¿ Omega-3"],time:"40 mins",serves:"2",
     ingredients:["2 salmon fillets","2 sweet potatoes, cubed","200g tenderstem broccoli","2 tbsp olive oil","1 lemon","Salt, pepper, garlic powder"],
     steps:["Preheat oven 200Â°C. Toss sweet potato in oil, garlic powder and salt. Roast 20 mins.","Add salmon and broccoli. Squeeze lemon over everything.","Roast 15â€“18 more mins until salmon is cooked. Season and serve."]},
    {name:"Chicken Stir Fry",desc:"Chicken breast, peppers, pak choi and brown rice with a light soy-ginger sauce.",emoji:"ğŸ¥˜",cals:480,protein:"42g",carbs:"48g",fat:"10g",tags:["ğŸ’ª High Protein","âš¡ Quick"],time:"20 mins",serves:"2",
     ingredients:["2 chicken breasts, sliced","200g brown rice, cooked","2 mixed peppers, sliced","2 pak choi, halved","2 tbsp soy sauce","1 tbsp oyster sauce","1 tsp grated ginger","2 garlic cloves","1 tsp sesame oil"],
     steps:["Stir-fry chicken in sesame oil over high heat 5 mins until golden.","Add garlic, ginger, peppers. Cook 3 more mins.","Add pak choi, soy and oyster sauce. Toss 2 mins until wilted.","Serve over brown rice."]},
    {name:"Chickpea Curry",desc:"Warming chickpea and spinach curry with coconut milk. Plant-based and protein-rich.",emoji:"ğŸ›",cals:460,protein:"18g",carbs:"62g",fat:"14g",tags:["ğŸŒ± Plant-Based","ğŸ¥£ Prep Ahead"],time:"25 mins",serves:"3",
     ingredients:["2 tins chickpeas, drained","1 tin chopped tomatoes","1 tin coconut milk","1 onion, diced","2 garlic cloves","1 tsp garam masala","1 tsp cumin","1 tsp turmeric","Handful of spinach"],
     steps:["Fry onion and garlic 5 mins until soft.","Add spices, cook 1 min stirring.","Add tomatoes, coconut milk, chickpeas. Simmer 15 mins.","Stir in spinach. Serve with brown rice."]},
    {name:"Turkey Meatballs",desc:"Lean turkey meatballs in rich tomato sauce with courgette.",emoji:"ğŸ",cals:390,protein:"35g",carbs:"18g",fat:"12g",tags:["ğŸ’ª High Protein","ğŸ¥— Low Carb"],time:"35 mins",serves:"3",
     ingredients:["500g lean turkey mince","1 egg","2 tbsp breadcrumbs","1 tsp dried oregano","400g tin chopped tomatoes","1 onion, diced","2 garlic cloves","1 courgette, diced","Salt and pepper"],
     steps:["Mix turkey, egg, breadcrumbs, oregano, salt and pepper. Roll into balls.","Brown meatballs in olive oil 5 mins, set aside.","Fry onion, garlic and courgette 5 mins. Add tomatoes, simmer 10 mins.","Return meatballs to sauce. Simmer 10 more mins."]},
    {name:"Greek Chicken Bowl",desc:"Marinated grilled chicken with tzatziki, feta, olives and Greek salad.",emoji:"ğŸ¥—",cals:473,protein:"35g",carbs:"9g",fat:"33g",tags:["ğŸ’ª High Protein","ğŸ¥— Low Carb","ğŸŒ¿ Mediterranean"],time:"30 mins",serves:"4",
     ingredients:["455g chicken breast","3 tbsp olive oil","2 tbsp lemon juice","1 tbsp Greek seasoning","224g Greek yoghurt","Â½ cucumber, grated","2 garlic cloves","115g feta","80g Kalamata olives","200g cherry tomatoes","Â½ red onion"],
     steps:["Marinate chicken in oil, lemon and seasoning 30 mins. Grill 4â€“5 mins each side.","Make tzatziki: mix yoghurt, grated cucumber, garlic and dill.","Arrange chicken, feta, olives, tomatoes and onion in bowls.","Top with tzatziki and drizzle of olive oil."]},
    {name:"Moroccan Sheet-pan Chicken",desc:"Chicken thighs roasted with peppers, cumin, coriander and harissa â€” all on one tray.",emoji:"ğŸ«‘",cals:490,protein:"40g",carbs:"22g",fat:"22g",tags:["ğŸ’ª High Protein","ğŸ¥£ Prep Ahead"],time:"50 mins",serves:"4",
     ingredients:["600g chicken thighs","3 mixed peppers, sliced","1 red onion, wedged","2 tbsp harissa paste","1 tsp cumin","1 tsp ground coriander","2 tbsp olive oil","1 lemon"],
     steps:["Preheat oven 200Â°C. Mix harissa, cumin, coriander and oil.","Toss chicken and veg in spice mix. Spread on a large tray.","Roast 40â€“45 mins until chicken is golden and cooked through.","Squeeze lemon over before serving."]},
    {name:"Mexican Baked Sweet Potato",desc:"Baked sweet potato loaded with black beans, avocado and salsa.",emoji:"ğŸ ",cals:420,protein:"16g",carbs:"68g",fat:"9g",tags:["ğŸŒ± Plant-Based"],time:"55 mins",serves:"2",
     ingredients:["2 large sweet potatoes","400g tin black beans, drained","1 avocado, diced","100ml fresh salsa","1 tsp cumin","100g Greek yogurt","Fresh coriander","Lime wedges"],
     steps:["Bake sweet potatoes at 200Â°C for 45â€“50 mins until soft.","Warm black beans with cumin and salt.","Split potatoes open. Load with black beans, avocado and salsa.","Top with yogurt, coriander and a squeeze of lime."]},
    {name:"Creamy Mushroom Pasta",desc:"One-pot pasta in a creamy mushroom and garlic sauce.",emoji:"ğŸ„",cals:510,protein:"18g",carbs:"72g",fat:"16g",tags:["ğŸŒ± Plant-Based","ğŸ¥£ Prep Ahead"],time:"25 mins",serves:"2",
     ingredients:["300g pasta","400g chestnut mushrooms, sliced","3 garlic cloves","500ml vegetable stock","100g light cream cheese","30g parmesan","Fresh thyme","Olive oil, salt and pepper"],
     steps:["Fry mushrooms in olive oil over high heat 5 mins until golden. Add garlic and thyme.","Add pasta and stock. Bring to boil, cover, cook 10 mins stirring occasionally.","Stir in cream cheese and parmesan until sauce is creamy.","Season and serve with extra parmesan."]},
    {name:"Sweet Potato Skillet Hash",desc:"Diced sweet potato, eggs, peppers and onion all in one pan.",emoji:"ğŸ¥š",cals:380,protein:"20g",carbs:"44g",fat:"14g",tags:["ğŸŒ± Plant-Based","âš¡ Quick"],time:"25 mins",serves:"2",
     ingredients:["2 sweet potatoes, diced small","4 eggs","2 mixed peppers, diced","1 onion, diced","1 tsp smoked paprika","2 tbsp olive oil","Salt and pepper","Fresh chives"],
     steps:["Cook sweet potato in olive oil over medium heat 10 mins, stirring often.","Add peppers, onion and paprika. Cook 5 more mins.","Make 4 wells in the hash. Crack an egg into each.","Cover and cook 3â€“4 mins until whites are set. Season and top with chives."]},
    {name:"Honey Turmeric Chicken Tray",desc:"Chicken glazed with honey and turmeric, roasted with veg.",emoji:"ğŸ¯",cals:460,protein:"38g",carbs:"28g",fat:"18g",tags:["ğŸ’ª High Protein","ğŸ¥£ Prep Ahead"],time:"45 mins",serves:"4",
     ingredients:["600g chicken drumsticks","2 sweet potatoes, cubed","200g broccoli florets","2 tbsp honey","1 tsp turmeric","2 garlic cloves, minced","2 tbsp olive oil","1 tbsp soy sauce"],
     steps:["Preheat oven 200Â°C. Mix honey, turmeric, garlic, oil and soy into a glaze.","Toss chicken and veg in glaze. Spread on a large roasting tray.","Roast 35â€“40 mins until chicken is cooked and sticky.","Serve with extra glaze drizzled over."]},
    {name:"Shrimp Fajita Bowl",desc:"Seasoned prawns with peppers and onion over cauliflower rice with guacamole.",emoji:"ğŸŒ®",cals:320,protein:"30g",carbs:"18g",fat:"14g",tags:["ğŸ¥— Low Carb","ğŸ’ª High Protein","âš¡ Quick"],time:"20 mins",serves:"2",
     ingredients:["400g raw king prawns","2 mixed peppers, sliced","1 onion, sliced","1 tsp cumin","1 tsp smoked paprika","1 tsp garlic powder","Juice of 1 lime","400g cauliflower rice","2 tbsp guacamole","Fresh coriander"],
     steps:["Season prawns with cumin, paprika and garlic powder.","Stir-fry peppers and onion in oil 5 mins. Add prawns, cook 3 mins.","Microwave or pan-fry cauliflower rice 3â€“4 mins.","Serve prawns over cauli rice. Top with guacamole, coriander and lime."]},
    {name:"Air Fryer Peanut Curry Tofu",desc:"Crispy air-fried tofu in a peanut curry sauce over gingery cauliflower rice.",emoji:"ğŸ¥œ",cals:387,protein:"18g",carbs:"22g",fat:"20g",tags:["ğŸŒ± Plant-Based","ğŸ¥— Low Carb"],time:"35 mins",serves:"2",
     ingredients:["400g firm tofu, pressed and cubed","3 tbsp peanut butter","1 tbsp red curry paste","1 tbsp soy sauce","1 tin coconut milk","400g cauliflower rice","1 tsp grated ginger","Lime and coriander to serve"],
     steps:["Toss tofu in 1 tbsp soy sauce. Air-fry at 200Â°C for 20 mins until very crispy.","Simmer curry paste, peanut butter and coconut milk 10 mins into a sauce.","Cook cauliflower rice with grated ginger in a pan 4 mins.","Serve tofu over cauli rice, pour sauce over. Finish with lime and coriander."]},
    {name:"Korean Salmon Tacos",desc:"Gochujang-glazed salmon in lettuce cups with spicy slaw and sesame.",emoji:"ğŸŒ®",cals:410,protein:"36g",carbs:"16g",fat:"20g",tags:["ğŸ’ª High Protein","ğŸ¥— Low Carb","âš¡ Quick"],time:"20 mins",serves:"2",
     ingredients:["2 salmon fillets","2 tbsp gochujang paste","1 tbsp soy sauce","1 tbsp honey","Â½ red cabbage, shredded","1 carrot, julienned","2 tbsp rice vinegar","Butter lettuce leaves","Sesame seeds and spring onion"],
     steps:["Mix gochujang, soy and honey. Brush over salmon.","Pan-fry or grill salmon 4 mins each side, basting with glaze.","Toss cabbage and carrot in rice vinegar with a pinch of salt.","Serve salmon flaked into lettuce cups with slaw, sesame and spring onion."]},
    {name:"Prawn Cauliflower Fried Rice",desc:"Cauliflower rice stir-fried with prawns, egg, peas and soy. Under 350 calories.",emoji:"ğŸš",cals:340,protein:"28g",carbs:"14g",fat:"12g",tags:["ğŸ¥— Low Carb","ğŸ’ª High Protein","âš¡ Quick"],time:"20 mins",serves:"2",
     ingredients:["400g cauliflower rice","300g cooked prawns","2 eggs, beaten","100g frozen peas","2 spring onions, sliced","2 tbsp soy sauce","1 tsp sesame oil","1 garlic clove, minced","1 tsp grated ginger"],
     steps:["Stir-fry garlic and ginger in sesame oil 30 secs. Add cauliflower rice, cook 4 mins.","Push to one side, scramble eggs in the other side of the pan.","Add prawns, peas and spring onion. Pour over soy sauce.","Toss everything together and cook 2 more mins."]},
    {name:"Ground Beef & Zucchini Bake",desc:"Cheesy skillet with lean beef mince, courgette and Italian herbs.",emoji:"ğŸ«•",cals:337,protein:"36g",carbs:"10g",fat:"16g",tags:["ğŸ¥— Low Carb","ğŸ’ª High Protein","ğŸ¥£ Prep Ahead"],time:"35 mins",serves:"4",
     ingredients:["500g lean beef mince","2 courgettes, diced","400g tin chopped tomatoes","1 onion, diced","2 garlic cloves","1 tsp dried oregano","1 tsp dried basil","80g mozzarella, grated","Salt and pepper"],
     steps:["Brown mince and onion in an oven-safe pan 8 mins. Add garlic.","Add courgette, tomatoes, oregano and basil. Simmer 15 mins.","Top with mozzarella. Bake at 200Â°C for 10 mins until bubbling and golden.","Serve straight from the pan."]},
    {name:"Slow Cooker Coq au Vin",desc:"Chicken thighs slow-cooked in red wine with mushrooms and herbs. 35g protein.",emoji:"ğŸ·",cals:420,protein:"35g",carbs:"14g",fat:"18g",tags:["ğŸ’ª High Protein","ğŸ¥£ Prep Ahead"],time:"6 hrs",serves:"4",
     ingredients:["600g chicken thighs","1 bottle red wine","300g mushrooms, halved","2 carrots, sliced","1 onion, diced","2 garlic cloves","2 sprigs thyme","1 bay leaf","200ml chicken stock","2 tbsp plain flour"],
     steps:["Brown chicken in a pan 5 mins each side. Place in slow cooker.","Fry onion and garlic 3 mins. Add flour, wine and stock. Pour over chicken.","Add mushrooms, carrots, thyme and bay. Cook on low 6 hours.","Serve with mashed potato or crusty bread."]},
    {name:"Air Fryer Asian Meatballs",desc:"Lean pork and ginger meatballs with a sticky teriyaki glaze. Ready in 20 minutes.",emoji:"ğŸ¥¢",cals:350,protein:"28g",carbs:"20g",fat:"14g",tags:["ğŸ’ª High Protein","âš¡ Quick"],time:"20 mins",serves:"2",
     ingredients:["400g lean pork mince","1 tsp grated ginger","2 garlic cloves, minced","2 spring onions, finely sliced","1 tbsp soy sauce","1 egg","3 tbsp teriyaki sauce","Sesame seeds","Brown rice to serve"],
     steps:["Mix pork, ginger, garlic, spring onion, soy and egg. Roll into 16 balls.","Air-fry at 200Â°C for 12 mins, shaking halfway, until cooked through.","Brush generously with teriyaki sauce. Air-fry 2 more mins until sticky.","Serve over brown rice. Scatter sesame seeds."]},
    {name:"Sausage & White Bean Bake",desc:"Italian sausage with white beans, kale and tomatoes in one pan.",emoji:"ğŸ«˜",cals:451,protein:"27g",carbs:"30g",fat:"18g",tags:["ğŸ¥£ Prep Ahead"],time:"35 mins",serves:"3",
     ingredients:["6 Italian-style chicken sausages","2 tins white beans (cannellini), drained","200g kale, shredded","400g tin chopped tomatoes","1 onion, diced","3 garlic cloves","1 tsp dried rosemary","Olive oil, salt and pepper"],
     steps:["Brown sausages in olive oil in an oven-safe pan. Remove and slice.","Fry onion and garlic 4 mins. Add tomatoes, beans and rosemary. Simmer 10 mins.","Stir in kale, return sausages. Bake at 180Â°C for 15 mins.","Serve in deep bowls with crusty bread."]},
    {name:"Pizza Chicken",desc:"Chicken breast topped with marinara, mozzarella and basil. 50g protein.",emoji:"ğŸ•",cals:439,protein:"50g",carbs:"8g",fat:"18g",tags:["ğŸ’ª High Protein","ğŸ¥— Low Carb","âš¡ Quick"],time:"25 mins",serves:"2",
     ingredients:["2 large chicken breasts","4 tbsp marinara or tomato sauce","80g fresh mozzarella, sliced","1 tsp dried Italian herbs","1 tbsp olive oil","Fresh basil","Salt and pepper"],
     steps:["Preheat oven 200Â°C. Pound chicken to even thickness. Season.","Sear in olive oil 3 mins each side until golden.","Place on baking tray. Spoon sauce on each, top with mozzarella and herbs.","Bake 12â€“15 mins until cheese bubbles. Top with fresh basil."]},
    {name:"Balsamic Pork with Mediterranean Veg",desc:"Pork loin with balsamic, roasted with courgette, peppers and cherry tomatoes.",emoji:"ğŸ¥©",cals:380,protein:"32g",carbs:"16g",fat:"14g",tags:["ğŸ’ª High Protein","ğŸŒ¿ Mediterranean"],time:"40 mins",serves:"2",
     ingredients:["2 pork loin steaks","3 tbsp balsamic vinegar","1 courgette, sliced","2 mixed peppers, sliced","150g cherry tomatoes","2 garlic cloves","2 tbsp olive oil","1 tsp dried rosemary","Salt and pepper"],
     steps:["Marinate pork in balsamic, garlic, olive oil and rosemary for 20 mins.","Toss veg in remaining marinade on a roasting tray. Roast at 200Â°C for 20 mins.","Pan-sear pork 4 mins each side until cooked through.","Rest pork 5 mins. Slice and serve over the roasted veg."]}
  ]},

  {meal:"Snacks",ideas:[
    {name:"Apple & Nut Butter",desc:"Apple slices with a tablespoon of almond or peanut butter.",emoji:"ğŸ",cals:180,protein:"4g",carbs:"24g",fat:"9g",tags:["ğŸŒ± Plant-Based"],time:"2 mins",serves:"1",
     ingredients:["1 apple, sliced","1 tbsp almond or peanut butter"],
     steps:["Slice apple and arrange on a plate.","Serve with nut butter for dipping."]},
    {name:"Hummus & Veg",desc:"Carrot, cucumber and pepper sticks with hummus.",emoji:"ğŸ¥•",cals:120,protein:"5g",carbs:"14g",fat:"5g",tags:["ğŸŒ± Plant-Based","ğŸ¥— Low Carb"],time:"5 mins",serves:"1",
     ingredients:["3 tbsp hummus","1 carrot, cut into sticks","Â½ cucumber, cut into sticks","Â½ pepper, cut into strips"],
     steps:["Cut all vegetables into sticks.","Arrange around a pot of hummus and dip."]},
    {name:"Mixed Nuts",desc:"A small handful of unsalted mixed nuts.",emoji:"ğŸ¥œ",cals:170,protein:"5g",carbs:"6g",fat:"15g",tags:["ğŸŒ± Plant-Based","ğŸ¥— Low Carb"],time:"1 min",serves:"1",
     ingredients:["30g unsalted mixed nuts (almonds, walnuts, cashews)"],
     steps:["Weigh out 30g nuts â€” roughly a small palmful.","Eat slowly and mindfully."]},
    {name:"Boiled Eggs",desc:"2 hard-boiled eggs with salt and pepper.",emoji:"ğŸ¥š",cals:140,protein:"12g",carbs:"1g",fat:"10g",tags:["ğŸ’ª High Protein","ğŸ¥— Low Carb"],time:"10 mins",serves:"1",
     ingredients:["2 eggs","Pinch of salt and pepper"],
     steps:["Place eggs in cold water. Bring to the boil.","Boil 8 mins for hard-boiled. Cool under cold water and peel.","Season with salt and pepper."]},
    {name:"Cottage Cheese & Pineapple",desc:"Cottage cheese with pineapple chunks. Sweet, filling, high protein.",emoji:"ğŸ",cals:160,protein:"14g",carbs:"18g",fat:"2g",tags:["ğŸ’ª High Protein"],time:"2 mins",serves:"1",
     ingredients:["150g low-fat cottage cheese","80g pineapple chunks (fresh or tinned in juice)"],
     steps:["Spoon cottage cheese into a bowl.","Top with pineapple chunks and serve."]},
    {name:"Greek Yogurt & Honey",desc:"Plain Greek yogurt with honey and cinnamon.",emoji:"ğŸ¯",cals:150,protein:"12g",carbs:"16g",fat:"4g",tags:["ğŸ’ª High Protein"],time:"2 mins",serves:"1",
     ingredients:["150g plain Greek yogurt","1 tsp honey","Pinch of cinnamon"],
     steps:["Spoon yogurt into a bowl.","Drizzle over honey and dust with cinnamon."]},
    {name:"Rice Cakes & Avocado",desc:"Two rice cakes topped with mashed avocado and chilli flakes.",emoji:"ğŸ¥‘",cals:200,protein:"4g",carbs:"24g",fat:"10g",tags:["ğŸŒ± Plant-Based"],time:"3 mins",serves:"1",
     ingredients:["2 plain rice cakes","Â½ ripe avocado","Juice of Â¼ lemon","Pinch of chilli flakes","Salt and pepper"],
     steps:["Mash avocado with lemon juice, salt and pepper.","Spread onto rice cakes.","Sprinkle with chilli flakes and serve."]},
    {name:"Protein Bar",desc:"A whole-food protein bar under 200 calories.",emoji:"ğŸ«",cals:190,protein:"15g",carbs:"20g",fat:"7g",tags:["ğŸ’ª High Protein","âš¡ Quick"],time:"0 mins",serves:"1",
     ingredients:["1 high-quality protein bar (e.g. KIND, RXBAR, Grenade, Fulfil)"],
     steps:["Choose a bar with at least 10g protein and under 200 calories.","Pair with water or a herbal tea."]}
  ]}
];

const RECIPES = [
  {name:"Recovery Porridge",time:"10 mins",serves:"1",difficulty:"Easy",emoji:"ğŸ¥£",cals:380,protein:"12g",carbs:"62g",fat:"8g",
   ingredients:["80g rolled oats","300ml oat or almond milk","1 banana, sliced","1 tbsp nut butter","Pinch of cinnamon","Drizzle of honey"],
   steps:["Cook oats in milk over medium heat, stirring for 5 minutes.","Pour into a bowl and top with banana slices.","Add a dollop of nut butter, a sprinkle of cinnamon and a drizzle of honey.","Serve immediately."]},
  {name:"Simple Lentil Soup",time:"30 mins",serves:"4",difficulty:"Easy",emoji:"ğŸ²",cals:280,protein:"16g",carbs:"44g",fat:"3g",
   ingredients:["250g red lentils","1 onion, diced","2 carrots, diced","2 garlic cloves","1 tsp cumin","1 tsp turmeric","1 litre vegetable stock","Salt & pepper"],
   steps:["Fry onion and garlic in a little oil for 5 minutes until soft.","Add carrots, cumin and turmeric â€” cook 2 more minutes.","Add lentils and stock. Bring to the boil then simmer 20 minutes.","Blend half the soup for a creamy texture. Season and serve."]},
  {name:"One-Pan Chicken & Veg",time:"35 mins",serves:"2",difficulty:"Easy",emoji:"ğŸ—",cals:490,protein:"45g",carbs:"32g",fat:"18g",
   ingredients:["2 chicken breasts","1 sweet potato, cubed","1 courgette, sliced","1 red pepper, sliced","2 tbsp olive oil","1 tsp paprika","Salt & pepper"],
   steps:["Preheat oven to 200Â°C / 180Â°C fan.","Toss all veg in oil, paprika, salt and pepper on a baking tray.","Place chicken breasts on top and season well.","Roast for 30-35 minutes until chicken is cooked through."]},
  {name:"Chickpea Curry",time:"25 mins",serves:"3",difficulty:"Easy",emoji:"ğŸ›",cals:460,protein:"18g",carbs:"68g",fat:"12g",
   ingredients:["2 tins chickpeas, drained","1 tin chopped tomatoes","1 tin coconut milk","1 onion, diced","2 garlic cloves","1 tsp garam masala","1 tsp cumin","1 tsp turmeric","Handful of spinach"],
   steps:["Fry onion and garlic until soft, about 5 minutes.","Add spices and cook for 1 minute, stirring constantly.","Add tomatoes, coconut milk and chickpeas. Simmer 15 minutes.","Stir in spinach until wilted. Serve with brown rice."]},
  {name:"Salmon & Sweet Potato",time:"40 mins",serves:"2",difficulty:"Easy",emoji:"ğŸŸ",cals:520,protein:"38g",carbs:"35g",fat:"22g",
   ingredients:["2 salmon fillets","2 sweet potatoes, cubed","200g tenderstem broccoli","2 tbsp olive oil","1 lemon","Salt & pepper","1 tsp garlic powder"],
   steps:["Preheat oven to 200Â°C. Toss sweet potato in oil, garlic powder and salt.","Roast sweet potato for 20 minutes.","Add salmon and broccoli to the tray. Squeeze over lemon juice.","Roast a further 15-18 minutes until salmon is cooked. Season and serve."]},
  {name:"Overnight Oats",time:"5 mins + overnight",serves:"1",difficulty:"Easy",emoji:"ğŸ¥£",cals:380,protein:"12g",carbs:"62g",fat:"8g",
   ingredients:["80g rolled oats","200ml almond milk","1 tbsp chia seeds","1 tbsp honey","1 tsp vanilla extract","Fruit and nuts to top"],
   steps:["Mix oats, milk, chia seeds, honey and vanilla in a jar or bowl.","Stir well, cover and refrigerate overnight.","In the morning, stir again and add your favourite toppings.","Eat cold straight from the jar â€” no cooking needed."]},
  {name:"Greek Chicken Bowl",time:"30 mins",serves:"4",difficulty:"Easy",emoji:"ğŸ¥—",cals:473,protein:"35g",carbs:"9g",fat:"33g",
   tags:["ğŸ’ª High Protein","ğŸ¥— Low Carb","ğŸŒ¿ Gluten-Free"],
   ingredients:["455g chicken breast, cut into cubes","3 tbsp olive oil","2 tbsp lemon juice","1 tbsp red wine vinegar","1 tbsp Greek seasoning","Â¼ tsp sea salt","224g full-fat Greek yoghurt","Â½ cucumber, grated","2 cloves garlic, grated","Zest & juice of 1 lemon","2 tbsp fresh dill, minced","1 large cucumber, diced","200g cherry tomatoes, halved","Â½ red onion, thinly sliced","80g Kalamata olives","115g feta cheese, crumbled","3 tbsp olive oil (for dressing)","1 tbsp red wine vinegar (for dressing)","1 tsp fresh oregano"],
   steps:["Combine chicken, olive oil, lemon juice, vinegar, Greek seasoning and salt. Marinate in the fridge for at least 30 minutes.","Make the tzatziki: mix yoghurt, grated cucumber, garlic, lemon zest, lemon juice, dill, salt and pepper. Refrigerate.","Heat a frying pan over medium-high heat. Cook chicken and marinade for 3-4 minutes each side until cooked through.","Make dressing: whisk together olive oil, red wine vinegar, oregano and salt.","Divide chicken into bowls. Top with cucumber, tomatoes, red onion, olives and feta. Drizzle dressing over and top with tzatziki to serve."]},
  {name:"Farro & Blackened Salmon Salad",time:"40 mins",serves:"2",difficulty:"Medium",emoji:"ğŸŸ",cals:510,protein:"40g",carbs:"48g",fat:"16g",
   tags:["ğŸ’ª High Protein","ğŸŒ¿ Gluten-Free","ğŸ¥— Macro-Friendly"],
   source:"lillieeatsandtells.com",
   ingredients:["2 x 150g salmon fillets","100g farro (dry)","1 large sweet potato","2 large handfuls rocket / arugula","1 corn on the cob","100g cherry tomatoes, halved","Â½ avocado, sliced","Small bunch fresh basil","1 jalapeÃ±o","100g Greek yogurt","Juice of 1 lemon","1 tbsp blackening seasoning (paprika, cayenne, garlic, oregano)","Salt & pepper"],
   steps:["Cook farro according to packet (usually 25-30 mins). Bake sweet potato at 200Â°C for 35-40 mins then dice.","Make dressing: blend Greek yogurt, jalapeÃ±o, lemon juice, salt and a splash of water until smooth.","Coat salmon in blackening spice. Cook in a hot dry pan 3-4 mins each side.","Char corn in the same pan until golden, then slice off the cob.","Build bowls: rocket, farro, sweet potato, corn, tomatoes, basil. Top with salmon and avocado. Drizzle dressing over."]},
  {name:"Roasted Tomato Chicken Sandwich",time:"45 mins",serves:"2",difficulty:"Medium",emoji:"ğŸ¥ª",cals:430,protein:"38g",carbs:"34g",fat:"14g",
   tags:["ğŸ’ª High Protein","âš¡ Meal Prep Friendly","ğŸ¥— Macro-Friendly"],
   source:"lillieeatsandtells.com",
   ingredients:["2 x 150g chicken breasts","2 wholegrain buns","300g tomatoes on the vine, halved","Small bunch fresh basil","1 tbsp light mayo","1 garlic clove, minced","1 onion, thinly sliced","4 rashers lean back bacon","60g reduced fat mozzarella","2 handfuls rocket / arugula","Olive oil, salt & pepper"],
   steps:["Roast tomatoes: place cut-side up on a tray with olive oil and salt at 180Â°C for 30 mins until caramelised.","Caramelise onions in a pan with a little oil over low heat for 20 mins, stirring occasionally.","Make basil aioli: blend mayo, basil, garlic and a squeeze of lemon. Season to taste.","Grill chicken breasts until cooked through. Grill bacon until crispy.","Toast buns. Spread basil aioli on each half. Layer with rocket, chicken, bacon, caramelised onion, roasted tomatoes and mozzarella."]}
];

const NUTRITION_TIPS = [
  {title:"Blood Sugar & Cravings",emoji:"ğŸ©¸",tip:"Early recovery often brings intense sugar cravings as your brain seeks dopamine. Eating regular meals with protein, healthy fats and complex carbs helps keep blood sugar stable and reduces cravings significantly."},
  {title:"Protein for Brain Repair",emoji:"ğŸ§ ",tip:"Protein contains amino acids like tyrosine and tryptophan which your brain uses to produce dopamine and serotonin â€” the same neurotransmitters affected by addiction. Aim for protein at every meal: eggs, chicken, fish, lentils, Greek yogurt."},
  {title:"Hydration is Everything",emoji:"ğŸ’§",tip:"Many people in early recovery are chronically dehydrated. Aim for 6-8 glasses of water a day. Dehydration mimics hunger and can worsen anxiety, fatigue and mood swings. Keep a bottle with you always."},
  {title:"B Vitamins for Energy",emoji:"âš¡",tip:"Substance use depletes B vitamins â€” especially B1, B6 and B12 â€” which are crucial for energy and nervous system health. Eat eggs, leafy greens, wholegrains, fish and consider a B-complex supplement."},
  {title:"Omega-3 for Mood",emoji:"ğŸŸ",tip:"Omega-3 fatty acids support brain health and have been shown to reduce depression and anxiety. Eat oily fish (salmon, mackerel, sardines) 2-3 times a week or consider a fish oil supplement."},
  {title:"Eat Regularly â€” Don't Skip",emoji:"ğŸ½",tip:"Skipping meals can trigger irritability, poor decision-making and cravings. Three meals and two snacks a day helps keep your mood and energy stable. Your brain needs a steady supply of glucose."},
  {title:"Gut Health & Mental Health",emoji:"ğŸŒ¿",tip:"Your gut produces around 90% of your serotonin. A healthy gut microbiome supports mood, reduces anxiety and improves sleep. Eat probiotic foods like yogurt, kefir and fermented veg, and plenty of fibre."},
  {title:"Magnesium for Sleep & Calm",emoji:"ğŸ˜´",tip:"Magnesium helps regulate the nervous system and is often depleted in addiction. It can improve sleep quality and reduce anxiety. Good sources: dark leafy greens, nuts, seeds, dark chocolate and bananas."},
  {title:"Limit Caffeine & Sugar",emoji:"â˜•",tip:"High caffeine and sugar intake can worsen anxiety and disrupt sleep â€” both key relapse triggers. If you're drinking lots of energy drinks or coffee, try cutting back gradually and notice the difference in your mood."},
  {title:"Cook for Yourself",emoji:"ğŸ‘¨â€ğŸ³",tip:"Learning to prepare simple, healthy meals is a powerful act of self-care. It builds routine, saves money and gives you something to focus on. Start with just one new recipe a week â€” it adds up."}
];

const PLANNER_DAYS = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];
let mealPlan = JSON.parse(localStorage.getItem('na_meal_plan')||'{}');

function switchMovementTab(tab){
  ['yoga','meditation','soundbath','breathwork'].forEach(t=>{
    document.getElementById('mvtab-'+t).style.display = t===tab?'block':'none';
    const btn = document.getElementById('mvtab-btn-'+t);
    btn.style.background = t===tab ? 'var(--accent)' : 'transparent';
    btn.style.color = t===tab ? '#1a1208' : 'var(--text-muted)';
  });
}
// SHOPPING LIST & PROGRESS DATA
let shoppingList = JSON.parse(localStorage.getItem('na_shopping')||'[]');
let defaultPortions = parseInt(localStorage.getItem('na_portions')||'4');
let foodLog = JSON.parse(localStorage.getItem('na_food_log')||'{}');

// INGREDIENT MAP - maps meal names to ingredients with categories
const MEAL_INGREDIENTS = {
  "Overnight Oats":        [{item:"Rolled oats",qty:"80g",cat:"ğŸ¥£ Dry Goods"},{item:"Almond or oat milk",qty:"300ml",cat:"ğŸ¥› Dairy & Alternatives"},{item:"Banana",qty:"1",cat:"ğŸ¥¦ Fresh Produce"},{item:"Honey",qty:"1 tbsp",cat:"ğŸ¥£ Dry Goods"},{item:"Nut butter",qty:"1 tbsp",cat:"ğŸ¥£ Dry Goods"}],
  "Eggs & Avocado Toast":  [{item:"Eggs",qty:"2",cat:"ğŸ¥› Dairy & Alternatives"},{item:"Wholegrain bread",qty:"2 slices",cat:"ğŸ¥£ Dry Goods"},{item:"Avocado",qty:"1",cat:"ğŸ¥¦ Fresh Produce"},{item:"Chilli flakes",qty:"pinch",cat:"ğŸ§‚ Condiments"}],
  "Greek Yogurt Bowl":     [{item:"Greek yogurt",qty:"200g",cat:"ğŸ¥› Dairy & Alternatives"},{item:"Mixed berries",qty:"80g",cat:"ğŸ¥¦ Fresh Produce"},{item:"Granola",qty:"40g",cat:"ğŸ¥£ Dry Goods"},{item:"Honey",qty:"1 tsp",cat:"ğŸ¥£ Dry Goods"}],
  "Smoothie Bowl":         [{item:"Frozen banana",qty:"2",cat:"â„ï¸ Frozen"},{item:"Spinach",qty:"1 handful",cat:"ğŸ¥¦ Fresh Produce"},{item:"Almond milk",qty:"150ml",cat:"ğŸ¥› Dairy & Alternatives"},{item:"Mixed seeds",qty:"2 tbsp",cat:"ğŸ¥£ Dry Goods"},{item:"Nut butter",qty:"1 tbsp",cat:"ğŸ¥£ Dry Goods"}],
  "Chicken & Veg Wrap":    [{item:"Chicken breast",qty:"150g",cat:"ğŸ¥© Meat & Fish"},{item:"Wholemeal wraps",qty:"1",cat:"ğŸ¥£ Dry Goods"},{item:"Mixed salad leaves",qty:"1 handful",cat:"ğŸ¥¦ Fresh Produce"},{item:"Cucumber",qty:"Â¼",cat:"ğŸ¥¦ Fresh Produce"},{item:"Tomatoes",qty:"1",cat:"ğŸ¥¦ Fresh Produce"},{item:"Hummus",qty:"2 tbsp",cat:"ğŸ¥› Dairy & Alternatives"}],
  "Lentil Soup":           [{item:"Red lentils",qty:"250g",cat:"ğŸ¥£ Dry Goods"},{item:"Onion",qty:"1",cat:"ğŸ¥¦ Fresh Produce"},{item:"Carrots",qty:"2",cat:"ğŸ¥¦ Fresh Produce"},{item:"Garlic",qty:"2 cloves",cat:"ğŸ¥¦ Fresh Produce"},{item:"Cumin",qty:"1 tsp",cat:"ğŸ§‚ Condiments"},{item:"Turmeric",qty:"1 tsp",cat:"ğŸ§‚ Condiments"},{item:"Vegetable stock",qty:"1 litre",cat:"ğŸ¥£ Dry Goods"}],
  "Quinoa Salad":          [{item:"Quinoa",qty:"100g",cat:"ğŸ¥£ Dry Goods"},{item:"Sweet potato",qty:"1 large",cat:"ğŸ¥¦ Fresh Produce"},{item:"Tinned chickpeas",qty:"400g tin",cat:"ğŸ¥« Tins & Jars"},{item:"Feta cheese",qty:"80g",cat:"ğŸ¥› Dairy & Alternatives"},{item:"Lemon",qty:"1",cat:"ğŸ¥¦ Fresh Produce"},{item:"Tahini",qty:"2 tbsp",cat:"ğŸ¥£ Dry Goods"}],
  "Tuna Rice Bowl":        [{item:"Brown rice",qty:"80g dry",cat:"ğŸ¥£ Dry Goods"},{item:"Tinned tuna",qty:"1 tin (145g)",cat:"ğŸ¥« Tins & Jars"},{item:"Cucumber",qty:"Â½",cat:"ğŸ¥¦ Fresh Produce"},{item:"Edamame",qty:"80g",cat:"â„ï¸ Frozen"},{item:"Soy sauce",qty:"1 tbsp",cat:"ğŸ§‚ Condiments"},{item:"Sesame oil",qty:"1 tsp",cat:"ğŸ§‚ Condiments"}],
  "Salmon & Roasted Veg":  [{item:"Salmon fillets",qty:"2 x 150g",cat:"ğŸ¥© Meat & Fish"},{item:"Broccoli",qty:"200g",cat:"ğŸ¥¦ Fresh Produce"},{item:"Sweet potato",qty:"1 large",cat:"ğŸ¥¦ Fresh Produce"},{item:"Lemon",qty:"1",cat:"ğŸ¥¦ Fresh Produce"},{item:"Olive oil",qty:"2 tbsp",cat:"ğŸ§‚ Condiments"}],
  "Chicken Stir Fry":      [{item:"Chicken breast",qty:"300g",cat:"ğŸ¥© Meat & Fish"},{item:"Mixed peppers",qty:"2",cat:"ğŸ¥¦ Fresh Produce"},{item:"Pak choi",qty:"1 head",cat:"ğŸ¥¦ Fresh Produce"},{item:"Brown rice",qty:"160g dry",cat:"ğŸ¥£ Dry Goods"},{item:"Soy sauce",qty:"2 tbsp",cat:"ğŸ§‚ Condiments"},{item:"Fresh ginger",qty:"2cm piece",cat:"ğŸ¥¦ Fresh Produce"}],
  "Chickpea Curry":        [{item:"Tinned chickpeas",qty:"2 x 400g tins",cat:"ğŸ¥« Tins & Jars"},{item:"Tinned tomatoes",qty:"400g tin",cat:"ğŸ¥« Tins & Jars"},{item:"Coconut milk",qty:"400ml tin",cat:"ğŸ¥« Tins & Jars"},{item:"Onion",qty:"1",cat:"ğŸ¥¦ Fresh Produce"},{item:"Garlic",qty:"2 cloves",cat:"ğŸ¥¦ Fresh Produce"},{item:"Garam masala",qty:"1 tsp",cat:"ğŸ§‚ Condiments"},{item:"Spinach",qty:"100g",cat:"ğŸ¥¦ Fresh Produce"},{item:"Brown rice",qty:"200g dry",cat:"ğŸ¥£ Dry Goods"}],
  "Turkey Meatballs":      [{item:"Turkey mince",qty:"500g",cat:"ğŸ¥© Meat & Fish"},{item:"Courgette",qty:"2",cat:"ğŸ¥¦ Fresh Produce"},{item:"Tinned tomatoes",qty:"400g tin",cat:"ğŸ¥« Tins & Jars"},{item:"Fresh basil",qty:"1 bunch",cat:"ğŸ¥¦ Fresh Produce"},{item:"Garlic",qty:"3 cloves",cat:"ğŸ¥¦ Fresh Produce"}],
  "Greek Chicken Bowl":    [{item:"Chicken breast",qty:"455g",cat:"ğŸ¥© Meat & Fish"},{item:"Olive oil",qty:"6 tbsp",cat:"ğŸ§‚ Condiments"},{item:"Lemon",qty:"2",cat:"ğŸ¥¦ Fresh Produce"},{item:"Red wine vinegar",qty:"2 tbsp",cat:"ğŸ§‚ Condiments"},{item:"Greek seasoning",qty:"1 tbsp",cat:"ğŸ§‚ Condiments"},{item:"Full-fat Greek yoghurt",qty:"224g",cat:"ğŸ¥› Dairy & Alternatives"},{item:"Cucumber",qty:"2",cat:"ğŸ¥¦ Fresh Produce"},{item:"Garlic",qty:"3 cloves",cat:"ğŸ¥¦ Fresh Produce"},{item:"Fresh dill",qty:"1 small bunch",cat:"ğŸ¥¦ Fresh Produce"},{item:"Cherry tomatoes",qty:"200g",cat:"ğŸ¥¦ Fresh Produce"},{item:"Red onion",qty:"Â½",cat:"ğŸ¥¦ Fresh Produce"},{item:"Kalamata olives",qty:"80g",cat:"ğŸ¥« Tins & Jars"},{item:"Feta cheese",qty:"115g",cat:"ğŸ¥› Dairy & Alternatives"},{item:"Fresh oregano",qty:"1 tsp",cat:"ğŸ§‚ Condiments"}],
  "Apple & Nut Butter":    [{item:"Apple",qty:"1",cat:"ğŸ¥¦ Fresh Produce"},{item:"Nut butter",qty:"1 tbsp",cat:"ğŸ¥£ Dry Goods"}],
  "Hummus & Veg":          [{item:"Hummus",qty:"80g",cat:"ğŸ¥› Dairy & Alternatives"},{item:"Carrots",qty:"2",cat:"ğŸ¥¦ Fresh Produce"},{item:"Cucumber",qty:"Â½",cat:"ğŸ¥¦ Fresh Produce"},{item:"Mixed peppers",qty:"1",cat:"ğŸ¥¦ Fresh Produce"}],
  "Mixed Nuts":            [{item:"Mixed unsalted nuts",qty:"30g",cat:"ğŸ¥£ Dry Goods"}],
  "Boiled Eggs":           [{item:"Eggs",qty:"2",cat:"ğŸ¥› Dairy & Alternatives"}],
  "Recovery Porridge":     [{item:"Rolled oats",qty:"80g",cat:"ğŸ¥£ Dry Goods"},{item:"Oat or almond milk",qty:"300ml",cat:"ğŸ¥› Dairy & Alternatives"},{item:"Banana",qty:"1",cat:"ğŸ¥¦ Fresh Produce"},{item:"Nut butter",qty:"1 tbsp",cat:"ğŸ¥£ Dry Goods"},{item:"Cinnamon",qty:"Â½ tsp",cat:"ğŸ§‚ Condiments"},{item:"Honey",qty:"1 tbsp",cat:"ğŸ¥£ Dry Goods"}],
  "Simple Lentil Soup":    [{item:"Red lentils",qty:"250g",cat:"ğŸ¥£ Dry Goods"},{item:"Onion",qty:"1",cat:"ğŸ¥¦ Fresh Produce"},{item:"Carrots",qty:"2",cat:"ğŸ¥¦ Fresh Produce"},{item:"Garlic",qty:"2 cloves",cat:"ğŸ¥¦ Fresh Produce"},{item:"Cumin",qty:"1 tsp",cat:"ğŸ§‚ Condiments"},{item:"Turmeric",qty:"1 tsp",cat:"ğŸ§‚ Condiments"},{item:"Vegetable stock",qty:"1 litre",cat:"ğŸ¥£ Dry Goods"}],
  "One-Pan Chicken & Veg": [{item:"Chicken breasts",qty:"2 x 200g",cat:"ğŸ¥© Meat & Fish"},{item:"Sweet potato",qty:"1 large",cat:"ğŸ¥¦ Fresh Produce"},{item:"Courgette",qty:"1",cat:"ğŸ¥¦ Fresh Produce"},{item:"Red pepper",qty:"1",cat:"ğŸ¥¦ Fresh Produce"},{item:"Olive oil",qty:"2 tbsp",cat:"ğŸ§‚ Condiments"},{item:"Paprika",qty:"1 tsp",cat:"ğŸ§‚ Condiments"}],
  "Salmon & Sweet Potato": [{item:"Salmon fillets",qty:"2 x 150g",cat:"ğŸ¥© Meat & Fish"},{item:"Sweet potatoes",qty:"2",cat:"ğŸ¥¦ Fresh Produce"},{item:"Tenderstem broccoli",qty:"200g",cat:"ğŸ¥¦ Fresh Produce"},{item:"Olive oil",qty:"2 tbsp",cat:"ğŸ§‚ Condiments"},{item:"Lemon",qty:"1",cat:"ğŸ¥¦ Fresh Produce"},{item:"Garlic powder",qty:"1 tsp",cat:"ğŸ§‚ Condiments"}],
  "Farro & Blackened Salmon Salad": [{item:"Salmon fillet",qty:"150g",cat:"ğŸ¥© Meat & Fish"},{item:"Farro",qty:"100g dry",cat:"ğŸ¥£ Dry Goods"},{item:"Sweet potato",qty:"1",cat:"ğŸ¥¦ Fresh Produce"},{item:"Arugula / rocket",qty:"2 large handfuls",cat:"ğŸ¥¦ Fresh Produce"},{item:"Corn on the cob",qty:"1",cat:"ğŸ¥¦ Fresh Produce"},{item:"Cherry tomatoes",qty:"100g",cat:"ğŸ¥¦ Fresh Produce"},{item:"Avocado",qty:"Â½",cat:"ğŸ¥¦ Fresh Produce"},{item:"Fresh basil",qty:"small bunch",cat:"ğŸ¥¦ Fresh Produce"},{item:"JalapeÃ±o",qty:"1",cat:"ğŸ¥¦ Fresh Produce"},{item:"Greek yogurt",qty:"100g",cat:"ğŸ¥› Dairy & Alternatives"},{item:"Lemon",qty:"1",cat:"ğŸ¥¦ Fresh Produce"}],
  "Roasted Tomato Chicken Sandwich": [{item:"Chicken breast",qty:"150g",cat:"ğŸ¥© Meat & Fish"},{item:"Wholegrain bun",qty:"1",cat:"ğŸ¥£ Dry Goods"},{item:"Tomatoes on the vine",qty:"200g",cat:"ğŸ¥¦ Fresh Produce"},{item:"Fresh basil",qty:"small bunch",cat:"ğŸ¥¦ Fresh Produce"},{item:"Light mayo",qty:"1 tbsp",cat:"ğŸ§‚ Condiments"},{item:"Garlic",qty:"1 clove",cat:"ğŸ¥¦ Fresh Produce"},{item:"Onion",qty:"1",cat:"ğŸ¥¦ Fresh Produce"},{item:"Back bacon (lean)",qty:"2 rashers",cat:"ğŸ¥© Meat & Fish"},{item:"Reduced fat mozzarella",qty:"30g",cat:"ğŸ¥› Dairy & Alternatives"},{item:"Rocket / arugula",qty:"1 handful",cat:"ğŸ¥¦ Fresh Produce"}],
  "Moroccan Sheet-pan Chicken":    [{item:"Chicken thighs (bone-in)",qty:"600g",cat:"ğŸ¥© Meat & Fish"},{item:"Mixed peppers",qty:"3",cat:"ğŸ¥¦ Fresh Produce"},{item:"Red onion",qty:"1",cat:"ğŸ¥¦ Fresh Produce"},{item:"Harissa paste",qty:"2 tbsp",cat:"ğŸ§‚ Condiments"},{item:"Cumin",qty:"1 tsp",cat:"ğŸ§‚ Condiments"},{item:"Coriander (ground)",qty:"1 tsp",cat:"ğŸ§‚ Condiments"},{item:"Olive oil",qty:"2 tbsp",cat:"ğŸ§‚ Condiments"},{item:"Lemon",qty:"1",cat:"ğŸ¥¦ Fresh Produce"}],
  "Mexican Baked Sweet Potato":    [{item:"Sweet potatoes",qty:"2 large",cat:"ğŸ¥¦ Fresh Produce"},{item:"Tinned black beans",qty:"400g tin",cat:"ğŸ¥« Tins & Jars"},{item:"Avocado",qty:"1",cat:"ğŸ¥¦ Fresh Produce"},{item:"Cherry tomatoes",qty:"150g",cat:"ğŸ¥¦ Fresh Produce"},{item:"Greek yogurt",qty:"100g",cat:"ğŸ¥› Dairy & Alternatives"},{item:"Lime",qty:"1",cat:"ğŸ¥¦ Fresh Produce"},{item:"Cumin",qty:"1 tsp",cat:"ğŸ§‚ Condiments"},{item:"Smoked paprika",qty:"1 tsp",cat:"ğŸ§‚ Condiments"}],
  "Creamy Mushroom Pasta":         [{item:"Pasta (any short shape)",qty:"300g",cat:"ğŸ¥£ Dry Goods"},{item:"Chestnut mushrooms",qty:"400g",cat:"ğŸ¥¦ Fresh Produce"},{item:"Garlic",qty:"3 cloves",cat:"ğŸ¥¦ Fresh Produce"},{item:"Vegetable stock",qty:"500ml",cat:"ğŸ¥£ Dry Goods"},{item:"Light cream cheese",qty:"100g",cat:"ğŸ¥› Dairy & Alternatives"},{item:"Parmesan",qty:"30g",cat:"ğŸ¥› Dairy & Alternatives"},{item:"Fresh thyme",qty:"few sprigs",cat:"ğŸ¥¦ Fresh Produce"}],
  "Sweet Potato Skillet Hash":     [{item:"Sweet potato",qty:"2 medium",cat:"ğŸ¥¦ Fresh Produce"},{item:"Eggs",qty:"4",cat:"ğŸ¥› Dairy & Alternatives"},{item:"Mixed peppers",qty:"2",cat:"ğŸ¥¦ Fresh Produce"},{item:"Onion",qty:"1",cat:"ğŸ¥¦ Fresh Produce"},{item:"Smoked paprika",qty:"1 tsp",cat:"ğŸ§‚ Condiments"},{item:"Olive oil",qty:"2 tbsp",cat:"ğŸ§‚ Condiments"}],
  "Honey Turmeric Chicken Tray":   [{item:"Chicken drumsticks",qty:"600g",cat:"ğŸ¥© Meat & Fish"},{item:"Sweet potato",qty:"2",cat:"ğŸ¥¦ Fresh Produce"},{item:"Broccoli",qty:"200g",cat:"ğŸ¥¦ Fresh Produce"},{item:"Honey",qty:"2 tbsp",cat:"ğŸ¥£ Dry Goods"},{item:"Turmeric",qty:"1 tsp",cat:"ğŸ§‚ Condiments"},{item:"Garlic",qty:"2 cloves",cat:"ğŸ¥¦ Fresh Produce"},{item:"Olive oil",qty:"2 tbsp",cat:"ğŸ§‚ Condiments"},{item:"Soy sauce",qty:"1 tbsp",cat:"ğŸ§‚ Condiments"}]
};

// MEAL SWAPS - multiple tagged options per meal
const MEAL_SWAPS = {
  "Overnight Oats":        [{name:"Greek Yogurt Bowl",tag:"ğŸ¥— Similar Cals",cals:350},{name:"Eggs & Avocado Toast",tag:"ğŸ’ª Higher Protein",cals:420},{name:"Smoothie Bowl",tag:"ğŸŒ± Plant-Based",cals:400}],
  "Eggs & Avocado Toast":  [{name:"Overnight Oats",tag:"ğŸ¥— Lower Cal",cals:380},{name:"Greek Yogurt Bowl",tag:"âš¡ Quicker",cals:350},{name:"Smoothie Bowl",tag:"ğŸŒ± Plant-Based",cals:400}],
  "Greek Yogurt Bowl":     [{name:"Overnight Oats",tag:"ğŸ¥£ Prep Ahead",cals:380},{name:"Smoothie Bowl",tag:"ğŸŒ± Plant-Based",cals:400},{name:"Eggs & Avocado Toast",tag:"ğŸ’ª Higher Protein",cals:420}],
  "Smoothie Bowl":         [{name:"Overnight Oats",tag:"ğŸ¥— Similar Cals",cals:380},{name:"Greek Yogurt Bowl",tag:"ğŸ’ª Higher Protein",cals:350},{name:"Eggs & Avocado Toast",tag:"âš¡ Quick",cals:420}],
  "Chicken & Veg Wrap":    [{name:"Tuna Rice Bowl",tag:"ğŸ¥— Similar Cals",cals:420},{name:"Greek Chicken Bowl",tag:"ğŸ’ª Higher Protein",cals:473},{name:"Quinoa Salad",tag:"ğŸŒ± Veggie Option",cals:480}],
  "Lentil Soup":           [{name:"Quinoa Salad",tag:"ğŸŒ± Also Veggie",cals:480},{name:"Chickpea Curry",tag:"âš¡ Similar",cals:460},{name:"Tuna Rice Bowl",tag:"ğŸ’ª Higher Protein",cals:420}],
  "Quinoa Salad":          [{name:"Chickpea Curry",tag:"ğŸŒ± Also Veggie",cals:460},{name:"Lentil Soup",tag:"ğŸ¥— Lower Cal",cals:280},{name:"Greek Chicken Bowl",tag:"ğŸ’ª Higher Protein",cals:473}],
  "Tuna Rice Bowl":        [{name:"Chicken & Veg Wrap",tag:"ğŸ¥— Similar Cals",cals:450},{name:"Greek Chicken Bowl",tag:"ğŸ’ª Higher Protein",cals:473},{name:"Quinoa Salad",tag:"ğŸŒ± Veggie Option",cals:480}],
  "Salmon & Roasted Veg":  [{name:"Chicken Stir Fry",tag:"ğŸ¥— Lower Cal",cals:480},{name:"Greek Chicken Bowl",tag:"âš¡ Quicker",cals:473},{name:"Turkey Meatballs",tag:"ğŸ¥— Lower Carb",cals:390}],
  "Chicken Stir Fry":      [{name:"Salmon & Roasted Veg",tag:"ğŸ’ª More Omega-3",cals:520},{name:"Turkey Meatballs",tag:"ğŸ¥— Lower Carb",cals:390},{name:"Greek Chicken Bowl",tag:"ğŸŒ¿ Mediterranean",cals:473}],
  "Chickpea Curry":        [{name:"Lentil Soup",tag:"ğŸ¥— Lower Cal",cals:280},{name:"Quinoa Salad",tag:"ğŸŒ± Also Veggie",cals:480},{name:"Turkey Meatballs",tag:"ğŸ’ª Higher Protein",cals:390}],
  "Turkey Meatballs":      [{name:"Salmon & Roasted Veg",tag:"ğŸ’ª More Omega-3",cals:520},{name:"Chicken Stir Fry",tag:"ğŸ¥— Similar Cals",cals:480},{name:"Greek Chicken Bowl",tag:"ğŸŒ¿ Mediterranean",cals:473}],
  "Greek Chicken Bowl":    [{name:"Chicken & Veg Wrap",tag:"âš¡ Quicker",cals:450},{name:"Salmon & Roasted Veg",tag:"ğŸ’ª More Omega-3",cals:520},{name:"Quinoa Salad",tag:"ğŸŒ± Veggie Option",cals:480}],
  "Apple & Nut Butter":    [{name:"Boiled Eggs",tag:"ğŸ’ª Higher Protein",cals:140},{name:"Hummus & Veg",tag:"ğŸ¥— Lower Cal",cals:120},{name:"Mixed Nuts",tag:"âš¡ No Prep",cals:170}],
  "Hummus & Veg":          [{name:"Mixed Nuts",tag:"âš¡ No Prep",cals:170},{name:"Apple & Nut Butter",tag:"ğŸ More Filling",cals:180},{name:"Boiled Eggs",tag:"ğŸ’ª Higher Protein",cals:140}],
  "Mixed Nuts":            [{name:"Apple & Nut Butter",tag:"ğŸ More Filling",cals:180},{name:"Hummus & Veg",tag:"ğŸ¥— Lower Cal",cals:120},{name:"Boiled Eggs",tag:"ğŸ’ª Higher Protein",cals:140}],
  "Boiled Eggs":           [{name:"Hummus & Veg",tag:"ğŸŒ± Plant-Based",cals:120},{name:"Apple & Nut Butter",tag:"ğŸ More Filling",cals:180},{name:"Mixed Nuts",tag:"âš¡ No Prep",cals:170}]
};

function setPortions(n) {
  defaultPortions = n;
  localStorage.setItem('na_portions', n);
  [1,2,4,6].forEach(v => {
    const btn = document.getElementById('p'+v);
    if(btn) { btn.style.background = v===n ? 'var(--accent)' : 'transparent'; btn.style.color = v===n ? '#1a1208' : 'var(--text-muted)'; }
  });
  showToast('Portions set to ' + n);
}

function addMealToPlanner(mealName, mealType) {
  const days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
  const today = days[new Date().getDay()];
  if(!mealPlan[today]) mealPlan[today] = {};
  mealPlan[today][mealType] = mealName;
  localStorage.setItem('na_meal_plan', JSON.stringify(mealPlan));
  addIngredientsToList(mealName, defaultPortions);
  showToast('Added to ' + today + ' Â· ' + defaultPortions + ' portions âœ“');
}

function parseFraction(str) {
  // Safe fraction parser - no eval()
  if(str.includes('/')) {
    const parts = str.split('/');
    return parseFloat(parts[0]) / parseFloat(parts[1]);
  }
  return parseFloat(str);
}

function scaleQty(qty, portions, basePortions) {
  if(!qty) return '';
  try {
    const match = qty.match(/^([\d.\/]+)\s*(.*)/);
    if(match) {
      const num = parseFraction(match[1]);
      const unit = match[2];
      const scaled = (num / basePortions) * portions;
      const rounded = scaled < 1 ? Math.round(scaled*10)/10 : Math.ceil(scaled);
      return rounded + (unit ? ' ' + unit : '');
    }
  } catch(e) {}
  return qty;
}

function addIngredientsToList(mealName, portions) {
  portions = portions || defaultPortions;
  const ingredients = MEAL_INGREDIENTS[mealName] || [];
  // Find base serves for this meal
  let baseServes = 1;
  RECIPES.forEach(r => { if(r.name === mealName) baseServes = parseInt(r.serves)||1; });
  ingredients.forEach(ing => {
    const scaledQty = scaleQty(ing.qty, portions, baseServes);
    const displayItem = ing.qty ? `${ing.item} â€” ${scaledQty}` : ing.item;
    const existing = shoppingList.find(i => i.item.toLowerCase() === ing.item.toLowerCase());
    if(!existing) {
      shoppingList.push({item: ing.item, qty: scaledQty, displayItem, cat: ing.cat, checked: false, id: Date.now()+Math.random()});
    }
  });
  localStorage.setItem('na_shopping', JSON.stringify(shoppingList));
}

function swapMeal(mealName, mealType) {
  const options = MEAL_SWAPS[mealName] || [];
  if(!options.length){ showToast('No swaps available'); return; }
  // Remove any existing swap panel
  const existing = document.getElementById('swap-panel');
  if(existing) existing.remove();
  // Find the meal card to insert below
  const cards = document.querySelectorAll('#daily-meals-container .meal-swap-anchor');
  // Build inline panel
  const panel = document.createElement('div');
  panel.id = 'swap-panel';
  panel.style.cssText = 'background:var(--surface);border:1px solid var(--accent);border-radius:14px;padding:14px;margin:8px 0 4px;';
  panel.innerHTML = `
    <div style="font-size:.78rem;font-weight:700;color:var(--accent);margin-bottom:10px;">ğŸ”„ Swap options for <em>${mealName}</em></div>
    ${options.map(opt=>`
      <div onclick="confirmSwap('${mealName}','${mealType}','${opt.name.replace(/'/g,"\'")}');document.getElementById('swap-panel').remove();"
           style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:var(--surface2);border-radius:10px;margin-bottom:7px;cursor:pointer;border:1px solid var(--border);">
        <div>
          <div style="font-size:.84rem;font-weight:600;color:var(--text);">${opt.name}</div>
          <div style="font-size:.72rem;color:var(--text-muted);margin-top:2px;">${opt.tag}</div>
        </div>
        <div style="text-align:right;">
          <div style="font-size:.78rem;color:var(--accent);font-weight:700;">ğŸ”¥ ${opt.cals} kcal</div>
          <div style="font-size:.68rem;color:var(--text-muted);">Tap to swap</div>
        </div>
      </div>`).join('')}
    <button onclick="document.getElementById('swap-panel').remove()" style="width:100%;padding:8px;border:1px solid var(--border);border-radius:8px;background:transparent;color:var(--text-muted);font-size:.78rem;cursor:pointer;margin-top:4px;">Cancel</button>`;
  // Insert after the meal card that was tapped
  const container = document.getElementById('daily-meals-container');
  if(container) container.appendChild(panel);
  panel.scrollIntoView({behavior:'smooth',block:'nearest'});
}

function confirmSwap(oldName, mealType, newName) {
  showToast('Swapped to ' + newName + ' ğŸ”„');
  renderDailyMeals();
}

function renderShoppingList() {
  const c = document.getElementById('shopping-list-container');
  if(!c) return;
  if(!shoppingList.length) {
    c.innerHTML = '<div class="card" style="text-align:center;padding:30px;color:var(--text-muted);font-size:.85rem;">Your shopping list is empty.<br><br>Add meals from the <b style="color:var(--accent);">ğŸ½ Meals</b> tab or build your <b style="color:var(--accent);">ğŸ“‹ Planner</b> and tap Save.</div>';
    return;
  }
  // Group by category
  const cats = {};
  shoppingList.forEach(item => {
    if(!cats[item.cat]) cats[item.cat] = [];
    cats[item.cat].push(item);
  });
  const catOrder = ['ğŸ¥© Meat & Fish','ğŸ¥¦ Fresh Produce','ğŸ¥› Dairy & Alternatives','ğŸ¥« Tins & Jars','â„ï¸ Frozen','ğŸ¥£ Dry Goods','ğŸ§‚ Condiments'];
  const sorted = [...catOrder.filter(c => cats[c]), ...Object.keys(cats).filter(c => !catOrder.includes(c))];
  
  c.innerHTML = sorted.map(cat => `
    <div class="card" style="margin-bottom:10px;">
      <div style="font-weight:700;font-size:.82rem;color:var(--accent);margin-bottom:8px;">${cat}</div>
      ${cats[cat].map(item => `
        <div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border);" id="shopitem-${item.id}">
          <div onclick="toggleShopItem('${item.id}')" style="width:22px;height:22px;border-radius:50%;border:2px solid ${item.checked?'var(--accent)':'var(--border)'};background:${item.checked?'var(--accent)':'transparent'};display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;">
            ${item.checked?'<span style="color:#1a1208;font-size:.75rem;">âœ“</span>':''}
          </div>
          <div style="flex:1;">
            <span style="font-size:.85rem;color:var(--text);${item.checked?'text-decoration:line-through;opacity:.4;':''}">${item.item}</span>
            ${item.qty?`<span style="font-size:.72rem;color:var(--accent);margin-left:6px;font-weight:600;">${item.qty}</span>`:''}
          </div>
        </div>`).join('')}
    </div>`).join('');
}

function toggleShopItem(id) {
  shoppingList = shoppingList.map(i => i.id == id ? {...i, checked: !i.checked} : i);
  localStorage.setItem('na_shopping', JSON.stringify(shoppingList));
  renderShoppingList();
}

function clearCheckedItems() {
  shoppingList = shoppingList.filter(i => !i.checked);
  localStorage.setItem('na_shopping', JSON.stringify(shoppingList));
  renderShoppingList();
  showToast('Ticked items cleared âœ“');
}

function clearAllShopping() {
  shoppingList = [];
  localStorage.setItem('na_shopping', JSON.stringify(shoppingList));
  renderShoppingList();
  showToast('Shopping list cleared');
}

// Add ingredients from meal plan to shopping list
function buildShoppingFromPlan() {
  Object.values(mealPlan).forEach(day => {
    Object.values(day).forEach(mealName => {
      if(mealName) addIngredientsToList(mealName, defaultPortions);
    });
  });
}

// FOOD LOG / PROGRESS
function addFoodLog() {
  const name = document.getElementById('food-log-name').value.trim();
  const cals = parseInt(document.getElementById('food-log-cals').value)||0;
  if(!name) return;
  const today = new Date().toDateString();
  if(!foodLog[today]) foodLog[today] = [];
  foodLog[today].push({name, cals, id: Date.now()});
  localStorage.setItem('na_food_log', JSON.stringify(foodLog));
  document.getElementById('food-log-name').value = '';
  document.getElementById('food-log-cals').value = '';
  renderFoodLog();
  showToast('Logged âœ“');
}

function removeFoodLog(date, id) {
  if(foodLog[date]) foodLog[date] = foodLog[date].filter(i => i.id != id);
  localStorage.setItem('na_food_log', JSON.stringify(foodLog));
  renderFoodLog();
}

function renderFoodLog() {
  const c = document.getElementById('food-log-container');
  if(!c) return;
  const today = new Date().toDateString();
  const entries = foodLog[today] || [];
  const total = entries.reduce((sum, e) => sum + (e.cals||0), 0);
  
  if(!entries.length) {
    c.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-muted);font-size:.82rem;">Nothing logged yet today</div>';
  } else {
    c.innerHTML = `
      <div class="card" style="margin-bottom:10px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
          <div style="font-weight:700;font-size:.88rem;color:var(--text);">Today's Log</div>
          <div style="background:rgba(232,201,122,0.15);border:1px solid rgba(232,201,122,0.3);border-radius:20px;padding:3px 12px;font-size:.78rem;color:var(--accent);font-weight:700;">ğŸ”¥ ${total} kcal</div>
        </div>
        ${entries.map(e => `
          <div style="display:flex;justify-content:space-between;align-items:center;padding:7px 0;border-bottom:1px solid var(--border);">
            <span style="font-size:.84rem;color:var(--text);">${e.name}</span>
            <div style="display:flex;align-items:center;gap:8px;">
              <span style="font-size:.78rem;color:var(--text-muted);">${e.cals?e.cals+' kcal':''}</span>
              <span onclick="removeFoodLog('${today}',${e.id})" style="color:var(--text-muted);cursor:pointer;font-size:.8rem;opacity:.6;">âœ•</span>
            </div>
          </div>`).join('')}
      </div>`;
  }
  renderWeekChart();
}

function renderWeekChart() {
  const c = document.getElementById('calorie-chart-container');
  if(!c) return;
  const days = [];
  const labels = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
  const today = new Date();
  const dayOfWeek = today.getDay();
  const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
  
  for(let i = 0; i < 7; i++) {
    const d = new Date(today);
    d.setDate(today.getDate() + mondayOffset + i);
    const key = d.toDateString();
    const total = (foodLog[key]||[]).reduce((sum,e) => sum+(e.cals||0), 0);
    days.push(total);
  }
  
  const max = Math.max(...days, 500);
  const todayIdx = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
  
  c.innerHTML = `
    <div class="card">
      <div style="font-weight:600;font-size:.85rem;color:var(--text);margin-bottom:14px;">Calories This Week</div>
      <div style="display:flex;align-items:flex-end;gap:6px;height:100px;">
        ${days.map((val,i) => `
          <div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;">
            <div style="font-size:.62rem;color:${val?'var(--accent)':'var(--text-muted)'};">${val||''}</div>
            <div style="width:100%;background:${i===todayIdx?'var(--accent)':'rgba(232,201,122,0.25)'};border-radius:6px 6px 0 0;height:${val?Math.max(8,Math.round((val/max)*80))+'px':'4px'};min-height:4px;transition:height .3s;"></div>
            <div style="font-size:.65rem;color:${i===todayIdx?'var(--accent)':'var(--text-muted)'};font-weight:${i===todayIdx?'700':'400'};">${labels[i]}</div>
          </div>`).join('')}
      </div>
    </div>`;
}

function switchFoodTab(tab){
  ['meals','planner','shopping','progress','tips'].forEach(t=>{
    const el = document.getElementById('ftab-'+t);
    if(el) el.style.display = t===tab?'block':'none';
    const btn = document.getElementById('ftab-btn-'+t);
    if(btn){ btn.style.background = t===tab ? 'var(--accent)' : 'transparent'; btn.style.color = t===tab ? '#1a1208' : 'var(--text-muted)'; }
  });
  if(tab==='meals') renderDailyMeals();
  if(tab==='planner') renderPlanner();
  if(tab==='shopping'){ buildShoppingFromPlan(); renderShoppingList(); }
  if(tab==='progress'){ renderFoodLog(); }
  if(tab==='tips') renderNutritionTips();
}

let activeMealFilter = 'all';

function filterMealIdeas(tag, el){
  activeMealFilter = tag;
  // Update active chip
  document.querySelectorAll('#ftab-meals .filter-chip').forEach(c=>c.classList.remove('active'));
  if(el) el.classList.add('active');
  renderDailyMeals();
}

function renderDailyMeals(){
  const c = document.getElementById('daily-meals-container');
  if(!c) return;

  let html = '';
  let totalShown = 0;

  MEAL_IDEAS.forEach(section => {
    const filtered = activeMealFilter === 'all'
      ? section.ideas
      : section.ideas.filter(idea => idea.tags && idea.tags.some(t => t.includes(activeMealFilter.replace(/[ğŸ’ªğŸ¥—ğŸŒ±âš¡ğŸ¥£ğŸŒ¿âœ¨]/g,'').trim())));

    if(!filtered.length) return;
    totalShown += filtered.length;

    html += `<div class="card" style="margin-bottom:12px;">
      <div class="card-title">${section.meal} <span style="font-size:.72rem;color:var(--text-muted);font-weight:400;">${filtered.length} meal${filtered.length!==1?'s':''}</span></div>
      ${filtered.map((idea,i) => `
        <div class="meal-swap-anchor" style="padding:10px 0;${i<filtered.length-1?'border-bottom:1px solid var(--border)':''}">
          <div style="display:flex;align-items:flex-start;gap:10px;">
            <div style="font-size:1.8rem;line-height:1;">${idea.emoji}</div>
            <div style="flex:1;">
              <div style="font-weight:600;font-size:.88rem;color:var(--text);margin-bottom:3px;">${idea.name}</div>
              <div style="font-size:.78rem;color:var(--text-muted);line-height:1.5;margin-bottom:6px;">${idea.desc}</div>
              <div style="display:flex;gap:4px;flex-wrap:wrap;margin-bottom:7px;">
                <span style="background:rgba(232,201,122,0.15);border:1px solid rgba(232,201,122,0.3);border-radius:20px;padding:2px 9px;font-size:.68rem;color:var(--accent);font-weight:700;">ğŸ”¥ ${idea.cals} kcal</span>
                <span style="background:var(--surface2);border:1px solid var(--border);border-radius:20px;padding:2px 9px;font-size:.68rem;color:var(--text-muted);">P ${idea.protein}</span>
                <span style="background:var(--surface2);border:1px solid var(--border);border-radius:20px;padding:2px 9px;font-size:.68rem;color:var(--text-muted);">C ${idea.carbs}</span>
                <span style="background:var(--surface2);border:1px solid var(--border);border-radius:20px;padding:2px 9px;font-size:.68rem;color:var(--text-muted);">F ${idea.fat}</span>
                ${(idea.tags||[]).map(t=>`<span style="background:rgba(255,255,255,0.05);border:1px solid var(--border);border-radius:20px;padding:2px 8px;font-size:.65rem;color:var(--text-muted);">${t}</span>`).join('')}
              </div>
              <div style="display:flex;gap:6px;flex-wrap:wrap;">
                <button onclick="openRecipeDetail('${idea.name.replace(/'/g,"\'")}','${section.meal}')" style="flex:1;min-width:80px;padding:7px;border:1px solid var(--accent);border-radius:8px;background:transparent;color:var(--accent);font-size:.74rem;font-weight:600;cursor:pointer;">ğŸ“– View Recipe</button>
                <button onclick="addMealToPlanner('${idea.name.replace(/'/g,"\'")}','${section.meal}')" style="flex:1;min-width:80px;padding:7px;border:none;border-radius:8px;background:var(--accent);color:#1a1208;font-size:.74rem;font-weight:600;cursor:pointer;">â• Plan</button>
                <button onclick="swapMeal('${idea.name.replace(/'/g,"\'")}','${section.meal}',${i})" style="padding:7px 10px;border:1px solid var(--border);border-radius:8px;background:transparent;color:var(--text-muted);font-size:.74rem;cursor:pointer;">ğŸ”„</button>
              </div>
            </div>
          </div>
        </div>`).join('')}
    </div>`;
  });

  if(!totalShown){
    html = `<div style="text-align:center;padding:40px 0;color:var(--text-muted);font-size:.84rem;">No meals match this filter</div>`;
  }
  c.innerHTML = html;
}

function renderRecipes(){
  const c = document.getElementById('recipes-container');
  if(!c) return;
  c.innerHTML = RECIPES.map((r,idx)=>`
    <div class="card" style="margin-bottom:12px;">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
        <div style="font-size:2rem;">${r.emoji}</div>
        <div>
          <div style="font-weight:700;font-size:.95rem;color:var(--text);">${r.name}</div>
          <div style="font-size:.74rem;color:var(--text-muted);">â± ${r.time} &nbsp;Â·&nbsp; ğŸ‘¤ Serves ${r.serves} &nbsp;Â·&nbsp; âœ… ${r.difficulty}${r.source?` &nbsp;Â·&nbsp; ğŸ”— ${r.source}`:''}</div>
        </div>
      </div>
      <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px;">
        <span style="background:rgba(232,201,122,0.15);border:1px solid rgba(232,201,122,0.3);border-radius:20px;padding:3px 10px;font-size:.72rem;color:var(--accent);font-weight:700;">ğŸ”¥ ${r.cals} kcal</span>
        <span style="background:var(--surface2);border:1px solid var(--border);border-radius:20px;padding:3px 10px;font-size:.72rem;color:var(--text-muted);">Protein ${r.protein}</span>
        <span style="background:var(--surface2);border:1px solid var(--border);border-radius:20px;padding:3px 10px;font-size:.72rem;color:var(--text-muted);">Carbs ${r.carbs}</span>
        <span style="background:var(--surface2);border:1px solid var(--border);border-radius:20px;padding:3px 10px;font-size:.72rem;color:var(--text-muted);">Fat ${r.fat}</span>
      </div>
      <div style="font-size:.8rem;font-weight:600;color:var(--accent);margin-bottom:5px;text-transform:uppercase;letter-spacing:.05em;">Ingredients</div>
      <ul style="margin:0 0 12px 16px;padding:0;font-size:.8rem;color:var(--text-muted);line-height:1.8;">
        ${r.ingredients.map(i=>`<li>${i}</li>`).join('')}
      </ul>
      <div style="font-size:.8rem;font-weight:600;color:var(--accent);margin-bottom:5px;text-transform:uppercase;letter-spacing:.05em;">Method</div>
      <ol style="margin:0 0 0 16px;padding:0;font-size:.8rem;color:var(--text-muted);line-height:1.8;">
        ${r.steps.map(s=>`<li style="margin-bottom:4px;">${s}</li>`).join('')}
      </ol>
    </div>`).join('');
}

let selectedPlannerDay = PLANNER_DAYS[new Date().getDay()===0?6:new Date().getDay()-1];
let pickerTargetDay = null;
let pickerTargetMeal = null;

function renderPlanner(){
  renderDayStrip();
  renderDayView();
}

function renderDayStrip(){
  const strip = document.getElementById('day-strip');
  if(!strip) return;
  const today = PLANNER_DAYS[new Date().getDay()===0?6:new Date().getDay()-1];
  const dayShort = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
  strip.innerHTML = PLANNER_DAYS.map((day,i)=>{
    const meals = mealPlan[day]||{};
    const count = Object.values(meals).filter(v=>v).length;
    const isSelected = day===selectedPlannerDay;
    const isToday = day===today;
    return `<div onclick="selectPlannerDay('${day}')" style="flex-shrink:0;width:56px;text-align:center;cursor:pointer;padding:8px 4px;border-radius:14px;background:${isSelected?'var(--accent)':'var(--surface2)'};border:${isToday&&!isSelected?'2px solid var(--accent)':'2px solid transparent'};transition:all .2s;">
      <div style="font-size:.65rem;font-weight:700;color:${isSelected?'#1a1208':'var(--text-muted)'};">${dayShort[i]}</div>
      <div style="font-size:1.1rem;margin:3px 0;">${isToday?'ğŸ“':count>0?'âœ…':'â—‹'}</div>
      <div style="font-size:.6rem;color:${isSelected?'#1a1208':'var(--text-muted)'};">${count>0?count+' meals':'empty'}</div>
    </div>`;
  }).join('');
}

function selectPlannerDay(day){
  selectedPlannerDay = day;
  renderDayStrip();
  renderDayView();
}

function renderDayView(){
  const c = document.getElementById('planner-day-view');
  if(!c) return;
  const meals = ['Breakfast','Lunch','Dinner','Snack'];
  const mealEmojis = {Breakfast:'ğŸŒ…',Lunch:'â˜€ï¸',Dinner:'ğŸŒ™',Snack:'ğŸ'};
  const dayMeals = mealPlan[selectedPlannerDay]||{};
  const today = PLANNER_DAYS[new Date().getDay()===0?6:new Date().getDay()-1];
  const isToday = selectedPlannerDay===today;

  c.innerHTML = `
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:16px;">
      <div style="font-size:1.1rem;font-weight:700;color:var(--text);">${selectedPlannerDay}</div>
      ${isToday?'<span style="background:rgba(232,201,122,0.2);border:1px solid var(--accent);border-radius:20px;padding:2px 10px;font-size:.68rem;color:var(--accent);font-weight:700;">TODAY</span>':''}
    </div>
    ${meals.map(meal=>{
      const chosen = dayMeals[meal]||'';
      // Find meal data for calorie display
      let mealData = null;
      MEAL_IDEAS.forEach(s=>s.ideas.forEach(i=>{ if(i.name===chosen) mealData=i; }));
      return `<div style="margin-bottom:10px;">
        <div style="font-size:.7rem;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:.06em;margin-bottom:5px;">${mealEmojis[meal]} ${meal}</div>
        ${chosen
          ? `<div style="background:var(--surface2);border-radius:14px;padding:12px 14px;display:flex;justify-content:space-between;align-items:center;">
               <div style="flex:1;">
                 <div style="font-size:.88rem;font-weight:600;color:var(--text);">${chosen}</div>
                 ${mealData?`<div style="font-size:.72rem;color:var(--accent);margin-top:2px;">ğŸ”¥ ${mealData.cals} kcal Â· ${mealData.protein} protein</div>`:''}
               </div>
               <div style="display:flex;gap:6px;flex-shrink:0;margin-left:8px;">
                 <button onclick="openMealPicker('${selectedPlannerDay}','${meal}')" style="padding:5px 10px;border:1px solid var(--border);border-radius:8px;background:transparent;color:var(--text-muted);font-size:.72rem;cursor:pointer;">Change</button>
                 <button onclick="removePlanMeal('${selectedPlannerDay}','${meal}')" style="padding:5px 10px;border:none;border-radius:8px;background:transparent;color:var(--text-muted);font-size:.88rem;cursor:pointer;">âœ•</button>
               </div>
             </div>`
          : `<button onclick="openMealPicker('${selectedPlannerDay}','${meal}')"
               style="width:100%;padding:16px;border:2px dashed var(--border);border-radius:14px;background:transparent;color:var(--text-muted);font-size:.84rem;cursor:pointer;text-align:left;">
               + Add ${meal.toLowerCase()}
             </button>`
        }
      </div>`;
    }).join('')}
    <div style="margin-top:6px;display:flex;gap:8px;">
      <button class="save-btn" style="flex:1;" onclick="saveDayAndUpdateList()">Save & add to shopping list</button>
    </div>`;
}

function openMealPicker(day, meal){
  pickerTargetDay = day;
  pickerTargetMeal = meal;
  const overlay = document.getElementById('meal-picker-overlay');
  const title = document.getElementById('picker-title');
  const list = document.getElementById('meal-picker-list');
  if(!overlay) return;
  title.textContent = 'Choose ' + meal.toLowerCase() + ' for ' + day;
  // Show relevant meal categories
  const mealMap = {Breakfast:['Breakfast'],Lunch:['Lunch'],Dinner:['Dinner'],Snack:['Snacks']};
  const cats = mealMap[meal]||MEAL_IDEAS.map(s=>s.meal);
  const ideas = MEAL_IDEAS.filter(s=>cats.includes(s.meal));
  list.innerHTML = ideas.map(section=>`
    <div style="margin-bottom:14px;">
      <div style="font-size:.72rem;font-weight:700;color:var(--accent);text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px;">${section.meal}</div>
      ${section.ideas.map(idea=>`
        <div onclick="pickMeal('${idea.name.replace(/'/g,"\'")}')"
             style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--surface2);border-radius:12px;margin-bottom:6px;cursor:pointer;border:1px solid var(--border);">
          <div style="display:flex;align-items:center;gap:10px;flex:1;">
            <span style="font-size:1.4rem;">${idea.emoji}</span>
            <div>
              <div style="font-size:.86rem;font-weight:600;color:var(--text);">${idea.name}</div>
              <div style="font-size:.7rem;color:var(--text-muted);margin-top:1px;">${idea.desc.substring(0,50)}â€¦</div>
            </div>
          </div>
          <div style="text-align:right;flex-shrink:0;margin-left:8px;">
            <div style="font-size:.76rem;color:var(--accent);font-weight:700;">ğŸ”¥ ${idea.cals}</div>
            <div style="font-size:.66rem;color:var(--text-muted);">kcal</div>
          </div>
        </div>`).join('')}
    </div>`).join('');
  overlay.style.display = 'block';
  document.body.style.overflow = 'hidden';
}

function closeMealPicker(){
  document.getElementById('meal-picker-overlay').style.display = 'none';
  document.body.style.overflow = '';
}

function pickMeal(mealName){
  if(!pickerTargetDay||!pickerTargetMeal) return;
  if(!mealPlan[pickerTargetDay]) mealPlan[pickerTargetDay]={};
  mealPlan[pickerTargetDay][pickerTargetMeal] = mealName;
  localStorage.setItem('na_meal_plan', JSON.stringify(mealPlan));
  closeMealPicker();
  renderDayStrip();
  renderDayView();
  showToast(mealName + ' added âœ“');
}

function removePlanMeal(day, meal){
  if(mealPlan[day]) delete mealPlan[day][meal];
  localStorage.setItem('na_meal_plan', JSON.stringify(mealPlan));
  renderDayStrip();
  renderDayView();
}

function saveDayAndUpdateList(){
  buildShoppingFromPlan();
  showToast('Shopping list updated âœ“');
}

function clearWeekPlan(){
  mealPlan={};
  localStorage.setItem('na_meal_plan','{}');
  renderDayStrip();
  renderDayView();
  showToast('Week cleared');
}

function saveMealPlan(){
  // kept for compatibility
  localStorage.setItem('na_meal_plan', JSON.stringify(mealPlan));
  buildShoppingFromPlan();
  showToast('Plan saved & shopping list updated âœ“');
}

function renderNutritionTips(){
  const c = document.getElementById('tips-container');
  if(!c) return;
  c.innerHTML = NUTRITION_TIPS.map(tip=>`
    <div class="card" style="margin-bottom:12px;">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
        <div style="font-size:1.6rem;">${tip.emoji}</div>
        <div style="font-weight:700;font-size:.9rem;color:var(--text);">${tip.title}</div>
      </div>
      <div style="font-size:.82rem;color:var(--text-muted);line-height:1.6;">${tip.tip}</div>
    </div>`).join('');
}

// LOL MEETING TIMES - convert from ET to user's local timezone
function renderLOLTimes(){
  const el = document.getElementById('lol-times');
  if(!el) return;
  try {
    // Meeting times in US Eastern time
    // Friday 5:30pm ET, Saturday 11:30am ET
    const now = new Date();
    const year = now.getFullYear();
    const month = now.getMonth();
    const day = now.getDate();

    // Create dates in ET using Intl to find offset
    // Friday meeting: next Friday at 17:30 ET
    // Saturday meeting: next Saturday at 11:30 ET
    function getLocalTimeStr(etHour, etMin) {
      // Use a fixed reference date to get the ET offset
      // Create date as if it's in ET by using toLocaleString trick
      const etDate = new Date();
      const etStr = etDate.toLocaleString('en-US', {timeZone: 'America/New_York', hour:'numeric', minute:'2-digit', hour12: false});
      const localStr = etDate.toLocaleString('en-US', {hour:'numeric', minute:'2-digit', hour12: false});
      
      // Get ET offset vs UTC
      const etUTC = new Date(etDate.toLocaleString('en-US', {timeZone: 'America/New_York'}));
      const localUTC = new Date(etDate.toLocaleString('en-US'));
      const diffMins = Math.round((localUTC - etUTC) / 60000);
      
      // Build a date object for the meeting time in ET, then convert
      const meetingET = new Date(year, month, day, etHour, etMin, 0);
      const meetingLocal = new Date(meetingET.getTime() + diffMins * 60000);
      
      return meetingLocal.toLocaleTimeString([], {hour:'numeric', minute:'2-digit', hour12: true});
    }

    const fridayLocal = getLocalTimeStr(17, 30);
    const saturdayLocal = getLocalTimeStr(11, 30);
    
    const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
    const tzShort = new Date().toLocaleTimeString('en-US', {timeZoneName:'short'}).split(' ').pop();

    el.innerHTML = `<b style="color:var(--text);">Friday</b> ${fridayLocal} &nbsp;Â·&nbsp; <b style="color:var(--text);">Saturday</b> ${saturdayLocal} <span style="opacity:.6;">(your time Â· ${tzShort})</span><br>
      Zoom ID: <span style="color:var(--text);font-weight:500;">974 8817 4579</span> &nbsp;Â·&nbsp; Password: <span style="color:var(--text);font-weight:500;">hope</span>`;
  } catch(e) {
    el.innerHTML = `<b style="color:var(--text);">Friday</b> 5:30pm ET &nbsp;Â·&nbsp; <b style="color:var(--text);">Saturday</b> 11:30am ET<br>
      Zoom ID: <span style="color:var(--text);font-weight:500;">974 8817 4579</span> &nbsp;Â·&nbsp; Password: <span style="color:var(--text);font-weight:500;">hope</span>`;
  }
}

// â”€â”€ JOURNAL DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const JOURNAL_TYPES = {
  reflect: { title:'Reflective Journal', emoji:'ğŸ“' },
  gratitude: { title:'Gratitude List', emoji:'ğŸ™' },
  stepwork: { title:'Step Work', emoji:'ğŸ“–' },
  spotcheck: { title:'Spot Check Inventory', emoji:'âš¡' },
  step10: { title:'Step 10 Daily Inventory', emoji:'ğŸ”Ÿ' }
};

const REFLECT_PROMPTS = [
  "How am I feeling right now â€” honestly?",
  "Who did I connect with today, and how did that feel?",
  "Was there a moment today I'm proud of?",
  "Did anything challenge me today? How did I respond?",
  "What was something small but good that happened today?",
  "Is there anything I need to let go of from today?",
  "How did my relationships feel today â€” with others, and with myself?",
  "What emotions came up for me today, and what triggered them?",
  "Did I show up the way I wanted to today?",
  "What do I want to carry into tomorrow?"
];

const GRATITUDE_PROMPTS = [
  "Name three people who have shown up for you recently.",
  "What's something about your body you're grateful for today?",
  "Describe a simple moment from today that brought you peace.",
  "What's a relationship in your life you're grateful for, and why?",
  "What's something you often take for granted that you appreciate today?",
  "Write about a challenge that helped you grow.",
  "What's something you've learned recently that you're grateful for?",
  "Who has been kind to you this week â€” however small?",
  "What does having another clean day mean to you today?",
  "What's something in your home or surroundings you appreciate?",
  "Write about a memory that makes you smile.",
  "What's a quality in yourself you're grateful for?"
];

const SPOTCHECK_PROMPTS = [
  "Right now, in this moment â€” how am I actually feeling?",
  "Am I being honest with myself and others right now?",
  "Is there something sitting on my chest I need to address?",
  "Have I been selfish, resentful, or fearful today so far?",
  "Am I present â€” or am I in yesterday or tomorrow?",
  "Is there someone I owe a conversation or an amends to?",
  "What do I need right now to stay on solid ground?",
  "Am I HALT â€” Hungry, Angry, Lonely, or Tired?"
];

const STEP10_QUESTIONS = [
  "Have I reaffirmed my faith in a loving, caring Higher Power today?",
  "Have I sought out the guidance of my Higher Power today? How?",
  "What have I done to be of service to the people around me?",
  "What has my Higher Power given me to be grateful for today?",
  "Do I see any old patterns in my life today? Which ones?",
  "Have I been resentful, selfish, dishonest, or afraid?",
  "Have I set myself up for disappointment?",
  "Have I been kind and loving to all?",
  "Have I been worrying about yesterday or tomorrow?",
  "Did I allow myself to become obsessed about anything?",
  "Have I allowed myself to become too Hungry, Angry, Lonely, or Tired?",
  "Am I taking myself too seriously in any area of my life?",
  "Have I kept something to myself that I should discuss with my sponsor?",
  "Did I have any extreme feelings today? What were they and why?",
  "What are the problem areas in my life today?",
  "Which defects played a part in my life today? How?",
  "Was there fear in my life today?",
  "What did I do today that I wish I hadn't done?",
  "What didn't I do today that I wish I had done?",
  "Am I willing to change?",
  "Has there been conflict in any of my relationships today?",
  "Am I maintaining personal integrity in my relations with others?",
  "Have I harmed myself or others, directly or indirectly today? How?",
  "Do I owe apologies or amends?",
  "Where was I wrong? What would I do differently next time?",
  "Did I stay clean today?",
  "Was I good to myself today?",
  "What feelings did I have today? How did I use them to choose principle-centred action?",
  "What did I do to be of service to others today?",
  "What have I done today that I feel positive about?",
  "What has given me satisfaction today?",
  "What did I do today that I want to be sure to repeat?",
  "Did I go to a meeting or talk to another recovering addict today?",
  "What do I have to be grateful for today?"
];

// â”€â”€ JOURNAL FUNCTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let journalDeleteMode = false;

function toggleJournalDeleteMode(){
  journalDeleteMode = !journalDeleteMode;
  const btn = document.getElementById('journal-delete-mode-btn');
  if(btn){
    btn.textContent = journalDeleteMode ? 'Done' : 'Edit';
    btn.style.color = journalDeleteMode ? 'var(--accent)' : 'var(--text-muted)';
  }
  renderJournalList();
}

function deleteEntryById(id, evt){
  if(evt) evt.stopPropagation();
  // Show inline confirmation banner instead of confirm() which iOS blocks
  const existing = document.getElementById('delete-confirm-bar');
  if(existing) existing.remove();
  const bar = document.createElement('div');
  bar.id = 'delete-confirm-bar';
  bar.style.cssText = 'position:fixed;bottom:80px;left:16px;right:16px;background:#c0392b;border-radius:14px;padding:14px 16px;z-index:999;display:flex;justify-content:space-between;align-items:center;box-shadow:0 4px 20px rgba(0,0,0,.4);';
  bar.innerHTML = `
    <span style="color:white;font-size:.86rem;font-weight:600;">Delete this entry?</span>
    <div style="display:flex;gap:10px;">
      <button onclick="document.getElementById('delete-confirm-bar').remove()" style="background:rgba(255,255,255,.2);border:none;border-radius:8px;color:white;padding:7px 14px;font-size:.82rem;cursor:pointer;">Cancel</button>
      <button onclick="confirmDeleteEntry('${id}')" style="background:white;border:none;border-radius:8px;color:#c0392b;padding:7px 14px;font-size:.82rem;font-weight:700;cursor:pointer;">Delete</button>
    </div>`;
  document.body.appendChild(bar);
}

function confirmDeleteEntry(id){
  const bar = document.getElementById('delete-confirm-bar');
  if(bar) bar.remove();
  journalEntries = journalEntries.filter(en=>en.id!==id);
  localStorage.setItem('na_journal', JSON.stringify(journalEntries));
  if(!journalEntries.length) journalDeleteMode = false;
  if(window._deleteAndGoHome){
    window._deleteAndGoHome = false;
    backToJournalHome();
  } else {
    renderJournalList();
  }
  showToast('Entry deleted');
}

function renderJournalList(){
  const c=document.getElementById('journal-entries-container');
  if(!c) return;
  if(!journalEntries.length){
    journalDeleteMode = false;
    c.innerHTML=`<div style="color:var(--text-muted);font-size:.83rem;text-align:center;padding:30px 0;">No entries yet.<br>Choose a type above to begin.</div>`;
    return;
  }
  const typeEmojis = {reflect:'ğŸ“',gratitude:'ğŸ™',stepwork:'ğŸ“–',spotcheck:'âš¡',step10:'ğŸ”Ÿ'};

  // Build header with Edit button
  let html = `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
    <div style="font-size:.72rem;color:var(--text-muted);">${journalEntries.length} entr${journalEntries.length===1?'y':'ies'}</div>
    <button id="journal-delete-mode-btn" onclick="toggleJournalDeleteMode()" style="background:none;border:none;font-size:.8rem;font-weight:600;color:${journalDeleteMode?'var(--accent)':'var(--text-muted)'};cursor:pointer;padding:4px 8px;">${journalDeleteMode?'Done':'Edit'}</button>
  </div>`;

  [...journalEntries].reverse().forEach(e=>{
    const dt=new Date(e.date);
    const emoji = typeEmojis[e.type]||'ğŸ“';
    const label = JOURNAL_TYPES[e.type]?.title||'Journal Entry';
    const preview = e.text.slice(0,110)+(e.text.length>110?'â€¦':'');

    if(journalDeleteMode){
      html += `<div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
        <button onclick="deleteEntryById('${e.id}',event)" style="flex-shrink:0;width:28px;height:28px;border-radius:50%;background:#e05;border:none;color:white;font-size:1rem;cursor:pointer;display:flex;align-items:center;justify-content:center;">âˆ’</button>
        <div class="journal-entry-card" style="flex:1;margin:0;opacity:.85;" onclick="openJournalEntry('${e.id}')">
          <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:4px;">
            <div class="journal-date">${dt.toLocaleDateString('en-GB',{weekday:'short',day:'numeric',month:'short',year:'numeric'})}</div>
            <span style="font-size:.68rem;background:rgba(232,201,122,0.12);border:1px solid rgba(232,201,122,0.25);border-radius:20px;padding:2px 8px;color:var(--accent);white-space:nowrap;">${emoji} ${label}</span>
          </div>
          <div class="journal-preview">${preview}</div>
        </div>
      </div>`;
    } else {
      html += `<div class="journal-entry-card" onclick="openJournalEntry('${e.id}')">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:4px;">
          <div class="journal-date">${dt.toLocaleDateString('en-GB',{weekday:'short',day:'numeric',month:'short',year:'numeric'})}</div>
          <span style="font-size:.68rem;background:rgba(232,201,122,0.12);border:1px solid rgba(232,201,122,0.25);border-radius:20px;padding:2px 8px;color:var(--accent);white-space:nowrap;">${emoji} ${label}</span>
        </div>
        <div class="journal-preview">${preview}</div>
      </div>`;
    }
  });

  c.innerHTML = html;
}

function startJournalEntry(type){
  currentJournalId = null;
  currentJournalType = type;
  const info = JOURNAL_TYPES[type];
  document.getElementById('journal-home').style.display='none';
  document.getElementById('journal-write-view').style.display='block';
  document.getElementById('journal-write-title').textContent = info.emoji+' '+info.title;
  document.getElementById('journal-write-date').textContent = new Date().toLocaleDateString('en-GB',{weekday:'long',day:'numeric',month:'long',year:'numeric'});
  document.getElementById('journal-write-text').value='';
  document.getElementById('journal-delete-write-btn').style.display='none';
  renderJournalPrompts(type);
  document.getElementById('journal-write-text').focus();
}

function renderJournalPrompts(type){
  const area = document.getElementById('journal-prompts-area');
  if(!area) return;

  // Restore textarea visibility (step10 hides it)
  const ta = document.getElementById('journal-write-text');
  if(ta) ta.style.display = type==='step10' ? 'none' : 'block';

  if(type==='gratitude'){
    const prompts = GRATITUDE_PROMPTS.sort(()=>Math.random()-.5).slice(0,3);
    area.innerHTML = `
      <div style="background:rgba(232,201,122,0.07);border:1px solid rgba(232,201,122,0.2);border-radius:14px;padding:14px;margin-bottom:14px;">
        <div style="font-size:.72rem;font-weight:700;color:var(--accent);text-transform:uppercase;letter-spacing:.05em;margin-bottom:10px;">ğŸ™ Today's prompts</div>
        <div style="font-size:.78rem;color:var(--text-muted);margin-bottom:8px;font-style:italic;">Use one, some, or all â€” or just write freely.</div>
        ${prompts.map((p,i)=>`<div style="padding:8px 0;border-bottom:${i<prompts.length-1?'1px solid var(--border)':'none'};font-size:.82rem;color:var(--text);">â€¢ ${p}</div>`).join('')}
        <button onclick="renderJournalPrompts('gratitude')" style="margin-top:10px;background:none;border:1px solid var(--border);border-radius:8px;padding:5px 12px;font-size:.72rem;color:var(--text-muted);cursor:pointer;">â†» New prompts</button>
      </div>`;
  } else if(type==='reflect'){
    const prompts = REFLECT_PROMPTS.sort(()=>Math.random()-.5).slice(0,3);
    area.innerHTML = `
      <div style="background:rgba(232,201,122,0.07);border:1px solid rgba(232,201,122,0.2);border-radius:14px;padding:14px;margin-bottom:14px;">
        <div style="font-size:.72rem;font-weight:700;color:var(--accent);text-transform:uppercase;letter-spacing:.05em;margin-bottom:10px;">ğŸ’­ Prompts to get you started</div>
        ${prompts.map((p,i)=>`<div style="padding:8px 0;border-bottom:${i<prompts.length-1?'1px solid var(--border)':'none'};font-size:.82rem;color:var(--text);">â€¢ ${p}</div>`).join('')}
        <button onclick="renderJournalPrompts('reflect')" style="margin-top:10px;background:none;border:1px solid var(--border);border-radius:8px;padding:5px 12px;font-size:.72rem;color:var(--text-muted);cursor:pointer;">â†» New prompts</button>
      </div>`;
  } else if(type==='spotcheck'){
    const prompts = SPOTCHECK_PROMPTS;
    area.innerHTML = `
      <div style="background:rgba(232,201,122,0.07);border:1px solid rgba(232,201,122,0.2);border-radius:14px;padding:14px;margin-bottom:14px;">
        <div style="font-size:.72rem;font-weight:700;color:var(--accent);text-transform:uppercase;letter-spacing:.05em;margin-bottom:6px;">âš¡ Spot check â€” pause and check in</div>
        <div style="font-size:.76rem;color:var(--text-muted);margin-bottom:10px;">Take a breath. Answer honestly.</div>
        ${prompts.map((p,i)=>`<div style="padding:8px 0;border-bottom:${i<prompts.length-1?'1px solid var(--border)':'none'};font-size:.82rem;color:var(--text);">â€¢ ${p}</div>`).join('')}
      </div>`;
  } else if(type==='step10'){
    // Step 10 gets its own full Q&A interface â€” hide the generic textarea
    document.getElementById('journal-write-text').style.display='none';
    area.innerHTML = `
      <div style="margin-bottom:14px;">
        <div style="font-size:.75rem;color:var(--text-muted);margin-bottom:14px;line-height:1.6;">Answer each question honestly in your own words. When you're done, you can email it to yourself or share it directly to WhatsApp.</div>
        ${STEP10_QUESTIONS.map((q,i)=>`
          <div style="margin-bottom:16px;">
            <div style="font-size:.8rem;color:var(--accent);font-weight:700;margin-bottom:5px;">${i+1}. ${q}</div>
            <textarea id="s10q${i}" class="journal-area" placeholder="Your answer..." style="min-height:70px;margin:0;font-size:.82rem;"></textarea>
          </div>`).join('')}
        <div style="display:flex;gap:8px;margin-top:6px;flex-wrap:wrap;">
          <button onclick="saveStep10()" class="save-btn" style="flex:1;min-width:120px;">ğŸ’¾ Save</button>
          <button onclick="emailStep10()" style="flex:1;min-width:120px;padding:13px;border:1px solid var(--accent);border-radius:var(--radius);background:transparent;color:var(--accent);font-size:.84rem;font-weight:600;cursor:pointer;">âœ‰ï¸ Email</button>
          <button onclick="shareStep10()" style="flex:1;min-width:120px;padding:13px;border:1px solid #25D366;border-radius:var(--radius);background:transparent;color:#25D366;font-size:.84rem;font-weight:600;cursor:pointer;">ğŸ“¤ Share</button>
        </div>
        <div style="font-size:.72rem;color:var(--text-muted);text-align:center;margin-top:8px;">ğŸ“¤ Share opens your iPhone share sheet â€” send to WhatsApp, iMessage, save to Files, AirDrop & more</div>
      </div>`;
  } else if(type==='stepwork'){
    area.innerHTML = `
      <div style="background:rgba(232,201,122,0.07);border:1px solid rgba(232,201,122,0.2);border-radius:14px;padding:14px;margin-bottom:14px;">
        <div style="font-size:.72rem;font-weight:700;color:var(--accent);text-transform:uppercase;letter-spacing:.05em;margin-bottom:6px;">ğŸ“– Step Work</div>
        <div style="font-size:.82rem;color:var(--text);line-height:1.6;">Write about whichever step you're working. Note what's coming up for you, what you're discovering, and any questions for your sponsor.</div>
      </div>`;
  }
}

function backToJournalHome(){
  document.getElementById('journal-write-view').style.display='none';
  document.getElementById('journal-home').style.display='block';
  renderJournalList();
}

function openJournalEntry(id){
  const e=journalEntries.find(e=>e.id===id);
  if(!e) return;
  currentJournalId=id;
  currentJournalType=e.type||'reflect';
  const info=JOURNAL_TYPES[currentJournalType]||JOURNAL_TYPES.reflect;
  document.getElementById('journal-home').style.display='none';
  document.getElementById('journal-write-view').style.display='block';
  document.getElementById('journal-write-title').textContent=info.emoji+' '+info.title;
  document.getElementById('journal-write-date').textContent=new Date(e.date).toLocaleDateString('en-GB',{weekday:'long',day:'numeric',month:'long',year:'numeric'});
  document.getElementById('journal-write-text').value=e.text;
  document.getElementById('journal-delete-write-btn').style.display='block';
  renderJournalPrompts(currentJournalType);
  // For step10 â€” parse saved text back into individual answer fields
  if(currentJournalType==='step10' && e.text) {
    setTimeout(()=>{
      const lines = e.text.split('\n');
      let qIdx = -1;
      let answerLines = [];
      const answers = {};
      lines.forEach(line => {
        const qMatch = line.match(/^(\d+)\. /);
        if(qMatch) {
          if(qIdx>=0) answers[qIdx] = answerLines.join('\n').trim();
          qIdx = parseInt(qMatch[1])-1;
          answerLines = [];
        } else if(qIdx>=0 && line !== 'â”€'.repeat(40) && !line.startsWith('STEP 10')) {
          answerLines.push(line);
        }
      });
      if(qIdx>=0) answers[qIdx] = answerLines.join('\n').trim();
      Object.keys(answers).forEach(i => {
        const el = document.getElementById('s10q'+i);
        if(el && answers[i] && answers[i]!=='(no answer)') el.value = answers[i];
      });
    }, 100);
  }
}

function saveJournalWrite(){
  const text=document.getElementById('journal-write-text').value.trim();
  if(!text){alert('Please write something first.');return;}
  if(currentJournalId){
    const i=journalEntries.findIndex(e=>e.id===currentJournalId);
    if(i>-1){ journalEntries[i].text=text; journalEntries[i].type=currentJournalType; }
  } else {
    journalEntries.push({id:Date.now().toString(),date:new Date().toISOString(),text,type:currentJournalType});
  }
  localStorage.setItem('na_journal',JSON.stringify(journalEntries));
  showToast('Entry saved âœ“');
  backToJournalHome();
}

function buildStep10Text() {
  const today = new Date().toLocaleDateString('en-GB',{weekday:'long',day:'numeric',month:'long',year:'numeric'});
  let doc = 'STEP 10 DAILY INVENTORY\n' + today + '\n';
  doc += 'â”€'.repeat(40) + '\n\n';
  STEP10_QUESTIONS.forEach((q, i) => {
    const ans = (document.getElementById('s10q'+i)||{}).value || '';
    doc += (i+1) + '. ' + q + '\n';
    doc += (ans.trim() || '(no answer)') + '\n\n';
  });
  return doc;
}

function saveStep10() {
  const text = buildStep10Text();
  if(currentJournalId) {
    const i = journalEntries.findIndex(e=>e.id===currentJournalId);
    if(i>-1){ journalEntries[i].text=text; journalEntries[i].type='step10'; }
  } else {
    journalEntries.push({id:Date.now().toString(), date:new Date().toISOString(), text, type:'step10'});
  }
  localStorage.setItem('na_journal', JSON.stringify(journalEntries));
  showToast('Step 10 saved âœ“');
}

function emailStep10() {
  saveStep10();
  const text = buildStep10Text();
  const today = new Date().toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'});
  const subject = encodeURIComponent('Step 10 Daily Inventory â€” ' + today);
  const body = encodeURIComponent(text);
  window.open('mailto:?subject=' + subject + '&body=' + body, '_blank');
}

async function shareStep10() {
  saveStep10();
  const text = buildStep10Text();
  const today = new Date().toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'});
  const filename = 'Step10-Inventory-' + today.replace(/ /g,'-') + '.txt';

  // Create a text file blob
  const blob = new Blob([text], {type: 'text/plain'});
  const file = new File([blob], filename, {type: 'text/plain'});

  // Use Web Share API with file attachment (supported on iOS Safari 15+)
  if(navigator.canShare && navigator.canShare({files:[file]})) {
    try {
      await navigator.share({
        files: [file],
        title: 'Step 10 Daily Inventory',
        text: 'My Step 10 inventory â€” ' + today
      });
      showToast('Shared âœ“');
      return;
    } catch(e) {
      if(e.name !== 'AbortError') {
        // Fall through to text share
      } else {
        return; // User cancelled
      }
    }
  }

  // Fallback: share as plain text (no file) â€” works on older iOS
  if(navigator.share) {
    try {
      await navigator.share({
        title: 'Step 10 Daily Inventory â€” ' + today,
        text: text
      });
      showToast('Shared âœ“');
      return;
    } catch(e) {
      if(e.name === 'AbortError') return;
    }
  }

  // Final fallback: copy to clipboard
  try {
    await navigator.clipboard.writeText(text);
    showToast('Copied to clipboard â€” paste into WhatsApp âœ“');
  } catch(e) {
    // Manual copy fallback
    const ta = document.createElement('textarea');
    ta.value = text;
    ta.style.position='fixed';ta.style.opacity='0';
    document.body.appendChild(ta);
    ta.focus();ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
    showToast('Copied to clipboard â€” paste into WhatsApp âœ“');
  }
}

function deleteCurrentEntry(){
  if(!currentJournalId) return;
  // Show inline confirm bar, set a flag so confirmDeleteEntry knows to go back home
  window._deleteAndGoHome = true;
  deleteEntryById(currentJournalId, null);
}

// Keep old functions for any modal references still in HTML
function openNewJournalEntry(){ startJournalEntry('reflect'); }
function closeJournalModal(){ backToJournalHome(); }
function saveJournalModal(){ saveJournalWrite(); }

// â”€â”€ RECIPE DETAIL MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openRecipeDetail(mealName, mealType) {
  // Search MEAL_IDEAS for the recipe
  let idea = null;
  let section = null;
  MEAL_IDEAS.forEach(s => {
    s.ideas.forEach(i => {
      if(i.name === mealName) { idea = i; section = s.meal; }
    });
  });
  // Also check RECIPES array
  if(!idea) {
    idea = RECIPES.find(r => r.name === mealName);
  }
  if(!idea) return;

  const modal = document.getElementById('recipe-detail-modal');

  // Header
  document.getElementById('rd-header-title').textContent = idea.name;
  document.getElementById('rd-emoji').textContent = idea.emoji || 'ğŸ½';
  document.getElementById('rd-name').textContent = idea.name;

  // Meta
  const meta = [];
  if(idea.time) meta.push('â± ' + idea.time);
  if(idea.serves) meta.push('ğŸ‘¤ Serves ' + idea.serves);
  if(idea.difficulty) meta.push('âœ… ' + idea.difficulty);
  document.getElementById('rd-meta').innerHTML = meta.join('<span style="margin:0 4px;opacity:.3;">Â·</span>');

  // Macros
  document.getElementById('rd-macros').innerHTML = `
    <span style="background:rgba(232,201,122,0.15);border:1px solid rgba(232,201,122,0.3);border-radius:20px;padding:4px 12px;font-size:.76rem;color:var(--accent);font-weight:700;">ğŸ”¥ ${idea.cals} kcal</span>
    <span style="background:var(--surface2);border:1px solid var(--border);border-radius:20px;padding:4px 12px;font-size:.76rem;color:var(--text);">Protein ${idea.protein}</span>
    <span style="background:var(--surface2);border:1px solid var(--border);border-radius:20px;padding:4px 12px;font-size:.76rem;color:var(--text);">Carbs ${idea.carbs}</span>
    <span style="background:var(--surface2);border:1px solid var(--border);border-radius:20px;padding:4px 12px;font-size:.76rem;color:var(--text);">Fat ${idea.fat}</span>`;

  // Tags
  const tags = idea.tags || [];
  document.getElementById('rd-tags').innerHTML = tags.map(t =>
    `<span style="background:rgba(255,255,255,0.06);border:1px solid var(--border);border-radius:20px;padding:3px 10px;font-size:.72rem;color:var(--text-muted);">${t}</span>`
  ).join('');

  // Ingredients
  const ings = idea.ingredients || [];
  if(ings.length) {
    const portions = parseInt(localStorage.getItem('na_portions') || '4');
    document.getElementById('rd-ingredients').innerHTML = ings.map((ing, i) => `
      <div style="display:flex;align-items:center;gap:10px;padding:9px 0;${i < ings.length-1 ? 'border-bottom:1px solid var(--border)' : ''}">
        <div style="width:7px;height:7px;border-radius:50%;background:var(--accent);flex-shrink:0;"></div>
        <div style="font-size:.84rem;color:var(--text);">${ing}</div>
      </div>`).join('');
  } else {
    document.getElementById('rd-ingredients').innerHTML = '<div style="font-size:.82rem;color:var(--text-muted);">No ingredient list available.</div>';
  }

  // Steps
  const steps = idea.steps || [];
  if(steps.length) {
    document.getElementById('rd-steps').innerHTML = steps.map((step, i) => `
      <div style="display:flex;gap:12px;padding:10px 0;${i < steps.length-1 ? 'border-bottom:1px solid var(--border)' : ''}">
        <div style="flex-shrink:0;width:26px;height:26px;border-radius:50%;background:var(--accent);color:#1a1208;font-size:.76rem;font-weight:800;display:flex;align-items:center;justify-content:center;">${i+1}</div>
        <div style="font-size:.84rem;color:var(--text);line-height:1.6;padding-top:3px;">${step}</div>
      </div>`).join('');
  } else {
    document.getElementById('rd-steps').innerHTML = '<div style="font-size:.82rem;color:var(--text-muted);">No method available.</div>';
  }

  // Action buttons
  document.getElementById('rd-actions').innerHTML = `
    <button onclick="addMealToPlanner('${mealName.replace(/'/g,"\'")}','${mealType || section}')" style="flex:1;padding:14px;border:none;border-radius:var(--radius);background:var(--accent);color:#1a1208;font-size:.86rem;font-weight:700;cursor:pointer;">â• Add to Meal Plan</button>`;

  modal.style.display = 'block';
  modal.scrollTop = 0;
  document.body.style.overflow = 'hidden';
}

function closeRecipeDetail() {
  document.getElementById('recipe-detail-modal').style.display = 'none';
  document.body.style.overflow = '';
}


function toggleBasicTextAudio(){
  const el = document.getElementById('basic-text-audio');
  const arrow = document.getElementById('bt-toggle-arrow');
  if(!el) return;
  const shown = el.style.display !== 'none';
  el.style.display = shown ? 'none' : 'block';
  if(arrow) arrow.textContent = shown ? 'â–¾' : 'â–´';
}
// VIRTUAL MEETINGS
async function loadVirtualMeetings(){
  const c=document.getElementById('virtual-meetings-container');
  if(allMeetings.length>0){renderVirtualMeetings();return;}
  c.innerHTML='<div class="loading">Loading from virtual-na.org...</div>';
  try{
    const url='https://bmlt.virtual-na.org/main_server/client_interface/json/?switcher=GetSearchResults&lang_enum=en&data_field_key=id_bigint,meeting_name,start_time,weekday_tinyint,virtual_meeting_link,phone_meeting_number,comments&sort_results_by_distance=0';
    const r=await fetch(url);
    allMeetings=await r.json();
    renderVirtualMeetings();
  }catch(e){
    c.innerHTML=`<div class="card"><div class="card-title">Virtual NA Meetings</div><div class="card-text" style="margin-bottom:10px;">Browse hundreds of online NA meetings worldwide, sorted by day and time.</div><a href="https://virtual-na.org/meetings/" target="_blank" class="save-btn" style="display:block;text-decoration:none;text-align:center;">Open Virtual-NA.org</a></div>`;
  }
}
function renderVirtualMeetings(){
  const c=document.getElementById('virtual-meetings-container');
  let list=allMeetings;
  if(dayFilter!=='all')list=list.filter(m=>String(m.weekday_tinyint)===dayFilter);
  const shown=list.slice(0,50);
  if(!shown.length){c.innerHTML='<div class="loading">No meetings found for this day.</div>';return;}
  c.innerHTML=shown.map(m=>{
    const day=DAYS[m.weekday_tinyint]||'';
    const time=fmtTime(m.start_time);
    const tzShort=new Date().toLocaleTimeString('en-US',{timeZoneName:'short'}).split(' ').pop();
    const link=m.virtual_meeting_link||'';
    const phone=m.phone_meeting_number||'';
    return`<div class="meeting-card"><div class="meeting-name">${m.meeting_name||'NA Meeting'}</div><div class="meeting-meta">ğŸ“… ${day} at ${time} <span style="opacity:.6;font-size:.75em;">(${tzShort})</span>${phone?'<br>ğŸ“ '+phone:''}</div><span class="meeting-tag">ğŸŒ Virtual</span>${link?`<br><a href="${link}" target="_blank" class="meeting-link">Join Meeting â†’</a>`:''}</div>`;
  }).join('');
  if(list.length>50)c.innerHTML+=`<div style="text-align:center;padding:14px;"><a href="https://virtual-na.org/meetings/" target="_blank" style="color:var(--accent);font-size:.83rem;">View all ${list.length} meetings on Virtual-NA.org â†’</a></div>`;
}
function fmtTime(t){
  if(!t)return'';
  try{
    // BMLT API returns times in US Eastern time
    // Convert to user's local timezone
    const[h,mn]=t.split(':');
    const hr=parseInt(h);
    // Build a reference date in ET using today's date
    const now=new Date();
    const etString=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}T${String(hr).padStart(2,'0')}:${mn}:00`;
    // Get ET offset vs UTC
    const etRef=new Date(now.toLocaleString('en-US',{timeZone:'America/New_York'}));
    const utcRef=new Date(now.toLocaleString('en-US',{timeZone:'UTC'}));
    const offsetMins=Math.round((utcRef-etRef)/60000);
    // Build meeting time as if it's ET, shift to UTC, then display in local
    const meetingUTC=new Date(now);
    meetingUTC.setHours(hr,parseInt(mn),0,0);
    meetingUTC.setMinutes(meetingUTC.getMinutes()+offsetMins);
    return meetingUTC.toLocaleTimeString([],{hour:'numeric',minute:'2-digit',hour12:true});
  }catch(e){
    const[h,mn]=t.split(':');const hr=parseInt(h);
    return`${hr%12||12}:${mn} ${hr>=12?'PM':'AM'}`;
  }
}
function switchMeetingTab(tab){
  document.getElementById('tab-meetings').style.display = tab==='meetings' ? 'block' : 'none';
  document.getElementById('tab-events').style.display   = tab==='events'   ? 'block' : 'none';
  const mBtn = document.getElementById('tab-btn-meetings');
  const eBtn = document.getElementById('tab-btn-events');
  if(tab==='meetings'){
    mBtn.style.background=getComputedStyle(document.body).getPropertyValue('--accent').trim()||'#e8c97a';
    mBtn.style.color='#1a1208';
    eBtn.style.background='transparent';
    eBtn.style.color='var(--text-muted)';
  } else {
    eBtn.style.background=getComputedStyle(document.body).getPropertyValue('--accent').trim()||'#e8c97a';
    eBtn.style.color='#1a1208';
    mBtn.style.background='transparent';
    mBtn.style.color='var(--text-muted)';
  }
}
function filterMeetings(day,el){
  dayFilter=day;
  document.querySelectorAll('#day-filters .filter-chip').forEach(c=>c.classList.remove('active'));
  if(el)el.classList.add('active');
  renderVirtualMeetings();
}

// EVENTS
function renderEvents(){
  document.getElementById('events-container').innerHTML=`
    <div class="card" style="margin-bottom:12px;">
      <div class="card-title">ğŸŒ European NA Events</div>
      <div class="card-text" style="margin-bottom:10px;">Upcoming conventions & events from the European Delegates Meeting of NA.</div>
      <a href="https://edmna.org/events-calendar/" target="_blank" class="save-btn" style="display:block;text-decoration:none;text-align:center;">View Full Calendar at edmna.org</a>
    </div>`+
  EVENTS.map(e=>`
    <div class="event-card">
      <div class="event-date-block"><div class="event-month">${e.month}</div><div class="event-day">${e.day}</div></div>
      <div style="flex:1">
        <div class="event-name">${e.name}</div>
        <div class="event-loc">ğŸ“… ${e.dates}</div>
        <div class="event-loc">ğŸ“ ${e.location}</div>
        <div style="margin-top:6px;">
          <span class="meeting-tag">${e.type}</span>
          ${e.maps?`<a href="${e.maps}" target="_blank" class="meeting-link" style="margin-left:8px;font-size:.72rem;">ğŸ—º Map</a>`:''}
          ${e.link?`<a href="${e.link}" target="_blank" class="meeting-link" style="margin-left:8px;font-size:.72rem;">ğŸ“„ Info</a>`:''}
        </div>
      </div>
    </div>`).join('');
}

// SPONSOR
function renderSponsorScreen(){
  if(sponsor){
    document.getElementById('sponsor-setup').style.display='none';
    document.getElementById('sponsor-view').style.display='block';
    document.getElementById('sponsor-name-display').textContent=sponsor.name;
    document.getElementById('sponsor-phone-display').textContent=sponsor.phone;
    document.getElementById('sponsor-notes-display').textContent=sponsor.notes||'';
    document.getElementById('sponsor-call-btn').href='tel:'+sponsor.phone;
    renderContactLog();
  }else{
    document.getElementById('sponsor-setup').style.display='block';
    document.getElementById('sponsor-view').style.display='none';
  }
  renderMilestones();
}
function saveSponsor(){
  const name=document.getElementById('sponsor-name-input').value.trim();
  const phone=document.getElementById('sponsor-phone-input').value.trim();
  const notes=document.getElementById('sponsor-notes-input').value.trim();
  if(!name){alert('Please enter a name.');return;}
  sponsor={name,phone,notes};localStorage.setItem('na_sponsor',JSON.stringify(sponsor));
  renderSponsorScreen();showToast('Sponsor saved âœ“');
}
function editSponsor(){sponsor=null;localStorage.removeItem('na_sponsor');renderSponsorScreen();}
function logContact(){
  const text=document.getElementById('new-msg-input').value.trim();if(!text)return;
  contactLog.push({id:Date.now().toString(),date:new Date().toISOString(),text});
  localStorage.setItem('na_contacts',JSON.stringify(contactLog));
  document.getElementById('new-msg-input').value='';renderContactLog();showToast('Logged âœ“');
}
function renderContactLog(){
  const c=document.getElementById('msg-log-container');
  if(!contactLog.length){c.innerHTML='<div style="color:var(--text-muted);font-size:.76rem;padding-top:6px;">No contacts logged yet.</div>';return;}
  c.innerHTML='<div class="section-label" style="margin-top:0;">Previous contacts</div>'+[...contactLog].reverse().slice(0,10).map(x=>{
    const d=new Date(x.date);
    return`<div class="msg-item"><div class="msg-date">${d.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric',hour:'numeric',minute:'2-digit'})}</div><div class="msg-text">${x.text}</div></div>`;
  }).join('');
}

// MILESTONES
function renderMilestones(){
  const c=document.getElementById('milestones-container');
  const days=cleanDate?Math.max(0,Math.floor((Date.now()-new Date(cleanDate).getTime())/86400000)):0;
  c.innerHTML=MILESTONES.map(m=>{
    const achieved=days>=m.days;
    return`<div class="milestone-card" style="${achieved?'':'opacity:.45'}">
      <div class="milestone-num">${m.label}</div>
      <div class="milestone-label">${m.days} day${m.days!==1?'s':''}</div>
      ${achieved?`<div><div class="milestone-achieved">âœ“ Achieved</div></div><button class="share-milestone-btn" onclick="shareMilestone('${m.label}',${m.days})">Share This Milestone ğŸ‰</button>`:''}
    </div>`;
  }).join('');
}

// SHARE MILESTONE
function shareMilestone(label,days){
  const modal=document.getElementById('share-modal');
  const body=document.getElementById('share-modal-body');
  modal.classList.add('open');
  const canvas=document.getElementById('share-canvas');
  canvas.width=1080;canvas.height=1080;
  const ctx=canvas.getContext('2d');
  const g=ctx.createLinearGradient(0,0,1080,1080);
  g.addColorStop(0,'#0f0f1a');g.addColorStop(1,'#1a1a2e');
  ctx.fillStyle=g;ctx.fillRect(0,0,1080,1080);
  ctx.beginPath();ctx.arc(540,540,420,0,Math.PI*2);ctx.strokeStyle='rgba(232,201,122,0.2)';ctx.lineWidth=2;ctx.stroke();
  ctx.textAlign='center';ctx.fillStyle='#e8c97a';
  ctx.font='bold 90px Georgia';ctx.fillText('NA',540,430);
  ctx.font='300 56px Georgia';ctx.fillText(label,540,540);
  ctx.fillStyle='#f0ead6';ctx.font='28px Arial';ctx.fillText('Just For Today',540,630);
  ctx.fillStyle='rgba(232,201,122,0.5)';ctx.font='22px Arial';ctx.fillText('Narcotics Anonymous',540,700);
  const img=canvas.toDataURL('image/png');
  body.innerHTML=`<p style="color:var(--text-muted);font-size:.83rem;text-align:center;">Long-press to save, or download below</p><img src="${img}" style="width:100%;max-width:320px;border-radius:16px;box-shadow:0 8px 40px rgba(0,0,0,.4);"><a href="${img}" download="na-${days}-days.png" class="save-btn" style="display:block;text-decoration:none;text-align:center;max-width:300px;">Download Image</a>`;
}

// PRAYERS
function renderPrayers(){
  document.getElementById('prayers-container').innerHTML=PRAYERS.map((p,i)=>`
    <div class="prayer-card" onclick="togglePrayer(${i})">
      <div class="prayer-title">${p.title}<span class="prayer-chevron" id="chev-${i}">â–¾</span></div>
      <div class="prayer-text" id="ptext-${i}">${p.text}</div>
    </div>`).join('');
}
function togglePrayer(i){
  document.getElementById('ptext-'+i).classList.toggle('open');
  document.getElementById('chev-'+i).classList.toggle('open');
}

// TOAST
function showToast(msg){
  const t=document.createElement('div');t.textContent=msg;
  t.style.cssText='position:fixed;bottom:calc(80px + 8px);left:50%;transform:translateX(-50%);background:var(--accent);color:var(--bg);padding:8px 17px;border-radius:20px;font-size:.81rem;z-index:500;font-weight:500;white-space:nowrap;';
  document.body.appendChild(t);setTimeout(()=>t.remove(),2000);
}

// INIT
applyTheme();buildPinGrid();initHome();renderStepsList();renderPrayers();renderLOLTimes();
document.getElementById('pin-toggle').classList.toggle('on',pinEnabled);
if(pinEnabled)document.getElementById('pin-change-section').style.display='block';
document.getElementById('theme-toggle').classList.toggle('on',isDark);
if(pinEnabled&&savedPin)document.getElementById('pin-overlay').classList.remove('hidden');
</script>

  <!-- â•â• RECIPE DETAIL MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="recipe-detail-modal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:var(--bg);z-index:300;overflow-y:auto;">
    <div style="position:sticky;top:0;background:var(--bg);padding:14px 16px 10px;display:flex;align-items:center;gap:12px;border-bottom:1px solid var(--border);z-index:10;">
      <button onclick="closeRecipeDetail()" style="background:var(--surface2);border:none;border-radius:50%;width:36px;height:36px;font-size:1.1rem;cursor:pointer;color:var(--text);flex-shrink:0;">â†</button>
      <div id="rd-header-title" style="font-weight:700;font-size:.95rem;color:var(--text);flex:1;"></div>
    </div>
    <div style="padding:16px;">
      <!-- Hero -->
      <div style="text-align:center;font-size:4rem;margin:10px 0 6px;" id="rd-emoji"></div>
      <div style="font-size:1.1rem;font-weight:800;color:var(--text);text-align:center;margin-bottom:6px;" id="rd-name"></div>
      <div style="display:flex;justify-content:center;gap:12px;font-size:.76rem;color:var(--text-muted);margin-bottom:14px;" id="rd-meta"></div>

      <!-- Macros strip -->
      <div style="display:flex;gap:6px;justify-content:center;flex-wrap:wrap;margin-bottom:16px;" id="rd-macros"></div>

      <!-- Tags -->
      <div style="display:flex;gap:5px;flex-wrap:wrap;justify-content:center;margin-bottom:20px;" id="rd-tags"></div>

      <!-- Ingredients -->
      <div style="background:var(--surface);border-radius:16px;padding:16px;margin-bottom:14px;">
        <div style="font-size:.72rem;font-weight:800;color:var(--accent);text-transform:uppercase;letter-spacing:.07em;margin-bottom:12px;">ğŸ›’ Ingredients</div>
        <div id="rd-ingredients"></div>
      </div>

      <!-- Method -->
      <div style="background:var(--surface);border-radius:16px;padding:16px;margin-bottom:14px;">
        <div style="font-size:.72rem;font-weight:800;color:var(--accent);text-transform:uppercase;letter-spacing:.07em;margin-bottom:12px;">ğŸ‘¨â€ğŸ³ Method</div>
        <div id="rd-steps"></div>
      </div>

      <!-- Action buttons -->
      <div style="display:flex;gap:8px;margin-top:4px;" id="rd-actions"></div>
    </div>
  </div>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="NA Recovery">
<meta name="theme-color" content="#1a1a2e">
<title>NA Recovery</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#0f0f1a;--surface:#1a1a2e;--surface2:#16213e;
  --accent:#e8c97a;--text:#f0ead6;--text-muted:#8a8090;
  --border:rgba(232,201,122,0.15);--step-done:#4a7c59;
  --radius:16px;--nav-h:72px;
  --safe-top:env(safe-area-inset-top,20px);--safe-bottom:env(safe-area-inset-bottom,0px);
}
.light-mode{--bg:#f5f0e8;--surface:#fff;--surface2:#f0ebe0;--text:#1a1a2e;--text-muted:#6b6070;--border:rgba(100,80,60,0.15);}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);height:100dvh;overflow:hidden;position:fixed;width:100%;transition:background .3s,color .3s;}
body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse 80% 60% at 20% 10%,rgba(232,201,122,.06) 0%,transparent 60%),radial-gradient(ellipse 60% 80% at 80% 90%,rgba(100,80,160,.08) 0%,transparent 60%);pointer-events:none;z-index:0;}
#app{display:flex;flex-direction:column;height:100dvh;position:relative;z-index:1;}
.screen{display:none;flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:calc(var(--safe-top) + 16px) 20px calc(var(--nav-h) + var(--safe-bottom) + 16px);}
.screen.active{display:block;}
/* PIN */
#pin-overlay{position:fixed;inset:0;background:var(--bg);z-index:999;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:26px;padding:40px;}
#pin-overlay.hidden{display:none;}
.pin-title{font-family:'Cormorant Garamond',serif;font-size:2rem;font-weight:300;color:var(--accent);text-align:center;}
.pin-dots{display:flex;gap:16px;}
.pin-dot{width:14px;height:14px;border-radius:50%;border:2px solid var(--accent);background:transparent;transition:background .2s;}
.pin-dot.filled{background:var(--accent);}
.pin-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;width:100%;max-width:280px;}
.pin-btn{background:var(--surface);border:1px solid var(--border);border-radius:14px;color:var(--text);font-size:1.4rem;font-weight:300;padding:18px;cursor:pointer;transition:all .15s;text-align:center;}
.pin-btn:active{background:var(--accent);color:var(--bg);transform:scale(.95);}
.pin-error{color:#e74c3c;font-size:.8rem;min-height:20px;}
.pin-forgot{color:var(--accent);font-size:.8rem;cursor:pointer;text-decoration:underline;}
/* NAV */
nav{position:fixed;bottom:0;left:0;right:0;height:calc(var(--nav-h) + var(--safe-bottom));padding-bottom:var(--safe-bottom);background:rgba(15,15,26,.92);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-top:1px solid var(--border);display:flex;z-index:100;}
.light-mode nav{background:rgba(245,240,232,.95);}
.nav-item{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;cursor:pointer;color:var(--text-muted);font-size:.6rem;letter-spacing:.05em;text-transform:uppercase;transition:color .2s;-webkit-user-select:none;user-select:none;padding-bottom:4px;}
.nav-item.active{color:var(--accent);}
.nav-icon{font-size:1.3rem;line-height:1;}
/* TYPOGRAPHY */
.screen-title{font-family:'Cormorant Garamond',serif;font-size:2.1rem;font-weight:300;color:var(--accent);margin-bottom:4px;line-height:1.1;}
.screen-sub{color:var(--text-muted);font-size:.76rem;margin-bottom:22px;letter-spacing:.08em;text-transform:uppercase;}
.section-label{font-size:.7rem;text-transform:uppercase;letter-spacing:.1em;color:var(--text-muted);margin-bottom:8px;margin-top:18px;}
/* CARDS */
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:18px;margin-bottom:12px;}
.card-title{font-family:'Cormorant Garamond',serif;font-size:1.15rem;font-weight:400;color:var(--accent);margin-bottom:6px;}
.card-text{font-size:.86rem;color:var(--text-muted);line-height:1.6;}
/* HOME */
.home-hero{text-align:center;padding:20px 0 16px;}
.logo{font-family:'Cormorant Garamond',serif;font-size:3.2rem;font-weight:300;color:var(--accent);line-height:1;letter-spacing:-.02em;}
.tagline{color:var(--text-muted);font-size:.76rem;letter-spacing:.15em;text-transform:uppercase;margin-top:5px;}
.streak-card{background:linear-gradient(135deg,rgba(232,201,122,.12) 0%,rgba(100,80,160,.08) 100%);border:1px solid var(--border);border-radius:var(--radius);padding:18px;margin-bottom:14px;display:flex;align-items:center;gap:14px;}
.streak-num{font-family:'Cormorant Garamond',serif;font-size:3rem;font-weight:600;color:var(--accent);line-height:1;}
.streak-label{font-size:.68rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:.1em;}
.streak-sub{font-size:.8rem;color:var(--text);margin-top:3px;}
.quote-card{background:var(--surface2);border-left:3px solid var(--accent);border-radius:0 var(--radius) var(--radius) 0;padding:16px 18px;margin-bottom:14px;font-family:'Cormorant Garamond',serif;font-style:italic;font-size:1rem;line-height:1.6;color:var(--text);}
.quote-source{font-size:.7rem;color:var(--text-muted);font-style:normal;margin-top:5px;font-family:'DM Sans',sans-serif;}
.quick-actions{display:grid;grid-template-columns:1fr 1fr;gap:9px;margin-bottom:14px;}
.quick-btn{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:14px 10px;cursor:pointer;transition:all .2s;text-align:center;}
.quick-btn:active{transform:scale(.97);border-color:var(--accent);}
.quick-btn .qb-icon{font-size:1.6rem;margin-bottom:4px;}
.quick-btn .qb-label{font-size:.74rem;color:var(--text-muted);}
.crisis-banner{background:linear-gradient(135deg,rgba(192,57,43,.15),rgba(192,57,43,.05));border:1px solid rgba(192,57,43,.3);border-radius:var(--radius);padding:13px 16px;margin-bottom:14px;display:flex;align-items:center;gap:11px;}
.crisis-text{font-size:.81rem;line-height:1.5;}
.crisis-num{font-weight:500;color:#e74c3c;font-size:.92rem;}
/* MOOD */
.mood-row{display:flex;gap:7px;margin-bottom:12px;}
.mood-btn{flex:1;background:var(--surface2);border:1px solid var(--border);border-radius:11px;padding:10px 4px;text-align:center;cursor:pointer;transition:all .2s;}
.mood-btn.selected{border-color:var(--accent);background:rgba(232,201,122,.12);}
.mood-btn .mood-label{font-size:.58rem;color:var(--text-muted);margin-top:3px;display:block;}
.mood-history{display:flex;gap:6px;overflow-x:auto;padding-bottom:3px;}
.mood-pip{display:flex;flex-direction:column;align-items:center;gap:2px;flex-shrink:0;}
.mood-pip-date{font-size:.56rem;color:var(--text-muted);}
/* STEPS */
.step-item{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:15px 16px;margin-bottom:9px;cursor:pointer;display:flex;align-items:center;gap:13px;transition:all .2s;}
.step-item:active{transform:scale(.98);}
.step-num{font-family:'Cormorant Garamond',serif;font-size:1.6rem;font-weight:300;color:var(--accent);min-width:32px;text-align:center;line-height:1;}
.step-name{font-size:.86rem;font-weight:500;margin-bottom:2px;}
.step-preview{font-size:.74rem;color:var(--text-muted);}
.back-btn{display:flex;align-items:center;gap:7px;color:var(--accent);font-size:.83rem;cursor:pointer;margin-bottom:16px;background:none;border:none;-webkit-appearance:none;}
.step-full-title{font-family:'Cormorant Garamond',serif;font-size:1.65rem;font-weight:300;color:var(--accent);margin-bottom:13px;line-height:1.2;}
.prompts-title{font-size:.7rem;text-transform:uppercase;letter-spacing:.1em;color:var(--text-muted);margin-bottom:9px;margin-top:18px;}
.prompt-item{background:var(--surface2);border-radius:10px;padding:10px 12px;margin-bottom:6px;font-size:.82rem;color:var(--text);line-height:1.5;border-left:2px solid var(--accent);}
.journal-area{width:100%;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-family:'DM Sans',sans-serif;font-size:.86rem;line-height:1.6;padding:13px;resize:none;min-height:140px;margin-top:5px;outline:none;}
.journal-area:focus{border-color:var(--accent);}
.save-btn{width:100%;background:var(--accent);color:var(--bg);border:none;border-radius:var(--radius);padding:14px;font-family:'DM Sans',sans-serif;font-size:.86rem;font-weight:500;cursor:pointer;margin-top:9px;letter-spacing:.05em;transition:opacity .2s;}
.save-btn:active{opacity:.8;}
/* JOURNAL */
.journal-entry-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:15px 17px;margin-bottom:10px;cursor:pointer;}
.journal-date{font-size:.68rem;color:var(--text-muted);margin-bottom:4px;letter-spacing:.05em;}
.journal-preview{font-size:.84rem;line-height:1.5;color:var(--text);}
.new-entry-btn{position:fixed;bottom:calc(var(--nav-h) + var(--safe-bottom) + 16px);right:20px;width:52px;height:52px;border-radius:50%;background:var(--accent);color:var(--bg);border:none;font-size:1.6rem;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 20px rgba(232,201,122,.3);z-index:50;transition:transform .2s;}
.new-entry-btn:active{transform:scale(.9);}
/* MEETINGS */
.filter-row{display:flex;gap:7px;margin-bottom:14px;overflow-x:auto;padding-bottom:3px;-webkit-overflow-scrolling:touch;}
.filter-chip{background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:6px 13px;font-size:.74rem;color:var(--text-muted);cursor:pointer;white-space:nowrap;transition:all .2s;flex-shrink:0;}
.filter-chip.active{background:var(--accent);color:var(--bg);border-color:var(--accent);}
.meeting-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:15px 17px;margin-bottom:10px;}
.meeting-name{font-size:.9rem;font-weight:500;margin-bottom:4px;}
.meeting-meta{font-size:.74rem;color:var(--text-muted);line-height:1.8;}
.meeting-tag{display:inline-block;background:rgba(232,201,122,.1);border:1px solid var(--border);border-radius:4px;padding:2px 7px;font-size:.66rem;color:var(--accent);margin-right:3px;margin-top:4px;}
.meeting-link{display:inline-block;margin-top:8px;color:var(--accent);font-size:.79rem;text-decoration:none;}
.event-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:14px;margin-bottom:10px;display:flex;gap:12px;}
.event-date-block{background:rgba(232,201,122,.1);border:1px solid var(--border);border-radius:10px;min-width:48px;height:52px;display:flex;flex-direction:column;align-items:center;justify-content:center;flex-shrink:0;}
.event-month{font-size:.58rem;text-transform:uppercase;letter-spacing:.1em;color:var(--accent);}
.event-day{font-family:'Cormorant Garamond',serif;font-size:1.4rem;font-weight:600;color:var(--text);line-height:1;}
.event-name{font-size:.86rem;font-weight:500;margin-bottom:3px;}
.event-loc{font-size:.74rem;color:var(--text-muted);}
/* SPONSOR */
.sponsor-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:18px;margin-bottom:12px;}
.sponsor-name{font-family:'Cormorant Garamond',serif;font-size:1.3rem;color:var(--accent);margin-bottom:3px;}
.sponsor-phone{font-size:.83rem;color:var(--text-muted);}
.msg-item{background:var(--surface2);border-radius:10px;padding:10px 12px;margin-bottom:6px;}
.msg-date{font-size:.66rem;color:var(--text-muted);margin-bottom:3px;}
.msg-text{font-size:.82rem;line-height:1.5;}
.text-input{width:100%;background:var(--surface);border:1px solid var(--border);border-radius:12px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:.86rem;padding:11px 13px;outline:none;}
.text-input:focus{border-color:var(--accent);}
/* RESOURCES */
.resource-section{margin-bottom:24px;}
.resource-section-title{font-family:'Cormorant Garamond',serif;font-size:1.2rem;color:var(--accent);margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid var(--border);}
.resource-link-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:13px 16px;margin-bottom:8px;display:flex;align-items:center;gap:11px;cursor:pointer;text-decoration:none;color:var(--text);transition:border-color .2s;}
.resource-link-card:active{border-color:var(--accent);}
.resource-icon{font-size:1.25rem;}
.resource-name{font-size:.86rem;font-weight:500;}
.resource-desc{font-size:.71rem;color:var(--text-muted);margin-top:2px;}
/* PRAYERS */
.prayer-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:18px;margin-bottom:10px;cursor:pointer;}
.prayer-title{font-family:'Cormorant Garamond',serif;font-size:1.05rem;color:var(--accent);}
.prayer-chevron{float:right;color:var(--text-muted);transition:transform .2s;}
.prayer-chevron.open{transform:rotate(180deg);}
.prayer-text{font-size:.83rem;color:var(--text);line-height:1.7;display:none;margin-top:12px;white-space:pre-line;}
.prayer-text.open{display:block;}
/* MILESTONES */
.milestone-card{background:linear-gradient(135deg,rgba(232,201,122,.12),rgba(100,80,160,.08));border:1px solid var(--border);border-radius:var(--radius);padding:18px;text-align:center;margin-bottom:10px;}
.milestone-num{font-family:'Cormorant Garamond',serif;font-size:2.3rem;color:var(--accent);font-weight:600;}
.milestone-label{font-size:.74rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:.1em;margin-top:3px;}
.milestone-achieved{display:inline-block;background:var(--step-done);color:white;border-radius:20px;padding:3px 10px;font-size:.68rem;margin-top:7px;}
.share-milestone-btn{background:var(--surface);border:1px solid var(--accent);color:var(--accent);border-radius:10px;padding:8px 16px;font-size:.78rem;cursor:pointer;margin-top:9px;font-family:'DM Sans',sans-serif;}
/* SETTINGS */
.toggle-row{display:flex;align-items:center;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--border);}
.toggle-row:last-child{border-bottom:none;}
.toggle-label{font-size:.84rem;}
.toggle-sub{font-size:.7rem;color:var(--text-muted);margin-top:2px;}
.toggle{width:44px;height:24px;background:var(--surface2);border-radius:12px;border:1px solid var(--border);cursor:pointer;position:relative;transition:background .2s;flex-shrink:0;}
.toggle.on{background:var(--accent);border-color:var(--accent);}
.toggle::after{content:'';position:absolute;width:18px;height:18px;border-radius:50%;background:white;top:2px;left:2px;transition:transform .2s;}
.toggle.on::after{transform:translateX(20px);}
/* MODAL */
.modal{position:fixed;inset:0;background:var(--bg);z-index:200;display:none;flex-direction:column;padding-top:var(--safe-top);}
.modal.open{display:flex;}
.modal-header{display:flex;align-items:center;gap:11px;padding:13px 18px;border-bottom:1px solid var(--border);flex-shrink:0;}
.modal-title{font-family:'Cormorant Garamond',serif;font-size:1.2rem;color:var(--accent);flex:1;}
.modal-body{flex:1;overflow-y:auto;padding:18px;-webkit-overflow-scrolling:touch;}
.modal-close{background:none;border:none;color:var(--text-muted);font-size:1.4rem;cursor:pointer;padding:4px;}
.delete-btn{background:none;border:none;color:#e74c3c;font-size:.81rem;cursor:pointer;padding:8px;}
.loading{text-align:center;padding:28px;color:var(--text-muted);font-size:.83rem;}
::-webkit-scrollbar{width:3px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}
@keyframes fadeIn{from{opacity:0;transform:translateY(7px);}to{opacity:1;transform:translateY(0);}}
.screen.active>*{animation:fadeIn .3s ease forwards;}
</style>
</head>
<body>

<div id="pin-overlay" class="hidden">
  <div class="pin-title">NA Recovery</div>
  <p style="color:var(--text-muted);font-size:.82rem;">Enter your PIN</p>
  <div class="pin-dots" id="pin-dots">
    <div class="pin-dot" id="d0"></div><div class="pin-dot" id="d1"></div>
    <div class="pin-dot" id="d2"></div><div class="pin-dot" id="d3"></div>
  </div>
  <div class="pin-grid" id="pin-grid"></div>
  <div class="pin-error" id="pin-error"></div>
  <span class="pin-forgot" onclick="resetApp()">Forgot PIN? Reset app</span>
</div>

<!-- JOURNAL MODAL -->
<div class="modal" id="journal-modal">
  <div class="modal-header">
    <button class="modal-close" onclick="closeJournalModal()">â†</button>
    <div class="modal-title" id="journal-modal-title">Journal</div>
    <button class="delete-btn" id="journal-delete-btn" onclick="deleteCurrentEntry()">Delete</button>
  </div>
  <div class="modal-body">
    <div class="section-label" id="journal-modal-date" style="margin-top:0;"></div>
    <textarea class="journal-area" id="journal-modal-text" placeholder="Write your thoughts..." style="min-height:260px;"></textarea>
    <button class="save-btn" onclick="saveJournalModal()">Save Entry</button>
  </div>
</div>

<!-- SHARE MODAL -->
<div class="modal" id="share-modal">
  <div class="modal-header">
    <button class="modal-close" onclick="document.getElementById('share-modal').classList.remove('open')">â†</button>
    <div class="modal-title">Share Milestone</div>
  </div>
  <div class="modal-body" id="share-modal-body" style="display:flex;flex-direction:column;align-items:center;gap:16px;"></div>
</div>

<div id="app">
  <!-- HOME -->
  <div class="screen active" id="screen-home">
    <div class="home-hero">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div style="width:28px;"></div>
        <div class="logo">NA</div>
        <div onclick="toggleTheme()" style="cursor:pointer;font-size:1.2rem;width:28px;text-align:right;" id="theme-icon">â˜€ï¸</div>
      </div>
      <div class="tagline">One Day at a Time</div>
    </div>

    <div class="streak-card">
      <div>
        <div class="streak-num" id="days-count">0</div>
        <div class="streak-label">Days Clean</div>
      </div>
      <div style="flex:1">
        <div class="streak-sub" id="clean-since-label">Set your clean date</div>
        <input type="date" style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:.78rem;padding:7px 10px;width:100%;margin-top:7px;outline:none;" id="clean-date-input" onchange="saveCleanDate(this.value)">
      </div>
    </div>

    <div class="card">
      <div class="card-title">Today's Check-In</div>
      <div class="mood-row" id="mood-row">
        <div class="mood-btn" onclick="setMood('ğŸ˜”','Low')" data-mood="ğŸ˜”"><div style="font-size:1.3rem;">ğŸ˜”</div><span class="mood-label">Low</span></div>
        <div class="mood-btn" onclick="setMood('ğŸ˜','Okay')" data-mood="ğŸ˜"><div style="font-size:1.3rem;">ğŸ˜</div><span class="mood-label">Okay</span></div>
        <div class="mood-btn" onclick="setMood('ğŸ™‚','Good')" data-mood="ğŸ™‚"><div style="font-size:1.3rem;">ğŸ™‚</div><span class="mood-label">Good</span></div>
        <div class="mood-btn" onclick="setMood('ğŸ˜Š','Great')" data-mood="ğŸ˜Š"><div style="font-size:1.3rem;">ğŸ˜Š</div><span class="mood-label">Great</span></div>
        <div class="mood-btn" onclick="setMood('ğŸŒŸ','Amazing')" data-mood="ğŸŒŸ"><div style="font-size:1.3rem;">ğŸŒŸ</div><span class="mood-label">Amazing</span></div>
      </div>
      <div class="section-label" style="margin-top:4px;">Recent moods</div>
      <div class="mood-history" id="mood-history"></div>
    </div>

    <div class="quote-card" id="daily-quote">Loading...</div>

    <div class="quick-actions">
      <div class="quick-btn" onclick="showScreen('steps')"><div class="qb-icon">ğŸ“–</div><div class="qb-label">Step Work</div></div>
      <div class="quick-btn" onclick="openNewJournalEntry()"><div class="qb-icon">âœï¸</div><div class="qb-label">Daily Journal</div></div>
      <div class="quick-btn" onclick="showScreen('meetings')"><div class="qb-icon">ğŸ—“</div><div class="qb-label">Meetings</div></div>
      <div class="quick-btn" onclick="showScreen('sponsor')"><div class="qb-icon">ğŸ¤</div><div class="qb-label">My Sponsor</div></div>
    </div>

    <div class="crisis-banner">
      <div style="font-size:1.2rem;">ğŸ†˜</div>
      <div class="crisis-text">
        ğŸ‡¬ğŸ‡§ UK Helpline: <span class="crisis-num">0300 999 1212</span><br>
        <span style="font-size:.72rem;color:var(--text-muted);">10amâ€“midnight daily</span><br>
        ğŸŒ NA Help Line: <span class="crisis-num">1-818-773-9999</span>
      </div>
    </div>
  </div>

  <!-- STEPS -->
  <div class="screen" id="screen-steps">
    <div id="steps-list-view">
      <div class="screen-title">The 12 Steps</div>
      <div class="screen-sub">Your path to recovery</div>
      <div id="steps-container"></div>
    </div>
    <div id="step-detail-view" style="display:none;">
      <button class="back-btn" onclick="showStepsList()">â† All Steps</button>
      <div id="step-detail-content"></div>
    </div>
  </div>

  <!-- JOURNAL -->
  <div class="screen" id="screen-journal">
    <div class="screen-title">Journal</div>
    <div class="screen-sub">Your private reflections</div>
    <div id="journal-entries-container"></div>
    <button class="new-entry-btn" onclick="openNewJournalEntry()">+</button>
  </div>

  <!-- MEETINGS -->
  <div class="screen" id="screen-meetings">
    <div class="screen-title">Meetings</div>
    <div class="screen-sub">Find your people</div>
    <div class="filter-row" id="day-filters">
      <div class="filter-chip active" onclick="filterMeetings('all',this)">All Days</div>
      <div class="filter-chip" onclick="filterMeetings('1',this)">Sun</div>
      <div class="filter-chip" onclick="filterMeetings('2',this)">Mon</div>
      <div class="filter-chip" onclick="filterMeetings('3',this)">Tue</div>
      <div class="filter-chip" onclick="filterMeetings('4',this)">Wed</div>
      <div class="filter-chip" onclick="filterMeetings('5',this)">Thu</div>
      <div class="filter-chip" onclick="filterMeetings('6',this)">Fri</div>
      <div class="filter-chip" onclick="filterMeetings('7',this)">Sat</div>
    </div>
    <div class="card" style="margin-bottom:14px;">
      <div class="card-title">ğŸ” In-Person Meetings</div>
      <div class="card-text" style="margin-bottom:10px;">Find meetings near you via the official NA finder.</div>
      <a href="https://www.na.org/meetingsearch/" target="_blank" class="save-btn" style="display:block;text-decoration:none;text-align:center;margin-bottom:8px;">Open NA Meeting Finder</a>
      <a href="https://meetings.ukna.org/meeting/search" target="_blank" style="display:block;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:13px;text-decoration:none;text-align:center;color:var(--accent);font-size:.86rem;font-weight:500;">ğŸ‡¬ğŸ‡§ Find UK Meetings (ukna.org)</a>
    </div>

    <div class="card" style="margin-bottom:14px;">
      <div class="card-title">ğŸ‡¬ğŸ‡§ UK NA Events</div>
      <div class="card-text" style="margin-bottom:10px;">Conventions, speaker jams and fellowship events across the UK.</div>
      <a href="https://ukna.org/events" target="_blank" class="save-btn" style="display:block;text-decoration:none;text-align:center;">View UK Events Calendar</a>
    </div>
    <div class="section-label">Virtual NA Meetings (Live from virtual-na.org)</div>
    <div id="virtual-meetings-container"><div class="loading">Loading virtual meetings...</div></div>
    <div class="section-label" style="margin-top:18px;">Worldwide Local Events</div>
    <div class="card" style="margin-bottom:12px;">
      <div class="card-title">ğŸŒ NA Local Recovery Events</div>
      <div class="card-text" style="margin-bottom:10px;">Search for conventions, dances, speakers jams and recovery events near you â€” powered by NA World Services.</div>
      <a href="https://na.org/local-recovery-events/" target="_blank" class="save-btn" style="display:block;text-decoration:none;text-align:center;">Search Events Near Me</a>
    </div>
    <div class="section-label" style="margin-top:4px;">European NA Events (edmna.org)</div>
    <div id="events-container"></div>
  </div>

  <!-- SPONSOR -->
  <div class="screen" id="screen-sponsor">
    <div class="screen-title">My Sponsor</div>
    <div class="screen-sub">Your support network</div>
    <div id="sponsor-setup" style="display:none;">
      <div class="card">
        <div class="card-title">Add Your Sponsor</div>
        <div class="section-label" style="margin-top:0;">Name</div>
        <input type="text" class="text-input" id="sponsor-name-input" placeholder="Sponsor's name" style="margin-bottom:10px;">
        <div class="section-label" style="margin-top:0;">Phone</div>
        <input type="tel" class="text-input" id="sponsor-phone-input" placeholder="+1 555 000 0000" style="margin-bottom:10px;">
        <div class="section-label" style="margin-top:0;">Notes</div>
        <textarea class="journal-area" id="sponsor-notes-input" placeholder="Meeting times, notes..." style="min-height:80px;"></textarea>
        <button class="save-btn" onclick="saveSponsor()">Save Sponsor</button>
      </div>
    </div>
    <div id="sponsor-view" style="display:none;">
      <div class="sponsor-card">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;">
          <div><div class="sponsor-name" id="sponsor-name-display"></div><div class="sponsor-phone" id="sponsor-phone-display"></div></div>
          <button onclick="editSponsor()" style="background:none;border:1px solid var(--border);border-radius:8px;color:var(--text-muted);padding:5px 11px;font-size:.74rem;cursor:pointer;">Edit</button>
        </div>
        <div style="margin-top:8px;font-size:.8rem;color:var(--text-muted);" id="sponsor-notes-display"></div>
        <a id="sponsor-call-btn" href="" class="save-btn" style="display:block;text-decoration:none;text-align:center;margin-top:10px;">ğŸ“ Call Sponsor</a>
      </div>
      <div class="card">
        <div class="card-title">Contact Log</div>
        <div class="section-label" style="margin-top:0;">Log a contact</div>
        <textarea class="journal-area" id="new-msg-input" placeholder="Notes from this contact..." style="min-height:70px;"></textarea>
        <button class="save-btn" onclick="logContact()">Log Contact</button>
        <div id="msg-log-container" style="margin-top:12px;"></div>
      </div>
    </div>
    <div class="section-label">Clean Time Milestones</div>
    <div id="milestones-container"></div>
  </div>
<!-- RESOURCES -->
  <div class="screen" id="screen-resources">
    <div class="screen-title">Resources</div>
    <div class="screen-sub">Literature & support</div>
    <div class="crisis-banner">
      <div style="font-size:1.2rem;">ğŸ“</div>
      <div class="crisis-text">
        ğŸ‡¬ğŸ‡§ UK Helpline: <span class="crisis-num">0300 999 1212</span><br>
        <span style="font-size:.7rem;color:var(--text-muted);">10amâ€“midnight daily Â· low-cost from all phones</span><br>
        ğŸŒ NA Help Line: <span class="crisis-num">1-818-773-9999</span><br>
        <span style="font-size:.7rem;color:var(--text-muted);">Available 24/7</span>
      </div>
    </div>
    <div class="resource-section">
      <div class="resource-section-title">ğŸ™ Prayers & Traditions</div>
      <div id="prayers-container"></div>
    </div>
    <div class="resource-section">
      <div class="resource-section-title">ğŸ› NA Shop</div>
      <a href="https://www.na.org/shop/" target="_blank" class="resource-link-card">
        <div class="resource-icon">ğŸ“š</div><div><div class="resource-name">NA Literature Shop</div><div class="resource-desc">Basic Text, Step Working Guides, Keytags & more</div></div><div style="color:var(--text-muted);">â€º</div>
      </a>
      <a href="https://www.na.org/shop/" target="_blank" class="resource-link-card">
        <div class="resource-icon">ğŸ”‘</div><div><div class="resource-name">Recovery Keytags</div><div class="resource-desc">Celebrate milestones with official NA keytags</div></div><div style="color:var(--text-muted);">â€º</div>
      </a>
    </div>
    <div class="resource-section">
      <div class="resource-section-title">ğŸ“– Literature</div>
      <a href="https://www.na.org/?ID=daily-meditation" target="_blank" class="resource-link-card">
        <div class="resource-icon">ğŸŒ…</div><div><div class="resource-name">Just for Today</div><div class="resource-desc">Daily meditation from NA World Services</div></div><div style="color:var(--text-muted);">â€º</div>
      </a>
      <a href="https://www.na.org/?ID=ips-index" target="_blank" class="resource-link-card">
        <div class="resource-icon">ğŸ“„</div><div><div class="resource-name">IP Library</div><div class="resource-desc">Informational pamphlets on recovery topics</div></div><div style="color:var(--text-muted);">â€º</div>
      </a>
    </div>
    <div class="resource-section">
      <div class="resource-section-title">ğŸŒ Online</div>
      <a href="https://ukna.org" target="_blank" class="resource-link-card">
        <div class="resource-icon">ğŸ‡¬ğŸ‡§</div><div><div class="resource-name">UK NA (ukna.org)</div><div class="resource-desc">Official UK NA â€” meetings, events & helpline</div></div><div style="color:var(--text-muted);">â€º</div>
      </a>
      <a href="https://helpline.ukna.org" target="_blank" class="resource-link-card">
        <div class="resource-icon">ğŸ“</div><div><div class="resource-name">UK Helpline</div><div class="resource-desc">0300 999 1212 Â· 10amâ€“midnight daily</div></div><div style="color:var(--text-muted);">â€º</div>
      </a>
      <a href="https://na.org/local-recovery-events/" target="_blank" class="resource-link-card">
        <div class="resource-icon">ğŸ“…</div><div><div class="resource-name">NA Local Recovery Events</div><div class="resource-desc">Find conventions & events near you worldwide</div></div><div style="color:var(--text-muted);">â€º</div>
      </a>
      <a href="https://www.na.org" target="_blank" class="resource-link-card">
        <div class="resource-icon">ğŸŒ</div><div><div class="resource-name">NA World Services</div><div class="resource-desc">Official â€” na.org</div></div><div style="color:var(--text-muted);">â€º</div>
      </a>
      <a href="https://virtual-na.org/meetings/" target="_blank" class="resource-link-card">
        <div class="resource-icon">ğŸ’»</div><div><div class="resource-name">Virtual NA</div><div class="resource-desc">Online meetings worldwide â€” virtual-na.org</div></div><div style="color:var(--text-muted);">â€º</div>
      </a>
      <div class="section-label" style="margin-top:16px;">NA History & Speaker Recordings</div>
      <a href="https://www.nalongtimers.org" target="_blank" class="resource-link-card" style="flex-direction:column;align-items:flex-start;gap:10px;">
        <div style="display:flex;align-items:center;gap:12px;width:100%;">
          <div class="resource-icon">ğŸ™ï¸</div>
          <div style="flex:1;">
            <div class="resource-name">Loving Our Long-Timers</div>
            <div class="resource-desc">Speaker recordings & NA history from members with 30+ years clean</div>
          </div>
          <div style="color:var(--text-muted);">â€º</div>
        </div>
        <div style="background:rgba(232,201,122,0.08);border:1px solid var(--border);border-radius:10px;padding:10px 12px;width:100%;box-sizing:border-box;">
          <div style="font-size:.72rem;color:var(--accent);font-weight:600;margin-bottom:4px;">ğŸ“… Weekly Zoom Meetings</div>
          <div style="font-size:.75rem;color:var(--text-muted);line-height:1.6;" id="lol-times">Calculating your local times...</div>
          <a href="https://zoom.us/j/97488174579?pwd=UXpYUkRqZ1F6YWhMOVlmTFkybWk3Zz09" target="_blank"
             style="display:inline-block;margin-top:8px;background:var(--accent);color:#1a1208;font-size:.75rem;font-weight:700;padding:6px 14px;border-radius:20px;text-decoration:none;">
            Join Zoom Meeting â†—
          </a>
        </div>
      </a>
      <a href="https://www.inaorg.net" target="_blank" class="resource-link-card">
        <div class="resource-icon">ğŸ–¥</div><div><div class="resource-name">Internet NA (iNA)</div><div class="resource-desc">Online NA community</div></div><div style="color:var(--text-muted);">â€º</div>
      </a>
    </div>
    <div class="resource-section">
      <div class="resource-section-title">âš™ï¸ Settings</div>
      <div class="card">
        <div class="toggle-row">
          <div><div class="toggle-label">PIN Lock</div><div class="toggle-sub">Protect app with a 4-digit PIN</div></div>
          <div class="toggle" id="pin-toggle" onclick="togglePinLock()"></div>
        </div>
        <div id="pin-change-section" style="display:none;padding-top:12px;">
          <div class="section-label" style="margin-top:0;">Set PIN</div>
          <input type="number" id="new-pin-input" placeholder="4-digit PIN" class="text-input" style="-webkit-appearance:none;margin-bottom:8px;">
          <button class="save-btn" onclick="saveNewPin()">Save PIN</button>
        </div>
        <div class="toggle-row">
          <div><div class="toggle-label">Dark Mode</div><div class="toggle-sub">Toggle light / dark theme</div></div>
          <div class="toggle" id="theme-toggle" onclick="toggleTheme()"></div>
        </div>
      </div>
    </div>
  </div>

  <nav>
    <div class="nav-item active" id="nav-home" onclick="showScreen('home')"><div class="nav-icon">ğŸ </div><div>Home</div></div>
    <div class="nav-item" id="nav-steps" onclick="showScreen('steps')"><div class="nav-icon">ğŸ“–</div><div>Steps</div></div>
    <div class="nav-item" id="nav-journal" onclick="showScreen('journal')"><div class="nav-icon">âœï¸</div><div>Journal</div></div>
    <div class="nav-item" id="nav-meetings" onclick="showScreen('meetings')"><div class="nav-icon">ğŸ—“</div><div>Meetings</div></div>
    <div class="nav-item" id="nav-sponsor" onclick="showScreen('sponsor')"><div class="nav-icon">ğŸ¤</div><div>Sponsor</div></div>
    <div class="nav-item" id="nav-resources" onclick="showScreen('resources')"><div class="nav-icon">ğŸ“¦</div><div>Resources</div></div>
  </nav>
</div>

<canvas id="share-canvas" style="display:none;"></canvas>

<script>
const STEPS=[
{num:1,name:"Admitted powerlessness",short:"We admitted we were powerless over our addiction",full:"We admitted we were powerless over our addiction, that our lives had become unmanageable.",
sections:[
{title:"Powerlessness",qs:[
"What substances or behaviours have I tried to control, and failed?",
"Can I think of times I kept using even when I desperately did not want to? What happened?",
"What have I lost because of my addiction â€” relationships, jobs, health, trust?",
"How did my addiction take over my thinking, even when I was not using?",
"What does the word powerless genuinely mean to me, not as a concept but in my own lived experience?"
]},
{title:"Unmanageability",qs:[
"In what ways did my life fall apart because of my addiction â€” at home, at work, financially, emotionally?",
"How did I behave during my addiction that I am not proud of?",
"How did my addiction affect the people closest to me?",
"What did I do to hide the chaos my addiction was causing?",
"Looking back, what signs of unmanageability was I ignoring or explaining away?"
]},
{title:"Honesty",qs:[
"Have I been fully honest with myself about how bad things really got?",
"What excuses or stories did I tell myself to justify carrying on?",
"Who did I deceive during my addiction, and how?",
"What is the single hardest truth about my addiction that I have struggled to admit?"
]},
{title:"Surrender",qs:[
"What does surrender mean to me â€” does it feel like defeat, or relief, or something else?",
"What finally broke through my denial and brought me to this point?",
"Is there anything I am still holding on to that I have not fully let go of?",
"What would complete surrender look like for me in everyday life?",
"In my own words, what is my understanding of Step One?"
]}
]},
{num:2,name:"Came to believe",short:"Came to believe in a Power greater than ourselves",full:"We came to believe that a Power greater than ourselves could restore us to sanity.",
sections:[
{title:"Hope",qs:[
"When I first came into recovery, what gave me even a small glimmer of hope?",
"What do I have genuine hope about in my life today?",
"Have I seen recovery work for others? What did witnessing that show me?"
]},
{title:"Sanity",qs:[
"Looking back honestly, what behaviours or thought patterns would I now call insane?",
"How did my addiction distort the way I saw myself and the world?",
"What would a sane life actually feel like to me?",
"In what small ways is sanity already returning in my life?"
]},
{title:"A Higher Power",qs:[
"Do I have resistance to the idea of a Power greater than myself? Where does that resistance come from?",
"What could a Power greater than myself mean to me â€” it does not have to be religious?",
"What qualities would I want that Power to have?",
"Have I seen something at work in my recovery that feels bigger than human willpower alone?"
]},
{title:"Coming to Believe",qs:[
"Do I feel I have to force belief, or can I simply stay open to the possibility?",
"What small changes in my life might suggest something greater is at work?",
"What would it mean for my recovery if I genuinely believed help was available to me?",
"In my own words, what is my understanding of Step Two?"
]}
]},
{num:3,name:"Made a decision",short:"Made a decision to turn our will over",full:"We made a decision to turn our will and our lives over to the care of God as we understood Him.",
sections:[
{title:"The Decision",qs:[
"What does deciding to turn my will over actually mean in day-to-day life?",
"What makes this decision difficult for me?",
"Can I make this decision just for today, without worrying about forever?",
"What one concrete action today would reflect this decision?"
]},
{title:"Self-Will",qs:[
"What does self-will look like in my own life â€” what does it drive me to do?",
"When have I forced an outcome and made things worse?",
"Where do I most struggle to let go of control?",
"What is the difference between healthy effort and trying to manage everything?"
]},
{title:"My Understanding of a Higher Power",qs:[
"What does the care of God as I understand Him mean to me personally?",
"How do I try to communicate with my Higher Power?",
"How do I try to listen for guidance from something greater than myself?",
"How has my understanding of a Higher Power developed since I came into recovery?"
]},
{title:"Turning It Over",qs:[
"What does turning it over look like day to day â€” what do I actually do?",
"Which parts of my life am I most reluctant to hand over? Why?",
"Have there been times I let go and things worked out better than if I had tried to control them?",
"In my own words, what is my understanding of Step Three?"
]}
]},
{num:4,name:"Made a searching inventory",short:"Made a searching and fearless moral inventory",full:"We made a searching and fearless moral inventory of ourselves.",
sections:[
{title:"Getting Started",qs:[
"What does searching and fearless mean to me when it comes to looking at myself?",
"What am I most afraid of finding when I look honestly inward?",
"How have I prepared for this step, and am I working it with my sponsor?"
]},
{title:"Resentments",qs:[
"Who am I holding resentments towards, and what happened?",
"How have these resentments shaped my behaviour and my relationships?",
"What was my own part in each situation I feel resentful about?",
"What organisations, systems, or principles do I resent, and why?"
]},
{title:"Fears",qs:[
"What am I afraid of? Can I make as honest and complete a list as possible?",
"How have my fears shaped my decisions and actions over the years?",
"Which fears have caused the most harm in my life?",
"Where do I think my deepest fears originally come from?"
]},
{title:"Harms to Others",qs:[
"Where have I been selfish or self-seeking, and how did that affect people around me?",
"Where have I been dishonest, and who was hurt by it?",
"Have I been thoughtless or inconsiderate? What were the consequences?",
"Have I taken things from others that were not mine to take?"
]},
{title:"Patterns",qs:[
"What patterns do I notice running through my inventory?",
"What has this process revealed about myself that I had not fully seen before?",
"In my own words, what is my understanding of Step Four?"
]}
]},
{num:5,name:"Admitted wrongs to God",short:"Admitted the exact nature of our wrongs",full:"We admitted to God, to ourselves, and to another human being the exact nature of our wrongs.",
sections:[
{title:"Preparing",qs:[
"Why do I need to share this with another person â€” why is keeping it private not enough?",
"Who have I chosen to hear my Fifth Step, and why do I trust them?",
"Is there anything I am tempted to leave out? Why?"
]},
{title:"The Experience",qs:[
"How did it feel to say these things out loud to another person?",
"Was there anything harder to share than I expected?",
"Was anything left unsaid that still needs to be spoken?"
]},
{title:"Afterwards",qs:[
"How do I feel now that I have completed this step?",
"Did I sit quietly afterwards and reflect? What came up for me?",
"What patterns or character defects became clearest through this process?",
"Do I feel any freer, or more connected, after doing this work?",
"In my own words, what is my understanding of Step Five?"
]}
]},
{num:6,name:"Ready to have defects removed",short:"Were entirely ready to have our defects removed",full:"We were entirely ready to have God remove all these defects of character.",
sections:[
{title:"Identifying Defects",qs:[
"What character defects have become clear to me through Steps Four and Five?",
"Which ones have caused the most harm to myself and to others?",
"Are there any I was not aware of before going through this process?"
]},
{title:"Becoming Ready",qs:[
"Which defects am I most reluctant to let go of, and honestly why?",
"What have these defects given me? How have they protected or served me?",
"What would my life look and feel like if these defects were genuinely removed?",
"Am I entirely ready, or are there defects I am quietly hoping to keep?",
"What does entirely ready really mean to me?"
]},
{title:"Willingness",qs:[
"How do I cultivate willingness when I do not naturally feel it?",
"How do I become ready to let go of something I am afraid to lose?",
"In my own words, what is my understanding of Step Six?"
]}
]},
{num:7,name:"Humbly asked God",short:"Humbly asked Him to remove our shortcomings",full:"We humbly asked Him to remove our shortcomings.",
sections:[
{title:"Humility",qs:[
"What does humility genuinely mean to me?",
"How is humility different from humiliation, weakness, or low self-worth?",
"How has my understanding of humility changed since coming into recovery?",
"In what ways does pride or ego still get in the way of my recovery?"
]},
{title:"Asking",qs:[
"Have I actually asked my Higher Power to remove my shortcomings, or just thought about it?",
"Do I believe I deserve help with the parts of myself I am least proud of?",
"What does it feel like to genuinely ask for help with my own character?"
]},
{title:"Results",qs:[
"Have I noticed any shortcomings beginning to ease or lessen? Which ones?",
"Which shortcomings keep returning despite my efforts?",
"How has my behaviour or thinking shifted through working this step?",
"In my own words, what is my understanding of Step Seven?"
]}
]},
{num:8,name:"Made a list of those harmed",short:"Made a list of all persons we had harmed",full:"We made a list of all persons we had harmed, and became willing to make amends to them all.",
sections:[
{title:"The List",qs:[
"What does harm mean to me â€” physical, emotional, financial, relational, spiritual?",
"Who have I hurt through my addiction and my behaviour?",
"Have I included myself on this list?",
"Is there anyone I have left off because I am afraid, or because I feel they wronged me first?",
"Have I worked through this list honestly with my sponsor?"
]},
{title:"Becoming Willing",qs:[
"Am I genuinely willing to make amends to everyone on my list?",
"Is there anyone I am not yet willing to approach? What would help me get there?",
"What is the difference between writing the list and actually becoming willing?",
"How do I cultivate willingness when I do not naturally feel it?"
]},
{title:"Reflection",qs:[
"What does making this list bring up for me emotionally?",
"In my own words, what is my understanding of Step Eight?"
]}
]},
{num:9,name:"Made direct amends",short:"Made direct amends wherever possible",full:"We made direct amends to such people wherever possible, except when to do so would injure them or others.",
sections:[
{title:"Making Amends",qs:[
"What is the difference between making amends and simply saying sorry?",
"Have I talked through each amends with my sponsor before approaching anyone?",
"Are there amends where reaching out could cause further harm? How will I handle those?",
"What does a genuine amends actually look and sound like?"
]},
{title:"Working Through the List",qs:[
"Which amends have I made so far, and what happened?",
"How did I feel before, during, and after each one?",
"Which amends am I putting off, and what is really stopping me?",
"Are there financial amends I need to make? What is my honest plan for those?"
]},
{title:"Living Amends",qs:[
"What does a living amends mean â€” how am I changing my actual behaviour?",
"How are my relationships shifting as I work through this step?",
"Have any amends been poorly received? How did I handle that?",
"In my own words, what is my understanding of Step Nine?"
]}
]},
{num:10,name:"Continued personal inventory",short:"Continued to take personal inventory",full:"We continued to take personal inventory and when we were wrong, promptly admitted it.",
sections:[
{title:"Daily Inventory",qs:[
"What does a continuing daily inventory look like for me in practice?",
"When during the day do I pause and take stock of my thoughts, feelings and actions?",
"Am I honest in my ongoing inventory, or do I still minimise and rationalise?",
"What questions do I ask myself at the end of each day?"
]},
{title:"Promptly Admitting Wrongs",qs:[
"When I am wrong, how quickly do I admit it?",
"What gets in the way of admitting things promptly â€” pride, shame, fear?",
"How do I put things right when I have harmed someone during the day?",
"Am I carrying any resentments that have quietly built up and need addressing?"
]},
{title:"Patterns and Growth",qs:[
"What patterns keep showing up when I take honest inventory?",
"Where have I seen genuine growth and change in myself?",
"Where am I still struggling and need to keep working?",
"In my own words, what is my understanding of Step Ten?"
]}
]},
{num:11,name:"Sought spiritual contact",short:"Sought to improve our conscious contact with God",full:"We sought through prayer and meditation to improve our conscious contact with God as we understood Him, praying only for knowledge of His will for us and the power to carry that out.",
sections:[
{title:"Prayer",qs:[
"What does prayer mean to me, and what does it actually look like in my life?",
"Do I pray when things are going well, or mainly when I am struggling?",
"What do I pray for? Has this changed since I came into recovery?",
"How do I recognise when something I have prayed about has shifted?"
]},
{title:"Meditation",qs:[
"What does meditation mean to me, and what forms have I tried?",
"What gets in the way of a consistent meditation practice?",
"How does quieting my mind help me connect with something greater than myself?"
]},
{title:"Conscious Contact",qs:[
"What does conscious contact with a Higher Power feel like to me?",
"How has that sense of contact grown since I began working the steps?",
"What do I do when I feel cut off or disconnected from my Higher Power?",
"How does my Higher Power seem to guide or communicate with me?"
]},
{title:"Guidance",qs:[
"What does knowledge of God's will mean to me in ordinary everyday terms?",
"How do I tell the difference between my own will and something that feels like genuine guidance?",
"How do I seek direction when facing an important or difficult decision?",
"In my own words, what is my understanding of Step Eleven?"
]}
]},
{num:12,name:"Spiritual awakening",short:"Having had a spiritual awakening â€” carry the message",full:"Having had a spiritual awakening as a result of these steps, we tried to carry this message to addicts, and to practise these principles in all our affairs.",
sections:[
{title:"Spiritual Awakening",qs:[
"What does a spiritual awakening mean to me personally?",
"How is my life genuinely different today compared to when I first came into NA?",
"What specific shifts have I noticed in how I think, feel, and behave?",
"Do I feel a sense of purpose or meaning today that I did not have before?"
]},
{title:"Carrying the Message",qs:[
"How do I carry the message to other addicts in my day-to-day life?",
"What service commitments do I have, and why do they matter to my own recovery?",
"Have I sponsored anyone, or considered it? What holds me back if not?",
"What is the difference between carrying the message and giving advice or trying to control someone?"
]},
{title:"Practising the Principles",qs:[
"What does practising these principles in all our affairs look like in real life for me?",
"In which areas of my life do I find it hardest to live out what I have learned in recovery?",
"How have the steps changed my relationships with family, friends, and colleagues?",
"How do I apply what I have learned when life gets genuinely difficult?"
]},
{title:"Gratitude and Growth",qs:[
"What am I most genuinely grateful for in my recovery?",
"What would I say to someone walking through the door of NA for the very first time?",
"How do I keep growing spiritually on an ongoing basis?",
"In my own words, what is my understanding of Step Twelve?"
]}
]}
]
const QUOTES=[{text:"We admitted we were powerless over our addiction â€” that our lives had become unmanageable.",source:"Step One, NA"},{text:"Just for today, I will try to live through this day only.",source:"Just for Today"},{text:"The foundation of recovery is honesty.",source:"NA Basic Text"},{text:"Recovery is a process, not an event.",source:"NA Fellowship"},{text:"Keep coming back â€” it works if you work it.",source:"NA Fellowship"},{text:"One day at a time.",source:"NA Fellowship"},{text:"We come to know happiness, joy, and freedom.",source:"Narcotics Anonymous"},{text:"We do not have to be alone anymore.",source:"NA Basic Text"},{text:"The most important thing I can do for my recovery today is to not use, no matter what.",source:"NA Fellowship"},{text:"Pain is inevitable; suffering is optional.",source:"NA Fellowship"}];

const PRAYERS=[{title:"Serenity Prayer",text:"God, grant me the serenity to accept the things I cannot change,\nCourage to change the things I can,\nAnd wisdom to know the difference."},{title:"Third Step Prayer",text:"Take my will and my life. Guide me in my recovery. Show me how to live."},{title:"Seventh Step Prayer",text:"My Creator, I am now willing that you should have all of me, good and bad. I pray that you now remove from me every single defect of character which stands in the way of my usefulness to you and my fellows. Grant me strength, as I go out from here, to do your bidding. Amen."},{title:"Just for Today (Full)",text:"Just for today, my thoughts will be on my recovery, living and enjoying life without the use of drugs.\nJust for today, I will have faith in someone in NA who believes in me and wants to help me in my recovery.\nJust for today, I will have a program. I will try to follow it to the best of my ability.\nJust for today, through NA, I will try to get a better perspective on my life.\nJust for today, I will be unafraid. My thoughts will be on my new associations, people who are not using and who have found a new way of life."},{title:"The 12 Traditions",text:"1. Our common welfare should come first.\n2. Our leaders are but trusted servants.\n3. The only requirement for membership is a desire to stop using.\n4. Each group should be autonomous.\n5. Each group has but one primary purpose â€” to carry the message.\n6. NA ought never endorse, finance, or lend the NA name to any outside enterprise.\n7. Every NA group ought to be fully self-supporting.\n8. NA should remain forever nonprofessional.\n9. NA, as such, ought never be organized.\n10. NA has no opinion on outside issues.\n11. Our public relations policy is based on attraction rather than promotion.\n12. Anonymity is the spiritual foundation of all our traditions."},{title:"Acceptance Prayer",text:"Nothing, absolutely nothing, happens in God's world by mistake.\nUntil I could accept my addiction, I could not stay clean.\nUnless I accept life completely on life's terms, I cannot be happy.\nI need to concentrate not so much on what needs to be changed in the world,\nas on what needs to be changed in me and my attitudes."}];

const MILESTONES=[{days:1,label:"24 Hours"},{days:7,label:"1 Week"},{days:30,label:"30 Days"},{days:60,label:"60 Days"},{days:90,label:"90 Days"},{days:180,label:"6 Months"},{days:270,label:"9 Months"},{days:365,label:"1 Year"},{days:547,label:"18 Months"},{days:730,label:"2 Years"},{days:1095,label:"3 Years"},{days:1825,label:"5 Years"},{days:3650,label:"10 Years"}];

const EVENTS=[
  {name:"NA Group Assembly â€” The Power of Sponsorship",month:"FEB",day:"27",dates:"Feb 27 â€“ Mar 1, 2026",location:"Starachowice, Poland",type:"Assembly",maps:"https://maps.app.goo.gl/k6LqFPkCNpQQ5p4m6"},
  {name:"Ski & Recovery Norway",month:"MAR",day:"9",dates:"Mar 9â€“14, 2026",location:"Trysil, Norway",type:"Convention",link:"https://edmna.org/wp-content/uploads/2026/02/NA_Sky_and_Recovery.pdf"},
  {name:"NA Czecho-Slovak Convention",month:"MAY",day:"22",dates:"May 22â€“24, 2026",location:"Theatre X10, Prague, Czech Republic",type:"Convention",maps:"https://maps.app.goo.gl/YcawY7MvcaQaUD6m7"},
  {name:"NA UK Convention",month:"JUL",day:"2",dates:"Jul 2â€“5, 2026",location:"Hilton Birmingham Metropol, B40 1PP",type:"Convention",maps:"https://maps.app.goo.gl/Wuhuga3541NZhcbw5"},
  {name:"ECCNA 41",month:"JUL",day:"10",dates:"Jul 10â€“12, 2026",location:"Imi Forum, Stavanger, Norway",type:"Convention",maps:"https://maps.app.goo.gl/CEnmBfBpg5As7SSAA"},
  {name:"NA Youth Convention",month:"AUG",day:"14",dates:"Aug 14â€“16, 2026",location:"Ellertshaar, The Netherlands",type:"Convention",maps:"https://maps.app.goo.gl/kRGDx5U1KXiFA9YCA"},
  {name:"CENA 2026",month:"AUG",day:"28",dates:"Aug 28â€“30, 2026",location:"Up Event Space, Budapest, Hungary",type:"Convention",maps:"https://maps.app.goo.gl/FiGwhX8UMPWApqUv7"}
];

const DAYS={1:"Sunday",2:"Monday",3:"Tuesday",4:"Wednesday",5:"Thursday",6:"Friday",7:"Saturday"};

// STATE
let journalEntries=JSON.parse(localStorage.getItem('na_journal')||'[]');
let stepJournals=JSON.parse(localStorage.getItem('na_step_journals')||'{}');
let pinEnabled=localStorage.getItem('na_pin_enabled')==='true';
let savedPin=localStorage.getItem('na_pin')||'';
let cleanDate=localStorage.getItem('na_clean_date')||'';
let moodLog=JSON.parse(localStorage.getItem('na_moods')||'[]');
let sponsor=JSON.parse(localStorage.getItem('na_sponsor')||'null');
let contactLog=JSON.parse(localStorage.getItem('na_contacts')||'[]');
let isDark=localStorage.getItem('na_theme')!=='light';
let currentJournalId=null;
let allMeetings=[];
let dayFilter='all';
let pinInput='';

// THEME
function applyTheme(){
  document.body.classList.toggle('light-mode',!isDark);
  document.getElementById('theme-icon').textContent=isDark?'â˜€ï¸':'ğŸŒ™';
  const tt=document.getElementById('theme-toggle');
  if(tt)tt.classList.toggle('on',isDark);
}
function toggleTheme(){isDark=!isDark;localStorage.setItem('na_theme',isDark?'dark':'light');applyTheme();}

// PIN
function buildPinGrid(){
  const g=document.getElementById('pin-grid');
  [1,2,3,4,5,6,7,8,9,'',0,'âŒ«'].forEach(n=>{
    const b=document.createElement('button');
    b.className='pin-btn';b.textContent=n;
    if(n===''){b.style.opacity='0';b.style.pointerEvents='none';}
    b.onclick=()=>handlePinInput(n);g.appendChild(b);
  });
}
function handlePinInput(v){
  if(v==='âŒ«')pinInput=pinInput.slice(0,-1);
  else if(pinInput.length<4&&v!=='')pinInput+=v;
  updatePinDots();if(pinInput.length===4)setTimeout(checkPin,100);
}
function updatePinDots(){for(let i=0;i<4;i++)document.getElementById('d'+i).classList.toggle('filled',i<pinInput.length);}
function checkPin(){
  if(pinInput===savedPin){document.getElementById('pin-error').textContent='';document.getElementById('pin-overlay').classList.add('hidden');}
  else{document.getElementById('pin-error').textContent='Incorrect PIN. Try again.';pinInput='';updatePinDots();}
}
function resetApp(){if(confirm('This will clear ALL your data. Are you sure?')){localStorage.clear();location.reload();}}
function togglePinLock(){
  pinEnabled=!pinEnabled;
  document.getElementById('pin-toggle').classList.toggle('on',pinEnabled);
  document.getElementById('pin-change-section').style.display=pinEnabled?'block':'none';
  if(!pinEnabled){localStorage.setItem('na_pin_enabled','false');localStorage.removeItem('na_pin');savedPin='';}
}
function saveNewPin(){
  const v=document.getElementById('new-pin-input').value;
  if(v.length!==4||isNaN(v)){alert('Please enter a valid 4-digit PIN');return;}
  savedPin=v;localStorage.setItem('na_pin',v);localStorage.setItem('na_pin_enabled','true');
  document.getElementById('pin-change-section').style.display='none';showToast('PIN saved âœ“');
}

// NAV
function showScreen(name){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.getElementById('screen-'+name).classList.add('active');
  const nav=document.getElementById('nav-'+name);if(nav)nav.classList.add('active');
  if(name==='journal')renderJournalList();
  if(name==='steps')showStepsList();
  if(name==='meetings'){renderEvents();loadVirtualMeetings();}
  if(name==='sponsor')renderSponsorScreen();
  if(name==='resources')renderLOLTimes();
}

// HOME
function initHome(){
  if(cleanDate){document.getElementById('clean-date-input').value=cleanDate;updateDaysCount();}
  const q=QUOTES[new Date().getDate()%QUOTES.length];
  document.getElementById('daily-quote').innerHTML=`"${q.text}"<div class="quote-source">â€” ${q.source}</div>`;
  renderMoodHistory();markTodayMood();
}
function saveCleanDate(v){cleanDate=v;localStorage.setItem('na_clean_date',v);updateDaysCount();renderMilestones();}
function updateDaysCount(){
  if(!cleanDate)return;
  const diff=Math.floor((Date.now()-new Date(cleanDate).getTime())/86400000);
  document.getElementById('days-count').textContent=Math.max(0,diff);
  document.getElementById('clean-since-label').textContent=diff>=0?`Since ${new Date(cleanDate).toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'})}`:'Invalid date';
}

// MOOD
function setMood(emoji,label){
  const today=new Date().toDateString();
  moodLog=moodLog.filter(m=>m.date!==today);
  moodLog.push({date:today,emoji,label});
  if(moodLog.length>30)moodLog=moodLog.slice(-30);
  localStorage.setItem('na_moods',JSON.stringify(moodLog));
  markTodayMood();renderMoodHistory();showToast('Mood logged '+emoji);
}
function markTodayMood(){
  const today=new Date().toDateString();
  const tm=moodLog.find(m=>m.date===today);
  document.querySelectorAll('.mood-btn').forEach(b=>b.classList.toggle('selected',tm&&b.dataset.mood===tm.emoji));
}
function renderMoodHistory(){
  const c=document.getElementById('mood-history');
  const r=[...moodLog].slice(-14).reverse();
  if(!r.length){c.innerHTML='<span style="color:var(--text-muted);font-size:.76rem;">No moods logged yet</span>';return;}
  c.innerHTML=r.map(m=>{const d=new Date(m.date);return`<div class="mood-pip"><div style="font-size:1.1rem;">${m.emoji}</div><div class="mood-pip-date">${d.toLocaleDateString('en-US',{month:'numeric',day:'numeric'})}</div></div>`;}).join('');
}

// STEPS
function renderStepsList(){
  const c=document.getElementById('steps-container');c.innerHTML='';
  STEPS.forEach(s=>{
    const d=document.createElement('div');d.className='step-item';d.onclick=()=>showStepDetail(s.num);
    d.innerHTML=`<div class="step-num">${s.num}</div><div style="flex:1"><div class="step-name">${s.name}</div><div class="step-preview">${s.short}</div></div><div style="color:var(--text-muted);">â€º</div>`;
    c.appendChild(d);
  });
}
function showStepsList(){document.getElementById('steps-list-view').style.display='block';document.getElementById('step-detail-view').style.display='none';renderStepsList();}
function showStepDetail(num){
  const s=STEPS[num-1];const saved=stepJournals[num]||'';
  const PAGE=[2,8,14,20,28,33,37,41,46,54,58,63][num-1];
  document.getElementById('steps-list-view').style.display='none';
  document.getElementById('step-detail-view').style.display='block';
  document.getElementById('step-detail-content').innerHTML=`
    <div class="step-full-title">Step ${s.num}: ${s.full}</div>
    <div style="background:rgba(232,201,122,0.07);border:1px solid var(--border);border-radius:14px;padding:18px;margin:16px 0;text-align:center;">
      <div style="font-size:2.2rem;margin-bottom:8px;">ğŸ“–</div>
      <div style="font-size:.95rem;font-weight:600;color:var(--text);margin-bottom:8px;">NA Step Working Guide</div>
      <div style="font-size:.8rem;color:var(--text-muted);margin-bottom:16px;line-height:1.6;">
        The official questions for Step ${s.num} are in the NA Step Working Guide.<br>
        Tap below to open it, then work through the questions with your sponsor.
      </div>
      <a href="https://www.nwnjna.org/wp-content/uploads/2020/03/NARCOTICS-ANONYMOUS-STEP-WRITING-GUIDE.pdf#page=${PAGE}"
         target="_blank"
         style="display:inline-block;background:var(--accent);color:#1a1208;font-weight:700;font-size:.95rem;padding:13px 28px;border-radius:25px;text-decoration:none;letter-spacing:.02em;">
        Open Step ${s.num} Questions &nbsp;â†—
      </a>
      <div style="font-size:.7rem;color:var(--text-muted);margin-top:12px;opacity:.8;">Official NA Step Working Guide PDF &nbsp;Â·&nbsp; Page ${PAGE}</div>
    </div>
    <div class="prompts-title" style="margin-top:4px;">Your Journal for Step ${s.num}</div>
    <div style="font-size:.78rem;color:var(--text-muted);margin-bottom:10px;line-height:1.5;">Write your answers and reflections here as you work through the guide with your sponsor.</div>
    <textarea class="journal-area" id="step-journal-${num}" placeholder="Write your reflections here...">${saved}</textarea>
    <button class="save-btn" onclick="saveStepJournal(${num})">Save Journal</button>`;
}
function saveStepJournal(num){
  stepJournals[num]=document.getElementById('step-journal-'+num).value;
  localStorage.setItem('na_step_journals',JSON.stringify(stepJournals));showToast('Saved âœ“');
}

// LOL MEETING TIMES - convert from ET to user's local timezone
function renderLOLTimes(){
  const el = document.getElementById('lol-times');
  if(!el) return;
  try {
    // Meeting times in US Eastern time
    // Friday 5:30pm ET, Saturday 11:30am ET
    const now = new Date();
    const year = now.getFullYear();
    const month = now.getMonth();
    const day = now.getDate();

    // Create dates in ET using Intl to find offset
    // Friday meeting: next Friday at 17:30 ET
    // Saturday meeting: next Saturday at 11:30 ET
    function getLocalTimeStr(etHour, etMin) {
      // Use a fixed reference date to get the ET offset
      // Create date as if it's in ET by using toLocaleString trick
      const etDate = new Date();
      const etStr = etDate.toLocaleString('en-US', {timeZone: 'America/New_York', hour:'numeric', minute:'2-digit', hour12: false});
      const localStr = etDate.toLocaleString('en-US', {hour:'numeric', minute:'2-digit', hour12: false});
      
      // Get ET offset vs UTC
      const etUTC = new Date(etDate.toLocaleString('en-US', {timeZone: 'America/New_York'}));
      const localUTC = new Date(etDate.toLocaleString('en-US'));
      const diffMins = Math.round((localUTC - etUTC) / 60000);
      
      // Build a date object for the meeting time in ET, then convert
      const meetingET = new Date(year, month, day, etHour, etMin, 0);
      const meetingLocal = new Date(meetingET.getTime() + diffMins * 60000);
      
      return meetingLocal.toLocaleTimeString([], {hour:'numeric', minute:'2-digit', hour12: true});
    }

    const fridayLocal = getLocalTimeStr(17, 30);
    const saturdayLocal = getLocalTimeStr(11, 30);
    
    const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
    const tzShort = new Date().toLocaleTimeString('en-US', {timeZoneName:'short'}).split(' ').pop();

    el.innerHTML = `<b style="color:var(--text);">Friday</b> ${fridayLocal} &nbsp;Â·&nbsp; <b style="color:var(--text);">Saturday</b> ${saturdayLocal} <span style="opacity:.6;">(your time Â· ${tzShort})</span><br>
      Zoom ID: <span style="color:var(--text);font-weight:500;">974 8817 4579</span> &nbsp;Â·&nbsp; Password: <span style="color:var(--text);font-weight:500;">hope</span>`;
  } catch(e) {
    el.innerHTML = `<b style="color:var(--text);">Friday</b> 5:30pm ET &nbsp;Â·&nbsp; <b style="color:var(--text);">Saturday</b> 11:30am ET<br>
      Zoom ID: <span style="color:var(--text);font-weight:500;">974 8817 4579</span> &nbsp;Â·&nbsp; Password: <span style="color:var(--text);font-weight:500;">hope</span>`;
  }
}

// JOURNAL
function renderJournalList(){
  const c=document.getElementById('journal-entries-container');
  if(!journalEntries.length){c.innerHTML=`<div style="color:var(--text-muted);font-size:.83rem;text-align:center;padding:40px 0;">No entries yet. Tap + to begin.</div>`;return;}
  c.innerHTML='';
  [...journalEntries].reverse().forEach(e=>{
    const d=document.createElement('div');d.className='journal-entry-card';d.onclick=()=>openJournalEntry(e.id);
    const dt=new Date(e.date);
    d.innerHTML=`<div class="journal-date">${dt.toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'})}</div><div class="journal-preview">${e.text.slice(0,120)}${e.text.length>120?'â€¦':''}</div>`;
    c.appendChild(d);
  });
}
function openNewJournalEntry(){
  currentJournalId=null;
  document.getElementById('journal-modal-title').textContent='New Entry';
  document.getElementById('journal-modal-date').textContent=new Date().toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
  document.getElementById('journal-modal-text').value='';
  document.getElementById('journal-delete-btn').style.display='none';
  document.getElementById('journal-modal').classList.add('open');
}
function openJournalEntry(id){
  const e=journalEntries.find(e=>e.id===id);if(!e)return;
  currentJournalId=id;
  document.getElementById('journal-modal-title').textContent='Journal Entry';
  document.getElementById('journal-modal-date').textContent=new Date(e.date).toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
  document.getElementById('journal-modal-text').value=e.text;
  document.getElementById('journal-delete-btn').style.display='block';
  document.getElementById('journal-modal').classList.add('open');
}
function closeJournalModal(){document.getElementById('journal-modal').classList.remove('open');renderJournalList();}
function saveJournalModal(){
  const text=document.getElementById('journal-modal-text').value.trim();
  if(!text){alert('Please write something first.');return;}
  if(currentJournalId){const i=journalEntries.findIndex(e=>e.id===currentJournalId);if(i>-1)journalEntries[i].text=text;}
  else journalEntries.push({id:Date.now().toString(),date:new Date().toISOString(),text});
  localStorage.setItem('na_journal',JSON.stringify(journalEntries));
  closeJournalModal();showToast('Entry saved âœ“');
}
function deleteCurrentEntry(){
  if(!currentJournalId||!confirm('Delete this entry?'))return;
  journalEntries=journalEntries.filter(e=>e.id!==currentJournalId);
  localStorage.setItem('na_journal',JSON.stringify(journalEntries));closeJournalModal();
}

// VIRTUAL MEETINGS
async function loadVirtualMeetings(){
  const c=document.getElementById('virtual-meetings-container');
  if(allMeetings.length>0){renderVirtualMeetings();return;}
  c.innerHTML='<div class="loading">Loading from virtual-na.org...</div>';
  try{
    const url='https://bmlt.virtual-na.org/main_server/client_interface/json/?switcher=GetSearchResults&lang_enum=en&data_field_key=id_bigint,meeting_name,start_time,weekday_tinyint,virtual_meeting_link,phone_meeting_number,comments&sort_results_by_distance=0';
    const r=await fetch(url);
    allMeetings=await r.json();
    renderVirtualMeetings();
  }catch(e){
    c.innerHTML=`<div class="card"><div class="card-title">Virtual NA Meetings</div><div class="card-text" style="margin-bottom:10px;">Browse hundreds of online NA meetings worldwide, sorted by day and time.</div><a href="https://virtual-na.org/meetings/" target="_blank" class="save-btn" style="display:block;text-decoration:none;text-align:center;">Open Virtual-NA.org</a></div>`;
  }
}
function renderVirtualMeetings(){
  const c=document.getElementById('virtual-meetings-container');
  let list=allMeetings;
  if(dayFilter!=='all')list=list.filter(m=>String(m.weekday_tinyint)===dayFilter);
  const shown=list.slice(0,50);
  if(!shown.length){c.innerHTML='<div class="loading">No meetings found for this day.</div>';return;}
  c.innerHTML=shown.map(m=>{
    const day=DAYS[m.weekday_tinyint]||'';
    const time=fmtTime(m.start_time);
    const link=m.virtual_meeting_link||'';
    const phone=m.phone_meeting_number||'';
    return`<div class="meeting-card"><div class="meeting-name">${m.meeting_name||'NA Meeting'}</div><div class="meeting-meta">ğŸ“… ${day} at ${time}${phone?'<br>ğŸ“ '+phone:''}</div><span class="meeting-tag">ğŸŒ Virtual</span>${link?`<br><a href="${link}" target="_blank" class="meeting-link">Join Meeting â†’</a>`:''}</div>`;
  }).join('');
  if(list.length>50)c.innerHTML+=`<div style="text-align:center;padding:14px;"><a href="https://virtual-na.org/meetings/" target="_blank" style="color:var(--accent);font-size:.83rem;">View all ${list.length} meetings on Virtual-NA.org â†’</a></div>`;
}
function fmtTime(t){if(!t)return'';const[h,m]=t.split(':');const hr=parseInt(h);return`${hr%12||12}:${m} ${hr>=12?'PM':'AM'}`;}
function filterMeetings(day,el){
  dayFilter=day;
  document.querySelectorAll('#day-filters .filter-chip').forEach(c=>c.classList.remove('active'));
  if(el)el.classList.add('active');
  renderVirtualMeetings();
}

// EVENTS
function renderEvents(){
  document.getElementById('events-container').innerHTML=`
    <div class="card" style="margin-bottom:12px;">
      <div class="card-title">ğŸŒ European NA Events</div>
      <div class="card-text" style="margin-bottom:10px;">Upcoming conventions & events from the European Delegates Meeting of NA.</div>
      <a href="https://edmna.org/events-calendar/" target="_blank" class="save-btn" style="display:block;text-decoration:none;text-align:center;">View Full Calendar at edmna.org</a>
    </div>`+
  EVENTS.map(e=>`
    <div class="event-card">
      <div class="event-date-block"><div class="event-month">${e.month}</div><div class="event-day">${e.day}</div></div>
      <div style="flex:1">
        <div class="event-name">${e.name}</div>
        <div class="event-loc">ğŸ“… ${e.dates}</div>
        <div class="event-loc">ğŸ“ ${e.location}</div>
        <div style="margin-top:6px;">
          <span class="meeting-tag">${e.type}</span>
          ${e.maps?`<a href="${e.maps}" target="_blank" class="meeting-link" style="margin-left:8px;font-size:.72rem;">ğŸ—º Map</a>`:''}
          ${e.link?`<a href="${e.link}" target="_blank" class="meeting-link" style="margin-left:8px;font-size:.72rem;">ğŸ“„ Info</a>`:''}
        </div>
      </div>
    </div>`).join('');
}

// SPONSOR
function renderSponsorScreen(){
  if(sponsor){
    document.getElementById('sponsor-setup').style.display='none';
    document.getElementById('sponsor-view').style.display='block';
    document.getElementById('sponsor-name-display').textContent=sponsor.name;
    document.getElementById('sponsor-phone-display').textContent=sponsor.phone;
    document.getElementById('sponsor-notes-display').textContent=sponsor.notes||'';
    document.getElementById('sponsor-call-btn').href='tel:'+sponsor.phone;
    renderContactLog();
  }else{
    document.getElementById('sponsor-setup').style.display='block';
    document.getElementById('sponsor-view').style.display='none';
  }
  renderMilestones();
}
function saveSponsor(){
  const name=document.getElementById('sponsor-name-input').value.trim();
  const phone=document.getElementById('sponsor-phone-input').value.trim();
  const notes=document.getElementById('sponsor-notes-input').value.trim();
  if(!name){alert('Please enter a name.');return;}
  sponsor={name,phone,notes};localStorage.setItem('na_sponsor',JSON.stringify(sponsor));
  renderSponsorScreen();showToast('Sponsor saved âœ“');
}
function editSponsor(){sponsor=null;localStorage.removeItem('na_sponsor');renderSponsorScreen();}
function logContact(){
  const text=document.getElementById('new-msg-input').value.trim();if(!text)return;
  contactLog.push({id:Date.now().toString(),date:new Date().toISOString(),text});
  localStorage.setItem('na_contacts',JSON.stringify(contactLog));
  document.getElementById('new-msg-input').value='';renderContactLog();showToast('Logged âœ“');
}
function renderContactLog(){
  const c=document.getElementById('msg-log-container');
  if(!contactLog.length){c.innerHTML='<div style="color:var(--text-muted);font-size:.76rem;padding-top:6px;">No contacts logged yet.</div>';return;}
  c.innerHTML='<div class="section-label" style="margin-top:0;">Previous contacts</div>'+[...contactLog].reverse().slice(0,10).map(x=>{
    const d=new Date(x.date);
    return`<div class="msg-item"><div class="msg-date">${d.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric',hour:'numeric',minute:'2-digit'})}</div><div class="msg-text">${x.text}</div></div>`;
  }).join('');
}

// MILESTONES
function renderMilestones(){
  const c=document.getElementById('milestones-container');
  const days=cleanDate?Math.max(0,Math.floor((Date.now()-new Date(cleanDate).getTime())/86400000)):0;
  c.innerHTML=MILESTONES.map(m=>{
    const achieved=days>=m.days;
    return`<div class="milestone-card" style="${achieved?'':'opacity:.45'}">
      <div class="milestone-num">${m.label}</div>
      <div class="milestone-label">${m.days} day${m.days!==1?'s':''}</div>
      ${achieved?`<div><div class="milestone-achieved">âœ“ Achieved</div></div><button class="share-milestone-btn" onclick="shareMilestone('${m.label}',${m.days})">Share This Milestone ğŸ‰</button>`:''}
    </div>`;
  }).join('');
}
// SHARE MILESTONE
function shareMilestone(label,days){
  const modal=document.getElementById('share-modal');
  const body=document.getElementById('share-modal-body');
  modal.classList.add('open');
  const canvas=document.getElementById('share-canvas');
  canvas.width=1080;canvas.height=1080;
  const ctx=canvas.getContext('2d');
  const g=ctx.createLinearGradient(0,0,1080,1080);
  g.addColorStop(0,'#0f0f1a');g.addColorStop(1,'#1a1a2e');
  ctx.fillStyle=g;ctx.fillRect(0,0,1080,1080);
  ctx.beginPath();ctx.arc(540,540,420,0,Math.PI*2);ctx.strokeStyle='rgba(232,201,122,0.2)';ctx.lineWidth=2;ctx.stroke();
  ctx.textAlign='center';ctx.fillStyle='#e8c97a';
  ctx.font='bold 90px Georgia';ctx.fillText('NA',540,430);
  ctx.font='300 56px Georgia';ctx.fillText(label,540,540);
  ctx.fillStyle='#f0ead6';ctx.font='28px Arial';ctx.fillText('One Day at a Time',540,630);
  ctx.fillStyle='rgba(232,201,122,0.5)';ctx.font='22px Arial';ctx.fillText('Narcotics Anonymous',540,700);
  const img=canvas.toDataURL('image/png');
  body.innerHTML=`<p style="color:var(--text-muted);font-size:.83rem;text-align:center;">Long-press to save, or download below</p><img src="${img}" style="width:100%;max-width:320px;border-radius:16px;box-shadow:0 8px 40px rgba(0,0,0,.4);"><a href="${img}" download="na-${days}-days.png" class="save-btn" style="display:block;text-decoration:none;text-align:center;max-width:300px;">Download Image</a>`;
}

// PRAYERS
function renderPrayers(){
  document.getElementById('prayers-container').innerHTML=PRAYERS.map((p,i)=>`
    <div class="prayer-card" onclick="togglePrayer(${i})">
      <div class="prayer-title">${p.title}<span class="prayer-chevron" id="chev-${i}">â–¾</span></div>
      <div class="prayer-text" id="ptext-${i}">${p.text}</div>
    </div>`).join('');
}
function togglePrayer(i){
  document.getElementById('ptext-'+i).classList.toggle('open');
  document.getElementById('chev-'+i).classList.toggle('open');
}

// TOAST
function showToast(msg){
  const t=document.createElement('div');t.textContent=msg;
  t.style.cssText='position:fixed;bottom:calc(var(--nav-h) + 18px);left:50%;transform:translateX(-50%);background:var(--accent);color:var(--bg);padding:8px 17px;border-radius:20px;font-size:.81rem;z-index:500;font-weight:500;white-space:nowrap;';
  document.body.appendChild(t);setTimeout(()=>t.remove(),2000);
}

// INIT
applyTheme();buildPinGrid();initHome();renderStepsList();renderPrayers();renderLOLTimes();
document.getElementById('pin-toggle').classList.toggle('on',pinEnabled);
if(pinEnabled)document.getElementById('pin-change-section').style.display='block';
document.getElementById('theme-toggle').classList.toggle('on',isDark);
if(pinEnabled&&savedPin)document.getElementById('pin-overlay').classList.remove('hidden');
</script>
</body>
</html>

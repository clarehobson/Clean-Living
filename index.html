<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Clean Living">
<meta name="theme-color" content="#0f0f1a">
<title>Clean Living</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;600&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0f0f1a;
  --sf: #1a1a2e;
  --sf2: #16213e;
  --ac: #e8c97a;
  --tx: #f0ead6;
  --tm: #8a8090;
  --bd: rgba(232,201,122,0.15);
  --r: 16px;
}
a { color: inherit; text-decoration: none; -webkit-text-fill-color: inherit; }
* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
html, body { height: 100%; height: 100dvh; }
body { font-family: "DM Sans", sans-serif; background: var(--bg); color: var(--tx); overflow: hidden; }

#app { display: flex; flex-direction: column; height: 100%; height: 100dvh; }

/* SCREENS */
.screen { display: none; flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; padding: 20px 16px 24px; }
.screen.active { display: block; }

/* NAV */
nav {
flex-shrink: 0;
display: flex;
background: rgba(15,15,26,0.97);
border-top: 1px solid var(â€“bd);
padding-bottom: env(safe-area-inset-bottom, 0);
}
.nav-item {
flex: 1;
display: flex;
flex-direction: column;
align-items: center;
justify-content: center;
gap: 2px;
padding: 8px 1px 6px;
cursor: pointer;
color: var(â€“tm);
font-size: 0.38rem;
letter-spacing: 0.03em;
text-transform: uppercase;
-webkit-user-select: none;
user-select: none;
}
.nav-item.active { color: var(â€“ac); }
.nav-icon { font-size: 1.1rem; line-height: 1; }

/* CARDS */
.card {
background: var(â€“sf);
border: 1px solid rgba(232,201,122,0.35);
border-radius: var(â€“r);
padding: 16px;
margin-bottom: 10px;
box-shadow: 0 2px 8px rgba(0,0,0,0.25);
}
.label {
font-size: 0.62rem;
font-weight: 800;
color: var(â€“ac);
text-transform: uppercase;
letter-spacing: 0.08em;
margin-bottom: 8px;
}
.btn {
width: 100%;
padding: 13px;
border: none;
border-radius: var(â€“r);
background: var(â€“ac);
color: #1a1208;
font-size: 0.86rem;
font-weight: 700;
cursor: pointer;
margin-top: 8px;
}
.input {
width: 100%;
background: var(â€“sf2);
border: 1px solid var(â€“bd);
border-radius: 10px;
color: var(â€“tx);
font-size: 0.84rem;
padding: 10px 12px;
outline: none;
}
.input:focus { border-color: var(â€“ac); }

/* MOOD BUTTONS */
.mood-row { display: flex; gap: 6px; }
.mood-btn {
flex: 1;
background: var(â€“sf);
border: 1px solid var(â€“bd);
border-radius: 12px;
padding: 10px 4px;
cursor: pointer;
text-align: center;
}
.mood-btn.selected { border-color: var(â€“ac); background: rgba(232,201,122,0.1); }
.mood-emoji { font-size: 1.3rem; }
.mood-label { font-size: 0.56rem; color: var(â€“tm); margin-top: 3px; }

.step-card {
display: flex;
align-items: center;
gap: 14px;
background: var(â€“sf);
border: 1px solid var(â€“bd);
border-radius: var(â€“r);
padding: 14px 16px;
margin-bottom: 8px;
text-decoration: none;
color: var(â€“tx);
}
.step-num {
width: 32px;
height: 32px;
border-radius: 50%;
border: 1px solid var(â€“ac);
background: rgba(232,201,122,0.08);
display: flex;
align-items: center;
justify-content: center;
font-family: â€˜Cormorant Garamondâ€™, serif;
font-size: 1rem;
font-weight: 400;
color: var(â€“ac);
flex-shrink: 0;
}
.step-body { flex: 1; min-width: 0; }
.step-title { font-size: 0.86rem; font-weight: 600; color: var(â€“tx); }
.step-sub { font-size: 0.7rem; color: var(â€“tm); margin-top: 2px; }
.step-arrow { color: var(â€“tm); font-size: 0.9rem; }
.bt-ch {
display: flex;
flex-direction: column;
gap: 5px;
padding: 9px 0;
border-bottom: 1px solid var(â€“bd);
}
.bt-ch:last-child { border-bottom: none; }
.bt-ch span { font-size: 0.78rem; font-weight: 600; color: var(â€“tx); }
.bt-ch audio { width: 100%; height: 32px; }

.j-type-card {
display: flex;
align-items: center;
gap: 14px;
background: var(â€“sf);
border: 1px solid rgba(232,201,122,0.35);
border-radius: var(â€“r);
padding: 16px 18px;
margin-bottom: 10px;
cursor: pointer;
box-shadow: 0 2px 8px rgba(0,0,0,0.25);
transition: background 0.15s;
}
.j-type-card:active { background: var(â€“sf2); }
.j-entry-card {
background: var(â€“sf);
border: 1px solid var(â€“bd);
border-radius: var(â€“r);
padding: 12px 14px;
margin-bottom: 8px;
cursor: pointer;
}
.j-entry-card:active { background: var(â€“sf2); }

.j-entry-wrap {
position: relative;
margin-bottom: 8px;
overflow: hidden;
border-radius: var(â€“r);
}
.j-delete-reveal {
position: absolute;
right: 0;
top: 0;
bottom: 0;
width: 80px;
background: #c0392b;
display: flex;
align-items: center;
justify-content: center;
color: white;
font-size: 0.75rem;
font-weight: 700;
letter-spacing: 0.05em;
cursor: pointer;
}
.j-entry-card {
position: relative;
transform: translateX(0);
transition: transform 0.2s ease;
cursor: pointer;
touch-action: pan-y;
}

.book-card {
display: flex;
align-items: center;
gap: 12px;
background: var(â€“sf);
border: 1px solid rgba(232,201,122,0.35);
border-radius: var(â€“r);
padding: 12px 14px;
margin-bottom: 6px;
text-decoration: none;
color: var(â€“tx);
box-shadow: 0 2px 8px rgba(0,0,0,0.25);
}
.book-card * { color: inherit; text-decoration: none; }
.book-sub { font-size: 0.68rem; color: var(â€“tm) !important; margin-top: 2px; }
.book-card:active { background: var(â€“sf2); }
.book-icon { font-size: 1.2rem; flex-shrink: 0; }
.book-body { flex: 1; min-width: 0; }
.book-title { font-size: 0.84rem; font-weight: 600; color: var(â€“tx) !important; -webkit-text-fill-color: var(â€“tx) !important; }
.book-arr { color: var(â€“tm); font-size: 0.9rem; flex-shrink: 0; }

.book-expand-card {
background: var(â€“sf);
border: 1px solid rgba(232,201,122,0.35);
border-radius: var(â€“r);
margin-bottom: 10px;
overflow: hidden;
}
.book-expand-header {
display: flex;
align-items: center;
gap: 12px;
padding: 13px 14px;
cursor: pointer;
}
.book-expand-header:active { background: var(â€“sf2); }
.book-expand-chevron {
color: var(â€“tm);
font-size: 0.75rem;
margin-left: auto;
transition: transform 0.2s;
flex-shrink: 0;
}
.book-expand-card.open .book-expand-chevron { transform: rotate(90deg); }
.book-expand-body {
display: none;
padding: 0 14px 14px 14px;
border-top: 1px solid var(â€“bd);
}
.book-expand-card.open .book-expand-body { display: block; }
.book-expand-section {
font-size: 0.6rem;
color: var(â€“tm);
letter-spacing: 0.09em;
text-transform: uppercase;
margin: 12px 0 6px 0;
}
.book-buy-row {
display: flex;
gap: 6px;
flex-wrap: wrap;
margin-bottom: 4px;
}
.book-buy-btn {
display: inline-flex;
align-items: center;
gap: 5px;
padding: 7px 11px;
border-radius: 8px;
font-size: 0.7rem;
font-weight: 600;
text-decoration: none;
white-space: nowrap;
}
.book-buy-btn.apple { background: #1c1c1e; color: #fff; border: 1px solid #3a3a3c; }
.book-buy-btn.android { background: #1a3c27; color: #5fcf80; border: 1px solid #2d6b45; }
.book-buy-btn.hardcopy { background: #2a2418; color: var(â€“ac); border: 1px solid #4a3f28; }
.book-buy-btn:active { opacity: 0.75; }

.book-expand-card {
background: var(â€“sf);
border: 1px solid rgba(232,201,122,0.35);
border-radius: var(â€“r);
margin-bottom: 8px;
overflow: hidden;
}
.book-card-header {
display: flex;
align-items: center;
gap: 12px;
padding: 13px 14px;
cursor: pointer;
}
.book-card-header:active { background: var(â€“sf2); }
.book-chevron {
color: var(â€“tm);
font-size: 1.2rem;
transition: transform 0.25s;
flex-shrink: 0;
}
.book-expand-card.open .book-chevron { transform: rotate(90deg); }
.book-card-body {
display: none;
padding: 0 14px 14px 14px;
border-top: 1px solid var(â€“bd);
}
.book-expand-card.open .book-card-body { display: block; }
.book-section-label {
font-size: 0.68rem;
color: var(â€“tm);
letter-spacing: 0.06em;
text-transform: uppercase;
margin: 12px 0 7px;
}
.book-btn-row {
display: flex;
gap: 8px;
}
.buy-btn {
display: block;
text-align: center;
padding: 9px 10px;
border-radius: 8px;
font-size: 0.75rem;
font-weight: 600;
text-decoration: none;
margin-bottom: 6px;
}
.book-btn-row .buy-btn { flex: 1; margin-bottom: 0; }
.apple-btn  { background: #1c1c1e; color: #fff; border: 1px solid #3a3a3c; }
.google-btn { background: #1a73e8; color: #fff; }
.world-btn  { background: var(â€“sf2); color: var(â€“tx); border: 1px solid var(â€“bd); }
.uk-btn     { background: #012169; color: #fff; }
.eu-btn     { background: #003399; color: #ffd700; }

.meeting-card {
display: flex;
align-items: center;
justify-content: space-between;
background: var(â€“sf);
border: 1px solid rgba(232,201,122,0.35);
border-radius: var(â€“r);
padding: 13px 14px;
margin-bottom: 8px;
text-decoration: none;
color: var(â€“tx);
box-shadow: 0 2px 8px rgba(0,0,0,0.25);
}
.meeting-card * { color: inherit; text-decoration: none; }
.meeting-sub { font-size: 0.68rem; color: var(â€“tm) !important; margin-top: 2px; line-height: 1.4; }
.meeting-card:active { background: var(â€“sf2); }
.meeting-left {
display: flex;
align-items: center;
gap: 12px;
}
.meeting-flag { font-size: 1.4rem; flex-shrink: 0; }
.meeting-title { font-size: 0.84rem; font-weight: 600; color: var(â€“tx) !important; -webkit-text-fill-color: var(â€“tx) !important; }
.meeting-arr { color: var(â€“tm); font-size: 1rem; flex-shrink: 0; margin-left: 8px; }

/* NETWORK */
.net-card {
background: var(â€“sf);
border: 1px solid rgba(232,201,122,0.3);
border-radius: var(â€“r);
padding: 14px 16px;
margin-bottom: 12px;
}
.net-card-header {
display: flex;
align-items: center;
gap: 12px;
}
.net-avatar {
width: 44px;
height: 44px;
border-radius: 50%;
background: rgba(232,201,122,0.12);
border: 1px solid var(â€“bd);
display: flex;
align-items: center;
justify-content: center;
font-size: 1.2rem;
flex-shrink: 0;
}
.net-info { flex: 1; min-width: 0; }
.net-name { font-size: 0.9rem; font-weight: 700; color: var(â€“tx); }
.net-role { display: inline-block; font-size: 0.6rem; font-weight: 700; letter-spacing: 0.08em; color: var(â€“ac); background: rgba(232,201,122,0.12); border: 1px solid rgba(232,201,122,0.3); border-radius: 20px; padding: 2px 8px; margin-top: 4px; text-transform: uppercase; }
.net-clean { font-size: 0.66rem; color: var(â€“tm); margin-top: 2px; }
.net-location { font-size: 0.66rem; color: var(â€“tm); margin-top: 1px; }
.net-actions {
display: flex;
gap: 8px;
margin-top: 12px;
padding-top: 10px;
border-top: 1px solid var(â€“bd);
}
.net-action-btn {
flex: 1;
display: flex;
flex-direction: column;
align-items: center;
gap: 4px;
padding: 8px 4px;
background: var(â€“sf2);
border: 1px solid var(â€“bd);
border-radius: 10px;
cursor: pointer;
text-decoration: none;
color: var(â€“tx);
-webkit-text-fill-color: var(â€“tx);
font-size: 0.6rem;
text-align: center;
}
.net-action-btn:active { background: rgba(232,201,122,0.1); }
.net-action-icon { font-size: 1.1rem; }

/* MODAL */
.modal-overlay {
display: none;
position: fixed;
inset: 0;
background: rgba(0,0,0,0.7);
z-index: 9000;
align-items: flex-end;
}
.modal-overlay.open { display: flex; }
.modal-sheet {
background: var(â€“sf);
border-radius: 20px 20px 0 0;
padding: 20px 16px 40px;
width: 100%;
max-height: 85vh;
overflow-y: auto;
}
.modal-title {
font-family: â€˜Cormorant Garamondâ€™, serif;
font-size: 1.4rem;
font-weight: 300;
color: var(â€“ac);
margin-bottom: 16px;
text-align: center;
}
.modal-label {
font-size: 0.62rem;
font-weight: 800;
color: var(â€“ac);
text-transform: uppercase;
letter-spacing: 0.08em;
margin-bottom: 6px;
margin-top: 14px;
}
.role-grid {
display: grid;
grid-template-columns: 1fr 1fr;
gap: 7px;
margin-bottom: 4px;
}
.role-btn {
padding: 9px 8px;
border: 1px solid var(â€“bd);
border-radius: 10px;
background: var(â€“sf2);
color: var(â€“tm);
font-size: 0.74rem;
cursor: pointer;
text-align: center;
}
.role-btn.selected { border-color: var(â€“ac); color: var(â€“ac); background: rgba(232,201,122,0.1); }

/* EXPORT MODAL */
.export-overlay {
display: none;
position: fixed;
inset: 0;
background: rgba(0,0,0,0.7);
z-index: 9000;
align-items: flex-end;
}
.export-overlay.open { display: flex; }

/* NETWORK */
.net-card {
background: var(â€“sf);
border: 1px solid var(â€“bd);
border-radius: var(â€“r);
padding: 14px 16px;
margin-bottom: 10px;
position: relative;
}
.net-card-top {
display: flex;
align-items: center;
gap: 12px;
margin-bottom: 10px;
}
.net-avatar {
width: 42px;
height: 42px;
border-radius: 50%;
background: rgba(232,201,122,0.12);
border: 1px solid var(â€“bd);
display: flex;
align-items: center;
justify-content: center;
font-size: 1.2rem;
flex-shrink: 0;
}
.net-name { font-size: 0.92rem; font-weight: 700; color: var(â€“tx); }
.net-role {
display: inline-block;
font-size: 0.6rem;
font-weight: 700;
text-transform: uppercase;
letter-spacing: 0.07em;
padding: 2px 8px;
border-radius: 20px;
margin-top: 3px;
background: rgba(232,201,122,0.1);
border: 1px solid rgba(232,201,122,0.25);
color: var(â€“ac);
}
.net-met
.net-actions {
display: flex;
gap: 8px;
}
.net-btn {
flex: 1;
display: flex;
align-items: center;
justify-content: center;
gap: 6px;
padding: 9px;
border-radius: 10px;
font-size: 0.74rem;
font-weight: 600;
text-decoration: none;
border: none;
cursor: pointer;
}
.net-btn.call { background: rgba(52,199,89,0.15); color: #34c759; border: 1px solid rgba(52,199,89,0.25); }
.net-btn.whatsapp { background: rgba(37,211,102,0.12); color: #25d366; border: 1px solid rgba(37,211,102,0.25); }
.net-delete-btn {
position: absolute;
top: 12px;
right: 12px;
background: none;
border: none;
color: var(â€“tm);
font-size: 1rem;
cursor: pointer;
padding: 2px 6px;
line-height: 1;
}

/* MODAL */
.modal-overlay {
display: none;
position: fixed;
inset: 0;
background: rgba(0,0,0,0.7);
z-index: 500;
align-items: flex-end;
justify-content: center;
}
.modal-overlay.open { display: flex; }
.modal-box {
background: var(â€“sf);
border: 1px solid var(â€“bd);
border-radius: 20px 20px 0 0;
padding: 24px 18px 40px;
width: 100%;
max-width: 500px;
max-height: 85vh;
overflow-y: auto;
}
.modal-title {
font-family: â€˜Cormorant Garamondâ€™, serif;
font-size: 1.4rem;
font-weight: 300;
color: var(â€“ac);
margin-bottom: 16px;
}
.modal-label {
font-size: 0.68rem;
font-weight: 700;
color: var(â€“tm);
text-transform: uppercase;
letter-spacing: 0.07em;
margin-bottom: 5px;
margin-top: 12px;
}
.modal-select {
width: 100%;
background: var(â€“sf2);
border: 1px solid var(â€“bd);
border-radius: 10px;
color: var(â€“tx);
font-size: 0.84rem;
padding: 10px 12px;
outline: none;
-webkit-appearance: none;
}

/* EXPORT MODAL */
.export-btn {
display: flex;
align-items: center;
gap: 12px;
background: var(â€“sf2);
border: 1px solid var(â€“bd);
border-radius: var(â€“r);
padding: 14px 16px;
margin-bottom: 10px;
cursor: pointer;
width: 100%;
text-align: left;
color: var(â€“tx);
}
.export-btn:active { opacity: 0.75; }

/* WELCOME SCREEN */
#welcome-screen {
display: none;
position: fixed;
inset: 0;
z-index: 10000;
background: var(â€“bg);
flex-direction: column;
align-items: center;
justify-content: flex-end;
padding: 0 24px 48px;
}
#welcome-hero {
flex: 1;
display: flex;
flex-direction: column;
align-items: center;
justify-content: center;
text-align: center;
width: 100%;
}
.welcome-logo {
font-family: â€˜Cormorant Garamondâ€™, serif;
font-size: 2.8rem;
font-weight: 300;
color: var(â€“ac);
margin-bottom: 6px;
}
.welcome-sub {
font-size: 0.65rem;
letter-spacing: 0.18em;
text-transform: uppercase;
color: var(â€“tm);
margin-bottom: 40px;
}
.welcome-tagline {
font-size: 0.9rem;
color: var(â€“tx);
line-height: 1.7;
max-width: 280px;
margin-bottom: 40px;
}
.welcome-btn-primary {
width: 100%;
padding: 16px;
background: var(â€“ac);
color: #1a1208;
border: none;
border-radius: var(â€“r);
font-size: 0.92rem;
font-weight: 700;
cursor: pointer;
margin-bottom: 12px;
}
.welcome-btn-secondary {
width: 100%;
padding: 15px;
background: transparent;
color: var(â€“tx);
border: 1px solid rgba(232,201,122,0.35);
border-radius: var(â€“r);
font-size: 0.88rem;
cursor: pointer;
margin-bottom: 12px;
}
.welcome-btn-ghost {
background: transparent;
border: none;
color: var(â€“tm);
font-size: 0.75rem;
cursor: pointer;
padding: 8px;
}
#auth-form { display: none; width: 100%; }
.auth-back {
background: transparent;
border: none;
color: var(â€“tm);
font-size: 0.8rem;
cursor: pointer;
padding: 0;
margin-bottom: 20px;
display: flex;
align-items: center;
gap: 4px;
}

/* EVENTS */
.ef-btn {
padding: 7px 14px;
border: 1px solid rgba(232,201,122,0.35);
border-radius: 20px;
background: var(â€“sf);
color: var(â€“tm);
font-size: 0.72rem;
cursor: pointer;
white-space: nowrap;
flex-shrink: 0;
}
.ef-btn.ef-active {
background: var(â€“ac);
color: #1a1208;
font-weight: 700;
border-color: var(â€“ac);
}
.event-card {
background: var(â€“sf);
border: 1px solid rgba(232,201,122,0.35);
border-radius: var(â€“r);
margin-bottom: 12px;
overflow: hidden;
box-shadow: 0 2px 8px rgba(0,0,0,0.25);
cursor: pointer;
}
.event-flyer {
width: 100%;
height: 160px;
object-fit: cover;
display: block;
}
.event-flyer-placeholder {
width: 100%;
height: 100px;
background: linear-gradient(135deg, #1a1a2e, #16213e);
display: flex;
align-items: center;
justify-content: center;
font-size: 2.5rem;
}
.event-body { padding: 14px 16px; }
.event-title { font-weight: 700; font-size: 0.95rem; margin-bottom: 4px; }
.event-meta { font-size: 0.72rem; color: var(â€“tm); margin-bottom: 10px; line-height: 1.6; }
.event-type-tag {
display: inline-block;
background: rgba(232,201,122,0.12);
border: 1px solid rgba(232,201,122,0.25);
border-radius: 20px;
padding: 2px 10px;
font-size: 0.65rem;
color: var(â€“ac);
margin-bottom: 8px;
}
.event-going-bar {
display: flex;
align-items: center;
justify-content: space-between;
padding-top: 10px;
border-top: 1px solid var(â€“bd);
margin-top: 8px;
}
.going-btn {
padding: 7px 16px;
border-radius: 20px;
border: none;
font-size: 0.75rem;
font-weight: 700;
cursor: pointer;
background: var(â€“ac);
color: #1a1208;
}
.going-btn.going-active {
background: #5fcf80;
color: #0f1a10;
}

/* LEAFLET POPUP DARK THEME */
.net-popup .leaflet-popup-content-wrapper {
background: #1a1a2e;
color: #f0ead6;
border: 1px solid rgba(232,201,122,0.2);
border-radius: 10px;
box-shadow: 0 4px 20px rgba(0,0,0,0.5);
}
.net-popup .leaflet-popup-tip { background: #1a1a2e; }

/* TOAST */
#toast {
position: fixed;
bottom: 80px;
left: 50%;
transform: translateX(-50%) translateY(8px);
background: var(â€“ac);
color: #1a1208;
padding: 8px 20px;
border-radius: 20px;
font-size: 0.78rem;
font-weight: 700;
opacity: 0;
transition: opacity 0.25s, transform 0.25s;
pointer-events: none;
z-index: 999;
}
#toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
</style>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
// Fallback if Supabase fails to load
// Set up supabase fallback immediately in case CDN fails
function setupSupabaseFallback() {
  if (!window.supabase) {
    window.supabase = { createClient: function() { return { auth: { getSession: async function() { return {data:{session:null}}; }, onAuthStateChange: function() {}, signInWithPassword: async function() { return {error:{message:'Offline mode'}}; }, signUp: async function() { return {error:{message:'Offline mode'}}; }, signInWithOAuth: async function() {}, signOut: async function() {}, resetPasswordForEmail: async function() { return {}; } }, from: function() { return { select: function() { return { eq: function() { return { single: async function() { return {data:null,error:'offline'}; } } } } }, upsert: async function() { return {}; } }; } }; } };
  }
}
window.addEventListener('error', function(e) { setupSupabaseFallback(); }, true);
</script>

</head>
<body>

<!-- SPLASH SCREEN -->

<!-- AUTH SCREEN -->

<!-- FORGOT PASSWORD SCREEN -->

<div id="app">

  <!-- HOME SCREEN -->

  <div class="screen active" id="screen-home">

```
<!-- Header -->
<div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:16px;">
  <div>
    <div style="font-family:'Cormorant Garamond',serif; font-size:1.6rem; font-weight:300; color:var(--ac);">Just For Today</div>
    <div style="font-size:0.62rem; color:var(--tm); letter-spacing:0.08em; text-transform:uppercase;">Clean Living</div>
  </div>
  <button id="home-signin-btn" onclick="openAccountSheet()" style="width:34px;height:34px;border-radius:50%;background:var(--sf);border:1px solid rgba(232,201,122,0.35);cursor:pointer;font-size:1rem;display:flex;align-items:center;justify-content:center;color:var(--ac);">ğŸ‘¤</button>
</div>

<!-- Clean Date Counter -->
<div class="card">
  <div style="display:flex; align-items:center; gap:14px;">
    <div style="text-align:center; min-width:64px;">
      <div id="days-count" style="font-family:'Cormorant Garamond',serif; font-size:2.8rem; font-weight:300; color:var(--ac); line-height:1;">0</div>
      <div style="font-size:0.54rem; font-weight:700; color:var(--tm); letter-spacing:0.1em; text-transform:uppercase;">Days Clean</div>
    </div>
    <div style="flex:1;">
      <div style="font-size:0.68rem; color:var(--tm); margin-bottom:6px;">Set your clean date</div>
      <input type="date" id="clean-date-input" class="input" onchange="saveCleanDate(this.value)">
      <div id="clean-date-label" style="font-size:0.64rem; color:var(--tm); margin-top:4px;"></div>
    </div>
  </div>
</div>

<!-- Mood Check-in -->
<div class="card">
  <div class="label">Today's Check-In</div>
  <div class="mood-row">
    <div class="mood-btn" id="mood-sad" onclick="setMood('sad')">
      <div class="mood-emoji">&#x1F614;</div>
      <div class="mood-label">Low</div>
    </div>
    <div class="mood-btn" id="mood-meh" onclick="setMood('meh')">
      <div class="mood-emoji">&#x1F610;</div>
      <div class="mood-label">Okay</div>
    </div>
    <div class="mood-btn" id="mood-good" onclick="setMood('good')">
      <div class="mood-emoji">&#x1F642;</div>
      <div class="mood-label">Good</div>
    </div>
    <div class="mood-btn" id="mood-great" onclick="setMood('great')">
      <div class="mood-emoji">&#x1F60A;</div>
      <div class="mood-label">Great</div>
    </div>
    <div class="mood-btn" id="mood-wow" onclick="setMood('wow')">
      <div class="mood-emoji">&#x1F31F;</div>
      <div class="mood-label">Amazing</div>
    </div>
  </div>
  <div id="mood-history" style="font-size:0.74rem; color:var(--tm); margin-top:10px;"></div>
</div>

<!-- Daily Quote -->
<div class="card" style="border-left: 3px solid var(--ac);">
  <div id="daily-quote" style="font-style:italic; font-size:0.84rem; line-height:1.6;"></div>
</div>


<!-- Daily Readings -->
<div class="label" style="margin-top:4px;">Today's Readings</div>
<a href="https://www.jftna.org/jft/" target="_blank" style="display:flex;align-items:center;gap:13px;background:var(--sf);border:1px solid rgba(232,201,122,0.35);border-radius:var(--r);padding:13px 15px;margin-bottom:8px;text-decoration:none;color:var(--tx);box-shadow:0 2px 8px rgba(0,0,0,0.25);">
  <div style="font-size:1.4rem;">&#x1F4D4;</div>
  <div style="flex:1;">
    <div style="font-weight:600;font-size:0.86rem;">Just For Today</div>
    <div style="font-size:0.7rem;color:var(--tm);margin-top:2px;">Read today's daily meditation</div>
  </div>
  <div style="color:var(--tm);">&#8250;</div>
</a>
<a href="https://spadna.org" target="_blank" style="display:flex;align-items:center;gap:13px;background:var(--sf);border:1px solid rgba(232,201,122,0.35);border-radius:var(--r);padding:13px 15px;margin-bottom:8px;text-decoration:none;color:var(--tx);box-shadow:0 2px 8px rgba(0,0,0,0.25);">
  <div style="font-size:1.4rem;">&#x2728;</div>
  <div style="flex:1;">
    <div style="font-weight:600;font-size:0.86rem;">Spiritual Principle a Day</div>
    <div style="font-size:0.7rem;color:var(--tm);margin-top:2px;">Read today's spiritual principle</div>
  </div>
  <div style="color:var(--tm);">&#8250;</div>
</a>

<!-- Quick Links -->
<div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:2px;">
  <div class="card" onclick="showScreen('journal')" style="text-align:center; cursor:pointer; margin-bottom:0; padding:18px 16px;">
    <div style="font-size:1.8rem;">&#x270D;</div>
    <div style="font-size:0.76rem; font-weight:600; color:var(--tx); margin-top:6px;">Journal</div>
  </div>
  <div class="card" onclick="showScreen('meetings')" style="text-align:center; cursor:pointer; margin-bottom:0; padding:18px 16px;">
    <div style="font-size:1.8rem;">&#x1F5D3;</div>
    <div style="font-size:0.76rem; font-weight:600; color:var(--tx); margin-top:6px;">Meetings</div>
  </div>
</div>

<!-- Crisis Line -->
<div style="background:rgba(180,60,60,0.12); border:1px solid rgba(180,60,60,0.25); border-radius:var(--r); padding:12px 14px; margin-top:10px;">
  <div style="display:flex; gap:10px; align-items:center; margin-bottom:8px;">
    <div style="font-size:1rem;">ğŸ“</div>
    <div style="font-size:0.74rem; font-weight:700; color:var(--tx);">Helplines</div>
  </div>
  <a href="tel:03009991212" style="display:flex; align-items:center; justify-content:space-between; text-decoration:none; padding:8px 0; border-bottom:1px solid rgba(180,60,60,0.2);">
    <div>
      <div style="font-size:0.76rem; font-weight:700; color:#ff6b6b;">ğŸ‡¬ğŸ‡§ UK Helpline</div>
      <div style="font-size:0.63rem; color:var(--tm);">0300 999 1212 Â· 10amâ€“midnight daily</div>
    </div>
    <div style="font-size:0.7rem; color:var(--tm);">Tap to call â€º</div>
  </a>
  <a href="tel:+18187739999" style="display:flex; align-items:center; justify-content:space-between; text-decoration:none; padding:8px 0; border-bottom:1px solid rgba(180,60,60,0.2);">
    <div>
      <div style="font-size:0.76rem; font-weight:700; color:#ff6b6b;">ğŸŒ NA World Service Office</div>
      <div style="font-size:0.63rem; color:var(--tm);">+1 818 773 9999 Â· Monâ€“Fri, 8amâ€“5pm PST</div>
    </div>
    <div style="font-size:0.7rem; color:var(--tm);">Tap to call â€º</div>
  </a>
  <a href="https://www.na.org/meetingsearch" target="_blank" style="display:flex; align-items:center; justify-content:space-between; text-decoration:none; padding:8px 0;">
    <div>
      <div style="font-size:0.76rem; font-weight:700; color:#ff6b6b;">ğŸ” Find Your Local Helpline</div>
      <div style="font-size:0.63rem; color:var(--tm);">na.org Â· Search by country or region</div>
    </div>
    <div style="font-size:0.7rem; color:var(--tm);">Open â€º</div>
  </a>
</div>
```

  </div><!-- end home -->

  <!-- PLACEHOLDER SCREENS (we'll build these next) -->

  <div class="screen" id="screen-journal">

```
<div style="font-family:'Cormorant Garamond',serif; font-size:1.9rem; font-weight:300; color:var(--ac); margin-bottom:2px;">Journal</div>
<div style="font-size:0.62rem; color:var(--tm); letter-spacing:0.08em; text-transform:uppercase; margin-bottom:18px;">Your daily recovery writing</div>

<!-- JOURNAL HOME - type selector -->
<div id="j-home">
  <div class="label">Choose a journal type</div>

  <div onclick="openJournal('gratitude')" class="j-type-card">
    <div style="font-size:1.8rem;width:42px;text-align:center;">&#x1F64F;</div>
    <div style="flex:1;">
      <div style="font-weight:700; font-size:0.92rem;">Gratitude List</div>
      <div style="font-size:0.74rem; color:var(--tm); margin-top:3px;">Count your blessings with guided prompts</div>
    </div>
    <div style="color:var(--tm);font-size:1.1rem;">&#8250;</div>
  </div>

  <div onclick="openJournal('spotcheck')" class="j-type-card">
    <div style="font-size:1.8rem;width:42px;text-align:center;">&#x26A1;</div>
    <div style="flex:1;">
      <div style="font-weight:700; font-size:0.92rem;">Spot Check Inventory</div>
      <div style="font-size:0.74rem; color:var(--tm); margin-top:3px;">Quick nightly check-in based on Step 10</div>
    </div>
    <div style="color:var(--tm);font-size:1.1rem;">&#8250;</div>
  </div>

  <div onclick="openJournal('step10')" class="j-type-card">
    <div style="font-size:1.8rem;width:42px;text-align:center;">&#x1F4CB;</div>
    <div style="flex:1;">
      <div style="font-weight:700; font-size:0.92rem;">Full Step 10 Inventory</div>
      <div style="font-size:0.74rem; color:var(--tm); margin-top:3px;">Complete daily inventory questions</div>
    </div>
    <div style="color:var(--tm);font-size:1.1rem;">&#8250;</div>
  </div>

  <div id="j-type-guiding" onclick="openJournal('guiding')" class="j-type-card">
    <div style="font-size:1.8rem;width:42px;text-align:center;">&#x1F4D6;</div>
    <div style="flex:1;">
      <div style="font-weight:700; font-size:0.92rem;">Guiding Principles</div>
      <div style="font-size:0.74rem; color:var(--tm); margin-top:3px;">Work through your Traditions questions</div>
    </div>
    <div style="color:var(--tm);font-size:1.1rem;">&#8250;</div>
  </div>

  <div onclick="openJournal('daily')" class="j-type-card">
    <div style="font-size:1.8rem;width:42px;text-align:center;">&#x270D;</div>
    <div style="flex:1;">
      <div style="font-weight:700; font-size:0.92rem;">Daily Journal</div>
      <div style="font-size:0.74rem; color:var(--tm); margin-top:3px;">Free writing with gentle prompts</div>
    </div>
    <div style="color:var(--tm);font-size:1.1rem;">&#8250;</div>
  </div>

  <!-- Past entries -->
  <div style="display:flex;align-items:center;justify-content:space-between;margin-top:20px;margin-bottom:8px;">
    <div class="label" style="margin:0;">Recent Entries</div>
    <button onclick="showExportPicker()" style="background:var(--sf);border:1px solid var(--bd);border-radius:20px;padding:5px 12px;font-size:0.66rem;color:var(--ac);cursor:pointer;">â†‘ Export</button>
  </div>
  <div id="j-entries"></div>
</div>

<!-- JOURNAL WRITE VIEW -->
<div id="j-write" style="display:none;">
  <div style="display:flex; align-items:center; gap:12px; margin-bottom:16px;">
    <button onclick="closeJournal()" style="background:var(--sf);border:1px solid var(--bd);border-radius:50%;width:34px;height:34px;color:var(--tx);font-size:1rem;cursor:pointer;flex-shrink:0;">&#8592;</button>
    <div>
      <div id="j-write-title" style="font-weight:700; font-size:0.94rem;"></div>
      <div id="j-write-date" style="font-size:0.68rem; color:var(--tm);"></div>
    </div>
  </div>

  <!-- Prompts area -->
  <div id="j-prompts"></div>

  <!-- Text area -->
  <textarea id="j-text" class="input" rows="10" placeholder="Write here..." style="resize:none; line-height:1.6; padding:12px;"></textarea>

  <div style="display:flex; gap:8px; margin-top:10px;">
    <button onclick="saveJournal()" class="btn" style="flex:1;">Save Entry</button>
    <button id="j-delete-btn" onclick="deleteJournal()" style="display:none; background:transparent; border:1px solid rgba(180,60,60,0.4); border-radius:var(--r); padding:13px 16px; color:#ff6b6b; font-size:0.8rem; cursor:pointer;">Delete</button>
  </div>
</div>
```

  </div>

  <div class="screen" id="screen-steps">
    <div style="font-family:'Cormorant Garamond',serif; font-size:1.9rem; font-weight:300; color:var(--ac); margin-bottom:2px;">Worksheets</div>
    <div style="font-size:0.62rem; color:var(--tm); letter-spacing:0.08em; text-transform:uppercase; margin-bottom:18px;">Step work &amp; recovery worksheets</div>
        <!-- WORKSHEETS -->

```
<!-- CUSTOM QUESTIONS -->
<div class="label" style="margin-top:20px;"><span style="margin-right:5px;">&#x270F;</span>My Own Questions</div>
<div style="font-size:0.72rem;color:var(--tm);margin-bottom:12px;line-height:1.5;">Add your own questions from your workbook or sponsor. Once saved they'll appear in your journal automatically.</div>

<!-- Step 10 custom questions -->
<div style="background:var(--sf);border:1px solid var(--bd);border-radius:var(--r);padding:16px;margin-bottom:10px;">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;">
    <div style="font-size:0.82rem;font-weight:700;color:var(--ac);">&#x1F4CB; Step 10 Questions</div>
    <a href="https://cart-us.na.org/recovery-products/books/the-na-step-working-guides-1400" target="_blank" style="font-size:0.65rem;color:var(--tm);text-decoration:underline;">Buy the workbook â€º</a>
  </div>
  <div style="font-size:0.7rem;color:var(--tm);margin-bottom:10px;">One question per line â€” replaces the default questions in your Step 10 journal.</div>
  <textarea id="custom-step10" style="width:100%;min-height:110px;background:var(--sf2);border:1px solid var(--bd);border-radius:10px;padding:10px;color:var(--tx);font-size:0.8rem;line-height:1.6;resize:vertical;box-sizing:border-box;" placeholder="Paste your questions here, one per line..."></textarea>
  <div style="display:flex;gap:8px;margin-top:10px;">
    <button onclick="saveCustomStep10()" class="btn" style="flex:2;margin-top:0;padding:11px;">Save</button>
    <button onclick="clearCustomStep10()" style="flex:1;padding:11px;background:transparent;border:1px solid var(--bd);border-radius:var(--r);color:var(--tm);font-size:0.75rem;cursor:pointer;">Reset</button>
  </div>
  <div id="step10-saved-msg" style="display:none;margin-top:8px;font-size:0.72rem;color:#5fcf80;text-align:center;">&#x2713; Saved â€” your questions will appear in the Step 10 journal</div>
</div>

<!-- Guiding Principles custom questions -->
<div style="background:var(--sf);border:1px solid var(--bd);border-radius:var(--r);padding:16px;margin-bottom:8px;">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;">
    <div style="font-size:0.82rem;font-weight:700;color:var(--ac);">&#x1F4D6; Guiding Principles Questions</div>
    <a href="javascript:buyBook('guiding-principles')" style="font-size:0.65rem;color:var(--tm);text-decoration:underline;">Buy the workbook â€º</a>
  </div>
  <div style="font-size:0.7rem;color:var(--tm);margin-bottom:10px;">One question per line â€” adds a Guiding Principles journal type once saved.</div>
  <textarea id="custom-guiding" style="width:100%;min-height:110px;background:var(--sf2);border:1px solid var(--bd);border-radius:10px;padding:10px;color:var(--tx);font-size:0.8rem;line-height:1.6;resize:vertical;box-sizing:border-box;" placeholder="Paste your questions here, one per line..."></textarea>
  <button onclick="saveCustomGuiding()" class="btn" style="margin-top:10px;width:100%;">Save</button>
  <div id="guiding-saved-msg" style="display:none;margin-top:8px;font-size:0.72rem;color:#5fcf80;text-align:center;">&#x2713; Saved â€” Guiding Principles now appears in your journal</div>
</div>
```

  </div><!-- end screen-steps -->

  <div class="screen" id="screen-meetings">
    <div style="font-family:'Cormorant Garamond',serif; font-size:1.9rem; font-weight:300; color:var(--ac); margin-bottom:2px;">Meetings</div>
    <div style="font-size:0.62rem; color:var(--tm); letter-spacing:0.08em; text-transform:uppercase; margin-bottom:20px;">Find your fellowship</div>

```
<!-- IN-PERSON FINDERS -->
<div class="label">ğŸ“ Find an In-Person Meeting</div>

<a href="https://na.org/meetingsearch/" target="_blank" class="meeting-card">
  <div class="meeting-left">
    <div class="meeting-flag">ğŸŒ</div>
    <div>
      <div class="meeting-title">NA World Meeting Search</div>
      <div class="meeting-sub">Find meetings anywhere in the world</div>
    </div>
  </div>
  <div class="meeting-arr">â€º</div>
</a>

<a href="https://meetings.ukna.org/meeting/search" target="_blank" class="meeting-card">
  <div class="meeting-left">
    <div class="meeting-flag">ğŸ‡¬ğŸ‡§</div>
    <div>
      <div class="meeting-title">UK Meeting Finder</div>
      <div class="meeting-sub">Search by postcode, town or county</div>
    </div>
  </div>
  <div class="meeting-arr">â€º</div>
</a>

<a href="https://edmna.org/regions-and-events/" target="_blank" class="meeting-card">
  <div class="meeting-left">
    <div class="meeting-flag">ğŸ‡ªğŸ‡º</div>
    <div>
      <div class="meeting-title">European Meeting Finder</div>
      <div class="meeting-sub">NA European Delegates Meeting â€” all regions</div>
    </div>
  </div>
  <div class="meeting-arr">â€º</div>
</a>

<!-- ONLINE MEETINGS -->
<div class="label" style="margin-top:20px;">ğŸ’» Online & Virtual Meetings</div>
<div style="font-size:0.72rem; color:var(--tm); margin-bottom:12px; line-height:1.5;">Can't get to a meeting? Online meetings are available 24/7 from anywhere in the world.</div>

<a href="https://virtual-na.org/meetings/" target="_blank" class="meeting-card">
  <div class="meeting-left">
    <div class="meeting-flag">ğŸŒ</div>
    <div>
      <div class="meeting-title">Virtual NA</div>
      <div class="meeting-sub">Worldwide online & phone meetings, sorted by language & day</div>
    </div>
  </div>
  <div class="meeting-arr">â€º</div>
</a>

<a href="https://meetings.ukna.org/meeting/search/online" target="_blank" class="meeting-card">
  <div class="meeting-left">
    <div class="meeting-flag">ğŸ‡¬ğŸ‡§</div>
    <div>
      <div class="meeting-title">UK Online Meetings</div>
      <div class="meeting-sub">450+ online UK NA meetings</div>
    </div>
  </div>
  <div class="meeting-arr">â€º</div>
</a>





<!-- HELPLINE REMINDER -->
<div style="background:var(--sf); border:1px solid var(--bd); border-radius:var(--r); padding:14px; margin-top:20px;">
  <div style="font-size:0.68rem; color:var(--tm); text-transform:uppercase; letter-spacing:0.06em; margin-bottom:12px;">ğŸ“ Helplines</div>
  <a href="tel:03009991212" style="display:flex; align-items:center; justify-content:space-between; text-decoration:none; padding:8px 0; border-bottom:1px solid var(--bd);">
    <div>
      <div style="font-size:0.82rem; font-weight:700; color:var(--ac);">ğŸ‡¬ğŸ‡§ UK Helpline</div>
      <div style="font-size:0.68rem; color:var(--tm); margin-top:2px;">0300 999 1212 Â· 10amâ€“midnight daily</div>
    </div>
    <div style="font-size:0.7rem; color:var(--tm);">Tap to call â€º</div>
  </a>
  <a href="tel:+18187739999" style="display:flex; align-items:center; justify-content:space-between; text-decoration:none; padding:8px 0; border-bottom:1px solid var(--bd);">
    <div>
      <div style="font-size:0.82rem; font-weight:700; color:var(--ac);">ğŸŒ NA World Service Office</div>
      <div style="font-size:0.68rem; color:var(--tm); margin-top:2px;">+1 818 773 9999 Â· Monâ€“Fri, 8amâ€“5pm PST</div>
    </div>
    <div style="font-size:0.7rem; color:var(--tm);">Tap to call â€º</div>
  </a>
  <a href="https://www.na.org/meetingsearch" target="_blank" style="display:flex; align-items:center; justify-content:space-between; text-decoration:none; padding:8px 0;">
    <div>
      <div style="font-size:0.82rem; font-weight:700; color:var(--ac);">ğŸ” Find Your Local Helpline</div>
      <div style="font-size:0.68rem; color:var(--tm); margin-top:2px;">na.org Â· Search by country or region</div>
    </div>
    <div style="font-size:0.7rem; color:var(--tm);">Open â€º</div>
  </a>
</div>
```

  </div>

  <div class="screen" id="screen-books">
    <div style="font-family:'Cormorant Garamond',serif; font-size:1.9rem; font-weight:300; color:var(--ac); margin-bottom:2px;">Books</div>
    <div style="font-size:0.62rem; color:var(--tm); letter-spacing:0.08em; text-transform:uppercase; margin-bottom:18px;">NA Literature Library</div>

```
<!-- MAIN BOOKS -->
<div class="label">ğŸ“• Main Books</div>
<div style="font-size:0.7rem; color:var(--tm); margin-bottom:12px;">Tap a book to see purchase options</div>

<div class="book-expand-card">
  <div class="book-card-header" onclick="toggleBook(this)">
    <div class="book-icon">ğŸ“˜</div>
    <div class="book-body"><div class="book-title">Basic Text</div><div class="book-sub">Narcotics Anonymous â€” 6th Edition</div></div>
    <div class="book-chevron">&#8250;</div>
  </div>
  <div class="book-card-body">
    <div class="book-section-label">ğŸ“± Digital Edition</div>
    <div class="book-btn-row">
      <a href="https://books.apple.com/us/book/narcotics-anonymous/id560639864" target="_blank" class="buy-btn apple-btn">ğŸ Apple Books</a>
      <a href="https://play.google.com/store/books/details/Fellowship_of_Narcotics_Anonymous_Narcotics_Anonymo?id=560639864" target="_blank" class="buy-btn google-btn">â–¶ Google Play</a>
    </div>
    <div class="book-section-label" style="margin-top:12px;">ğŸ“¦ Buy Hardcopy</div>
    <a href="https://cart-us.na.org/recovery-products/books/basic-text-hardcover-1101" target="_blank" class="buy-btn world-btn">ğŸŒ NA World Store</a>
    <a href="https://ukso.biz" target="_blank" class="buy-btn uk-btn">ğŸ‡¬ğŸ‡§ UK Service Office</a>
    <a href="https://cart-eu.na.org" target="_blank" class="buy-btn eu-btn">ğŸ‡ªğŸ‡º NA Europe Store</a>
  </div>
</div>
<div class="book-expand-card">
  <div class="book-card-header" onclick="toggleBook(this)">
    <div class="book-icon">ğŸ“”</div>
    <div class="book-body"><div class="book-title">Just for Today</div><div class="book-sub">Daily meditations for recovering addicts</div></div>
    <div class="book-chevron">&#8250;</div>
  </div>
  <div class="book-card-body">
    <div class="book-section-label">ğŸ“± Digital Edition</div>
    <div class="book-btn-row">
      <a href="https://books.apple.com/us/book/just-for-today/id1608426774" target="_blank" class="buy-btn apple-btn">ğŸ Apple Books</a>
      <a href="https://play.google.com/store/books/details?id=just-for-today-na" target="_blank" class="buy-btn google-btn">â–¶ Google Play</a>
    </div>
    <div class="book-section-label" style="margin-top:12px;">ğŸ“¦ Buy Hardcopy</div>
    <a href="https://cart-us.na.org/recovery-products/books/just-for-today-daily-meditation-book-1112" target="_blank" class="buy-btn world-btn">ğŸŒ NA World Store</a>
    <a href="https://ukso.biz" target="_blank" class="buy-btn uk-btn">ğŸ‡¬ğŸ‡§ UK Service Office</a>
    <a href="https://cart-eu.na.org" target="_blank" class="buy-btn eu-btn">ğŸ‡ªğŸ‡º NA Europe Store</a>
  </div>
</div>
<div class="book-expand-card">
  <div class="book-card-header" onclick="toggleBook(this)">
    <div class="book-icon">ğŸ“™</div>
    <div class="book-body"><div class="book-title">It Works: How and Why</div><div class="book-sub">The 12 Steps & 12 Traditions of NA</div></div>
    <div class="book-chevron">&#8250;</div>
  </div>
  <div class="book-card-body">
    <div class="book-section-label">ğŸ“± Digital Edition</div>
    <div class="book-btn-row">
      <a href="https://books.apple.com/us/book/it-works-how-and-why/id564200715" target="_blank" class="buy-btn apple-btn">ğŸ Apple Books</a>
      <a href="https://play.google.com/store/books/details/Fellowship_of_Narcotics_Anonymous_It_Works_How_and?id=564200715" target="_blank" class="buy-btn google-btn">â–¶ Google Play</a>
    </div>
    <div class="book-section-label" style="margin-top:12px;">ğŸ“¦ Buy Hardcopy</div>
    <a href="https://cart-us.na.org/recovery-products/books/it-works-5-how-and-why-hardcover-1140" target="_blank" class="buy-btn world-btn">ğŸŒ NA World Store</a>
    <a href="https://ukso.biz" target="_blank" class="buy-btn uk-btn">ğŸ‡¬ğŸ‡§ UK Service Office</a>
    <a href="https://cart-eu.na.org" target="_blank" class="buy-btn eu-btn">ğŸ‡ªğŸ‡º NA Europe Store</a>
  </div>
</div>
<div class="book-expand-card">
  <div class="book-card-header" onclick="toggleBook(this)">
    <div class="book-icon">ğŸ“–</div>
    <div class="book-body"><div class="book-title">Guiding Principles</div><div class="book-sub">The Spirit of Our Traditions</div></div>
    <div class="book-chevron">&#8250;</div>
  </div>
  <div class="book-card-body">
    <div class="book-section-label">ğŸ“± Digital Edition</div>
    <div class="book-btn-row">
      <a href="https://books.apple.com/us/book/guiding-principles-the-spirit-of-our-traditions/id1478457214" target="_blank" class="buy-btn apple-btn">ğŸ Apple Books</a>
      <a href="https://play.google.com/store/books/details/Fellowship_of_Narcotics_Anonymous_Guiding_Principle?id=1478457214" target="_blank" class="buy-btn google-btn">â–¶ Google Play</a>
    </div>
    <div class="book-section-label" style="margin-top:12px;">ğŸ“¦ Buy Hardcopy</div>
    <a href="https://cart-us.na.org/recovery-products/books" target="_blank" class="buy-btn world-btn">ğŸŒ NA World Store</a>
    <a href="https://ukso.biz" target="_blank" class="buy-btn uk-btn">ğŸ‡¬ğŸ‡§ UK Service Office</a>
    <a href="https://cart-eu.na.org" target="_blank" class="buy-btn eu-btn">ğŸ‡ªğŸ‡º NA Europe Store</a>
  </div>
</div>
<div class="book-expand-card">
  <div class="book-card-header" onclick="toggleBook(this)">
    <div class="book-icon">ğŸ›¤ï¸</div>
    <div class="book-body"><div class="book-title">Living Clean</div><div class="book-sub">The Journey Continues</div></div>
    <div class="book-chevron">&#8250;</div>
  </div>
  <div class="book-card-body">
    <div class="book-section-label">ğŸ“± Digital Edition</div>
    <div class="book-btn-row">
      <a href="https://books.apple.com/us/book/living-clean-the-journey-continues/id733950643" target="_blank" class="buy-btn apple-btn">ğŸ Apple Books</a>
      <a href="https://play.google.com/store/books/details/Fellowship_of_Narcotics_Anonymous_Living_Clean_The?id=733950643" target="_blank" class="buy-btn google-btn">â–¶ Google Play</a>
    </div>
    <div class="book-section-label" style="margin-top:12px;">ğŸ“¦ Buy Hardcopy</div>
    <a href="https://cart-us.na.org/recovery-products/books/living-clean-1160" target="_blank" class="buy-btn world-btn">ğŸŒ NA World Store</a>
    <a href="https://ukso.biz" target="_blank" class="buy-btn uk-btn">ğŸ‡¬ğŸ‡§ UK Service Office</a>
    <a href="https://cart-eu.na.org" target="_blank" class="buy-btn eu-btn">ğŸ‡ªğŸ‡º NA Europe Store</a>
  </div>
</div>
<div class="book-expand-card">
  <div class="book-card-header" onclick="toggleBook(this)">
    <div class="book-icon">ğŸ“‹</div>
    <div class="book-body"><div class="book-title">Step Working Guides</div><div class="book-sub">NA 12 Step working guides</div></div>
    <div class="book-chevron">&#8250;</div>
  </div>
  <div class="book-card-body">
    <div class="book-section-label">ğŸ“± Digital Edition</div>
    <div class="book-btn-row">
      <a href="https://books.apple.com/us/book/the-na-step-working-guides/id1036368127" target="_blank" class="buy-btn apple-btn">ğŸ Apple Books</a>
      <a href="https://play.google.com/store/books/details/Fellowship_of_Narcotics_Anonymous_The_NA_Step_Worki?id=1036368127" target="_blank" class="buy-btn google-btn">â–¶ Google Play</a>
    </div>
    <div class="book-section-label" style="margin-top:12px;">ğŸ“¦ Buy Hardcopy</div>
    <a href="https://cart-us.na.org/recovery-products/books/the-na-step-working-guides-1400" target="_blank" class="buy-btn world-btn">ğŸŒ NA World Store</a>
    <a href="https://ukso.biz" target="_blank" class="buy-btn uk-btn">ğŸ‡¬ğŸ‡§ UK Service Office</a>
    <a href="https://cart-eu.na.org" target="_blank" class="buy-btn eu-btn">ğŸ‡ªğŸ‡º NA Europe Store</a>
  </div>
</div>
<div class="book-expand-card">
  <div class="book-card-header" onclick="toggleBook(this)">
    <div class="book-icon">âœ¨</div>
    <div class="book-body"><div class="book-title">A Spiritual Principle a Day</div><div class="book-sub">Daily readings on spiritual principles</div></div>
    <div class="book-chevron">&#8250;</div>
  </div>
  <div class="book-card-body">
    <div class="book-section-label">ğŸ“± Digital Edition</div>
    <div class="book-btn-row">
      <a href="https://books.apple.com/us/book/a-spiritual-principle-a-day/id1590889673" target="_blank" class="buy-btn apple-btn">ğŸ Apple Books</a>
      <a href="https://play.google.com/store/books/details/Fellowship_of_Narcotics_Anonymous_A_Spiritual_Princ?id=1590889673" target="_blank" class="buy-btn google-btn">â–¶ Google Play</a>
    </div>
    <div class="book-section-label" style="margin-top:12px;">ğŸ“¦ Buy Hardcopy</div>
    <a href="https://cart-us.na.org/recovery-products/books/a-spiritual-principle-a-day-1170" target="_blank" class="buy-btn world-btn">ğŸŒ NA World Store</a>
    <a href="https://ukso.biz" target="_blank" class="buy-btn uk-btn">ğŸ‡¬ğŸ‡§ UK Service Office</a>
    <a href="https://cart-eu.na.org" target="_blank" class="buy-btn eu-btn">ğŸ‡ªğŸ‡º NA Europe Store</a>
  </div>
</div>

<!-- BOOKLETS -->
<div class="label" style="margin-top:20px;">ğŸ“„ Booklets</div>
<a href="https://na.org/wp-content/uploads/2024/05/AN1500_LWB-Little-White-Book-English-Anglicized.pdf" target="_blank" class="book-card">
  <div class="book-icon">ğŸ“„</div><div class="book-body"><div class="book-title">The White Booklet</div><div class="book-sub">Free PDF â€” official na.org</div></div><div class="book-arr">â€º</div>
</a>

<!-- INFORMATIONAL PAMPHLETS -->
<div class="label" style="margin-top:16px;">ğŸ“ƒ Informational Pamphlets</div>
<div style="font-size:0.7rem; color:var(--tm); margin-bottom:10px;">All free official PDFs from na.org</div>
<a href="https://na.org/wp-content/uploads/2024/05/AN3101_6-22-IP-1-English-Anglicized.pdf" target="_blank" class="book-card"><div class="book-icon">ğŸ“ƒ</div><div class="book-body"><div class="book-title">IP #1: Who, What, How, and Why</div></div><div class="book-arr">â€º</div></a>
<a href="https://na.org/wp-content/uploads/2024/05/AN3105-IP-5-English-Anglicized.pdf" target="_blank" class="book-card"><div class="book-icon">ğŸ“ƒ</div><div class="book-body"><div class="book-title">IP #5: Another Look</div></div><div class="book-arr">â€º</div></a>
<a href="https://na.org/wp-content/uploads/2024/05/AN3106-IP-6-English-Anglicized.pdf" target="_blank" class="book-card"><div class="book-icon">ğŸ“ƒ</div><div class="book-body"><div class="book-title">IP #6: Recovery &amp; Relapse</div></div><div class="book-arr">â€º</div></a>
<a href="https://na.org/wp-content/uploads/2024/05/AN3107-IP-7-English-Anglicized.pdf" target="_blank" class="book-card"><div class="book-icon">ğŸ“ƒ</div><div class="book-body"><div class="book-title">IP #7: Am I an Addict?</div></div><div class="book-arr">â€º</div></a>
<a href="https://na.org/wp-content/uploads/2024/05/AN3108-IP-8-English-Anglicized.pdf" target="_blank" class="book-card"><div class="book-icon">ğŸ“ƒ</div><div class="book-body"><div class="book-title">IP #8: Just for Today</div></div><div class="book-arr">â€º</div></a>
<a href="https://na.org/wp-content/uploads/2024/05/AN3109_10-22-IP-9-English-Anglicized.pdf" target="_blank" class="book-card"><div class="book-icon">ğŸ“ƒ</div><div class="book-body"><div class="book-title">IP #9: Living the Programme</div></div><div class="book-arr">â€º</div></a>
<a href="https://na.org/wp-content/uploads/2024/05/AN3111-IP-11-English-Anglicized.pdf" target="_blank" class="book-card"><div class="book-icon">ğŸ“ƒ</div><div class="book-body"><div class="book-title">IP #11: Sponsorship</div></div><div class="book-arr">â€º</div></a>
<a href="https://na.org/wp-content/uploads/2024/05/AN3112-IP-12-English-Anglicized.pdf" target="_blank" class="book-card"><div class="book-icon">ğŸ“ƒ</div><div class="book-body"><div class="book-title">IP #12: The Triangle of Self-Obsession</div></div><div class="book-arr">â€º</div></a>
<a href="https://na.org/wp-content/uploads/2024/05/AN3113-IP-13-English-Anglicized.pdf" target="_blank" class="book-card"><div class="book-icon">ğŸ“ƒ</div><div class="book-body"><div class="book-title">IP #13: Youth and Recovery</div></div><div class="book-arr">â€º</div></a>
<a href="https://na.org/wp-content/uploads/2024/05/AN3114-IP-14-English-Anglicized.pdf" target="_blank" class="book-card"><div class="book-icon">ğŸ“ƒ</div><div class="book-body"><div class="book-title">IP #14: One Addict's Experience</div></div><div class="book-arr">â€º</div></a>
<a href="https://na.org/wp-content/uploads/2024/05/AN3115_7-22-IP-15-English-Anglicized.pdf" target="_blank" class="book-card"><div class="book-icon">ğŸ“ƒ</div><div class="book-body"><div class="book-title">IP #15: PI and the NA Member</div></div><div class="book-arr">â€º</div></a>
<a href="https://na.org/wp-content/uploads/2024/05/AN3116-IP-16-English-Anglicized.pdf" target="_blank" class="book-card"><div class="book-icon">ğŸ“ƒ</div><div class="book-body"><div class="book-title">IP #16: For the Newcomer</div></div><div class="book-arr">â€º</div></a>
<a href="https://na.org/wp-content/uploads/2024/05/AN3119-IP-19-English-Anglicized.pdf" target="_blank" class="book-card"><div class="book-icon">ğŸ“ƒ</div><div class="book-body"><div class="book-title">IP #19: Self-Acceptance</div></div><div class="book-arr">â€º</div></a>
<a href="https://na.org/wp-content/uploads/2024/05/AN3120_7-22-IP-20-English-Anglicized.pdf" target="_blank" class="book-card"><div class="book-icon">ğŸ“ƒ</div><div class="book-body"><div class="book-title">IP #20: H&amp;I Service and the NA Member</div></div><div class="book-arr">â€º</div></a>
<a href="https://na.org/wp-content/uploads/2024/05/AN3122-IP-22-English-Anglicized.pdf" target="_blank" class="book-card"><div class="book-icon">ğŸ“ƒ</div><div class="book-body"><div class="book-title">IP #22: Welcome to Narcotics Anonymous</div></div><div class="book-arr">â€º</div></a>
<a href="https://na.org/wp-content/uploads/2024/05/AN3123-IP-23-English-Anglicized.pdf" target="_blank" class="book-card"><div class="book-icon">ğŸ“ƒ</div><div class="book-body"><div class="book-title">IP #23: Staying Clean on the Inside</div></div><div class="book-arr">â€º</div></a>
<a href="https://na.org/wp-content/uploads/2024/05/AN3124-IP-24-English-Anglicized.pdf" target="_blank" class="book-card"><div class="book-icon">ğŸ“ƒ</div><div class="book-body"><div class="book-title">IP #24: Why Are We Self-Supporting?</div></div><div class="book-arr">â€º</div></a>
```

  </div><!-- end screen-books -->

  <div class="screen" id="screen-resources">
    <div style="font-family:'Cormorant Garamond',serif; font-size:1.9rem; font-weight:300; color:var(--ac); margin-bottom:4px;">Movement</div>
    <div style="color:var(--tm); font-size:0.84rem; margin-bottom:18px;">Gentle practices to support your recovery â€” body, breath & mind</div>

```
<!-- YOGA -->
<div style="color:var(--ac); font-size:0.75rem; letter-spacing:0.12em; text-transform:uppercase; margin-bottom:10px;">ğŸ§˜ Yoga</div>

<a href="https://crpf.gov.in/writereaddata/images/pdf/Yoga_Beginner.pdf" target="_blank" class="meeting-card" style="text-decoration:none; display:flex; margin-bottom:10px;">
  <div class="meeting-left">
    <div style="font-size:1.5rem;">ğŸ“„</div>
  </div>
  <div style="flex:1;">
    <div class="meeting-title">Breath, Movement & Stillness</div>
    <div class="meeting-sub">A complete yoga manual for beginners â€” poses, safety guidance & philosophy</div>
  </div>
  <div class="meeting-arr">â€º</div>
</a>

<a href="https://darebee.com/pdf/programs/30-days-of-yoga.pdf" target="_blank" class="meeting-card" style="text-decoration:none; display:flex; margin-bottom:10px;">
  <div class="meeting-left">
    <div style="font-size:1.5rem;">ğŸ“„</div>
  </div>
  <div style="flex:1;">
    <div class="meeting-title">30 Days of Yoga</div>
    <div class="meeting-sub">A free beginner programme â€” one session per day, building gently over a month</div>
  </div>
  <div class="meeting-arr">â€º</div>
</a>

<a href="https://tintyoga.com/wp-content/uploads/2019/11/Yoga-Class-Plans.pdf" target="_blank" class="meeting-card" style="text-decoration:none; display:flex; margin-bottom:18px;">
  <div class="meeting-left">
    <div style="font-size:1.5rem;">ğŸ“„</div>
  </div>
  <div style="flex:1;">
    <div class="meeting-title">Beginner Yoga Sequence</div>
    <div class="meeting-sub">A 60-minute class plan with alignment focus â€” accessible for complete beginners</div>
  </div>
  <div class="meeting-arr">â€º</div>
</a>

<!-- BREATHWORK -->
<div style="color:var(--ac); font-size:0.75rem; letter-spacing:0.12em; text-transform:uppercase; margin-bottom:10px;">ğŸŒ¬ï¸ Breathwork</div>

<a href="https://uhs.berkeley.edu/sites/default/files/breathing_exercises_0.pdf" target="_blank" class="meeting-card" style="text-decoration:none; display:flex; margin-bottom:10px;">
  <div class="meeting-left">
    <div style="font-size:1.5rem;">ğŸ“„</div>
  </div>
  <div style="flex:1;">
    <div class="meeting-title">Breathing Exercises Guide</div>
    <div class="meeting-sub">UC Berkeley Health â€” simple techniques including diaphragmatic & box breathing</div>
  </div>
  <div class="meeting-arr">â€º</div>
</a>

<a href="https://umsonline.org/printerfriendly/pranayama.pdf" target="_blank" class="meeting-card" style="text-decoration:none; display:flex; margin-bottom:10px;">
  <div class="meeting-left">
    <div style="font-size:1.5rem;">ğŸ“„</div>
  </div>
  <div style="flex:1;">
    <div class="meeting-title">Pranayama & the Art of Breathing</div>
    <div class="meeting-sub">An introduction to yogic breathwork â€” what it is, how it works & techniques to try</div>
  </div>
  <div class="meeting-arr">â€º</div>
</a>

<a href="https://www.artofliving.org/us-en/breathwork/pranayama/breathing-exercises" target="_blank" class="meeting-card" style="text-decoration:none; display:flex; margin-bottom:18px;">
  <div class="meeting-left">
    <div style="font-size:1.5rem;">ğŸŒ</div>
  </div>
  <div style="flex:1;">
    <div class="meeting-title">Beginner's Guide to Breathwork</div>
    <div class="meeting-sub">Art of Living â€” 5 techniques to try today with step-by-step instructions</div>
  </div>
  <div class="meeting-arr">â€º</div>
</a>

<!-- MEDITATION -->
<div style="color:var(--ac); font-size:0.75rem; letter-spacing:0.12em; text-transform:uppercase; margin-bottom:10px;">ğŸª· Meditation</div>

<a href="https://share.upmc.com/wp-content/uploads/2021/10/HBEAT521847_Mindfulness_MeditationPDF_FNL-1.pdf" target="_blank" class="meeting-card" style="text-decoration:none; display:flex; margin-bottom:10px;">
  <div class="meeting-left">
    <div style="font-size:1.5rem;">ğŸ“„</div>
  </div>
  <div style="flex:1;">
    <div class="meeting-title">A Beginner's Guide to Mindfulness</div>
    <div class="meeting-sub">UPMC Health â€” what mindfulness is, breathing techniques & how to start today</div>
  </div>
  <div class="meeting-arr">â€º</div>
</a>

<a href="https://chloeyturner.com/wp-content/uploads/2023/04/eBook-Mindfulness-Meditation-for-Beginners-3.pdf" target="_blank" class="meeting-card" style="text-decoration:none; display:flex; margin-bottom:10px;">
  <div class="meeting-left">
    <div style="font-size:1.5rem;">ğŸ“„</div>
  </div>
  <div style="flex:1;">
    <div class="meeting-title">Simple Guide to Mindfulness Meditation</div>
    <div class="meeting-sub">Covers posture, breathing, attitudes & sitting meditation â€” beginner-friendly eBook</div>
  </div>
  <div class="meeting-arr">â€º</div>
</a>

<a href="https://zenfulspirit.com/wp-content/uploads/2017/07/Meditation-for-Beginners-Book-1.pdf" target="_blank" class="meeting-card" style="text-decoration:none; display:flex; margin-bottom:10px;">
  <div class="meeting-left">
    <div style="font-size:1.5rem;">ğŸ“„</div>
  </div>
  <div style="flex:1;">
    <div class="meeting-title">Meditation for Beginners</div>
    <div class="meeting-sub">A comprehensive guide â€” how to start, how long to sit & what to expect</div>
  </div>
  <div class="meeting-arr">â€º</div>
</a>

<a href="https://www.nhs.uk/mental-health/self-help/tips-and-support/mindfulness/" target="_blank" class="meeting-card" style="text-decoration:none; display:flex; margin-bottom:10px;">
  <div class="meeting-left">
    <div style="font-size:1.5rem;">ğŸŒ</div>
  </div>
  <div style="flex:1;">
    <div class="meeting-title">NHS Mindfulness Guide</div>
    <div class="meeting-sub">Trusted UK resource â€” what mindfulness is, how it helps & free audio exercises</div>
  </div>
  <div class="meeting-arr">â€º</div>
</a>
```

  </div>

  <!-- EVENTS SCREEN -->

  <div class="screen" id="screen-events">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:2px;">
      <div style="font-family:'Cormorant Garamond',serif;font-size:1.9rem;font-weight:300;color:var(--ac);">Events</div>
      <button onclick="openSubmitEvent()" style="background:var(--ac);border:none;border-radius:20px;padding:7px 14px;font-size:0.75rem;font-weight:700;color:#1a1208;cursor:pointer;">+ Submit Event</button>
    </div>
    <div style="font-size:0.62rem;color:var(--tm);letter-spacing:0.08em;text-transform:uppercase;margin-bottom:16px;">Global recovery events</div>

```
<!-- FILTERS -->
<div style="display:flex;gap:8px;margin-bottom:16px;overflow-x:auto;padding-bottom:4px;">
  <button onclick="filterEvents('all')" id="ef-all" class="ef-btn ef-active">All</button>
  <button onclick="filterEvents('UK')" id="ef-UK" class="ef-btn">ğŸ‡¬ğŸ‡§ UK</button>
  <button onclick="filterEvents('USA')" id="ef-USA" class="ef-btn">ğŸ‡ºğŸ‡¸ USA</button>
  <button onclick="filterEvents('Europe')" id="ef-Europe" class="ef-btn">ğŸ‡ªğŸ‡º Europe</button>
  <button onclick="filterEvents('Australia')" id="ef-Australia" class="ef-btn">ğŸ‡¦ğŸ‡º Australia</button>
  <button onclick="filterEvents('worldwide')" id="ef-worldwide" class="ef-btn">ğŸŒ Worldwide</button>
</div>

<!-- EVENTS LIST -->
<div id="events-list"></div>
<div id="events-empty" style="display:none;text-align:center;padding:40px 0;">
  <div style="font-size:2rem;margin-bottom:10px;">ğŸŒ</div>
  <div style="font-size:0.84rem;color:var(--tm);">No events yet</div>
  <div style="font-size:0.72rem;color:var(--tm);margin-top:4px;">Be the first to submit one</div>
</div>
<div id="events-loading" style="text-align:center;padding:30px 0;color:var(--tm);font-size:0.8rem;">Loading events...</div>
```

  </div>

  <!-- SUBMIT EVENT MODAL -->

  <div class="modal-overlay" id="submit-event-modal" onclick="closeSubmitEvent(event)">
    <div class="modal-sheet" onclick="event.stopPropagation()" style="max-height:92vh;">
      <div class="modal-title">Submit an Event</div>
      <div style="font-size:0.72rem;color:var(--tm);margin-bottom:16px;">All submissions are reviewed before going live.</div>

```
  <div class="modal-label">Event Name *</div>
  <input id="ev-name" class="input" type="text" placeholder="e.g. European Convention 2025">

  <div class="modal-label">Type</div>
  <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px;">
    <div class="role-btn" onclick="selectEvType(this,'Convention')">ğŸ›ï¸ Convention</div>
    <div class="role-btn" onclick="selectEvType(this,'Marathon')">â±ï¸ Marathon</div>
    <div class="role-btn" onclick="selectEvType(this,'Speaker Meeting')">ğŸ¤ Speaker</div>
    <div class="role-btn" onclick="selectEvType(this,'Workshop')">ğŸ“š Workshop</div>
    <div class="role-btn" onclick="selectEvType(this,'Other')">âœ¨ Other</div>
  </div>

  <div class="modal-label">Date *</div>
  <input id="ev-date" class="input" type="date">

  <div class="modal-label">End Date (if multi-day)</div>
  <input id="ev-enddate" class="input" type="date">

  <div class="modal-label">Location / Venue *</div>
  <input id="ev-location" class="input" type="text" placeholder="e.g. Birmingham, UK">

  <div class="modal-label">Country *</div>
  <select id="ev-country" class="input" style="appearance:none;">
    <option value="">Select country...</option>
    <option>UK</option><option>USA</option><option>Canada</option>
    <option>Australia</option><option>Ireland</option>
    <option>Germany</option><option>France</option><option>Netherlands</option>
    <option>Spain</option><option>Italy</option><option>Portugal</option>
    <option>Sweden</option><option>Norway</option><option>Denmark</option>
    <option>South Africa</option><option>New Zealand</option>
    <option>worldwide</option><option>Other</option>
  </select>

  <div class="modal-label">Website / Booking Link</div>
  <input id="ev-url" class="input" type="url" placeholder="https://...">

  <div class="modal-label">Flyer Image URL</div>
  <input id="ev-flyer" class="input" type="url" placeholder="Link to flyer image (optional)">
  <div style="font-size:0.68rem;color:var(--tm);margin-top:-8px;margin-bottom:14px;">Upload your flyer to Imgur or Google Drive and paste the link here</div>

  <div class="modal-label">Description</div>
  <textarea id="ev-desc" class="input" style="min-height:80px;resize:vertical;" placeholder="Tell people about the event..."></textarea>

  <div style="display:flex;gap:8px;margin-top:16px;">
    <button onclick="closeSubmitEventDirect()" style="flex:1;padding:13px;border:1px solid var(--bd);border-radius:var(--r);background:transparent;color:var(--tm);cursor:pointer;">Cancel</button>
    <button onclick="submitEvent()" class="btn" style="flex:2;margin-top:0;">Submit for Review</button>
  </div>
  <div id="ev-submit-msg" style="display:none;margin-top:12px;font-size:0.78rem;text-align:center;color:#5fcf80;">âœ“ Submitted! We'll review it shortly.</div>
</div>
```

  </div>

  <!-- EVENT DETAIL MODAL -->

  <div class="modal-overlay" id="event-detail-modal" onclick="closeEventDetail(event)">
    <div class="modal-sheet" onclick="event.stopPropagation()" style="max-height:92vh;">
      <div id="event-detail-content"></div>
      <button onclick="closeEventDetailDirect()" style="width:100%;margin-top:12px;padding:13px;border:1px solid var(--bd);border-radius:var(--r);background:transparent;color:var(--tm);cursor:pointer;">Close</button>
    </div>
  </div>

  <!-- ADMIN PANEL MODAL -->

  <div class="modal-overlay" id="admin-modal" onclick="closeAdminModal(event)">
    <div class="modal-sheet" onclick="event.stopPropagation()" style="max-height:92vh;">
      <div class="modal-title">&#x1F6E1; Admin Panel</div>
      <div id="admin-pending-list"></div>
      <button onclick="closeAdminModalDirect()" style="width:100%;margin-top:12px;padding:13px;border:1px solid var(--bd);border-radius:var(--r);background:transparent;color:var(--tm);cursor:pointer;">Close</button>
    </div>
  </div>

  <!-- NETWORK SCREEN -->

  <div class="screen" id="screen-network">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:2px;">
      <div style="font-family:'Cormorant Garamond',serif; font-size:1.9rem; font-weight:300; color:var(--ac);">My Network</div>
      <button onclick="openAddContact()" style="background:var(--ac);border:none;border-radius:50%;width:36px;height:36px;font-size:1.2rem;cursor:pointer;color:#1a1208;flex-shrink:0;">+</button>
    </div>
    <div style="font-size:0.62rem; color:var(--tm); letter-spacing:0.08em; text-transform:uppercase; margin-bottom:12px;">Your recovery people</div>

```
<!-- NETWORK MAP -->
<div id="net-map-wrap" style="border-radius:16px;overflow:hidden;margin-bottom:16px;border:1px solid var(--bd);position:relative;">
  <div id="net-map" style="height:220px;width:100%;background:var(--sf2);"></div>
  <div style="position:absolute;bottom:8px;left:8px;display:flex;gap:6px;z-index:1000;pointer-events:none;">
    <div style="background:rgba(15,15,26,0.85);border-radius:20px;padding:3px 8px;font-size:0.58rem;color:#fff;display:flex;align-items:center;gap:4px;"><span style="width:8px;height:8px;border-radius:50%;background:#e74c3c;display:inline-block;"></span>Sponsor</div>
    <div style="background:rgba(15,15,26,0.85);border-radius:20px;padding:3px 8px;font-size:0.58rem;color:#fff;display:flex;align-items:center;gap:4px;"><span style="width:8px;height:8px;border-radius:50%;background:#2ecc71;display:inline-block;"></span>Sponsee / Sister / Brother</div>
    <div style="background:rgba(15,15,26,0.85);border-radius:20px;padding:3px 8px;font-size:0.58rem;color:#fff;display:flex;align-items:center;gap:4px;"><span style="width:8px;height:8px;border-radius:50%;background:#f1c40f;display:inline-block;"></span>Friend</div>
  </div>
</div>

<div id="net-list"></div>
<div id="net-empty" style="display:none;text-align:center;padding:40px 0 20px;">
  <div style="font-size:2rem;margin-bottom:10px;">ğŸ¤</div>
  <div style="font-size:0.84rem;color:var(--tm);">No contacts yet</div>
  <div style="font-size:0.72rem;color:var(--tm);margin-top:4px;">Tap + to add someone from your network</div>
</div>
```

  </div>

  <!-- ADD CONTACT MODAL -->

  <div class="modal-overlay" id="contact-modal" onclick="closeContactModal(event)">
    <div class="modal-sheet" onclick="event.stopPropagation()">
      <div class="modal-title" id="contact-modal-title">Add Contact</div>

```
  <div class="modal-label">Name</div>
  <input id="cn-name" class="input" type="text" placeholder="Their name">

  <div class="modal-label">Relationship</div>
  <div class="role-grid">
    <div class="role-btn" onclick="selectRole(this,'Sponsor')">ğŸ’› Sponsor</div>
    <div class="role-btn" onclick="selectRole(this,'Sponsee')">ğŸŒ± Sponsee</div>
    <div class="role-btn" onclick="selectRole(this,'Sponsor Sister')">ğŸ’œ Sponsor Sister</div>
    <div class="role-btn" onclick="selectRole(this,'Sponsor Brother')">ğŸ’™ Sponsor Brother</div>
    <div class="role-btn" onclick="selectRole(this,'Friend in Recovery')" style="grid-column:span 2;">ğŸ¤ Friend in Recovery</div>
  </div>

  <div class="modal-label">Phone Number</div>
  <input id="cn-phone" class="input" type="tel" placeholder="+44 7700 000000">

  <div class="modal-label">WhatsApp Number <span style="color:var(--tm);font-weight:400;">(if different)</span></div>
  <input id="cn-whatsapp" class="input" type="tel" placeholder="Same as phone if blank">

  <div class="modal-label">Town / City</div>
  <input id="cn-location" class="input" type="text" placeholder="e.g. Manchester">

  <div class="modal-label">Clean Date</div>
  <input id="cn-cleandate" class="input" type="date">

  <div style="display:flex;gap:8px;margin-top:18px;">
    <button onclick="closeContactModalDirect()" style="flex:1;padding:13px;border:1px solid var(--bd);border-radius:var(--r);background:transparent;color:var(--tm);cursor:pointer;">Cancel</button>
    <button onclick="saveContact()" class="btn" style="flex:2;margin-top:0;">Save</button>
  </div>
  <div id="cn-delete-wrap" style="display:none;margin-top:10px;">
    <button onclick="deleteContact()" style="width:100%;padding:12px;border:1px solid rgba(180,60,60,0.4);border-radius:var(--r);background:transparent;color:#ff6b6b;font-size:0.8rem;cursor:pointer;">Remove Contact</button>
  </div>
</div>
```

  </div>

  <!-- EXPORT MODAL -->

  <div class="export-overlay" id="export-modal" onclick="closeExportModalDirect()">
    <div class="modal-sheet" onclick="event.stopPropagation()">
      <div id="export-picker-view">
        <div class="modal-title">Export Which Journal?</div>
        <div id="export-type-list"></div>
        <button onclick="closeExportModalDirect()" style="width:100%;margin-top:6px;padding:12px;border:1px solid var(--bd);border-radius:var(--r);background:transparent;color:var(--tm);cursor:pointer;">Cancel</button>
      </div>
      <div id="export-send-view" style="display:none;">
        <div class="modal-title" id="export-send-title"></div>
        <div id="export-preview" style="background:var(--sf2);border:1px solid var(--bd);border-radius:12px;padding:12px;font-size:0.72rem;color:var(--tm);line-height:1.6;max-height:200px;overflow-y:auto;margin-bottom:16px;white-space:pre-wrap;"></div>
        <div style="display:flex;gap:8px;">
          <button onclick="exportEmail()" class="btn" style="flex:1;margin-top:0;">âœ‰ï¸ Email</button>
          <button onclick="exportCopy()" class="btn" style="flex:1;margin-top:0;background:var(--sf2);color:var(--tx);border:1px solid var(--bd);">ğŸ“‹ Copy</button>
        </div>
        <button onclick="showExportPicker()" style="width:100%;margin-top:10px;padding:12px;border:1px solid var(--bd);border-radius:var(--r);background:transparent;color:var(--tm);cursor:pointer;">â† Back</button>
      </div>
    </div>
  </div>

  <!-- NAV -->

  <nav>
    <div class="nav-item active" id="nav-home" onclick="showScreen('home')">
      <div class="nav-icon">&#x1F3E0;</div>
      <div>Home</div>
    </div>
    <div class="nav-item" id="nav-journal" onclick="showScreen('journal')">
      <div class="nav-icon">&#x270D;</div>
      <div>Journal</div>
    </div>
    <div class="nav-item" id="nav-steps" onclick="showScreen('steps')">
      <div class="nav-icon">&#x1F4D6;</div>
      <div>Worksheets</div>
    </div>
    <div class="nav-item" id="nav-books" onclick="showScreen('books')">
      <div class="nav-icon">&#x1F4DA;</div>
      <div>Books</div>
    </div>
    <div class="nav-item" id="nav-meetings" onclick="showScreen('meetings')">
      <div class="nav-icon">&#x1F5D3;</div>
      <div>Meetings</div>
    </div>
    <div class="nav-item" id="nav-network" onclick="showScreen('network')">
      <div class="nav-icon">ğŸ¤</div>
      <div>Network</div>
    </div>
    <div class="nav-item" id="nav-events" onclick="showScreen('events')">
      <div class="nav-icon">&#x1F30D;</div>
      <div>Events</div>
    </div>
    <div class="nav-item" id="nav-resources" onclick="showScreen('resources')">
      <div class="nav-icon">ğŸƒ</div>
      <div>Movement</div>
    </div>
  </nav>

</div><!-- end app -->
<div id="toast"></div>

<script>
var QUOTES = [
  {text: "Just for today, I will try to live through this day only.", source: "Just for Today"},
  {text: "We admitted we were powerless over our addiction.", source: "Step One"},
  {text: "The foundation of recovery is honesty.", source: "Basic Text"},
  {text: "Recovery is a process, not an event.", source: "Fellowship"},
  {text: "Keep coming back - it works if you work it.", source: "Fellowship"},
  {text: "One day at a time.", source: "Fellowship"},
  {text: "We do not have to be alone anymore.", source: "Basic Text"},
  {text: "Pain is inevitable; suffering is optional.", source: "Fellowship"},
  {text: "We will love and support you no matter what.", source: "Fellowship"},
  {text: "God, grant me the serenity to accept the things I cannot change.", source: "Serenity Prayer"}
];

// --- STATE ---
var cleanDate = localStorage.getItem('na_clean_date') || '';
var moodLog   = JSON.parse(localStorage.getItem('na_mood_log')  || '[]');

// --- NAVIGATION ---
function showScreen(name) {
  // Membership gate
  if (!canAccess(name)) {
    if (!currentUser) { showWelcomeScreen(); return; }
    showPaywall(name);
    return;
  }
  document.querySelectorAll('.screen').forEach(function(s) { s.classList.remove('active'); });
  document.querySelectorAll('.nav-item').forEach(function(n) { n.classList.remove('active'); });
  document.getElementById('screen-' + name).classList.add('active');
  document.getElementById('nav-' + name).classList.add('active');
  if (name === 'network') {
    setTimeout(function(){
      if (typeof L === 'undefined') return;
      if (!netMap) {
        initNetMap();
        setTimeout(function(){ geocodeAndPlot(); }, 200);
      } else {
        netMap.invalidateSize();
        geocodeAndPlot();
      }
    }, 100);
  }
  if (name === 'events') {
    loadEvents();
  }
}

// --- CLEAN DATE ---
function saveCleanDate(val) {
  cleanDate = val;
  localStorage.setItem('na_clean_date', val);
  updateDaysCount();
}

function updateDaysCount() {
  if (!cleanDate) { document.getElementById('days-count').textContent = '0'; return; }
  var start = new Date(cleanDate);
  var today = new Date();
  var days = Math.floor((today - start) / 86400000);
  if (days < 0) days = 0;
  document.getElementById('days-count').textContent = days;
  var label = days === 1 ? '1 day clean' : days + ' days clean';
  document.getElementById('clean-date-label').textContent = label;
}

// --- MOOD ---
function setMood(mood) {
  var today = new Date().toISOString().split('T')[0];
  moodLog = moodLog.filter(function(m) { return m.date !== today; });
  moodLog.push({ date: today, mood: mood });
  if (moodLog.length > 30) moodLog = moodLog.slice(-30);
  localStorage.setItem('na_mood_log', JSON.stringify(moodLog));
  document.querySelectorAll('.mood-btn').forEach(function(b) { b.classList.remove('selected'); });
  document.getElementById('mood-' + mood).classList.add('selected');
  renderMoodHistory();
  toast('Mood saved');
}

function renderMoodHistory() {
  var emojis = { sad: '&#x1F614;', meh: '&#x1F610;', good: '&#x1F642;', great: '&#x1F60A;', wow: '&#x1F31F;' };
  var recent = moodLog.slice(-7);
  if (!recent.length) { document.getElementById('mood-history').innerHTML = ''; return; }
  var html = '<div style="font-size:0.62rem; color:var(--tm); margin-bottom:4px;">Recent</div><div style="display:flex; gap:5px;">';
  recent.forEach(function(m) {
    html += '<div style="text-align:center;"><div style="font-size:1rem;">' + (emojis[m.mood] || '') + '</div><div style="font-size:0.5rem; color:var(--tm);">' + m.date.slice(5) + '</div></div>';
  });
  html += '</div>';
  document.getElementById('mood-history').innerHTML = html;
}

function markTodayMood() {
  var today = new Date().toISOString().split('T')[0];
  var entry = moodLog.find(function(m) { return m.date === today; });
  if (entry) {
    document.getElementById('mood-' + entry.mood).classList.add('selected');
  }
}

// --- DAILY QUOTE ---
function showDailyQuote() {
  var q = QUOTES[new Date().getDate() % QUOTES.length];
  document.getElementById('daily-quote').innerHTML =
    '"' + q.text + '"<div style="font-size:0.7rem; color:var(--tm); margin-top:6px;">-- ' + q.source + '</div>';
}

// --- TOAST ---
function toast(msg) {
  var t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(function() { t.classList.remove('show'); }, 2000);
}


// --- JOURNAL DATA ---
var journalEntries = JSON.parse(localStorage.getItem('na_journal') || '[]');
var currentJournalId = null;
var currentJournalType = null;

var JOURNAL_TYPES = {
  gratitude: { title: 'Gratitude List', emoji: '&#x1F64F;' },
  spotcheck: { title: 'Spot Check Inventory', emoji: '&#x26A1;' },
  step10:    { title: 'Full Step 10 Inventory', emoji: '&#x1F4CB;' },
  guiding:   { title: 'Guiding Principles', emoji: '&#x1F4D6;' },
  daily:     { title: 'Daily Journal', emoji: '&#x270D;' }
};

var GRATITUDE_PROMPTS = [
  "What's something small that made you smile today?",
  "Who has shown up for you recently, however small?",
  "What's one thing about your body you're grateful for?",
  "Name something you often take for granted.",
  "What's a quality in yourself you appreciate?",
  "Describe a moment of peace you felt recently.",
  "What does having another clean day mean to you?",
  "Who in recovery are you grateful for, and why?",
  "What's something in your home or surroundings you appreciate?",
  "Write about a challenge that helped you grow."
];

var SPOTCHECK_PROMPTS = [
  "Have I been resentful, selfish, dishonest or afraid today?",
  "Do I owe an apology to anyone?",
  "Have I kept something to myself that I should share with my sponsor?",
  "Was I kind and loving to those around me?",
  "Am I HALT right now â€” Hungry, Angry, Lonely, or Tired?",
  "Did I stay in the present, or was I in yesterday or tomorrow?",
  "What do I need to let go of before I sleep?",
  "Did I do anything today I'm proud of?"
];

var STEP10_QUESTIONS = [
  "Have I taken time today to reconnect with my Higher Power?",
  "Did I seek spiritual guidance today, and if so, how?",
  "How have I been of service to others today?",
  "What am I grateful for that my Higher Power has given me today?",
  "Do I trust that my Higher Power can guide me toward a better way of living?",
  "Have any old patterns or behaviours shown up for me today?",
  "Have I been resentful, selfish, dishonest, or afraid at any point today?",
  "Did I set myself up for disappointment or unrealistic expectations?",
  "Was I kind and loving in my interactions with others today?",
  "Have I been living in the past or the future rather than the present?",
  "Did I allow myself to become obsessed or fixated on anything today?",
  "Have I let myself get too hungry, angry, lonely, or tired today?",
  "Am I taking myself or any situation too seriously right now?",
  "Are there any physical, mental, or spiritual struggles I need to address?",
  "Is there anything I've been keeping from my sponsor that I should share?",
  "Did I experience any intense or overwhelming feelings today â€” what caused them?",
  "What areas of my life are causing me difficulty right now?",
  "Which character defects showed up in my behaviour today, and how?",
  "Did fear play a role in any of my actions or thoughts today?",
  "Is there anything I did today that I regret or wish I had handled differently?",
  "Is there anything I didn't do today that I know I should have?",
  "Am I genuinely open and willing to change?",
  "Was there conflict in any of my relationships today â€” what happened?",
  "Am I living with integrity in how I treat the people around me?",
  "Did I cause harm â€” directly or indirectly â€” to myself or anyone else today?",
  "Do I owe an apology or amends to anyone?",
  "Where did I go wrong today, and what would I do differently next time?",
  "Did I stay clean today?",
  "Was I compassionate and caring toward myself today?",
  "What feelings did I experience today, and how did I let them guide my choices?",
  "What did I do today to be of service to another person?",
  "What am I feeling good or positive about from today?",
  "What gave me a sense of meaning or satisfaction today?",
  "What did I do today that I want to make sure I repeat?",
  "Did I connect with the fellowship today â€” a meeting, a phone call, a message?",
  "What do I have to be grateful for today?"
];

var DAILY_PROMPTS = [
  "How am I feeling right now â€” honestly?",
  "What was the most important moment of my day?",
  "Did anything challenge me today? How did I respond?",
  "Was there a moment today I'm proud of?",
  "What emotions came up for me today, and what triggered them?",
  "Did I show up the way I wanted to today?",
  "What do I want to carry into tomorrow?",
  "How did my relationships feel today?",
  "What is something I need to let go of?",
  "What would I do differently if I could?"
];

function openJournal(type) {
  currentJournalId = null;
  currentJournalType = type;
  var info = JOURNAL_TYPES[type];
  document.getElementById('j-home').style.display = 'none';
  document.getElementById('j-write').style.display = 'block';
  document.getElementById('j-write-title').innerHTML = info.emoji + ' ' + info.title;
  document.getElementById('j-write-date').textContent = new Date().toLocaleDateString('en-GB', {weekday:'long', day:'numeric', month:'long', year:'numeric'});
  document.getElementById('j-text').value = '';
  document.getElementById('j-delete-btn').style.display = 'none';
  renderJournalPrompts(type);
  document.getElementById('j-text').focus();
}

function renderJournalPrompts(type) {
  var area = document.getElementById('j-prompts');
  var html = '<div style="background:rgba(232,201,122,0.07);border:1px solid rgba(232,201,122,0.18);border-radius:14px;padding:14px;margin-bottom:12px;">';

  if (type === 'gratitude') {
    var prompts = GRATITUDE_PROMPTS.slice().sort(function(){return Math.random()-.5;}).slice(0,3);
    html += '<div style="font-size:0.68rem;font-weight:800;color:var(--ac);text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px;">&#x1F64F; Prompts to get you started</div>';
    html += '<div style="font-size:0.74rem;color:var(--tm);margin-bottom:8px;font-style:italic;">Use one, some, or all â€” or just write freely.</div>';
    prompts.forEach(function(p, i) {
      html += '<div style="padding:7px 0;' + (i < prompts.length-1 ? 'border-bottom:1px solid var(--bd);' : '') + 'font-size:0.8rem;color:var(--tx);">&#x2022; ' + p + '</div>';
    });
    html += '<button onclick="renderJournalPrompts(\'gratitude\')" style="margin-top:10px;background:none;border:1px solid var(--bd);border-radius:8px;padding:5px 12px;font-size:0.7rem;color:var(--tm);cursor:pointer;">&#8635; New prompts</button>';

  } else if (type === 'spotcheck') {
    html += '<div style="font-size:0.68rem;font-weight:800;color:var(--ac);text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px;">&#x26A1; Spot Check â€” pause and be honest</div>';
    html += '<div style="font-size:0.74rem;color:var(--tm);margin-bottom:10px;font-style:italic;">Sit with these questions, then write freely below.</div>';
    SPOTCHECK_PROMPTS.forEach(function(p, i) {
      html += '<div style="padding:6px 0;' + (i < SPOTCHECK_PROMPTS.length-1 ? 'border-bottom:1px solid var(--bd);' : '') + 'font-size:0.78rem;color:var(--tm);">&#x2022; ' + p + '</div>';
    });

  } else if (type === 'step10') {
    html += '<div style="font-size:0.68rem;font-weight:800;color:var(--ac);text-transform:uppercase;letter-spacing:.06em;margin-bottom:6px;">&#x1F4CB; Full Step 10 â€” work through each question</div>';
    STEP10_QUESTIONS.forEach(function(p, i) {
      html += '<div style="padding:7px 0;' + (i < STEP10_QUESTIONS.length-1 ? 'border-bottom:1px solid var(--bd);' : '') + 'font-size:0.8rem;color:var(--tx);"><span style="color:var(--ac);font-weight:700;">' + (i+1) + '.</span> ' + p + '</div>';
    });

  } else if (type === 'guiding') {
    html += '<div style="font-size:0.68rem;font-weight:800;color:var(--ac);text-transform:uppercase;letter-spacing:.06em;margin-bottom:6px;">&#x1F4D6; Guiding Principles â€” work through each question</div>';
    CUSTOM_GUIDING_QUESTIONS.forEach(function(p, i) {
      html += '<div style="padding:7px 0;' + (i < CUSTOM_GUIDING_QUESTIONS.length-1 ? 'border-bottom:1px solid var(--bd);' : '') + 'font-size:0.8rem;color:var(--tx);"><span style="color:var(--ac);font-weight:700;">' + (i+1) + '.</span> ' + p + '</div>';
    });

  } else if (type === 'daily') {
    var prompts = DAILY_PROMPTS.slice().sort(function(){return Math.random()-.5;}).slice(0,3);
    html += '<div style="font-size:0.68rem;font-weight:800;color:var(--ac);text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px;">&#x270D; Prompts for today</div>';
    html += '<div style="font-size:0.74rem;color:var(--tm);margin-bottom:8px;font-style:italic;">Write freely â€” these are just here to help you start.</div>';
    prompts.forEach(function(p, i) {
      html += '<div style="padding:7px 0;' + (i < prompts.length-1 ? 'border-bottom:1px solid var(--bd);' : '') + 'font-size:0.8rem;color:var(--tx);">&#x2022; ' + p + '</div>';
    });
    html += '<button onclick="renderJournalPrompts(\'daily\')" style="margin-top:10px;background:none;border:1px solid var(--bd);border-radius:8px;padding:5px 12px;font-size:0.7rem;color:var(--tm);cursor:pointer;">&#8635; New prompts</button>';
  }

  html += '</div>';
  area.innerHTML = html;
}


function usePrompt(prompt) {
  var ta = document.getElementById('j-text');
  if (!ta.value.trim()) {
    ta.value = prompt + '\n\n';
  } else {
    ta.value += '\n\n' + prompt + '\n\n';
  }
  ta.focus();
  ta.setSelectionRange(ta.value.length, ta.value.length);
}
function saveJournal() {
  var text = document.getElementById('j-text').value.trim();
  if (!text) { alert('Please write something first.'); return; }
  if (currentJournalId) {
    var idx = journalEntries.findIndex(function(e){ return e.id === currentJournalId; });
    if (idx > -1) { journalEntries[idx].text = text; }
  } else {
    journalEntries.push({ id: Date.now().toString(), date: new Date().toISOString(), type: currentJournalType, text: text });
  }
  localStorage.setItem('na_journal', JSON.stringify(journalEntries));
  toast('Entry saved \u2713');
  closeJournal();
}

function deleteJournal() {
  if (!currentJournalId) return;
  journalEntries = journalEntries.filter(function(e){ return e.id !== currentJournalId; });
  localStorage.setItem('na_journal', JSON.stringify(journalEntries));
  closeJournal();
}

function closeJournal() {
  document.getElementById('j-write').style.display = 'none';
  document.getElementById('j-home').style.display = 'block';
  renderJournalEntries();
}

function openJournalEntry(id) {
  var entry = journalEntries.find(function(e){ return e.id === id; });
  if (!entry) return;
  currentJournalId = id;
  currentJournalType = entry.type || 'daily';
  var info = JOURNAL_TYPES[currentJournalType] || JOURNAL_TYPES.daily;
  document.getElementById('j-home').style.display = 'none';
  document.getElementById('j-write').style.display = 'block';
  document.getElementById('j-write-title').innerHTML = info.emoji + ' ' + info.title;
  document.getElementById('j-write-date').textContent = new Date(entry.date).toLocaleDateString('en-GB', {weekday:'long', day:'numeric', month:'long', year:'numeric'});
  document.getElementById('j-text').value = entry.text;
  document.getElementById('j-delete-btn').style.display = 'block';
  renderJournalPrompts(currentJournalType);
}

function renderJournalEntries() {
  var c = document.getElementById('j-entries');
  if (!journalEntries.length) {
    c.innerHTML = '<div style="text-align:center;padding:20px 0;font-size:0.8rem;color:var(--tm);">No entries yet â€” choose a type above to begin.</div>';
    return;
  }
  var emojis = { gratitude:'&#x1F64F;', spotcheck:'&#x26A1;', step10:'&#x1F4CB;', daily:'&#x270D;' };
  c.innerHTML = '';
  journalEntries.slice().reverse().forEach(function(e) {
    var dt = new Date(e.date).toLocaleDateString('en-GB', {weekday:'short', day:'numeric', month:'short'});
    var emoji = emojis[e.type] || '&#x270D;';
    var info = JOURNAL_TYPES[e.type] || JOURNAL_TYPES.daily;
    var preview = e.text.slice(0, 80) + (e.text.length > 80 ? '...' : '');

    // Wrapper holds card + red delete panel
    var wrap = document.createElement('div');
    wrap.className = 'j-entry-wrap';

    // Red delete panel behind
    var delPanel = document.createElement('div');
    delPanel.className = 'j-delete-reveal';
    delPanel.textContent = 'DELETE';
    (function(id, w, card) {
      delPanel.onclick = function() {
        journalEntries = journalEntries.filter(function(x) { return x.id !== id; });
        localStorage.setItem('na_journal', JSON.stringify(journalEntries));
        renderJournalEntries();
        toast('Entry deleted');
      };
    })(e.id, wrap);

    // Card on top
    var card = document.createElement('div');
    card.className = 'j-entry-card';
    card.style.background = 'var(--sf)';
    card.style.border = '1px solid var(--bd)';
    card.style.borderRadius = 'var(--r)';
    card.style.padding = '12px 14px';

    var topRow = document.createElement('div');
    topRow.style.cssText = 'display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;';

    var dateEl = document.createElement('div');
    dateEl.style.cssText = 'font-size:0.72rem;color:var(--tm);';
    dateEl.textContent = dt;

    var tag = document.createElement('div');
    tag.style.cssText = 'font-size:0.62rem;background:rgba(232,201,122,0.1);border:1px solid var(--bd);border-radius:20px;padding:2px 8px;color:var(--ac);';
    tag.innerHTML = emoji + ' ' + info.title;

    topRow.appendChild(dateEl);
    topRow.appendChild(tag);

    var previewEl = document.createElement('div');
    previewEl.style.cssText = 'font-size:0.78rem;color:var(--tx);';
    previewEl.textContent = preview;

    card.appendChild(topRow);
    card.appendChild(previewEl);

    // Swipe logic
    var startX = 0;
    var startY = 0;
    var swiped = false;

    card.addEventListener('touchstart', function(ev) {
      startX = ev.touches[0].clientX;
      startY = ev.touches[0].clientY;
      swiped = false;
    }, {passive: true});

    card.addEventListener('touchmove', function(ev) {
      var dx = ev.touches[0].clientX - startX;
      var dy = ev.touches[0].clientY - startY;
      if (Math.abs(dy) > Math.abs(dx)) return; // vertical scroll
      if (dx < 0) {
        var x = Math.max(dx, -80);
        card.style.transition = 'none';
        card.style.transform = 'translateX(' + x + 'px)';
        swiped = true;
      } else if (dx > 0 && swiped) {
        card.style.transition = 'none';
        card.style.transform = 'translateX(0)';
      }
    }, {passive: true});

    card.addEventListener('touchend', function(ev) {
      var dx = ev.changedTouches[0].clientX - startX;
      card.style.transition = 'transform 0.2s ease';
      if (dx < -50) {
        card.style.transform = 'translateX(-80px)';
        swiped = true;
      } else {
        card.style.transform = 'translateX(0)';
        swiped = false;
        // Only open if it was a tap not a swipe
        if (Math.abs(dx) < 10) {
          (function(id){ openJournalEntry(id); })(e.id);
        }
      }
    });

    // Click to open on desktop
    card.addEventListener('click', function(ev) {
      if (!swiped) {
        (function(id){ openJournalEntry(id); })(e.id);
      }
    });

    wrap.appendChild(delPanel);
    wrap.appendChild(card);
    c.appendChild(wrap);
  });
}


// =====================
// MAP
// =====================
// Uses Google Maps static embed - no external library needed

function initNetMap() {
  renderNetMap();
}

function geocodeAndPlot() {
  renderNetMap();
}

function renderNetMap() {
  var el = document.getElementById('net-map');
  if (!el) return;

  var contacts = networkContacts.filter(function(c){ return c.location; });

  if (!contacts.length) {
    el.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--tm);font-size:0.78rem;">Add contact locations to see them on the map</div>';
    return;
  }

  // Build Google Maps embed URL with multiple markers
  var roleColours = {
    'Sponsor': 'red',
    'Sponsee': 'green',
    'Sponsor Sister': 'green',
    'Sponsor Brother': 'green',
    'Friend in Recovery': 'yellow'
  };

  var markers = contacts.map(function(c) {
    var colour = roleColours[c.role] || 'blue';
    return 'markers=color:' + colour + '%7Clabel:' + encodeURIComponent((c.name || 'C')[0].toUpperCase()) + '%7C' + encodeURIComponent(c.location);
  }).join('&');

  var src = 'https://maps.googleapis.com/maps/api/staticmap?size=600x220&scale=2&maptype=roadmap&style=element:geometry%7Ccolor:0x1a1a2e&style=element:labels.text.fill%7Ccolor:0xe8c97a&' + markers + '&key=AIzaSyD-placeholder';

  // Use OpenStreetMap embed instead - no API key needed
  // Build a simple iframe with the first contact location as centre
  var firstLocation = encodeURIComponent(contacts[0].location);
  var iframeSrc = 'https://www.openstreetmap.org/export/embed.html?bbox=-10,49,2,61&layer=mapnik&marker=' + firstLocation;

  // Actually use a much simpler approach - clickable map link with contact list as pins
  el.innerHTML = '';

  // Show a styled list of contacts with location as clickable map links
  var wrap = document.createElement('div');
  wrap.style.cssText = 'padding:10px;height:220px;overflow-y:auto;';

  var title = document.createElement('div');
  title.style.cssText = 'font-size:0.62rem;font-weight:800;color:var(--ac);text-transform:uppercase;letter-spacing:0.08em;margin-bottom:8px;';
  title.textContent = 'Your Network Locations';
  wrap.appendChild(title);

  contacts.forEach(function(c) {
    var colour = { 'Sponsor':'#e74c3c','Sponsee':'#2ecc71','Sponsor Sister':'#2ecc71','Sponsor Brother':'#2ecc71','Friend in Recovery':'#f1c40f' }[c.role] || '#e8c97a';
    var row = document.createElement('div');
    row.style.cssText = 'display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.06);cursor:pointer;';

    var dot = document.createElement('div');
    dot.style.cssText = 'width:10px;height:10px;border-radius:50%;background:' + colour + ';flex-shrink:0;';
    row.appendChild(dot);

    var info = document.createElement('div');
    info.style.cssText = 'flex:1;';
    info.innerHTML = '<div style="font-size:0.8rem;font-weight:600;">' + c.name + '</div><div style="font-size:0.68rem;color:var(--tm);">' + c.location + '</div>';
    row.appendChild(info);

    var mapBtn = document.createElement('a');
    var ua = navigator.userAgent;
    if (/iPhone|iPad|iPod/.test(ua)) {
      mapBtn.href = 'https://maps.apple.com/?q=' + encodeURIComponent(c.location);
    } else {
      mapBtn.href = 'https://www.google.com/maps/search/' + encodeURIComponent(c.location);
    }
    mapBtn.target = '_blank';
    mapBtn.style.cssText = 'font-size:0.62rem;color:var(--ac);padding:4px 8px;border:1px solid rgba(232,201,122,0.3);border-radius:10px;text-decoration:none;white-space:nowrap;';
    mapBtn.textContent = 'Open Map';
    row.appendChild(mapBtn);

    wrap.appendChild(row);
  });

  el.appendChild(wrap);
}

// =====================
// NETWORK
// =====================
var networkContacts = JSON.parse(localStorage.getItem('na_network') || '[]');
var editingContactId = null;
var selectedRole = '';

var ROLE_EMOJIS = {
  'Sponsor': 'ğŸ’›',
  'Sponsee': 'ğŸŒ±',
  'Sponsor Sister': 'ğŸ’œ',
  'Sponsor Brother': 'ğŸ’™',
  'Friend in Recovery': 'ğŸ¤'
};

function openAddContact() {
  editingContactId = null;
  selectedRole = '';
  document.getElementById('contact-modal-title').textContent = 'Add Contact';
  document.getElementById('cn-name').value = '';
  document.getElementById('cn-phone').value = '';
  document.getElementById('cn-whatsapp').value = '';
  document.getElementById('cn-location').value = '';
  document.getElementById('cn-cleandate').value = '';
  document.querySelectorAll('.role-btn').forEach(function(b){ b.classList.remove('selected'); });
  document.getElementById('cn-delete-wrap').style.display = 'none';
  document.getElementById('contact-modal').classList.add('open');
}

function openEditContact(id) {
  var c = networkContacts.find(function(x){ return x.id === id; });
  if (!c) return;
  editingContactId = id;
  selectedRole = c.role || '';
  document.getElementById('contact-modal-title').textContent = 'Edit Contact';
  document.getElementById('cn-name').value = c.name || '';
  document.getElementById('cn-phone').value = c.phone || '';
  document.getElementById('cn-whatsapp').value = c.whatsapp || '';
  document.getElementById('cn-location').value = c.location || '';
  document.getElementById('cn-cleandate').value = c.cleandate || '';
  document.querySelectorAll('.role-btn').forEach(function(b){
    b.classList.remove('selected');
    if (b.textContent.trim().includes(selectedRole)) b.classList.add('selected');
  });
  document.getElementById('cn-delete-wrap').style.display = 'block';
  document.getElementById('contact-modal').classList.add('open');
}

function selectRole(btn, role) {
  selectedRole = role;
  document.querySelectorAll('.role-btn').forEach(function(b){ b.classList.remove('selected'); });
  btn.classList.add('selected');
}

function saveContact() {
  var name = document.getElementById('cn-name').value.trim();
  if (!name) { alert('Please enter a name.'); return; }
  var contact = {
    id: editingContactId || Date.now().toString(),
    name: name,
    role: selectedRole,
    phone: document.getElementById('cn-phone').value.trim(),
    whatsapp: document.getElementById('cn-whatsapp').value.trim(),
    location: document.getElementById('cn-location').value.trim(),
    cleandate: document.getElementById('cn-cleandate').value
  };
  if (editingContactId) {
    var idx = networkContacts.findIndex(function(x){ return x.id === editingContactId; });
    if (idx > -1) networkContacts[idx] = contact;
  } else {
    networkContacts.push(contact);
  }
  localStorage.setItem('na_network', JSON.stringify(networkContacts));
  closeContactModalDirect();
  renderNetwork();
  toast('Contact saved âœ“');
}

function deleteContact() {
  if (!editingContactId) return;
  networkContacts = networkContacts.filter(function(x){ return x.id !== editingContactId; });
  localStorage.setItem('na_network', JSON.stringify(networkContacts));
  closeContactModalDirect();
  renderNetwork();
  toast('Contact removed');
}

function closeContactModal(event) {
  document.getElementById('contact-modal').classList.remove('open');
}
function closeContactModalDirect() {
  document.getElementById('contact-modal').classList.remove('open');
}

function calcCleanTime(dateStr) {
  if (!dateStr) return null;
  var start = new Date(dateStr);
  var now = new Date();
  var days = Math.floor((now - start) / 86400000);
  if (days < 0) return null;
  if (days < 30) return days + (days === 1 ? ' day' : ' days') + ' clean';
  var months = Math.floor(days / 30.4375);
  if (months < 12) return months + (months === 1 ? ' month' : ' months') + ' clean';
  var years = Math.floor(days / 365.25);
  var remMonths = Math.floor((days % 365.25) / 30.4375);
  var str = years + (years === 1 ? ' year' : ' years');
  if (remMonths > 0) str += ' ' + remMonths + (remMonths === 1 ? ' month' : ' months');
  return str + ' clean';
}

function openMaps(location) {
  var encoded = encodeURIComponent(location);
  // Try Apple Maps first on iOS, fallback to Google Maps
  var ua = navigator.userAgent;
  if (/iPhone|iPad|iPod/.test(ua)) {
    window.open('https://maps.apple.com/?q=' + encoded, '_blank');
  } else {
    window.open('https://www.google.com/maps/search/' + encoded, '_blank');
  }
}

function renderNetwork() {
  var list = document.getElementById('net-list');
  var empty = document.getElementById('net-empty');
  if (!networkContacts.length) {
    list.innerHTML = '';
    empty.style.display = 'block';
    return;
  }
  empty.style.display = 'none';
  list.innerHTML = '';
  networkContacts.forEach(function(c) {
    var emoji = ROLE_EMOJIS[c.role] || 'ğŸ‘¤';
    var cleanTime = c.cleandate ? calcCleanTime(c.cleandate) : null;
    var phoneNum = c.whatsapp || c.phone;
    var waNum = (c.whatsapp || c.phone).replace(/\D/g, '');

    var div = document.createElement('div');
    div.className = 'net-card';
    div.innerHTML =
      '<div class="net-card-header">' +
        '<div class="net-avatar">' + emoji + '</div>' +
        '<div class="net-info">' +
          '<div class="net-name">' + c.name + '</div>' +
          (c.role ? '<div class="net-role">' + c.role + '</div>' : '') +
          (cleanTime ? '<div class="net-clean">â³ ' + cleanTime + '</div>' : '') +
          (c.location ? '<div class="net-location">ğŸ“ ' + c.location + '</div>' : '') +
        '</div>' +
        '<button onclick="openEditContact(\'' + c.id + '\')" style="background:transparent;border:none;color:var(--tm);font-size:1rem;cursor:pointer;padding:4px;">âœï¸</button>' +
      '</div>' +
      '<div class="net-actions">' +
        (c.phone ? '<a href="tel:' + c.phone.replace(/\s/g,'') + '" class="net-action-btn"><span class="net-action-icon">ğŸ“</span>Call</a>' : '') +
        (waNum ? '<a href="https://wa.me/' + waNum + '" target="_blank" class="net-action-btn"><span class="net-action-icon">ğŸ’¬</span>WhatsApp</a>' : '') +
        (c.location ? '<div class="net-action-btn" onclick="openMaps(\'' + c.location.replace(/'/g,"\\'") + '\')"><span class="net-action-icon">ğŸ—ºï¸</span>Map</div>' : '') +
      '</div>';
    list.appendChild(div);
  });
  geocodeAndPlot();
}

// =====================
// JOURNAL EXPORT
// =====================
var exportType = null;
var exportText = '';

function showExportPicker() {
  var types = ['gratitude','spotcheck','step10','daily'];
  var names = { gratitude:'Gratitude List', spotcheck:'Spot Check', step10:'Full Step 10', daily:'Daily Journal' };
  var html = '';
  types.forEach(function(t) {
    var count = journalEntries.filter(function(e){ return e.type === t; }).length;
    html += '<div onclick="doExport(\'' + t + '\')" style="display:flex;align-items:center;justify-content:space-between;background:var(--sf2);border:1px solid var(--bd);border-radius:12px;padding:13px 16px;margin-bottom:8px;cursor:pointer;">' +
      '<span style="font-size:0.86rem;">' + names[t] + '</span>' +
      '<span style="font-size:0.72rem;color:var(--tm);">' + count + ' ' + (count === 1 ? 'entry' : 'entries') + ' â€º</span>' +
    '</div>';
  });
  document.getElementById('export-type-list').innerHTML = html;
  document.getElementById('export-picker-view').style.display = 'block';
  document.getElementById('export-send-view').style.display = 'none';
  document.getElementById('export-modal').classList.add('open');
}

function doExport(type) {
  var names = { gratitude:'Gratitude List', spotcheck:'Spot Check Inventory', step10:'Full Step 10 Inventory', daily:'Daily Journal' };
  var entries = journalEntries.filter(function(e){ return e.type === type; });
  if (!entries.length) { toast('No entries for this journal'); return; }
  exportType = type;
  var lines = 'Clean Living App â€” ' + names[type] + '\n';
  lines += 'Exported: ' + new Date().toLocaleDateString('en-GB', {weekday:'long',day:'numeric',month:'long',year:'numeric'}) + '\n';
  lines += 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n';
  entries.slice().reverse().forEach(function(e, i) {
    var dt = new Date(e.date);
    var dateStr = dt.toLocaleDateString('en-GB', {weekday:'long',day:'numeric',month:'long',year:'numeric'});
    var timeStr = dt.toLocaleTimeString('en-GB', {hour:'2-digit',minute:'2-digit'});
    lines += 'ğŸ“ Entry ' + (i+1) + ' â€” ' + dateStr + ' at ' + timeStr + '\n';
    lines += e.text + '\n\n';
  });
  exportText = lines;
  document.getElementById('export-send-title').textContent = names[type] + ' â€” ' + entries.length + (entries.length === 1 ? ' entry' : ' entries');
  document.getElementById('export-preview').textContent = lines;
  document.getElementById('export-picker-view').style.display = 'none';
  document.getElementById('export-send-view').style.display = 'block';
}

function exportEmail() {
  var names = { gratitude:'Gratitude List', spotcheck:'Spot Check', step10:'Step 10 Inventory', daily:'Daily Journal' };
  var subject = 'Clean Living â€” ' + (names[exportType] || 'Journal') + ' Export';
  window.location.href = 'mailto:?subject=' + encodeURIComponent(subject) + '&body=' + encodeURIComponent(exportText);
}

function exportCopy() {
  if (navigator.clipboard) {
    navigator.clipboard.writeText(exportText).then(function(){ toast('Copied to clipboard âœ“'); closeExportModalDirect(); });
  } else {
    var ta = document.createElement('textarea');
    ta.value = exportText;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
    toast('Copied to clipboard âœ“');
    closeExportModalDirect();
  }
}

function closeExportModalDirect() {
  document.getElementById('export-modal').classList.remove('open');
}

// Update init to include network
function init() {
  if (cleanDate) {
    document.getElementById('clean-date-input').value = cleanDate;
    updateDaysCount();
  }
  markTodayMood();
  renderMoodHistory();
  showDailyQuote();
  renderJournalEntries();
  renderNetwork();
}

init();



function toggleBook(header) {
  const card = header.parentElement;
  card.classList.toggle('open');
}

// =====================
// CUSTOM QUESTIONS
// =====================

function renderGuidingJournalBtn() {
  var btn = document.getElementById('j-type-guiding');
  if (btn) btn.style.display = 'flex';
}

// Smart geo buy link
function buyBook(book) {
  var tz = Intl.DateTimeFormat().resolvedOptions().timeZone || '';
  var lang = navigator.language || '';

  // UK: London or Dublin timezone, or en-GB language
  var isUK = tz.indexOf('London') > -1 || tz.indexOf('Dublin') > -1 || lang === 'en-GB' || lang.indexOf('en-GB') > -1;
  // EU: any European timezone except UK
  var isEU = tz.indexOf('Europe/') > -1 && !isUK;
  // US: American timezones
  var isUS = tz.indexOf('America/') > -1 || tz.indexOf('US/') > -1;

  var urls = {
    'step-working': {
      uk:    'https://ukso.biz/product-category/step-working-guides/',
      eu:    'https://cart-eu.na.org/en/recovery-literature/step-working-guides',
      us:    'https://cart-us.na.org/recovery-products/books/the-na-step-working-guides-1400',
      world: 'https://www.na.org/recovery-literature/'
    },
    'guiding-principles': {
      uk:    'https://ukso.biz/product-category/guiding-principles/',
      eu:    'https://cart-eu.na.org/en/recovery-literature/guiding-principles',
      us:    'https://cart-us.na.org/recovery-products/books/guiding-principles-1500',
      world: 'https://www.na.org/recovery-literature/'
    }
  };

  var set = urls[book] || urls['step-working'];
  var url;
  if (isUK) url = set.uk;
  else if (isEU) url = set.eu;
  else if (isUS) url = set.us;
  else url = set.world;

  window.open(url, '_blank', 'noopener');
}

function loadCustomQuestions() {
  var step10 = localStorage.getItem('na_custom_step10');
  if (step10) {
    STEP10_QUESTIONS = step10.split('\n').map(function(q){ return q.trim(); }).filter(function(q){ return q.length > 0; });
    var s10ta = document.getElementById('custom-step10');
    if (s10ta) { s10ta.value = step10; document.getElementById('step10-saved-msg').style.display = 'block'; }
  }
  var guiding = localStorage.getItem('na_custom_guiding');
  if (guiding) {
    CUSTOM_GUIDING_QUESTIONS = guiding.split('\n').map(function(q){ return q.trim(); }).filter(function(q){ return q.length > 0; });
    JOURNAL_TYPES.guiding = { title: 'Guiding Principles', emoji: '&#x1F4D6;' };
    var gta = document.getElementById('custom-guiding');
    if (gta) { gta.value = guiding; document.getElementById('guiding-saved-msg').style.display = 'block'; }
    renderGuidingJournalBtn();
  }
}

function saveCustomStep10() {
  var val = document.getElementById('custom-step10').value.trim();
  if (!val) { toast('Please enter some questions first'); return; }
  localStorage.setItem('na_custom_step10', val);
  STEP10_QUESTIONS = val.split('\n').map(function(q){ return q.trim(); }).filter(function(q){ return q.length > 0; });
  document.getElementById('step10-saved-msg').style.display = 'block';
  toast('Step 10 questions saved \u2713');
}

function clearCustomStep10() {
  localStorage.removeItem('na_custom_step10');
  document.getElementById('custom-step10').value = '';
  document.getElementById('step10-saved-msg').style.display = 'none';
  STEP10_QUESTIONS = DEFAULT_STEP10_QUESTIONS.slice();
  toast('Reset to default questions');
}

function saveCustomGuiding() {
  var val = document.getElementById('custom-guiding').value.trim();
  if (!val) { toast('Please enter some questions first'); return; }
  localStorage.setItem('na_custom_guiding', val);
  CUSTOM_GUIDING_QUESTIONS = val.split('\n').map(function(q){ return q.trim(); }).filter(function(q){ return q.length > 0; });
  if (!JOURNAL_TYPES.guiding) {
    JOURNAL_TYPES.guiding = { title: 'Guiding Principles', emoji: '&#x1F4D6;' };
  }
  document.getElementById('guiding-saved-msg').style.display = 'block';
  renderGuidingJournalBtn();
  toast('Guiding Principles questions saved \u2713');
}

var CUSTOM_GUIDING_QUESTIONS = [];
var DEFAULT_STEP10_QUESTIONS = STEP10_QUESTIONS.slice();

// Load on startup
loadCustomQuestions();




// =====================
// EVENTS
// =====================
var allEvents = [];
var currentFilter = 'all';
var selectedEvType = '';
var eventsLoaded = false;
var ADMIN_EMAIL = 'clarehobson@icloud.com';

function isAdmin() {
  return currentUser && currentUser.email === ADMIN_EMAIL;
}

async function loadEvents() {
  if (!supa) { showEventsEmpty(); return; }
  try {
    document.getElementById('events-loading').style.display = 'block';
    document.getElementById('events-list').innerHTML = '';
    document.getElementById('events-empty').style.display = 'none';

    var result = await supa
      .from('events')
      .select('*')
      .eq('approved', true)
      .order('date', { ascending: true });

    document.getElementById('events-loading').style.display = 'none';

    if (result.error || !result.data) { showEventsEmpty(); return; }
    allEvents = result.data;
    renderEvents();
    eventsLoaded = true;


  } catch(e) {
    document.getElementById('events-loading').style.display = 'none';
    showEventsEmpty();
  }
}

function showEventsEmpty() {
  document.getElementById('events-empty').style.display = 'block';
  document.getElementById('events-loading').style.display = 'none';
}

function filterEvents(filter) {
  currentFilter = filter;
  document.querySelectorAll('.ef-btn').forEach(function(b){ b.classList.remove('ef-active'); });
  var btn = document.getElementById('ef-' + filter);
  if (btn) btn.classList.add('ef-active');
  renderEvents();
}

function renderEvents() {
  var list = document.getElementById('events-list');
  var filtered = allEvents.filter(function(ev) {
    if (currentFilter === 'all') return true;
    return ev.country === currentFilter;
  });

  if (!filtered.length) {
    list.innerHTML = '<div style="text-align:center;padding:30px 0;color:var(--tm);font-size:0.8rem;">No events found for this filter</div>';
    return;
  }

  list.innerHTML = '';

  var grouped = {};
  filtered.forEach(function(ev) {
    var d = new Date(ev.date);
    var key = d.toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });
    if (!grouped[key]) grouped[key] = [];
    grouped[key].push(ev);
  });

  Object.keys(grouped).forEach(function(month) {
    var header = document.createElement('div');
    header.style.cssText = 'font-size:0.65rem;font-weight:800;color:var(--ac);text-transform:uppercase;letter-spacing:0.1em;margin:16px 0 8px;';
    header.textContent = month;
    list.appendChild(header);
    grouped[month].forEach(function(ev) {
      list.appendChild(buildEventCard(ev));
    });
  });
}

function buildEventCard(ev) {
  var card = document.createElement('div');
  card.className = 'event-card';

  var dateStr = new Date(ev.date).toLocaleDateString('en-GB', {weekday:'short',day:'numeric',month:'short',year:'numeric'});
  if (ev.end_date) dateStr += ' - ' + new Date(ev.end_date).toLocaleDateString('en-GB', {day:'numeric',month:'short'});

  var goingCount = ev.going_users ? ev.going_users.length : 0;
  var userGoing = currentUser && ev.going_users && ev.going_users.includes(currentUser.id);
  var goingNames = ev.going_names ? ev.going_names.slice(0,3).join(', ') : '';
  if (ev.going_names && ev.going_names.length > 3) goingNames += ' +' + (ev.going_names.length - 3) + ' more';

  if (ev.flyer_url) {
    var img = document.createElement('img');
    img.className = 'event-flyer';
    img.src = ev.flyer_url;
    img.onerror = function(){ this.style.display = 'none'; };
    card.appendChild(img);
  } else {
    var ph = document.createElement('div');
    ph.className = 'event-flyer-placeholder';
    ph.textContent = 'Event';
    card.appendChild(ph);
  }

  var body = document.createElement('div');
  body.className = 'event-body';

  var tag = document.createElement('div');
  tag.className = 'event-type-tag';
  tag.textContent = ev.type || 'Event';
  body.appendChild(tag);

  var ttl = document.createElement('div');
  ttl.className = 'event-title';
  ttl.textContent = ev.name;
  body.appendChild(ttl);

  var meta = document.createElement('div');
  meta.className = 'event-meta';
  meta.innerHTML = 'Date: ' + dateStr + '<br>Location: ' + ev.location + (ev.country ? ', ' + ev.country : '');
  if (ev.url) {
    var a = document.createElement('a');
    a.href = ev.url;
    a.target = '_blank';
    a.style.color = 'var(--ac)';
    a.textContent = 'Book / Info';
    meta.appendChild(document.createElement('br'));
    meta.appendChild(a);
  }
  body.appendChild(meta);

  var bar = document.createElement('div');
  bar.className = 'event-going-bar';

  var info = document.createElement('div');
  info.style.cssText = 'font-size:0.72rem;color:var(--tm);';
  info.textContent = goingCount > 0 ? (goingCount + ' going' + (goingNames ? ': ' + goingNames : '')) : 'Be the first going';
  bar.appendChild(info);

  var gbtn = document.createElement('button');
  gbtn.className = 'going-btn' + (userGoing ? ' going-active' : '');
  gbtn.textContent = userGoing ? 'Going' : '+ Going';
  gbtn.addEventListener('click', function(e) { toggleGoing(e, ev.id); });
  bar.appendChild(gbtn);

  body.appendChild(bar);
  card.appendChild(body);

  card.addEventListener('click', function(e) {
    if (e.target.tagName !== 'A' && e.target.tagName !== 'BUTTON') openEventDetail(ev);
  });

  return card;
}

function openEventDetail(ev) {
  var dateStr = new Date(ev.date).toLocaleDateString('en-GB', {weekday:'long',day:'numeric',month:'long',year:'numeric'});
  if (ev.end_date) dateStr += ' - ' + new Date(ev.end_date).toLocaleDateString('en-GB', {weekday:'long',day:'numeric',month:'long'});

  var goingCount = ev.going_users ? ev.going_users.length : 0;
  var userGoing = currentUser && ev.going_users && ev.going_users.includes(currentUser.id);
  var goingNames = ev.going_names ? ev.going_names.join(', ') : '';

  var c = document.getElementById('event-detail-content');
  c.innerHTML = '';

  if (ev.flyer_url) {
    var img = document.createElement('img');
    img.src = ev.flyer_url;
    img.style.cssText = 'width:100%;border-radius:12px;margin-bottom:16px;';
    img.onerror = function(){ this.style.display = 'none'; };
    c.appendChild(img);
  }

  var tag = document.createElement('div');
  tag.className = 'event-type-tag';
  tag.textContent = ev.type || 'Event';
  c.appendChild(tag);

  var ttl = document.createElement('div');
  ttl.style.cssText = 'font-size:1.5rem;font-weight:300;color:var(--ac);margin-bottom:8px;';
  ttl.textContent = ev.name;
  c.appendChild(ttl);

  var meta = document.createElement('div');
  meta.style.cssText = 'font-size:0.8rem;color:var(--tm);line-height:1.8;margin-bottom:12px;';
  meta.innerHTML = 'Date: ' + dateStr + '<br>Location: ' + ev.location + (ev.country ? ', ' + ev.country : '');
  c.appendChild(meta);

  if (ev.description) {
    var desc = document.createElement('div');
    desc.style.cssText = 'font-size:0.82rem;color:var(--tx);line-height:1.7;margin-bottom:14px;';
    desc.textContent = ev.description;
    c.appendChild(desc);
  }

  if (ev.url) {
    var lnk = document.createElement('a');
    lnk.href = ev.url;
    lnk.target = '_blank';
    lnk.className = 'btn';
    lnk.style.cssText = 'display:block;text-align:center;margin-bottom:14px;text-decoration:none;';
    lnk.textContent = 'Book / More Info';
    c.appendChild(lnk);
  }

  var gbox = document.createElement('div');
  gbox.style.cssText = 'background:var(--sf2);border:1px solid var(--bd);border-radius:12px;padding:12px;margin-bottom:12px;';

  var gtitle = document.createElement('div');
  gtitle.style.cssText = 'font-size:0.68rem;font-weight:800;color:var(--ac);text-transform:uppercase;margin-bottom:6px;';
  gtitle.textContent = "Who's Going (" + goingCount + ")";
  gbox.appendChild(gtitle);

  var glist = document.createElement('div');
  glist.style.cssText = goingNames ? 'font-size:0.78rem;color:var(--tx);' : 'font-size:0.75rem;color:var(--tm);';
  glist.textContent = goingNames || 'Nobody yet - be the first!';
  gbox.appendChild(glist);
  c.appendChild(gbox);

  var goBtn = document.createElement('button');
  goBtn.className = 'going-btn' + (userGoing ? ' going-active' : '');
  goBtn.style.cssText = 'width:100%;padding:13px;';
  goBtn.textContent = userGoing ? 'Going' : '+ Going';
  var evId = ev.id;
  goBtn.addEventListener('click', function(e) { toggleGoing(e, evId); });
  c.appendChild(goBtn);

  document.getElementById('event-detail-modal').classList.add('open');
}

async function toggleGoing(e, eventId) {
  e.stopPropagation();
  if (!currentUser) { toast('Sign in to mark yourself as going'); return; }
  if (!supa) return;
  try {
    var ev = allEvents.find(function(x){ return x.id === eventId; });
    if (!ev) return;
    var going = ev.going_users ? ev.going_users.slice() : [];
    var names = ev.going_names ? ev.going_names.slice() : [];
    var username = currentUser.email.split('@')[0];
    var idx = going.indexOf(currentUser.id);
    if (idx > -1) {
      going.splice(idx, 1);
      names.splice(idx, 1);
    } else {
      going.push(currentUser.id);
      names.push(username);
    }
    await supa.from('events').update({ going_users: going, going_names: names }).eq('id', eventId);
    ev.going_users = going;
    ev.going_names = names;
    renderEvents();
    closeEventDetailDirect();
    toast(idx > -1 ? 'Removed from going' : 'Marked as going!');
  } catch(e2) { toast('Could not update - try again'); }
}

function selectEvType(btn, type) {
  selectedEvType = type;
  document.querySelectorAll('#submit-event-modal .role-btn').forEach(function(b){ b.classList.remove('selected'); });
  btn.classList.add('selected');
}

function openSubmitEvent() {
  document.getElementById('ev-name').value = '';
  document.getElementById('ev-date').value = '';
  document.getElementById('ev-enddate').value = '';
  document.getElementById('ev-location').value = '';
  document.getElementById('ev-country').value = '';
  document.getElementById('ev-url').value = '';
  document.getElementById('ev-flyer').value = '';
  document.getElementById('ev-desc').value = '';
  document.getElementById('ev-submit-msg').style.display = 'none';
  selectedEvType = '';
  document.querySelectorAll('#submit-event-modal .role-btn').forEach(function(b){ b.classList.remove('selected'); });
  document.getElementById('submit-event-modal').classList.add('open');
}

async function submitEvent() {
  var name = document.getElementById('ev-name').value.trim();
  var date = document.getElementById('ev-date').value;
  var location = document.getElementById('ev-location').value.trim();
  var country = document.getElementById('ev-country').value;
  if (!name || !date || !location || !country) { toast('Please fill in all required fields'); return; }
  if (!supa) { toast('No connection - try again'); return; }
  try {
    await supa.from('events').insert({
      name: name,
      type: selectedEvType || 'Other',
      date: date,
      end_date: document.getElementById('ev-enddate').value || null,
      location: location,
      country: country,
      url: document.getElementById('ev-url').value.trim() || null,
      flyer_url: document.getElementById('ev-flyer').value.trim() || null,
      description: document.getElementById('ev-desc').value.trim() || null,
      approved: false,
      submitted_by: currentUser ? currentUser.email : 'anonymous',
      going_users: [],
      going_names: []
    });
    document.getElementById('ev-submit-msg').style.display = 'block';
    setTimeout(closeSubmitEventDirect, 2500);
  } catch(e) { toast('Submission failed - try again'); }
}

function closeSubmitEvent(event) { document.getElementById('submit-event-modal').classList.remove('open'); }
function closeSubmitEventDirect() { document.getElementById('submit-event-modal').classList.remove('open'); }
function closeEventDetail(event) { document.getElementById('event-detail-modal').classList.remove('open'); }
function closeEventDetailDirect() { document.getElementById('event-detail-modal').classList.remove('open'); }
function closeAdminModal(event) { document.getElementById('admin-modal').classList.remove('open'); }
function closeAdminModalDirect() { document.getElementById('admin-modal').classList.remove('open'); }

async function openAdminPanel() {
  if (!isAdmin() || !supa) return;
  try {
    var result = await supa.from('events').select('*').eq('approved', false).order('created_at', { ascending: false });
    var pending = result.data || [];
    var container = document.getElementById('admin-pending-list');
    container.innerHTML = '';

    if (!pending.length) {
      container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--tm);">No pending events</div>';
    } else {
      pending.forEach(function(ev) {
        var card = document.createElement('div');
        card.style.cssText = 'background:var(--sf2);border:1px solid var(--bd);border-radius:12px;padding:12px;margin-bottom:10px;';

        var title = document.createElement('div');
        title.style.cssText = 'font-weight:700;font-size:0.88rem;margin-bottom:4px;';
        title.textContent = ev.name;
        card.appendChild(title);

        var info = document.createElement('div');
        info.style.cssText = 'font-size:0.72rem;color:var(--tm);margin-bottom:8px;';
        info.textContent = ev.date + ' - ' + ev.location + ' - ' + (ev.submitted_by || '');
        card.appendChild(info);

        var btns = document.createElement('div');
        btns.style.cssText = 'display:flex;gap:8px;';

        var approveBtn = document.createElement('button');
        approveBtn.style.cssText = 'flex:1;padding:9px;background:#5fcf80;color:#0f1a10;border:none;border-radius:10px;font-weight:700;cursor:pointer;';
        approveBtn.textContent = 'Approve';
        (function(id){ approveBtn.addEventListener('click', function(){ approveEvent(id); }); })(ev.id);

        var rejectBtn = document.createElement('button');
        rejectBtn.style.cssText = 'flex:1;padding:9px;background:rgba(192,57,43,0.3);color:#e74c3c;border:1px solid rgba(192,57,43,0.4);border-radius:10px;cursor:pointer;';
        rejectBtn.textContent = 'Reject';
        (function(id){ rejectBtn.addEventListener('click', function(){ rejectEvent(id); }); })(ev.id);

        btns.appendChild(approveBtn);
        btns.appendChild(rejectBtn);
        card.appendChild(btns);
        container.appendChild(card);
      });
    }
    document.getElementById('admin-modal').classList.add('open');
  } catch(e) { toast('Could not load admin panel'); }
}

async function approveEvent(id) {
  await supa.from('events').update({ approved: true }).eq('id', id);
  toast('Event approved');
  openAdminPanel();
  loadEvents();
}

async function rejectEvent(id) {
  await supa.from('events').delete().eq('id', id);
  toast('Event rejected and removed');
  openAdminPanel();
}



// =====================
// SIGN IN / AUTH
// =====================
function openSigninModal() {
  var isSignedIn = currentUser !== null;
  document.getElementById('signin-password-wrap').style.display = isSignedIn ? 'none' : 'block';
  document.getElementById('signin-email').style.display = isSignedIn ? 'none' : 'block';
  document.querySelector('#signin-modal .modal-title').textContent = isSignedIn ? 'Account' : 'Sign In';
  document.getElementById('signin-msg').style.display = 'none';

  var btns = document.querySelectorAll('#signin-modal button:not(#home-signin-btn)');
  if (isSignedIn) {
    document.getElementById('signin-user-wrap').style.display = 'block';
    document.getElementById('signin-user-email').textContent = currentUser.email;
    // Hide sign in / create / forgot buttons
    document.querySelectorAll('#signin-modal .btn, #signin-modal button').forEach(function(b){
      if (b.textContent === 'Sign In' || b.textContent === 'Create Account' || b.textContent === 'Forgot password?') {
        b.style.display = 'none';
      }
    });
  } else {
    document.getElementById('signin-user-wrap').style.display = 'none';
    document.querySelectorAll('#signin-modal .btn, #signin-modal button').forEach(function(b){
      b.style.display = '';
    });
  }
  document.getElementById('signin-modal').classList.add('open');
}

function closeSigninModal(event) {
  document.getElementById('signin-modal').classList.remove('open');
}

function showSigninMsg(msg, colour) {
  var el = document.getElementById('signin-msg');
  el.textContent = msg;
  el.style.color = colour || 'var(--tm)';
  el.style.display = 'block';
}

async function doSignIn() {
  if (!supa) { showSigninMsg('No connection - try again'); return; }
  var email = document.getElementById('signin-email').value.trim();
  var password = document.getElementById('signin-password').value;
  if (!email || !password) { showSigninMsg('Please enter email and password'); return; }
  showSigninMsg('Signing in...');
  try {
    var result = await supa.auth.signInWithPassword({ email: email, password: password });
    if (result.error) { showSigninMsg(result.error.message, '#e74c3c'); return; }
    currentUser = result.data.user;
    pullFromCloud();
    updateSigninBtn();
    showAdminBtnIfNeeded();
    document.getElementById('signin-modal').classList.remove('open');
    toast('Signed in');
    // Reload events with auth
    eventsLoaded = false;
  } catch(e) { showSigninMsg('Sign in failed - try again', '#e74c3c'); }
}

async function doSignUp() {
  if (!supa) { showSigninMsg('No connection - try again'); return; }
  var email = document.getElementById('signin-email').value.trim();
  var password = document.getElementById('signin-password').value;
  if (!email || !password) { showSigninMsg('Please enter email and password'); return; }
  if (password.length < 6) { showSigninMsg('Password must be at least 6 characters'); return; }
  showSigninMsg('Creating account...');
  try {
    var result = await supa.auth.signUp({ email: email, password: password });
    if (result.error) { showSigninMsg(result.error.message, '#e74c3c'); return; }
    showSigninMsg('Account created! Check your email to confirm, then sign in.', '#5fcf80');
  } catch(e) { showSigninMsg('Sign up failed - try again', '#e74c3c'); }
}

async function doResetPassword() {
  if (!supa) return;
  var email = document.getElementById('signin-email').value.trim();
  if (!email) { showSigninMsg('Enter your email address first'); return; }
  try {
    await supa.auth.resetPasswordForEmail(email);
    showSigninMsg('Password reset email sent!', '#5fcf80');
  } catch(e) { showSigninMsg('Could not send reset email', '#e74c3c'); }
}

// =====================
// AUTH & MEMBERSHIP
// =====================
var membershipTier = null; // null = not checked, 'free', 'basic', 'member'

// Tier definitions
var TIER_FEATURES = {
  free:   ['home','meetings','books'],
  basic:  ['home','meetings','books','steps','network'],
  member: ['home','meetings','books','steps','network','journal','events','resources']
};

function getUserTier() {
  if (!currentUser) return null;
  // Admin / founder account always gets full member access
  if (currentUser.email === 'clarehobson@icloud.com' || currentUser.email === 'monahan.c78@gmail.com') {
    return 'member';
  }
  // Check Supabase user metadata for tier
  var meta = currentUser.user_metadata || {};
  return meta.tier || 'free';
}

function canAccess(screen) {
  var tier = getUserTier();
  if (!tier) return ['home','meetings','books'].indexOf(screen) > -1;
  var allowed = TIER_FEATURES[tier] || TIER_FEATURES['free'];
  return allowed.indexOf(screen) > -1;
}

// ---- WELCOME / AUTH SCREEN ----
function showWelcomeScreen() {
  document.getElementById('app').style.display = 'none';
  document.getElementById('welcome-screen').style.display = 'flex';
}

function hideWelcomeScreen() {
  document.getElementById('welcome-screen').style.display = 'none';
  document.getElementById('app').style.display = 'flex';
}

function showAuthForm(mode) {
  document.getElementById('welcome-hero').style.display = 'none';
  document.getElementById('auth-form').style.display = 'block';
  document.getElementById('auth-mode').dataset.mode = mode;
  document.getElementById('auth-title').textContent = mode === 'signin' ? 'Welcome back' : 'Create account';
  document.getElementById('auth-submit-btn').textContent = mode === 'signin' ? 'Sign In' : 'Create Account';
  document.getElementById('auth-switch-text').textContent = mode === 'signin' ? "Don't have an account?" : 'Already have an account?';
  document.getElementById('auth-switch-btn').textContent = mode === 'signin' ? 'Sign up' : 'Sign in';
  document.getElementById('auth-msg').style.display = 'none';
  document.getElementById('auth-forgot').style.display = mode === 'signin' ? 'block' : 'none';
}

function switchAuthMode() {
  var current = document.getElementById('auth-mode').dataset.mode;
  showAuthForm(current === 'signin' ? 'signup' : 'signin');
}

function showAuthMsg(msg, colour) {
  var el = document.getElementById('auth-msg');
  el.textContent = msg;
  el.style.color = colour || 'var(--tm)';
  el.style.display = 'block';
}

async function doAuth() {
  if (!supa) { showAuthMsg('No connection â€” please check your internet'); return; }
  var mode = document.getElementById('auth-mode').dataset.mode;
  var email = document.getElementById('auth-email').value.trim();
  var password = document.getElementById('auth-password').value;
  if (!email || !password) { showAuthMsg('Please enter your email and password'); return; }
  if (mode === 'signup' && password.length < 6) { showAuthMsg('Password must be at least 6 characters'); return; }

  document.getElementById('auth-submit-btn').textContent = 'Please wait...';
  document.getElementById('auth-submit-btn').disabled = true;

  try {
    var result;
    if (mode === 'signin') {
      result = await supa.auth.signInWithPassword({ email: email, password: password });
    } else {
      result = await supa.auth.signUp({ email: email, password: password });
    }

    document.getElementById('auth-submit-btn').disabled = false;
    document.getElementById('auth-submit-btn').textContent = mode === 'signin' ? 'Sign In' : 'Create Account';

    if (result.error) { showAuthMsg(result.error.message, '#e74c3c'); return; }

    if (mode === 'signup') {
      showAuthMsg('Account created! Check your email to confirm, then sign in.', '#5fcf80');
      return;
    }

    currentUser = result.data.user;
    pullFromCloud();
    updateSigninBtn();
    showAdminBtnIfNeeded();
    hideWelcomeScreen();
    eventsLoaded = false;
  } catch(e) {
    document.getElementById('auth-submit-btn').disabled = false;
    showAuthMsg('Something went wrong â€” try again', '#e74c3c');
  }
}

async function doAuthReset() {
  if (!supa) return;
  var email = document.getElementById('auth-email').value.trim();
  if (!email) { showAuthMsg('Enter your email address first'); return; }
  try {
    await supa.auth.resetPasswordForEmail(email, { redirectTo: 'https://cleanliving.app' });
    showAuthMsg('Password reset email sent!', '#5fcf80');
  } catch(e) { showAuthMsg('Could not send reset email', '#e74c3c'); }
}

function continueAsGuest() {
  hideWelcomeScreen();
}

// ---- PAYWALL ----
function showPaywall(screen) {
  var tierNeeded = 'basic';
  if (['journal','events','resources'].indexOf(screen) > -1) tierNeeded = 'member';

  var el = document.getElementById('paywall-modal');
  var title = document.getElementById('paywall-title');
  var desc = document.getElementById('paywall-desc');
  var price = document.getElementById('paywall-price');

  if (tierNeeded === 'member') {
    title.textContent = 'Member Feature';
    desc.textContent = 'Journal, Events and Movement are included in the Member plan â€” everything you need for your recovery in one place.';
    price.textContent = 'Â£4.99 / month';
  } else {
    title.textContent = 'Basic Feature';
    desc.textContent = 'Worksheets and your Network are included in the Basic plan.';
    price.textContent = 'Â£1.99 / month';
  }

  el.classList.add('open');
}

function closePaywall(e) {
  document.getElementById('paywall-modal').classList.remove('open');
}



// =====================
// ACCOUNT SHEET
// =====================
function openAccountSheet() {
  var sheet = document.getElementById('account-sheet');
  if (!sheet) return;

  if (!currentUser) {
    document.getElementById('account-signedout').style.display = 'block';
    document.getElementById('account-signedin').style.display = 'none';
  } else {
    document.getElementById('account-signedout').style.display = 'none';
    document.getElementById('account-signedin').style.display = 'block';

    var email = currentUser.email || '';
    var name = email.split('@')[0];
    var tier = getUserTier();

    document.getElementById('account-avatar').textContent = name[0].toUpperCase();
    document.getElementById('account-name').textContent = name;
    document.getElementById('account-email').textContent = email;

    var badge = document.getElementById('account-tier-badge');
    if (tier === 'member') {
      badge.textContent = 'Member';
      badge.style.cssText = 'margin-left:auto;padding:4px 10px;border-radius:20px;font-size:0.62rem;font-weight:800;text-transform:uppercase;background:rgba(232,201,122,0.2);color:var(--ac);border:1px solid rgba(232,201,122,0.4);';
    } else if (tier === 'basic') {
      badge.textContent = 'Basic';
      badge.style.cssText = 'margin-left:auto;padding:4px 10px;border-radius:20px;font-size:0.62rem;font-weight:800;text-transform:uppercase;background:rgba(94,164,207,0.2);color:#5ea4cf;border:1px solid rgba(94,164,207,0.4);';
    } else {
      badge.textContent = 'Free';
      badge.style.cssText = 'margin-left:auto;padding:4px 10px;border-radius:20px;font-size:0.62rem;font-weight:800;text-transform:uppercase;background:rgba(255,255,255,0.08);color:var(--tm);border:1px solid var(--bd);';
    }

    var detail = document.getElementById('account-membership-detail');
    if (tier === 'member') {
      detail.textContent = 'Full access â€” Journal, Events, Movement, Network, Community';
    } else if (tier === 'basic') {
      detail.textContent = 'Basic access â€” Network and Worksheets included';
    } else {
      detail.textContent = 'Free plan â€” meetings, books and daily readings';
    }

    document.getElementById('account-admin-section').style.display = isAdmin() ? 'block' : 'none';
  }

  sheet.classList.add('open');
}

function closeAccountSheet(event) {
  document.getElementById('account-sheet').classList.remove('open');
}

function updateSigninBtn() {
  var btn = document.getElementById('home-signin-btn');
  if (!btn) return;
  if (currentUser) {
    var initial = (currentUser.email.split('@')[0][0] || 'A').toUpperCase();
    btn.textContent = initial;
    btn.style.background = 'linear-gradient(135deg,var(--ac),#b8965a)';
    btn.style.color = '#1a1208';
    btn.style.fontWeight = '700';
  } else {
    btn.textContent = '\uD83D\uDC64';
    btn.style.background = 'var(--sf)';
    btn.style.color = 'var(--ac)';
    btn.style.fontWeight = 'normal';
  }
}

function showAdminBtnIfNeeded() {
  // Admin access is inside the account sheet - no floating button needed
}

async function doSignOut() {
  if (!supa) return;
  try {
    await supa.auth.signOut();
    currentUser = null;
    updateSigninBtn();
    document.getElementById('account-sheet').classList.remove('open');
    showWelcomeScreen();
    toast('Signed out');
  } catch(e) {}
}

// =====================
// SUPABASE SILENT SYNC
// =====================
const SUPA_URL = 'https://gencdhyxlyekpjvuwvpu.supabase.co';
const SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdlbmNkaHl4bHlla3BqdnV3dnB1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5NzEyNDEsImV4cCI6MjA4NzU0NzI0MX0.BR9biMN2K8Vj6SBbfBrEChppsuIMp2lSL3WOW7Z-1Ss';
var supa = null;
var currentUser = null;
try { supa = supabase.createClient(SUPA_URL, SUPA_KEY); } catch(e) {}

async function pushToCloud() {
  if (!supa || !currentUser) return;
  try {
    await supa.from('user_data').upsert({
      user_id: currentUser.id,
      clean_date: cleanDate,
      mood_log: moodLog,
      journal: journalEntries,
      network: networkContacts,
      updated_at: new Date().toISOString()
    }, { onConflict: 'user_id' });
  } catch(e) {}
}

async function pullFromCloud() {
  if (!supa || !currentUser) return;
  try {
    var result = await supa.from('user_data').select('*').eq('user_id', currentUser.id).single();
    var data = result.data;
    if (!data) return;
    if (data.clean_date) { cleanDate = data.clean_date; localStorage.setItem('na_clean_date', cleanDate); updateDaysCount(); }
    if (data.mood_log && data.mood_log.length) { moodLog = data.mood_log; localStorage.setItem('na_mood_log', JSON.stringify(moodLog)); markTodayMood(); renderMoodHistory(); }
    if (data.journal && data.journal.length) { journalEntries = data.journal; localStorage.setItem('na_journal', JSON.stringify(journalEntries)); renderJournalEntries(); }
    if (data.network && data.network.length) { networkContacts = data.network; localStorage.setItem('na_network', JSON.stringify(networkContacts)); renderNetwork(); }
  } catch(e) {}
}

// On load - wrapped in DOMContentLoaded so all functions exist first
document.addEventListener('DOMContentLoaded', function() {
  if (supa) {
    supa.auth.getSession().then(function(r) {
      if (r && r.data && r.data.session && r.data.session.user && r.data.session.user.email) {
        currentUser = r.data.session.user;
        pullFromCloud();
        updateSigninBtn();
      } else {
        showWelcomeScreen();
      }
    }).catch(function(){
      showWelcomeScreen();
    });
  } else {
    showWelcomeScreen();
  }
});

var _origSaveCleanDate = saveCleanDate; saveCleanDate = function() { _origSaveCleanDate.apply(this,arguments); pushToCloud(); };
var _origSaveJournal = saveJournal; saveJournal = function() { _origSaveJournal.apply(this,arguments); pushToCloud(); };
var _origSaveContact = saveContact; saveContact = function() { _origSaveContact.apply(this,arguments); pushToCloud(); };
var _origDeleteContact = deleteContact; deleteContact = function(id) { _origDeleteContact(id); pushToCloud(); };
var _origDeleteJournal = deleteJournal; deleteJournal = function(id) { _origDeleteJournal(id); pushToCloud(); };
var _origSetMood = setMood; setMood = function(m) { _origSetMood(m); pushToCloud(); };
</script>

  <!-- WELCOME / AUTH SCREEN -->

  <div id="welcome-screen">
    <!-- Hero -->
    <div id="welcome-hero">
      <div style="font-size:3.5rem;margin-bottom:16px;">ğŸŒ¿</div>
      <div class="welcome-logo">Clean Living</div>
      <div class="welcome-sub">Recovery Â· Community Â· Growth</div>
      <div class="welcome-tagline">"We do not have to be alone anymore."<br><span style="font-size:0.75rem;color:var(--tm);">â€” Basic Text</span></div>
      <button class="welcome-btn-primary" onclick="showAuthForm('signin')">Sign In</button>
      <button class="welcome-btn-secondary" onclick="showAuthForm('signup')">Create Account</button>
      <button class="welcome-btn-ghost" onclick="continueAsGuest()">Browse as guest</button>
    </div>

```
<!-- Auth Form -->
<div id="auth-form">
  <button class="auth-back" onclick="document.getElementById('welcome-hero').style.display='flex';document.getElementById('auth-form').style.display='none';">&#8592; Back</button>
  <div id="auth-mode" data-mode="signin"></div>
  <div style="font-family:'Cormorant Garamond',serif;font-size:1.8rem;font-weight:300;color:var(--ac);margin-bottom:6px;" id="auth-title">Welcome back</div>
  <div style="font-size:0.72rem;color:var(--tm);margin-bottom:24px;">Sign in to access your recovery tools</div>

  <div class="modal-label">Email</div>
  <input id="auth-email" class="input" type="email" placeholder="your@email.com" autocomplete="email" style="margin-bottom:14px;">

  <div class="modal-label">Password</div>
  <input id="auth-password" class="input" type="password" placeholder="Password" autocomplete="current-password" style="margin-bottom:6px;">

  <div id="auth-msg" style="display:none;font-size:0.75rem;margin-bottom:12px;text-align:center;padding:8px;border-radius:8px;background:rgba(0,0,0,0.2);"></div>

  <button id="auth-submit-btn" class="btn" style="width:100%;margin-bottom:12px;" onclick="doAuth()">Sign In</button>

  <button id="auth-forgot" onclick="doAuthReset()" style="width:100%;padding:8px;border:none;background:transparent;color:var(--tm);cursor:pointer;font-size:0.72rem;display:block;">Forgot password?</button>

  <div style="text-align:center;margin-top:16px;">
    <span id="auth-switch-text" style="font-size:0.75rem;color:var(--tm);">Don't have an account?</span>
    <button id="auth-switch-btn" onclick="switchAuthMode()" style="background:transparent;border:none;color:var(--ac);font-size:0.75rem;cursor:pointer;padding:0 0 0 4px;">Sign up</button>
  </div>
</div>
```

  </div>

  <!-- PAYWALL MODAL -->

  <div class="modal-overlay" id="paywall-modal" onclick="closePaywall(event)">
    <div class="modal-sheet" onclick="event.stopPropagation()">
      <div style="text-align:center;font-size:2.5rem;margin-bottom:12px;">ğŸ”</div>
      <div class="modal-title" id="paywall-title">Member Feature</div>
      <div id="paywall-desc" style="font-size:0.8rem;color:var(--tm);text-align:center;margin-bottom:20px;line-height:1.6;"></div>
      <div id="paywall-price" style="font-family:'Cormorant Garamond',serif;font-size:2rem;color:var(--ac);text-align:center;margin-bottom:20px;"></div>
      <button class="btn" style="width:100%;margin-bottom:10px;" onclick="closePaywall(event); openSigninModal();">Upgrade Now</button>
      <button onclick="closePaywall(event)" style="width:100%;padding:13px;border:1px solid var(--bd);border-radius:var(--r);background:transparent;color:var(--tm);cursor:pointer;">Maybe Later</button>
    </div>
  </div>

  <!-- ACCOUNT SHEET -->

  <div class="modal-overlay" id="account-sheet" onclick="closeAccountSheet(event)">
    <div class="modal-sheet" onclick="event.stopPropagation()" style="max-height:90vh;">

```
  <!-- Signed Out View -->
  <div id="account-signedout">
    <div style="text-align:center;margin-bottom:20px;">
      <div style="font-size:2.5rem;margin-bottom:8px;">ğŸ‘¤</div>
      <div style="font-size:1.1rem;font-weight:600;color:var(--tx);">Sign in to Clean Living</div>
      <div style="font-size:0.75rem;color:var(--tm);margin-top:4px;">Access your recovery tools across all devices</div>
    </div>
    <button class="btn" style="width:100%;margin-bottom:10px;" onclick="closeAccountSheet(event);showWelcomeScreen();">Sign In / Create Account</button>
  </div>

  <!-- Signed In View -->
  <div id="account-signedin" style="display:none;">

    <!-- Profile -->
    <div style="display:flex;align-items:center;gap:14px;padding:4px 0 20px;border-bottom:1px solid var(--bd);margin-bottom:16px;">
      <div style="width:48px;height:48px;border-radius:50%;background:linear-gradient(135deg,var(--ac),#b8965a);display:flex;align-items:center;justify-content:center;font-size:1.3rem;font-weight:700;color:#1a1208;" id="account-avatar">C</div>
      <div>
        <div style="font-weight:700;font-size:0.95rem;" id="account-name">Clare</div>
        <div style="font-size:0.72rem;color:var(--tm);" id="account-email"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="bcdfd0ddced9d4d3decfd3d2fcd5dfd0d3c9d892dfd3d1">[email&#160;protected]</a></div>
      </div>
      <div id="account-tier-badge" style="margin-left:auto;padding:4px 10px;border-radius:20px;font-size:0.62rem;font-weight:800;text-transform:uppercase;"></div>
    </div>

    <!-- Membership -->
    <div style="background:var(--sf2);border:1px solid rgba(232,201,122,0.35);border-radius:var(--r);padding:14px 16px;margin-bottom:12px;">
      <div style="font-size:0.62rem;font-weight:800;color:var(--ac);text-transform:uppercase;letter-spacing:0.08em;margin-bottom:8px;">Membership</div>
      <div id="account-membership-detail" style="font-size:0.8rem;color:var(--tx);line-height:1.6;"></div>
    </div>

    <!-- Admin Section (iCloud only) -->
    <div id="account-admin-section" style="display:none;background:rgba(231,76,60,0.1);border:1px solid rgba(231,76,60,0.3);border-radius:var(--r);padding:14px 16px;margin-bottom:12px;">
      <div style="font-size:0.62rem;font-weight:800;color:#e74c3c;text-transform:uppercase;letter-spacing:0.08em;margin-bottom:10px;">Admin</div>
      <button onclick="closeAccountSheet(event);openAdminPanel();" style="width:100%;padding:11px;background:rgba(231,76,60,0.2);border:1px solid rgba(231,76,60,0.4);border-radius:10px;color:#e74c3c;font-size:0.8rem;font-weight:600;cursor:pointer;">Review Pending Events</button>
    </div>

    <!-- Sign Out -->
    <button onclick="doSignOut()" style="width:100%;padding:13px;border:1px solid rgba(192,57,43,0.3);border-radius:var(--r);background:trans
```

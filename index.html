<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="NA Recovery">
<meta name="theme-color" content="#0f0f1a">
<title>NA Recovery</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;600&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
<style>
:root {
  --bg: #0f0f1a;
  --sf: #1a1a2e;
  --sf2: #16213e;
  --ac: #e8c97a;
  --tx: #f0ead6;
  --tm: #8a8090;
  --bd: rgba(232,201,122,0.15);
  --r: 16px;
}
* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
html, body { height: 100%; height: 100dvh; }
body { font-family: "DM Sans", sans-serif; background: var(--bg); color: var(--tx); overflow: hidden; }

#app { display: flex; flex-direction: column; height: 100%; height: 100dvh; }

/* SCREENS */
.screen { display: none; flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; padding: 20px 16px 24px; }
.screen.active { display: block; }

/* NAV */
nav {
flex-shrink: 0;
display: flex;
background: rgba(15,15,26,0.97);
border-top: 1px solid var(â€“bd);
padding-bottom: env(safe-area-inset-bottom, 0);
}
.nav-item {
flex: 1;
display: flex;
flex-direction: column;
align-items: center;
justify-content: center;
gap: 3px;
padding: 10px 2px 8px;
cursor: pointer;
color: var(â€“tm);
font-size: 0.42rem;
letter-spacing: 0.05em;
text-transform: uppercase;
-webkit-user-select: none;
user-select: none;
}
.nav-item.active { color: var(â€“ac); }
.nav-icon { font-size: 1.2rem; line-height: 1; }

/* CARDS */
.card {
background: var(â€“sf);
border: 1px solid var(â€“bd);
border-radius: var(â€“r);
padding: 16px;
margin-bottom: 10px;
}
.label {
font-size: 0.62rem;
font-weight: 800;
color: var(â€“ac);
text-transform: uppercase;
letter-spacing: 0.08em;
margin-bottom: 8px;
}
.btn {
width: 100%;
padding: 13px;
border: none;
border-radius: var(â€“r);
background: var(â€“ac);
color: #1a1208;
font-size: 0.86rem;
font-weight: 700;
cursor: pointer;
margin-top: 8px;
}
.input {
width: 100%;
background: var(â€“sf2);
border: 1px solid var(â€“bd);
border-radius: 10px;
color: var(â€“tx);
font-size: 0.84rem;
padding: 10px 12px;
outline: none;
}
.input:focus { border-color: var(â€“ac); }

/* MOOD BUTTONS */
.mood-row { display: flex; gap: 6px; }
.mood-btn {
flex: 1;
background: var(â€“sf);
border: 1px solid var(â€“bd);
border-radius: 12px;
padding: 10px 4px;
cursor: pointer;
text-align: center;
}
.mood-btn.selected { border-color: var(â€“ac); background: rgba(232,201,122,0.1); }
.mood-emoji { font-size: 1.3rem; }
.mood-label { font-size: 0.56rem; color: var(â€“tm); margin-top: 3px; }

.step-card {
display: flex;
align-items: center;
gap: 14px;
background: var(â€“sf);
border: 1px solid var(â€“bd);
border-radius: var(â€“r);
padding: 14px 16px;
margin-bottom: 8px;
text-decoration: none;
color: var(â€“tx);
}
.step-num {
width: 32px;
height: 32px;
border-radius: 50%;
border: 1px solid var(â€“ac);
background: rgba(232,201,122,0.08);
display: flex;
align-items: center;
justify-content: center;
font-family: â€˜Cormorant Garamondâ€™, serif;
font-size: 1rem;
font-weight: 400;
color: var(â€“ac);
flex-shrink: 0;
}
.step-body { flex: 1; min-width: 0; }
.step-title { font-size: 0.86rem; font-weight: 600; color: var(â€“tx); }
.step-sub { font-size: 0.7rem; color: var(â€“tm); margin-top: 2px; }
.step-arrow { color: var(â€“tm); font-size: 0.9rem; }
.bt-ch {
display: flex;
flex-direction: column;
gap: 5px;
padding: 9px 0;
border-bottom: 1px solid var(â€“bd);
}
.bt-ch:last-child { border-bottom: none; }
.bt-ch span { font-size: 0.78rem; font-weight: 600; color: var(â€“tx); }
.bt-ch audio { width: 100%; height: 32px; }

.j-type-card {
display: flex;
align-items: center;
gap: 13px;
background: var(â€“sf);
border: 1px solid var(â€“bd);
border-radius: var(â€“r);
padding: 14px 16px;
margin-bottom: 8px;
cursor: pointer;
}
.j-type-card:active { background: var(â€“sf2); }
.j-entry-card {
background: var(â€“sf);
border: 1px solid var(â€“bd);
border-radius: var(â€“r);
padding: 12px 14px;
margin-bottom: 8px;
cursor: pointer;
}
.j-entry-card:active { background: var(â€“sf2); }

.j-entry-wrap {
position: relative;
margin-bottom: 8px;
overflow: hidden;
border-radius: var(â€“r);
}
.j-delete-reveal {
position: absolute;
right: 0;
top: 0;
bottom: 0;
width: 80px;
background: #c0392b;
display: flex;
align-items: center;
justify-content: center;
color: white;
font-size: 0.75rem;
font-weight: 700;
letter-spacing: 0.05em;
cursor: pointer;
}
.j-entry-card {
position: relative;
transform: translateX(0);
transition: transform 0.2s ease;
cursor: pointer;
touch-action: pan-y;
}

.book-card {
display: flex;
align-items: center;
gap: 12px;
background: var(â€“sf);
border: 1px solid var(â€“bd);
border-radius: var(â€“r);
padding: 12px 14px;
margin-bottom: 6px;
text-decoration: none;
color: var(â€“tx);
}
.book-card * { color: inherit; text-decoration: none; }
.book-sub { font-size: 0.68rem; color: var(â€“tm) !important; margin-top: 2px; }
.book-card:active { background: var(â€“sf2); }
.book-icon { font-size: 1.2rem; flex-shrink: 0; }
.book-body { flex: 1; min-width: 0; }
.book-title { font-size: 0.84rem; font-weight: 600; }
.book-arr { color: var(â€“tm); font-size: 0.9rem; flex-shrink: 0; }

.book-expand-card {
background: var(â€“sf);
border: 1px solid var(â€“bd);
border-radius: var(â€“r);
margin-bottom: 10px;
overflow: hidden;
}
.book-expand-header {
display: flex;
align-items: center;
gap: 12px;
padding: 13px 14px;
cursor: pointer;
}
.book-expand-header:active { background: var(â€“sf2); }
.book-expand-chevron {
color: var(â€“tm);
font-size: 0.75rem;
margin-left: auto;
transition: transform 0.2s;
flex-shrink: 0;
}
.book-expand-card.open .book-expand-chevron { transform: rotate(90deg); }
.book-expand-body {
display: none;
padding: 0 14px 14px 14px;
border-top: 1px solid var(â€“bd);
}
.book-expand-card.open .book-expand-body { display: block; }
.book-expand-section {
font-size: 0.6rem;
color: var(â€“tm);
letter-spacing: 0.09em;
text-transform: uppercase;
margin: 12px 0 6px 0;
}
.book-buy-row {
display: flex;
gap: 6px;
flex-wrap: wrap;
margin-bottom: 4px;
}
.book-buy-btn {
display: inline-flex;
align-items: center;
gap: 5px;
padding: 7px 11px;
border-radius: 8px;
font-size: 0.7rem;
font-weight: 600;
text-decoration: none;
white-space: nowrap;
}
.book-buy-btn.apple { background: #1c1c1e; color: #fff; border: 1px solid #3a3a3c; }
.book-buy-btn.android { background: #1a3c27; color: #5fcf80; border: 1px solid #2d6b45; }
.book-buy-btn.hardcopy { background: #2a2418; color: var(â€“ac); border: 1px solid #4a3f28; }
.book-buy-btn:active { opacity: 0.75; }

.book-expand-card {
background: var(â€“sf);
border: 1px solid var(â€“bd);
border-radius: var(â€“r);
margin-bottom: 8px;
overflow: hidden;
}
.book-card-header {
display: flex;
align-items: center;
gap: 12px;
padding: 13px 14px;
cursor: pointer;
}
.book-card-header:active { background: var(â€“sf2); }
.book-chevron {
color: var(â€“tm);
font-size: 1.2rem;
transition: transform 0.25s;
flex-shrink: 0;
}
.book-expand-card.open .book-chevron { transform: rotate(90deg); }
.book-card-body {
display: none;
padding: 0 14px 14px 14px;
border-top: 1px solid var(â€“bd);
}
.book-expand-card.open .book-card-body { display: block; }
.book-section-label {
font-size: 0.68rem;
color: var(â€“tm);
letter-spacing: 0.06em;
text-transform: uppercase;
margin: 12px 0 7px;
}
.book-btn-row {
display: flex;
gap: 8px;
}
.buy-btn {
display: block;
text-align: center;
padding: 9px 10px;
border-radius: 8px;
font-size: 0.75rem;
font-weight: 600;
text-decoration: none;
margin-bottom: 6px;
}
.book-btn-row .buy-btn { flex: 1; margin-bottom: 0; }
.apple-btn  { background: #1c1c1e; color: #fff; border: 1px solid #3a3a3c; }
.google-btn { background: #1a73e8; color: #fff; }
.world-btn  { background: var(â€“sf2); color: var(â€“tx); border: 1px solid var(â€“bd); }
.uk-btn     { background: #012169; color: #fff; }
.eu-btn     { background: #003399; color: #ffd700; }

.meeting-card {
display: flex;
align-items: center;
justify-content: space-between;
background: var(â€“sf);
border: 1px solid var(â€“bd);
border-radius: var(â€“r);
padding: 13px 14px;
margin-bottom: 8px;
text-decoration: none;
color: var(â€“tx);
}
.meeting-card * { color: inherit; text-decoration: none; }
.meeting-sub { font-size: 0.68rem; color: var(â€“tm) !important; margin-top: 2px; line-height: 1.4; }
.meeting-card:active { background: var(â€“sf2); }
.meeting-left {
display: flex;
align-items: center;
gap: 12px;
}
.meeting-flag { font-size: 1.4rem; flex-shrink: 0; }
.meeting-title { font-size: 0.84rem; font-weight: 600; }
.meeting-arr { color: var(â€“tm); font-size: 1rem; flex-shrink: 0; margin-left: 8px; }

/* NETWORK */
.net-card {
background: var(â€“sf);
border: 1px solid var(â€“bd);
border-radius: var(â€“r);
padding: 14px 16px;
margin-bottom: 10px;
}
.net-card-header {
display: flex;
align-items: center;
gap: 12px;
}
.net-avatar {
width: 44px;
height: 44px;
border-radius: 50%;
background: rgba(232,201,122,0.12);
border: 1px solid var(â€“bd);
display: flex;
align-items: center;
justify-content: center;
font-size: 1.2rem;
flex-shrink: 0;
}
.net-info { flex: 1; min-width: 0; }
.net-name { font-size: 0.9rem; font-weight: 700; color: var(â€“tx); }
.net-role { font-size: 0.68rem; color: var(â€“ac); margin-top: 2px; }
.net-clean { font-size: 0.66rem; color: var(â€“tm); margin-top: 2px; }
.net-location { font-size: 0.66rem; color: var(â€“tm); margin-top: 1px; }
.net-actions {
display: flex;
gap: 8px;
margin-top: 12px;
padding-top: 10px;
border-top: 1px solid var(â€“bd);
}
.net-action-btn {
flex: 1;
display: flex;
flex-direction: column;
align-items: center;
gap: 4px;
padding: 8px 4px;
background: var(â€“sf2);
border: 1px solid var(â€“bd);
border-radius: 10px;
cursor: pointer;
text-decoration: none;
color: var(â€“tx);
font-size: 0.6rem;
text-align: center;
}
.net-action-btn:active { background: rgba(232,201,122,0.1); }
.net-action-icon { font-size: 1.1rem; }

/* MODAL */
.modal-overlay {
display: none;
position: fixed;
inset: 0;
background: rgba(0,0,0,0.7);
z-index: 200;
align-items: flex-end;
}
.modal-overlay.open { display: flex; }
.modal-sheet {
background: var(â€“sf);
border-radius: 20px 20px 0 0;
padding: 20px 16px 40px;
width: 100%;
max-height: 85vh;
overflow-y: auto;
}
.modal-title {
font-family: â€˜Cormorant Garamondâ€™, serif;
font-size: 1.4rem;
font-weight: 300;
color: var(â€“ac);
margin-bottom: 16px;
text-align: center;
}
.modal-label {
font-size: 0.62rem;
font-weight: 800;
color: var(â€“ac);
text-transform: uppercase;
letter-spacing: 0.08em;
margin-bottom: 6px;
margin-top: 14px;
}
.role-grid {
display: grid;
grid-template-columns: 1fr 1fr;
gap: 7px;
margin-bottom: 4px;
}
.role-btn {
padding: 9px 8px;
border: 1px solid var(â€“bd);
border-radius: 10px;
background: var(â€“sf2);
color: var(â€“tm);
font-size: 0.74rem;
cursor: pointer;
text-align: center;
}
.role-btn.selected { border-color: var(â€“ac); color: var(â€“ac); background: rgba(232,201,122,0.1); }

/* EXPORT MODAL */
.export-overlay {
display: none;
position: fixed;
inset: 0;
background: rgba(0,0,0,0.7);
z-index: 200;
align-items: flex-end;
}
.export-overlay.open { display: flex; }

/* NETWORK */
.net-card {
background: var(â€“sf);
border: 1px solid var(â€“bd);
border-radius: var(â€“r);
padding: 14px 16px;
margin-bottom: 10px;
position: relative;
}
.net-card-top {
display: flex;
align-items: center;
gap: 12px;
margin-bottom: 10px;
}
.net-avatar {
width: 42px;
height: 42px;
border-radius: 50%;
background: rgba(232,201,122,0.12);
border: 1px solid var(â€“bd);
display: flex;
align-items: center;
justify-content: center;
font-size: 1.2rem;
flex-shrink: 0;
}
.net-name { font-size: 0.92rem; font-weight: 700; color: var(â€“tx); }
.net-role {
display: inline-block;
font-size: 0.6rem;
font-weight: 700;
text-transform: uppercase;
letter-spacing: 0.07em;
padding: 2px 8px;
border-radius: 20px;
margin-top: 3px;
background: rgba(232,201,122,0.1);
border: 1px solid rgba(232,201,122,0.25);
color: var(â€“ac);
}
.net-meta {
font-size: 0.72rem;
color: var(â€“tm);
display: flex;
gap: 10px;
flex-wrap: wrap;
margin-bottom: 10px;
}
.net-actions {
display: flex;
gap: 8px;
}
.net-btn {
flex: 1;
display: flex;
align-items: center;
justify-content: center;
gap: 6px;
padding: 9px;
border-radius: 10px;
font-size: 0.74rem;
font-weight: 600;
text-decoration: none;
border: none;
cursor: pointer;
}
.net-btn.call { background: rgba(52,199,89,0.15); color: #34c759; border: 1px solid rgba(52,199,89,0.25); }
.net-btn.whatsapp { background: rgba(37,211,102,0.12); color: #25d366; border: 1px solid rgba(37,211,102,0.25); }
.net-delete-btn {
position: absolute;
top: 12px;
right: 12px;
background: none;
border: none;
color: var(â€“tm);
font-size: 1rem;
cursor: pointer;
padding: 2px 6px;
line-height: 1;
}

/* MODAL */
.modal-overlay {
display: none;
position: fixed;
inset: 0;
background: rgba(0,0,0,0.7);
z-index: 500;
align-items: flex-end;
justify-content: center;
}
.modal-overlay.open { display: flex; }
.modal-box {
background: var(â€“sf);
border: 1px solid var(â€“bd);
border-radius: 20px 20px 0 0;
padding: 24px 18px 40px;
width: 100%;
max-width: 500px;
max-height: 85vh;
overflow-y: auto;
}
.modal-title {
font-family: â€˜Cormorant Garamondâ€™, serif;
font-size: 1.4rem;
font-weight: 300;
color: var(â€“ac);
margin-bottom: 16px;
}
.modal-label {
font-size: 0.68rem;
font-weight: 700;
color: var(â€“tm);
text-transform: uppercase;
letter-spacing: 0.07em;
margin-bottom: 5px;
margin-top: 12px;
}
.modal-select {
width: 100%;
background: var(â€“sf2);
border: 1px solid var(â€“bd);
border-radius: 10px;
color: var(â€“tx);
font-size: 0.84rem;
padding: 10px 12px;
outline: none;
-webkit-appearance: none;
}

/* EXPORT MODAL */
.export-btn {
display: flex;
align-items: center;
gap: 12px;
background: var(â€“sf2);
border: 1px solid var(â€“bd);
border-radius: var(â€“r);
padding: 14px 16px;
margin-bottom: 10px;
cursor: pointer;
width: 100%;
text-align: left;
color: var(â€“tx);
}
.export-btn:active { opacity: 0.75; }

/* LEAFLET POPUP DARK THEME */
.net-popup .leaflet-popup-content-wrapper {
background: #1a1a2e;
color: #f0ead6;
border: 1px solid rgba(232,201,122,0.2);
border-radius: 10px;
box-shadow: 0 4px 20px rgba(0,0,0,0.5);
}
.net-popup .leaflet-popup-tip { background: #1a1a2e; }

/* TOAST */
#toast {
position: fixed;
bottom: 80px;
left: 50%;
transform: translateX(-50%) translateY(8px);
background: var(â€“ac);
color: #1a1208;
padding: 8px 20px;
border-radius: 20px;
font-size: 0.78rem;
font-weight: 700;
opacity: 0;
transition: opacity 0.25s, transform 0.25s;
pointer-events: none;
z-index: 999;
}
#toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
</style>

</head>
<body>

<!-- SPLASH SCREEN -->

<div id="splash" style="
  position:fixed; inset:0; z-index:9999;
  display:flex; flex-direction:column;
  align-items:center; justify-content:center;
  background:#0a0f1a;
  overflow:hidden;
  touch-action:pan-y;
">
  <!-- Background image -->
  <div id="splash-bg" style="
    position:absolute; inset:0;
    background-image: url('https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=800&q=80');
    background-size:cover; background-position:center;
    opacity:0; transition:opacity 1.2s ease;
  "></div>
  <!-- Dark overlay -->
  <div style="position:absolute;inset:0;background:linear-gradient(to bottom, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.55) 60%, rgba(0,0,0,0.75) 100%);"></div>

  <!-- Content -->

  <div style="position:relative;z-index:2;text-align:center;padding:0 32px;width:100%;">
    <div style="font-size:0.78rem;font-weight:300;letter-spacing:0.18em;text-transform:uppercase;color:rgba(255,255,255,0.7);margin-bottom:18px;">You are clean</div>

```
<div style="display:flex;justify-content:center;gap:28px;margin-bottom:32px;">
  <div style="text-align:center;">
    <div id="splash-years" style="font-family:'Cormorant Garamond',serif;font-size:5rem;font-weight:300;color:#fff;line-height:1;">0</div>
    <div style="font-size:0.62rem;letter-spacing:0.16em;text-transform:uppercase;color:rgba(255,255,255,0.65);margin-top:4px;">Years</div>
  </div>
  <div style="text-align:center;">
    <div id="splash-months" style="font-family:'Cormorant Garamond',serif;font-size:5rem;font-weight:300;color:#fff;line-height:1;">0</div>
    <div style="font-size:0.62rem;letter-spacing:0.16em;text-transform:uppercase;color:rgba(255,255,255,0.65);margin-top:4px;">Months</div>
  </div>
  <div style="text-align:center;">
    <div id="splash-weeks" style="font-family:'Cormorant Garamond',serif;font-size:5rem;font-weight:300;color:#fff;line-height:1;">0</div>
    <div style="font-size:0.62rem;letter-spacing:0.16em;text-transform:uppercase;color:rgba(255,255,255,0.65);margin-top:4px;">Weeks</div>
  </div>
</div>

<div id="splash-quote" style="font-size:0.88rem;font-style:italic;color:rgba(255,255,255,0.75);line-height:1.6;max-width:280px;margin:0 auto 48px;"></div>
```

  </div>

  <!-- Swipe indicator -->

  <div style="position:absolute;bottom:calc(env(safe-area-inset-bottom,0px) + 28px);left:0;right:0;text-align:center;z-index:2;">
    <div id="splash-swipe-hint" style="display:inline-flex;flex-direction:column;align-items:center;gap:6px;opacity:0.7;">
      <div style="width:1px;height:32px;background:rgba(255,255,255,0.5);margin:0 auto;"></div>
      <div style="font-size:0.6rem;letter-spacing:0.14em;text-transform:uppercase;color:rgba(255,255,255,0.6);">Swipe up</div>
    </div>
  </div>
</div>

<div id="app">

  <!-- HOME SCREEN -->

  <div class="screen active" id="screen-home">

```
<!-- Header -->
<div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:16px;">
  <div>
    <div style="font-family:'Cormorant Garamond',serif; font-size:1.6rem; font-weight:300; color:var(--ac);">Just For Today</div>
    <div style="font-size:0.62rem; color:var(--tm); letter-spacing:0.08em; text-transform:uppercase;">NA Recovery</div>
  </div>
</div>

<!-- Clean Date Counter -->
<div class="card">
  <div style="display:flex; align-items:center; gap:14px;">
    <div style="text-align:center; min-width:64px;">
      <div id="days-count" style="font-family:'Cormorant Garamond',serif; font-size:2.8rem; font-weight:300; color:var(--ac); line-height:1;">0</div>
      <div style="font-size:0.54rem; font-weight:700; color:var(--tm); letter-spacing:0.1em; text-transform:uppercase;">Days Clean</div>
    </div>
    <div style="flex:1;">
      <div style="font-size:0.68rem; color:var(--tm); margin-bottom:6px;">Set your clean date</div>
      <input type="date" id="clean-date-input" class="input" onchange="saveCleanDate(this.value)">
      <div id="clean-date-label" style="font-size:0.64rem; color:var(--tm); margin-top:4px;"></div>
    </div>
  </div>
</div>

<!-- Mood Check-in -->
<div class="card">
  <div class="label">Today's Check-In</div>
  <div class="mood-row">
    <div class="mood-btn" id="mood-sad" onclick="setMood('sad')">
      <div class="mood-emoji">&#x1F614;</div>
      <div class="mood-label">Low</div>
    </div>
    <div class="mood-btn" id="mood-meh" onclick="setMood('meh')">
      <div class="mood-emoji">&#x1F610;</div>
      <div class="mood-label">Okay</div>
    </div>
    <div class="mood-btn" id="mood-good" onclick="setMood('good')">
      <div class="mood-emoji">&#x1F642;</div>
      <div class="mood-label">Good</div>
    </div>
    <div class="mood-btn" id="mood-great" onclick="setMood('great')">
      <div class="mood-emoji">&#x1F60A;</div>
      <div class="mood-label">Great</div>
    </div>
    <div class="mood-btn" id="mood-wow" onclick="setMood('wow')">
      <div class="mood-emoji">&#x1F31F;</div>
      <div class="mood-label">Amazing</div>
    </div>
  </div>
  <div id="mood-history" style="font-size:0.74rem; color:var(--tm); margin-top:10px;"></div>
</div>

<!-- Daily Quote -->
<div class="card" style="border-left: 3px solid var(--ac);">
  <div id="daily-quote" style="font-style:italic; font-size:0.84rem; line-height:1.6;"></div>
</div>


<!-- Daily Readings -->
<div class="label" style="margin-top:4px;">Today's Readings</div>
<a href="https://www.jftna.org/jft/" target="_blank" style="display:flex;align-items:center;gap:13px;background:var(--sf);border:1px solid var(--bd);border-radius:var(--r);padding:13px 15px;margin-bottom:8px;text-decoration:none;color:var(--tx);">
  <div style="font-size:1.4rem;">&#x1F4D4;</div>
  <div style="flex:1;">
    <div style="font-weight:600;font-size:0.86rem;">Just For Today</div>
    <div style="font-size:0.7rem;color:var(--tm);margin-top:2px;">Read today's daily meditation</div>
  </div>
  <div style="color:var(--tm);">&#8250;</div>
</a>
<a href="https://spadna.org" target="_blank" style="display:flex;align-items:center;gap:13px;background:var(--sf);border:1px solid var(--bd);border-radius:var(--r);padding:13px 15px;margin-bottom:8px;text-decoration:none;color:var(--tx);">
  <div style="font-size:1.4rem;">&#x2728;</div>
  <div style="flex:1;">
    <div style="font-weight:600;font-size:0.86rem;">Spiritual Principle a Day</div>
    <div style="font-size:0.7rem;color:var(--tm);margin-top:2px;">Read today's spiritual principle</div>
  </div>
  <div style="color:var(--tm);">&#8250;</div>
</a>

<!-- Quick Links -->
<div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:2px;">
  <div class="card" onclick="showScreen('journal')" style="text-align:center; cursor:pointer; margin-bottom:0;">
    <div style="font-size:1.4rem;">&#x270D;</div>
    <div style="font-size:0.7rem; color:var(--tm); margin-top:4px;">Journal</div>
  </div>
  <div class="card" onclick="showScreen('meetings')" style="text-align:center; cursor:pointer; margin-bottom:0;">
    <div style="font-size:1.4rem;">&#x1F5D3;</div>
    <div style="font-size:0.7rem; color:var(--tm); margin-top:4px;">Meetings</div>
  </div>
</div>

<!-- Crisis Line -->
<div style="background:rgba(180,60,60,0.12); border:1px solid rgba(180,60,60,0.25); border-radius:var(--r); padding:12px 14px; margin-top:10px;">
  <div style="display:flex; gap:10px; align-items:center; margin-bottom:8px;">
    <div style="font-size:1rem;">ğŸ“</div>
    <div style="font-size:0.74rem; font-weight:700; color:var(--tx);">Helplines</div>
  </div>
  <a href="tel:03009991212" style="display:flex; align-items:center; justify-content:space-between; text-decoration:none; padding:8px 0; border-bottom:1px solid rgba(180,60,60,0.2);">
    <div>
      <div style="font-size:0.76rem; font-weight:700; color:#ff6b6b;">ğŸ‡¬ğŸ‡§ UK Helpline</div>
      <div style="font-size:0.63rem; color:var(--tm);">0300 999 1212 Â· 10amâ€“midnight daily</div>
    </div>
    <div style="font-size:0.7rem; color:var(--tm);">Tap to call â€º</div>
  </a>
  <a href="tel:+18187739999" style="display:flex; align-items:center; justify-content:space-between; text-decoration:none; padding:8px 0; border-bottom:1px solid rgba(180,60,60,0.2);">
    <div>
      <div style="font-size:0.76rem; font-weight:700; color:#ff6b6b;">ğŸŒ NA World Service Office</div>
      <div style="font-size:0.63rem; color:var(--tm);">+1 818 773 9999 Â· Monâ€“Fri, 8amâ€“5pm PST</div>
    </div>
    <div style="font-size:0.7rem; color:var(--tm);">Tap to call â€º</div>
  </a>
  <a href="https://www.na.org/meetingsearch" target="_blank" style="display:flex; align-items:center; justify-content:space-between; text-decoration:none; padding:8px 0;">
    <div>
      <div style="font-size:0.76rem; font-weight:700; color:#ff6b6b;">ğŸ” Find Your Local Helpline</div>
      <div style="font-size:0.63rem; color:var(--tm);">na.org Â· Search by country or region</div>
    </div>
    <div style="font-size:0.7rem; color:var(--tm);">Open â€º</div>
  </a>
</div>
```

  </div><!-- end home -->

  <!-- PLACEHOLDER SCREENS (we'll build these next) -->

  <div class="screen" id="screen-journal">

```
<div style="font-family:'Cormorant Garamond',serif; font-size:1.9rem; font-weight:300; color:var(--ac); margin-bottom:2px;">Journal</div>
<div style="font-size:0.62rem; color:var(--tm); letter-spacing:0.08em; text-transform:uppercase; margin-bottom:18px;">Your daily recovery writing</div>

<!-- JOURNAL HOME - type selector -->
<div id="j-home">
  <div class="label">Choose a journal type</div>

  <div onclick="openJournal('gratitude')" class="j-type-card">
    <div style="font-size:1.4rem;">&#x1F64F;</div>
    <div style="flex:1;">
      <div style="font-weight:600; font-size:0.88rem;">Gratitude List</div>
      <div style="font-size:0.72rem; color:var(--tm); margin-top:2px;">Count your blessings with guided prompts</div>
    </div>
    <div style="color:var(--tm);">&#8250;</div>
  </div>

  <div onclick="openJournal('spotcheck')" class="j-type-card">
    <div style="font-size:1.4rem;">&#x26A1;</div>
    <div style="flex:1;">
      <div style="font-weight:600; font-size:0.88rem;">Spot Check Inventory</div>
      <div style="font-size:0.72rem; color:var(--tm); margin-top:2px;">Quick nightly check-in based on Step 10</div>
    </div>
    <div style="color:var(--tm);">&#8250;</div>
  </div>

  <div onclick="openJournal('step10')" class="j-type-card">
    <div style="font-size:1.4rem;">&#x1F4CB;</div>
    <div style="flex:1;">
      <div style="font-weight:600; font-size:0.88rem;">Full Step 10 Inventory</div>
      <div style="font-size:0.72rem; color:var(--tm); margin-top:2px;">Complete NA daily inventory questions</div>
    </div>
    <div style="color:var(--tm);">&#8250;</div>
  </div>

  <div onclick="openJournal('daily')" class="j-type-card">
    <div style="font-size:1.4rem;">&#x270D;</div>
    <div style="flex:1;">
      <div style="font-weight:600; font-size:0.88rem;">Daily Journal</div>
      <div style="font-size:0.72rem; color:var(--tm); margin-top:2px;">Free writing with gentle prompts</div>
    </div>
    <div style="color:var(--tm);">&#8250;</div>
  </div>

  <!-- Past entries -->
  <div style="display:flex;align-items:center;justify-content:space-between;margin-top:20px;margin-bottom:8px;">
    <div class="label" style="margin:0;">Recent Entries</div>
    <button onclick="showExportPicker()" style="background:var(--sf);border:1px solid var(--bd);border-radius:20px;padding:5px 12px;font-size:0.66rem;color:var(--ac);cursor:pointer;">â†‘ Export</button>
  </div>
  <div id="j-entries"></div>
</div>

<!-- JOURNAL WRITE VIEW -->
<div id="j-write" style="display:none;">
  <div style="display:flex; align-items:center; gap:12px; margin-bottom:16px;">
    <button onclick="closeJournal()" style="background:var(--sf);border:1px solid var(--bd);border-radius:50%;width:34px;height:34px;color:var(--tx);font-size:1rem;cursor:pointer;flex-shrink:0;">&#8592;</button>
    <div>
      <div id="j-write-title" style="font-weight:700; font-size:0.94rem;"></div>
      <div id="j-write-date" style="font-size:0.68rem; color:var(--tm);"></div>
    </div>
  </div>

  <!-- Prompts area -->
  <div id="j-prompts"></div>

  <!-- Text area -->
  <textarea id="j-text" class="input" rows="10" placeholder="Write here..." style="resize:none; line-height:1.6; padding:12px;"></textarea>

  <div style="display:flex; gap:8px; margin-top:10px;">
    <button onclick="saveJournal()" class="btn" style="flex:1;">Save Entry</button>
    <button id="j-delete-btn" onclick="deleteJournal()" style="display:none; background:transparent; border:1px solid rgba(180,60,60,0.4); border-radius:var(--r); padding:13px 16px; color:#ff6b6b; font-size:0.8rem; cursor:pointer;">Delete</button>
  </div>
</div>
```

  </div>

  <div class="screen" id="screen-steps">
    <div style="font-family:'Cormorant Garamond',serif; font-size:1.9rem; font-weight:300; color:var(--ac); margin-bottom:2px;">Worksheets</div>
    <div style="font-size:0.62rem; color:var(--tm); letter-spacing:0.08em; text-transform:uppercase; margin-bottom:18px;">Step work &amp; recovery worksheets</div>
        <!-- WORKSHEETS -->
    <div class="label"><span style="margin-right:5px;">&#x1F4CB;</span>Worksheets</div>

```
<a href="https://www.nwnjna.org/wp-content/uploads/2020/03/NARCOTICS-ANONYMOUS-STEP-WRITING-GUIDE.pdf" target="_blank" style="display:flex;align-items:center;gap:14px;background:var(--sf);border:1px solid var(--bd);border-radius:var(--r);padding:14px 16px;margin-bottom:8px;text-decoration:none;color:var(--tx);">
  <div style="font-size:1.5rem;">&#x1F4C4;</div>
  <div style="flex:1;">
    <div style="font-weight:600;font-size:0.88rem;">The 12 Steps</div>
    <div style="font-size:0.72rem;color:var(--tm);margin-top:2px;">NA Step Writing Guide â€” full workbook PDF</div>
  </div>
  <div style="color:var(--tm);">&#8250;</div>
</a>

<a href="https://nameetingmakers.com/literature/NA-GUIDING-PRINCIPLES-TRADITIONS.pdf" target="_blank" style="display:flex;align-items:center;gap:14px;background:var(--sf);border:1px solid var(--bd);border-radius:var(--r);padding:14px 16px;margin-bottom:8px;text-decoration:none;color:var(--tx);">
  <div style="font-size:1.5rem;">&#x1F4D6;</div>
  <div style="flex:1;">
    <div style="font-weight:600;font-size:0.88rem;">Guiding Principles</div>
    <div style="font-size:0.72rem;color:var(--tm);margin-top:2px;">The Spirit of Our Traditions â€” full workbook PDF</div>
  </div>
  <div style="color:var(--tm);">&#8250;</div>
</a>
```

  </div><!-- end screen-steps -->

  <div class="screen" id="screen-meetings">
    <div style="font-family:'Cormorant Garamond',serif; font-size:1.9rem; font-weight:300; color:var(--ac); margin-bottom:2px;">Meetings</div>
    <div style="font-size:0.62rem; color:var(--tm); letter-spacing:0.08em; text-transform:uppercase; margin-bottom:20px;">Find your fellowship</div>

```
<!-- IN-PERSON FINDERS -->
<div class="label">ğŸ“ Find an In-Person Meeting</div>

<a href="https://na.org/meetingsearch/" target="_blank" class="meeting-card">
  <div class="meeting-left">
    <div class="meeting-flag">ğŸŒ</div>
    <div>
      <div class="meeting-title">NA World Meeting Search</div>
      <div class="meeting-sub">Find meetings anywhere in the world</div>
    </div>
  </div>
  <div class="meeting-arr">â€º</div>
</a>

<a href="https://meetings.ukna.org/meeting/search" target="_blank" class="meeting-card">
  <div class="meeting-left">
    <div class="meeting-flag">ğŸ‡¬ğŸ‡§</div>
    <div>
      <div class="meeting-title">UK Meeting Finder</div>
      <div class="meeting-sub">Search by postcode, town or county</div>
    </div>
  </div>
  <div class="meeting-arr">â€º</div>
</a>

<a href="https://edmna.org/regions-and-events/" target="_blank" class="meeting-card">
  <div class="meeting-left">
    <div class="meeting-flag">ğŸ‡ªğŸ‡º</div>
    <div>
      <div class="meeting-title">European Meeting Finder</div>
      <div class="meeting-sub">NA European Delegates Meeting â€” all regions</div>
    </div>
  </div>
  <div class="meeting-arr">â€º</div>
</a>

<!-- ONLINE MEETINGS -->
<div class="label" style="margin-top:20px;">ğŸ’» Online & Virtual Meetings</div>
<div style="font-size:0.72rem; color:var(--tm); margin-bottom:12px; line-height:1.5;">Can't get to a meeting? Online meetings are available 24/7 from anywhere in the world.</div>

<a href="https://virtual-na.org/meetings/" target="_blank" class="meeting-card">
  <div class="meeting-left">
    <div class="meeting-flag">ğŸŒ</div>
    <div>
      <div class="meeting-title">Virtual NA</div>
      <div class="meeting-sub">Worldwide online & phone meetings, sorted by language & day</div>
    </div>
  </div>
  <div class="meeting-arr">â€º</div>
</a>

<a href="https://meetings.ukna.org/meeting/search/online" target="_blank" class="meeting-card">
  <div class="meeting-left">
    <div class="meeting-flag">ğŸ‡¬ğŸ‡§</div>
    <div>
      <div class="meeting-title">UK Online Meetings</div>
      <div class="meeting-sub">450+ online UK NA meetings</div>
    </div>
  </div>
  <div class="meeting-arr">â€º</div>
</a>





<!-- HELPLINE REMINDER -->
<div style="background:var(--sf); border:1px solid var(--bd); border-radius:var(--r); padding:14px; margin-top:20px;">
  <div style="font-size:0.68rem; color:var(--tm); text-transform:uppercase; letter-spacing:0.06em; margin-bottom:12px;">ğŸ“ Helplines</div>
  <a href="tel:03009991212" style="display:flex; align-items:center; justify-content:space-between; text-decoration:none; padding:8px 0; border-bottom:1px solid var(--bd);">
    <div>
      <div style="font-size:0.82rem; font-weight:700; color:var(--ac);">ğŸ‡¬ğŸ‡§ UK Helpline</div>
      <div style="font-size:0.68rem; color:var(--tm); margin-top:2px;">0300 999 1212 Â· 10amâ€“midnight daily</div>
    </div>
    <div style="font-size:0.7rem; color:var(--tm);">Tap to call â€º</div>
  </a>
  <a href="tel:+18187739999" style="display:flex; align-items:center; justify-content:space-between; text-decoration:none; padding:8px 0; border-bottom:1px solid var(--bd);">
    <div>
      <div style="font-size:0.82rem; font-weight:700; color:var(--ac);">ğŸŒ NA World Service Office</div>
      <div style="font-size:0.68rem; color:var(--tm); margin-top:2px;">+1 818 773 9999 Â· Monâ€“Fri, 8amâ€“5pm PST</div>
    </div>
    <div style="font-size:0.7rem; color:var(--tm);">Tap to call â€º</div>
  </a>
  <a href="https://www.na.org/meetingsearch" target="_blank" style="display:flex; align-items:center; justify-content:space-between; text-decoration:none; padding:8px 0;">
    <div>
      <div style="font-size:0.82rem; font-weight:700; color:var(--ac);">ğŸ” Find Your Local Helpline</div>
      <div style="font-size:0.68rem; color:var(--tm); margin-top:2px;">na.org Â· Search by country or region</div>
    </div>
    <div style="font-size:0.7rem; color:var(--tm);">Open â€º</div>
  </a>
</div>
```

  </div>

  <div class="screen" id="screen-books">
    <div style="font-family:'Cormorant Garamond',serif; font-size:1.9rem; font-weight:300; color:var(--ac); margin-bottom:2px;">Books</div>
    <div style="font-size:0.62rem; color:var(--tm); letter-spacing:0.08em; text-transform:uppercase; margin-bottom:18px;">NA Literature Library</div>

```
<!-- MAIN BOOKS -->
<div class="label">ğŸ“• Main Books</div>
<div style="font-size:0.7rem; color:var(--tm); margin-bottom:12px;">Tap a book to see purchase options</div>

<div class="book-expand-card">
  <div class="book-card-header" onclick="toggleBook(this)">
    <div class="book-icon">ğŸ“˜</div>
    <div class="book-body"><div class="book-title">Basic Text</div><div class="book-sub">Narcotics Anonymous â€” 6th Edition</div></div>
    <div class="book-chevron">&#8250;</div>
  </div>
  <div class="book-card-body">
    <div class="book-section-label">ğŸ“± Digital Edition</div>
    <div class="book-btn-row">
      <a href="https://books.apple.com/us/book/narcotics-anonymous/id560639864" target="_blank" class="buy-btn apple-btn">ğŸ Apple Books</a>
      <a href="https://play.google.com/store/books/details/Fellowship_of_Narcotics_Anonymous_Narcotics_Anonymo?id=560639864" target="_blank" class="buy-btn google-btn">â–¶ Google Play</a>
    </div>
    <div class="book-section-label" style="margin-top:12px;">ğŸ“¦ Buy Hardcopy</div>
    <a href="https://cart-us.na.org/recovery-products/books/basic-text-hardcover-1101" target="_blank" class="buy-btn world-btn">ğŸŒ NA World Store</a>
    <a href="https://ukso.biz" target="_blank" class="buy-btn uk-btn">ğŸ‡¬ğŸ‡§ UK Service Office</a>
    <a href="https://cart-eu.na.org" target="_blank" class="buy-btn eu-btn">ğŸ‡ªğŸ‡º NA Europe Store</a>
  </div>
</div>
<div class="book-expand-card">
  <div class="book-card-header" onclick="toggleBook(this)">
    <div class="book-icon">ğŸ“”</div>
    <div class="book-body"><div class="book-title">Just for Today</div><div class="book-sub">Daily meditations for recovering addicts</div></div>
    <div class="book-chevron">&#8250;</div>
  </div>
  <div class="book-card-body">
    <div class="book-section-label">ğŸ“± Digital Edition</div>
    <div class="book-btn-row">
      <a href="https://books.apple.com/us/book/just-for-today/id1608426774" target="_blank" class="buy-btn apple-btn">ğŸ Apple Books</a>
      <a href="https://play.google.com/store/books/details?id=just-for-today-na" target="_blank" class="buy-btn google-btn">â–¶ Google Play</a>
    </div>
    <div class="book-section-label" style="margin-top:12px;">ğŸ“¦ Buy Hardcopy</div>
    <a href="https://cart-us.na.org/recovery-products/books/just-for-today-daily-meditation-book-1112" target="_blank" class="buy-btn world-btn">ğŸŒ NA World Store</a>
    <a href="https://ukso.biz" target="_blank" class="buy-btn uk-btn">ğŸ‡¬ğŸ‡§ UK Service Office</a>
    <a href="https://cart-eu.na.org" target="_blank" class="buy-btn eu-btn">ğŸ‡ªğŸ‡º NA Europe Store</a>
  </div>
</div>
<div class="book-expand-card">
  <div class="book-card-header" onclick="toggleBook(this)">
    <div class="book-icon">ğŸ“™</div>
    <div class="book-body"><div class="book-title">It Works: How and Why</div><div class="book-sub">The 12 Steps & 12 Traditions of NA</div></div>
    <div class="book-chevron">&#8250;</div>
  </div>
  <div class="book-card-body">
    <div class="book-section-label">ğŸ“± Digital Edition</div>
    <div class="book-btn-row">
      <a href="https://books.apple.com/us/book/it-works-how-and-why/id564200715" target="_blank" class="buy-btn apple-btn">ğŸ Apple Books</a>
      <a href="https://play.google.com/store/books/details/Fellowship_of_Narcotics_Anonymous_It_Works_How_and?id=564200715" target="_blank" class="buy-btn google-btn">â–¶ Google Play</a>
    </div>
    <div class="book-section-label" style="margin-top:12px;">ğŸ“¦ Buy Hardcopy</div>
    <a href="https://cart-us.na.org/recovery-products/books/it-works-5-how-and-why-hardcover-1140" target="_blank" class="buy-btn world-btn">ğŸŒ NA World Store</a>
    <a href="https://ukso.biz" target="_blank" class="buy-btn uk-btn">ğŸ‡¬ğŸ‡§ UK Service Office</a>
    <a href="https://cart-eu.na.org" target="_blank" class="buy-btn eu-btn">ğŸ‡ªğŸ‡º NA Europe Store</a>
  </div>
</div>
<div class="book-expand-card">
  <div class="book-card-header" onclick="toggleBook(this)">
    <div class="book-icon">ğŸ“–</div>
    <div class="book-body"><div class="book-title">Guiding Principles</div><div class="book-sub">The Spirit of Our Traditions</div></div>
    <div class="book-chevron">&#8250;</div>
  </div>
  <div class="book-card-body">
    <div class="book-section-label">ğŸ“± Digital Edition</div>
    <div class="book-btn-row">
      <a href="https://books.apple.com/us/book/guiding-principles-the-spirit-of-our-traditions/id1478457214" target="_blank" class="buy-btn apple-btn">ğŸ Apple Books</a>
      <a href="https://play.google.com/store/books/details/Fellowship_of_Narcotics_Anonymous_Guiding_Principle?id=1478457214" target="_blank" class="buy-btn google-btn">â–¶ Google Play</a>
    </div>
    <div class="book-section-label" style="margin-top:12px;">ğŸ“¦ Buy Hardcopy</div>
    <a href="https://cart-us.na.org/recovery-products/books" target="_blank" class="buy-btn world-btn">ğŸŒ NA World Store</a>
    <a href="https://ukso.biz" target="_blank" class="buy-btn uk-btn">ğŸ‡¬ğŸ‡§ UK Service Office</a>
    <a href="https://cart-eu.na.org" target="_blank" class="buy-btn eu-btn">ğŸ‡ªğŸ‡º NA Europe Store</a>
  </div>
</div>
<div class="book-expand-card">
  <div class="book-card-header" onclick="toggleBook(this)">
    <div class="book-icon">ğŸ›¤ï¸</div>
    <div class="book-body"><div class="book-title">Living Clean</div><div class="book-sub">The Journey Continues</div></div>
    <div class="book-chevron">&#8250;</div>
  </div>
  <div class="book-card-body">
    <div class="book-section-label">ğŸ“± Digital Edition</div>
    <div class="book-btn-row">
      <a href="https://books.apple.com/us/book/living-clean-the-journey-continues/id733950643" target="_blank" class="buy-btn apple-btn">ğŸ Apple Books</a>
      <a href="https://play.google.com/store/books/details/Fellowship_of_Narcotics_Anonymous_Living_Clean_The?id=733950643" target="_blank" class="buy-btn google-btn">â–¶ Google Play</a>
    </div>
    <div class="book-section-label" style="margin-top:12px;">ğŸ“¦ Buy Hardcopy</div>
    <a href="https://cart-us.na.org/recovery-products/books/living-clean-1160" target="_blank" class="buy-btn world-btn">ğŸŒ NA World Store</a>
    <a href="https://ukso.biz" target="_blank" class="buy-btn uk-btn">ğŸ‡¬ğŸ‡§ UK Service Office</a>
    <a href="https://cart-eu.na.org" target="_blank" class="buy-btn eu-btn">ğŸ‡ªğŸ‡º NA Europe Store</a>
  </div>
</div>
<div class="book-expand-card">
  <div class="book-card-header" onclick="toggleBook(this)">
    <div class="book-icon">ğŸ“‹</div>
    <div class="book-body"><div class="book-title">Step Working Guides</div><div class="book-sub">NA 12 Step working guides</div></div>
    <div class="book-chevron">&#8250;</div>
  </div>
  <div class="book-card-body">
    <div class="book-section-label">ğŸ“± Digital Edition</div>
    <div class="book-btn-row">
      <a href="https://books.apple.com/us/book/the-na-step-working-guides/id1036368127" target="_blank" class="buy-btn apple-btn">ğŸ Apple Books</a>
      <a href="https://play.google.com/store/books/details/Fellowship_of_Narcotics_Anonymous_The_NA_Step_Worki?id=1036368127" target="_blank" class="buy-btn google-btn">â–¶ Google Play</a>
    </div>
    <div class="book-section-label" style="margin-top:12px;">ğŸ“¦ Buy Hardcopy</div>
    <a href="https://cart-us.na.org/recovery-products/books/the-na-step-working-guides-1400" target="_blank" class="buy-btn world-btn">ğŸŒ NA World Store</a>
    <a href="https://ukso.biz" target="_blank" class="buy-btn uk-btn">ğŸ‡¬ğŸ‡§ UK Service Office</a>
    <a href="https://cart-eu.na.org" target="_blank" class="buy-btn eu-btn">ğŸ‡ªğŸ‡º NA Europe Store</a>
  </div>
</div>
<div class="book-expand-card">
  <div class="book-card-header" onclick="toggleBook(this)">
    <div class="book-icon">âœ¨</div>
    <div class="book-body"><div class="book-title">A Spiritual Principle a Day</div><div class="book-sub">Daily readings on spiritual principles</div></div>
    <div class="book-chevron">&#8250;</div>
  </div>
  <div class="book-card-body">
    <div class="book-section-label">ğŸ“± Digital Edition</div>
    <div class="book-btn-row">
      <a href="https://books.apple.com/us/book/a-spiritual-principle-a-day/id1590889673" target="_blank" class="buy-btn apple-btn">ğŸ Apple Books</a>
      <a href="https://play.google.com/store/books/details/Fellowship_of_Narcotics_Anonymous_A_Spiritual_Princ?id=1590889673" target="_blank" class="buy-btn google-btn">â–¶ Google Play</a>
    </div>
    <div class="book-section-label" style="margin-top:12px;">ğŸ“¦ Buy Hardcopy</div>
    <a href="https://cart-us.na.org/recovery-products/books/a-spiritual-principle-a-day-1170" target="_blank" class="buy-btn world-btn">ğŸŒ NA World Store</a>
    <a href="https://ukso.biz" target="_blank" class="buy-btn uk-btn">ğŸ‡¬ğŸ‡§ UK Service Office</a>
    <a href="https://cart-eu.na.org" target="_blank" class="buy-btn eu-btn">ğŸ‡ªğŸ‡º NA Europe Store</a>
  </div>
</div>

<!-- BOOKLETS -->
<div class="label" style="margin-top:20px;">ğŸ“„ Booklets</div>
<a href="https://na.org/wp-content/uploads/2024/05/AN1500_LWB-Little-White-Book-English-Anglicized.pdf" target="_blank" class="book-card">
  <div class="book-icon">ğŸ“„</div><div class="book-body"><div class="book-title">The White Booklet</div><div class="book-sub">Free PDF â€” official na.org</div></div><div class="book-arr">â€º</div>
</a>

<!-- INFORMATIONAL PAMPHLETS -->
<div class="label" style="margin-top:16px;">ğŸ“ƒ Informational Pamphlets</div>
<div style="font-size:0.7rem; color:var(--tm); margin-bottom:10px;">All free official PDFs from na.org</div>
<a href="https://na.org/wp-content/uploads/2024/05/AN3101_6-22-IP-1-English-Anglicized.pdf" target="_blank" class="book-card"><div class="book-icon">ğŸ“ƒ</div><div class="book-body"><div class="book-title">IP #1: Who, What, How, and Why</div></div><div class="book-arr">â€º</div></a>
<a href="https://na.org/wp-content/uploads/2024/05/AN3105-IP-5-English-Anglicized.pdf" target="_blank" class="book-card"><div class="book-icon">ğŸ“ƒ</div><div class="book-body"><div class="book-title">IP #5: Another Look</div></div><div class="book-arr">â€º</div></a>
<a href="https://na.org/wp-content/uploads/2024/05/AN3106-IP-6-English-Anglicized.pdf" target="_blank" class="book-card"><div class="book-icon">ğŸ“ƒ</div><div class="book-body"><div class="book-title">IP #6: Recovery &amp; Relapse</div></div><div class="book-arr">â€º</div></a>
<a href="https://na.org/wp-content/uploads/2024/05/AN3107-IP-7-English-Anglicized.pdf" target="_blank" class="book-card"><div class="book-icon">ğŸ“ƒ</div><div class="book-body"><div class="book-title">IP #7: Am I an Addict?</div></div><div class="book-arr">â€º</div></a>
<a href="https://na.org/wp-content/uploads/2024/05/AN3108-IP-8-English-Anglicized.pdf" target="_blank" class="book-card"><div class="book-icon">ğŸ“ƒ</div><div class="book-body"><div class="book-title">IP #8: Just for Today</div></div><div class="book-arr">â€º</div></a>
<a href="https://na.org/wp-content/uploads/2024/05/AN3109_10-22-IP-9-English-Anglicized.pdf" target="_blank" class="book-card"><div class="book-icon">ğŸ“ƒ</div><div class="book-body"><div class="book-title">IP #9: Living the Programme</div></div><div class="book-arr">â€º</div></a>
<a href="https://na.org/wp-content/uploads/2024/05/AN3111-IP-11-English-Anglicized.pdf" target="_blank" class="book-card"><div class="book-icon">ğŸ“ƒ</div><div class="book-body"><div class="book-title">IP #11: Sponsorship</div></div><div class="book-arr">â€º</div></a>
<a href="https://na.org/wp-content/uploads/2024/05/AN3112-IP-12-English-Anglicized.pdf" target="_blank" class="book-card"><div class="book-icon">ğŸ“ƒ</div><div class="book-body"><div class="book-title">IP #12: The Triangle of Self-Obsession</div></div><div class="book-arr">â€º</div></a>
<a href="https://na.org/wp-content/uploads/2024/05/AN3113-IP-13-English-Anglicized.pdf" target="_blank" class="book-card"><div class="book-icon">ğŸ“ƒ</div><div class="book-body"><div class="book-title">IP #13: Youth and Recovery</div></div><div class="book-arr">â€º</div></a>
<a href="https://na.org/wp-content/uploads/2024/05/AN3114-IP-14-English-Anglicized.pdf" target="_blank" class="book-card"><div class="book-icon">ğŸ“ƒ</div><div class="book-body"><div class="book-title">IP #14: One Addict's Experience</div></div><div class="book-arr">â€º</div></a>
<a href="https://na.org/wp-content/uploads/2024/05/AN3115_7-22-IP-15-English-Anglicized.pdf" target="_blank" class="book-card"><div class="book-icon">ğŸ“ƒ</div><div class="book-body"><div class="book-title">IP #15: PI and the NA Member</div></div><div class="book-arr">â€º</div></a>
<a href="https://na.org/wp-content/uploads/2024/05/AN3116-IP-16-English-Anglicized.pdf" target="_blank" class="book-card"><div class="book-icon">ğŸ“ƒ</div><div class="book-body"><div class="book-title">IP #16: For the Newcomer</div></div><div class="book-arr">â€º</div></a>
<a href="https://na.org/wp-content/uploads/2024/05/AN3119-IP-19-English-Anglicized.pdf" target="_blank" class="book-card"><div class="book-icon">ğŸ“ƒ</div><div class="book-body"><div class="book-title">IP #19: Self-Acceptance</div></div><div class="book-arr">â€º</div></a>
<a href="https://na.org/wp-content/uploads/2024/05/AN3120_7-22-IP-20-English-Anglicized.pdf" target="_blank" class="book-card"><div class="book-icon">ğŸ“ƒ</div><div class="book-body"><div class="book-title">IP #20: H&amp;I Service and the NA Member</div></div><div class="book-arr">â€º</div></a>
<a href="https://na.org/wp-content/uploads/2024/05/AN3122-IP-22-English-Anglicized.pdf" target="_blank" class="book-card"><div class="book-icon">ğŸ“ƒ</div><div class="book-body"><div class="book-title">IP #22: Welcome to Narcotics Anonymous</div></div><div class="book-arr">â€º</div></a>
<a href="https://na.org/wp-content/uploads/2024/05/AN3123-IP-23-English-Anglicized.pdf" target="_blank" class="book-card"><div class="book-icon">ğŸ“ƒ</div><div class="book-body"><div class="book-title">IP #23: Staying Clean on the Inside</div></div><div class="book-arr">â€º</div></a>
<a href="https://na.org/wp-content/uploads/2024/05/AN3124-IP-24-English-Anglicized.pdf" target="_blank" class="book-card"><div class="book-icon">ğŸ“ƒ</div><div class="book-body"><div class="book-title">IP #24: Why Are We Self-Supporting?</div></div><div class="book-arr">â€º</div></a>
```

  </div><!-- end screen-books -->

  <div class="screen" id="screen-resources">
    <div style="font-family:'Cormorant Garamond',serif; font-size:1.9rem; font-weight:300; color:var(--ac); margin-bottom:4px;">Movement</div>
    <div style="color:var(--tm); font-size:0.84rem; margin-bottom:18px;">Gentle practices to support your recovery â€” body, breath & mind</div>

```
<!-- YOGA -->
<div style="color:var(--ac); font-size:0.75rem; letter-spacing:0.12em; text-transform:uppercase; margin-bottom:10px;">ğŸ§˜ Yoga</div>

<a href="https://crpf.gov.in/writereaddata/images/pdf/Yoga_Beginner.pdf" target="_blank" class="meeting-card" style="text-decoration:none; display:flex; margin-bottom:10px;">
  <div class="meeting-left">
    <div style="font-size:1.5rem;">ğŸ“„</div>
  </div>
  <div style="flex:1;">
    <div class="meeting-title">Breath, Movement & Stillness</div>
    <div class="meeting-sub">A complete yoga manual for beginners â€” poses, safety guidance & philosophy</div>
  </div>
  <div class="meeting-arr">â€º</div>
</a>

<a href="https://darebee.com/pdf/programs/30-days-of-yoga.pdf" target="_blank" class="meeting-card" style="text-decoration:none; display:flex; margin-bottom:10px;">
  <div class="meeting-left">
    <div style="font-size:1.5rem;">ğŸ“„</div>
  </div>
  <div style="flex:1;">
    <div class="meeting-title">30 Days of Yoga</div>
    <div class="meeting-sub">A free beginner programme â€” one session per day, building gently over a month</div>
  </div>
  <div class="meeting-arr">â€º</div>
</a>

<a href="https://tintyoga.com/wp-content/uploads/2019/11/Yoga-Class-Plans.pdf" target="_blank" class="meeting-card" style="text-decoration:none; display:flex; margin-bottom:18px;">
  <div class="meeting-left">
    <div style="font-size:1.5rem;">ğŸ“„</div>
  </div>
  <div style="flex:1;">
    <div class="meeting-title">Beginner Yoga Sequence</div>
    <div class="meeting-sub">A 60-minute class plan with alignment focus â€” accessible for complete beginners</div>
  </div>
  <div class="meeting-arr">â€º</div>
</a>

<!-- BREATHWORK -->
<div style="color:var(--ac); font-size:0.75rem; letter-spacing:0.12em; text-transform:uppercase; margin-bottom:10px;">ğŸŒ¬ï¸ Breathwork</div>

<a href="https://uhs.berkeley.edu/sites/default/files/breathing_exercises_0.pdf" target="_blank" class="meeting-card" style="text-decoration:none; display:flex; margin-bottom:10px;">
  <div class="meeting-left">
    <div style="font-size:1.5rem;">ğŸ“„</div>
  </div>
  <div style="flex:1;">
    <div class="meeting-title">Breathing Exercises Guide</div>
    <div class="meeting-sub">UC Berkeley Health â€” simple techniques including diaphragmatic & box breathing</div>
  </div>
  <div class="meeting-arr">â€º</div>
</a>

<a href="https://umsonline.org/printerfriendly/pranayama.pdf" target="_blank" class="meeting-card" style="text-decoration:none; display:flex; margin-bottom:10px;">
  <div class="meeting-left">
    <div style="font-size:1.5rem;">ğŸ“„</div>
  </div>
  <div style="flex:1;">
    <div class="meeting-title">Pranayama & the Art of Breathing</div>
    <div class="meeting-sub">An introduction to yogic breathwork â€” what it is, how it works & techniques to try</div>
  </div>
  <div class="meeting-arr">â€º</div>
</a>

<a href="https://www.artofliving.org/us-en/breathwork/pranayama/breathing-exercises" target="_blank" class="meeting-card" style="text-decoration:none; display:flex; margin-bottom:18px;">
  <div class="meeting-left">
    <div style="font-size:1.5rem;">ğŸŒ</div>
  </div>
  <div style="flex:1;">
    <div class="meeting-title">Beginner's Guide to Breathwork</div>
    <div class="meeting-sub">Art of Living â€” 5 techniques to try today with step-by-step instructions</div>
  </div>
  <div class="meeting-arr">â€º</div>
</a>

<!-- MEDITATION -->
<div style="color:var(--ac); font-size:0.75rem; letter-spacing:0.12em; text-transform:uppercase; margin-bottom:10px;">ğŸª· Meditation</div>

<a href="https://share.upmc.com/wp-content/uploads/2021/10/HBEAT521847_Mindfulness_MeditationPDF_FNL-1.pdf" target="_blank" class="meeting-card" style="text-decoration:none; display:flex; margin-bottom:10px;">
  <div class="meeting-left">
    <div style="font-size:1.5rem;">ğŸ“„</div>
  </div>
  <div style="flex:1;">
    <div class="meeting-title">A Beginner's Guide to Mindfulness</div>
    <div class="meeting-sub">UPMC Health â€” what mindfulness is, breathing techniques & how to start today</div>
  </div>
  <div class="meeting-arr">â€º</div>
</a>

<a href="https://chloeyturner.com/wp-content/uploads/2023/04/eBook-Mindfulness-Meditation-for-Beginners-3.pdf" target="_blank" class="meeting-card" style="text-decoration:none; display:flex; margin-bottom:10px;">
  <div class="meeting-left">
    <div style="font-size:1.5rem;">ğŸ“„</div>
  </div>
  <div style="flex:1;">
    <div class="meeting-title">Simple Guide to Mindfulness Meditation</div>
    <div class="meeting-sub">Covers posture, breathing, attitudes & sitting meditation â€” beginner-friendly eBook</div>
  </div>
  <div class="meeting-arr">â€º</div>
</a>

<a href="https://zenfulspirit.com/wp-content/uploads/2017/07/Meditation-for-Beginners-Book-1.pdf" target="_blank" class="meeting-card" style="text-decoration:none; display:flex; margin-bottom:10px;">
  <div class="meeting-left">
    <div style="font-size:1.5rem;">ğŸ“„</div>
  </div>
  <div style="flex:1;">
    <div class="meeting-title">Meditation for Beginners</div>
    <div class="meeting-sub">A comprehensive guide â€” how to start, how long to sit & what to expect</div>
  </div>
  <div class="meeting-arr">â€º</div>
</a>

<a href="https://www.nhs.uk/mental-health/self-help/tips-and-support/mindfulness/" target="_blank" class="meeting-card" style="text-decoration:none; display:flex; margin-bottom:10px;">
  <div class="meeting-left">
    <div style="font-size:1.5rem;">ğŸŒ</div>
  </div>
  <div style="flex:1;">
    <div class="meeting-title">NHS Mindfulness Guide</div>
    <div class="meeting-sub">Trusted UK resource â€” what mindfulness is, how it helps & free audio exercises</div>
  </div>
  <div class="meeting-arr">â€º</div>
</a>
```

  </div>

  <!-- NETWORK SCREEN -->

  <div class="screen" id="screen-network">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:2px;">
      <div style="font-family:'Cormorant Garamond',serif; font-size:1.9rem; font-weight:300; color:var(--ac);">My Network</div>
      <button onclick="openAddContact()" style="background:var(--ac);border:none;border-radius:50%;width:36px;height:36px;font-size:1.2rem;cursor:pointer;color:#1a1208;flex-shrink:0;">+</button>
    </div>
    <div style="font-size:0.62rem; color:var(--tm); letter-spacing:0.08em; text-transform:uppercase; margin-bottom:12px;">Your recovery people</div>

```
<!-- NETWORK MAP -->
<div id="net-map-wrap" style="border-radius:16px;overflow:hidden;margin-bottom:16px;border:1px solid var(--bd);position:relative;">
  <div id="net-map" style="height:220px;width:100%;background:var(--sf2);"></div>
  <div style="position:absolute;bottom:8px;left:8px;display:flex;gap:6px;z-index:1000;pointer-events:none;">
    <div style="background:rgba(15,15,26,0.85);border-radius:20px;padding:3px 8px;font-size:0.58rem;color:#fff;display:flex;align-items:center;gap:4px;"><span style="width:8px;height:8px;border-radius:50%;background:#e74c3c;display:inline-block;"></span>Sponsor</div>
    <div style="background:rgba(15,15,26,0.85);border-radius:20px;padding:3px 8px;font-size:0.58rem;color:#fff;display:flex;align-items:center;gap:4px;"><span style="width:8px;height:8px;border-radius:50%;background:#2ecc71;display:inline-block;"></span>Sponsee / Sister / Brother</div>
    <div style="background:rgba(15,15,26,0.85);border-radius:20px;padding:3px 8px;font-size:0.58rem;color:#fff;display:flex;align-items:center;gap:4px;"><span style="width:8px;height:8px;border-radius:50%;background:#f1c40f;display:inline-block;"></span>Friend</div>
  </div>
</div>

<div id="net-list"></div>
<div id="net-empty" style="display:none;text-align:center;padding:40px 0 20px;">
  <div style="font-size:2rem;margin-bottom:10px;">ğŸ¤</div>
  <div style="font-size:0.84rem;color:var(--tm);">No contacts yet</div>
  <div style="font-size:0.72rem;color:var(--tm);margin-top:4px;">Tap + to add someone from your network</div>
</div>
```

  </div>

  <!-- ADD CONTACT MODAL -->

  <div class="modal-overlay" id="contact-modal" onclick="closeContactModal(event)">
    <div class="modal-sheet" onclick="event.stopPropagation()">
      <div class="modal-title" id="contact-modal-title">Add Contact</div>

```
  <div class="modal-label">Name</div>
  <input id="cn-name" class="input" type="text" placeholder="Their name">

  <div class="modal-label">Relationship</div>
  <div class="role-grid">
    <div class="role-btn" onclick="selectRole(this,'Sponsor')">ğŸ’› Sponsor</div>
    <div class="role-btn" onclick="selectRole(this,'Sponsee')">ğŸŒ± Sponsee</div>
    <div class="role-btn" onclick="selectRole(this,'Sponsor Sister')">ğŸ’œ Sponsor Sister</div>
    <div class="role-btn" onclick="selectRole(this,'Sponsor Brother')">ğŸ’™ Sponsor Brother</div>
    <div class="role-btn" onclick="selectRole(this,'Friend in Recovery')" style="grid-column:span 2;">ğŸ¤ Friend in Recovery</div>
  </div>

  <div class="modal-label">Phone Number</div>
  <input id="cn-phone" class="input" type="tel" placeholder="+44 7700 000000">

  <div class="modal-label">WhatsApp Number <span style="color:var(--tm);font-weight:400;">(if different)</span></div>
  <input id="cn-whatsapp" class="input" type="tel" placeholder="Same as phone if blank">

  <div class="modal-label">Town / City</div>
  <input id="cn-location" class="input" type="text" placeholder="e.g. Manchester">

  <div class="modal-label">Clean Date</div>
  <input id="cn-cleandate" class="input" type="date">

  <div style="display:flex;gap:8px;margin-top:18px;">
    <button onclick="closeContactModalDirect()" style="flex:1;padding:13px;border:1px solid var(--bd);border-radius:var(--r);background:transparent;color:var(--tm);cursor:pointer;">Cancel</button>
    <button onclick="saveContact()" class="btn" style="flex:2;margin-top:0;">Save</button>
  </div>
  <div id="cn-delete-wrap" style="display:none;margin-top:10px;">
    <button onclick="deleteContact()" style="width:100%;padding:12px;border:1px solid rgba(180,60,60,0.4);border-radius:var(--r);background:transparent;color:#ff6b6b;font-size:0.8rem;cursor:pointer;">Remove Contact</button>
  </div>
</div>
```

  </div>

  <!-- EXPORT MODAL -->

  <div class="export-overlay" id="export-modal" onclick="closeExportModalDirect()">
    <div class="modal-sheet" onclick="event.stopPropagation()">
      <div id="export-picker-view">
        <div class="modal-title">Export Which Journal?</div>
        <div id="export-type-list"></div>
        <button onclick="closeExportModalDirect()" style="width:100%;margin-top:6px;padding:12px;border:1px solid var(--bd);border-radius:var(--r);background:transparent;color:var(--tm);cursor:pointer;">Cancel</button>
      </div>
      <div id="export-send-view" style="display:none;">
        <div class="modal-title" id="export-send-title"></div>
        <div id="export-preview" style="background:var(--sf2);border:1px solid var(--bd);border-radius:12px;padding:12px;font-size:0.72rem;color:var(--tm);line-height:1.6;max-height:200px;overflow-y:auto;margin-bottom:16px;white-space:pre-wrap;"></div>
        <div style="display:flex;gap:8px;">
          <button onclick="exportEmail()" class="btn" style="flex:1;margin-top:0;">âœ‰ï¸ Email</button>
          <button onclick="exportCopy()" class="btn" style="flex:1;margin-top:0;background:var(--sf2);color:var(--tx);border:1px solid var(--bd);">ğŸ“‹ Copy</button>
        </div>
        <button onclick="showExportPicker()" style="width:100%;margin-top:10px;padding:12px;border:1px solid var(--bd);border-radius:var(--r);background:transparent;color:var(--tm);cursor:pointer;">â† Back</button>
      </div>
    </div>
  </div>

  <!-- NAV -->

  <nav>
    <div class="nav-item active" id="nav-home" onclick="showScreen('home')">
      <div class="nav-icon">&#x1F3E0;</div>
      <div>Home</div>
    </div>
    <div class="nav-item" id="nav-journal" onclick="showScreen('journal')">
      <div class="nav-icon">&#x270D;</div>
      <div>Journal</div>
    </div>
    <div class="nav-item" id="nav-steps" onclick="showScreen('steps')">
      <div class="nav-icon">&#x1F4D6;</div>
      <div>Worksheets</div>
    </div>
    <div class="nav-item" id="nav-books" onclick="showScreen('books')">
      <div class="nav-icon">&#x1F4DA;</div>
      <div>Books</div>
    </div>
    <div class="nav-item" id="nav-meetings" onclick="showScreen('meetings')">
      <div class="nav-icon">&#x1F5D3;</div>
      <div>Meetings</div>
    </div>
    <div class="nav-item" id="nav-network" onclick="showScreen('network')">
      <div class="nav-icon">ğŸ¤</div>
      <div>Network</div>
    </div>
    <div class="nav-item" id="nav-resources" onclick="showScreen('resources')">
      <div class="nav-icon">ğŸƒ</div>
      <div>Movement</div>
    </div>
  </nav>

</div><!-- end app -->
<div id="toast"></div>

<script>
var QUOTES = [
  {text: "Just for today, I will try to live through this day only.", source: "Just for Today"},
  {text: "We admitted we were powerless over our addiction.", source: "Step One"},
  {text: "The foundation of recovery is honesty.", source: "NA Basic Text"},
  {text: "Recovery is a process, not an event.", source: "NA Fellowship"},
  {text: "Keep coming back - it works if you work it.", source: "NA Fellowship"},
  {text: "One day at a time.", source: "NA Fellowship"},
  {text: "We do not have to be alone anymore.", source: "NA Basic Text"},
  {text: "Pain is inevitable; suffering is optional.", source: "NA Fellowship"},
  {text: "We will love and support you no matter what.", source: "NA Fellowship"},
  {text: "God, grant me the serenity to accept the things I cannot change.", source: "Serenity Prayer"}
];

// --- STATE ---
var cleanDate = localStorage.getItem('na_clean_date') || '';
var moodLog   = JSON.parse(localStorage.getItem('na_mood_log')  || '[]');

// --- NAVIGATION ---
function showScreen(name) {
  document.querySelectorAll('.screen').forEach(function(s) { s.classList.remove('active'); });
  document.querySelectorAll('.nav-item').forEach(function(n) { n.classList.remove('active'); });
  document.getElementById('screen-' + name).classList.add('active');
  document.getElementById('nav-' + name).classList.add('active');
  if (name === 'network') {
    setTimeout(function(){
      if (typeof L === 'undefined') return;
      if (!netMap) {
        initNetMap();
        setTimeout(function(){ geocodeAndPlot(); }, 200);
      } else {
        netMap.invalidateSize();
        geocodeAndPlot();
      }
    }, 100);
  }
}

// --- CLEAN DATE ---
function saveCleanDate(val) {
  cleanDate = val;
  localStorage.setItem('na_clean_date', val);
  updateDaysCount();
}

function updateDaysCount() {
  if (!cleanDate) { document.getElementById('days-count').textContent = '0'; return; }
  var start = new Date(cleanDate);
  var today = new Date();
  var days = Math.floor((today - start) / 86400000);
  if (days < 0) days = 0;
  document.getElementById('days-count').textContent = days;
  var label = days === 1 ? '1 day clean' : days + ' days clean';
  document.getElementById('clean-date-label').textContent = label;
}

// --- MOOD ---
function setMood(mood) {
  var today = new Date().toISOString().split('T')[0];
  moodLog = moodLog.filter(function(m) { return m.date !== today; });
  moodLog.push({ date: today, mood: mood });
  if (moodLog.length > 30) moodLog = moodLog.slice(-30);
  localStorage.setItem('na_mood_log', JSON.stringify(moodLog));
  document.querySelectorAll('.mood-btn').forEach(function(b) { b.classList.remove('selected'); });
  document.getElementById('mood-' + mood).classList.add('selected');
  renderMoodHistory();
  toast('Mood saved');
}

function renderMoodHistory() {
  var emojis = { sad: '&#x1F614;', meh: '&#x1F610;', good: '&#x1F642;', great: '&#x1F60A;', wow: '&#x1F31F;' };
  var recent = moodLog.slice(-7);
  if (!recent.length) { document.getElementById('mood-history').innerHTML = ''; return; }
  var html = '<div style="font-size:0.62rem; color:var(--tm); margin-bottom:4px;">Recent</div><div style="display:flex; gap:5px;">';
  recent.forEach(function(m) {
    html += '<div style="text-align:center;"><div style="font-size:1rem;">' + (emojis[m.mood] || '') + '</div><div style="font-size:0.5rem; color:var(--tm);">' + m.date.slice(5) + '</div></div>';
  });
  html += '</div>';
  document.getElementById('mood-history').innerHTML = html;
}

function markTodayMood() {
  var today = new Date().toISOString().split('T')[0];
  var entry = moodLog.find(function(m) { return m.date === today; });
  if (entry) {
    document.getElementById('mood-' + entry.mood).classList.add('selected');
  }
}

// --- DAILY QUOTE ---
function showDailyQuote() {
  var q = QUOTES[new Date().getDate() % QUOTES.length];
  document.getElementById('daily-quote').innerHTML =
    '"' + q.text + '"<div style="font-size:0.7rem; color:var(--tm); margin-top:6px;">-- ' + q.source + '</div>';
}

// --- TOAST ---
function toast(msg) {
  var t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(function() { t.classList.remove('show'); }, 2000);
}


// --- JOURNAL DATA ---
var journalEntries = JSON.parse(localStorage.getItem('na_journal') || '[]');
var currentJournalId = null;
var currentJournalType = null;

var JOURNAL_TYPES = {
  gratitude: { title: 'Gratitude List', emoji: '&#x1F64F;' },
  spotcheck: { title: 'Spot Check Inventory', emoji: '&#x26A1;' },
  step10:    { title: 'Full Step 10 Inventory', emoji: '&#x1F4CB;' },
  daily:     { title: 'Daily Journal', emoji: '&#x270D;' }
};

var GRATITUDE_PROMPTS = [
  "What's something small that made you smile today?",
  "Who has shown up for you recently, however small?",
  "What's one thing about your body you're grateful for?",
  "Name something you often take for granted.",
  "What's a quality in yourself you appreciate?",
  "Describe a moment of peace you felt recently.",
  "What does having another clean day mean to you?",
  "Who in recovery are you grateful for, and why?",
  "What's something in your home or surroundings you appreciate?",
  "Write about a challenge that helped you grow."
];

var SPOTCHECK_PROMPTS = [
  "Have I been resentful, selfish, dishonest or afraid today?",
  "Do I owe an apology to anyone?",
  "Have I kept something to myself that I should share with my sponsor?",
  "Was I kind and loving to those around me?",
  "Am I HALT right now â€” Hungry, Angry, Lonely, or Tired?",
  "Did I stay in the present, or was I in yesterday or tomorrow?",
  "What do I need to let go of before I sleep?",
  "Did I do anything today I'm proud of?"
];

var STEP10_QUESTIONS = [
  "Have I taken time today to reconnect with my Higher Power?",
  "Did I seek spiritual guidance today, and if so, how?",
  "How have I been of service to others today?",
  "What am I grateful for that my Higher Power has given me today?",
  "Do I trust that my Higher Power can guide me toward a better way of living?",
  "Have any old patterns or behaviours shown up for me today?",
  "Have I been resentful, selfish, dishonest, or afraid at any point today?",
  "Did I set myself up for disappointment or unrealistic expectations?",
  "Was I kind and loving in my interactions with others today?",
  "Have I been living in the past or the future rather than the present?",
  "Did I allow myself to become obsessed or fixated on anything today?",
  "Have I let myself get too hungry, angry, lonely, or tired today?",
  "Am I taking myself or any situation too seriously right now?",
  "Are there any physical, mental, or spiritual struggles I need to address?",
  "Is there anything I've been keeping from my sponsor that I should share?",
  "Did I experience any intense or overwhelming feelings today â€” what caused them?",
  "What areas of my life are causing me difficulty right now?",
  "Which character defects showed up in my behaviour today, and how?",
  "Did fear play a role in any of my actions or thoughts today?",
  "Is there anything I did today that I regret or wish I had handled differently?",
  "Is there anything I didn't do today that I know I should have?",
  "Am I genuinely open and willing to change?",
  "Was there conflict in any of my relationships today â€” what happened?",
  "Am I living with integrity in how I treat the people around me?",
  "Did I cause harm â€” directly or indirectly â€” to myself or anyone else today?",
  "Do I owe an apology or amends to anyone?",
  "Where did I go wrong today, and what would I do differently next time?",
  "Did I stay clean today?",
  "Was I compassionate and caring toward myself today?",
  "What feelings did I experience today, and how did I let them guide my choices?",
  "What did I do today to be of service to another person?",
  "What am I feeling good or positive about from today?",
  "What gave me a sense of meaning or satisfaction today?",
  "What did I do today that I want to make sure I repeat?",
  "Did I connect with the fellowship today â€” a meeting, a phone call, a message?",
  "What do I have to be grateful for today?"
];

var DAILY_PROMPTS = [
  "How am I feeling right now â€” honestly?",
  "What was the most important moment of my day?",
  "Did anything challenge me today? How did I respond?",
  "Was there a moment today I'm proud of?",
  "What emotions came up for me today, and what triggered them?",
  "Did I show up the way I wanted to today?",
  "What do I want to carry into tomorrow?",
  "How did my relationships feel today?",
  "What is something I need to let go of?",
  "What would I do differently if I could?"
];

function openJournal(type) {
  currentJournalId = null;
  currentJournalType = type;
  var info = JOURNAL_TYPES[type];
  document.getElementById('j-home').style.display = 'none';
  document.getElementById('j-write').style.display = 'block';
  document.getElementById('j-write-title').innerHTML = info.emoji + ' ' + info.title;
  document.getElementById('j-write-date').textContent = new Date().toLocaleDateString('en-GB', {weekday:'long', day:'numeric', month:'long', year:'numeric'});
  document.getElementById('j-text').value = '';
  document.getElementById('j-delete-btn').style.display = 'none';
  renderJournalPrompts(type);
  document.getElementById('j-text').focus();
}

function renderJournalPrompts(type) {
  var area = document.getElementById('j-prompts');
  var html = '<div style="background:rgba(232,201,122,0.07);border:1px solid rgba(232,201,122,0.18);border-radius:14px;padding:14px;margin-bottom:12px;">';

  if (type === 'gratitude') {
    var prompts = GRATITUDE_PROMPTS.slice().sort(function(){return Math.random()-.5;}).slice(0,3);
    html += '<div style="font-size:0.68rem;font-weight:800;color:var(--ac);text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px;">&#x1F64F; Prompts to get you started</div>';
    html += '<div style="font-size:0.74rem;color:var(--tm);margin-bottom:8px;font-style:italic;">Use one, some, or all â€” or just write freely.</div>';
    prompts.forEach(function(p, i) {
      html += '<div style="padding:7px 0;' + (i < prompts.length-1 ? 'border-bottom:1px solid var(--bd);' : '') + 'font-size:0.8rem;color:var(--tx);">&#x2022; ' + p + '</div>';
    });
    html += '<button onclick="renderJournalPrompts(\'gratitude\')" style="margin-top:10px;background:none;border:1px solid var(--bd);border-radius:8px;padding:5px 12px;font-size:0.7rem;color:var(--tm);cursor:pointer;">&#8635; New prompts</button>';

  } else if (type === 'spotcheck') {
    html += '<div style="font-size:0.68rem;font-weight:800;color:var(--ac);text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px;">&#x26A1; Spot Check â€” pause and be honest</div>';
    html += '<div style="font-size:0.74rem;color:var(--tm);margin-bottom:10px;font-style:italic;">Sit with these questions, then write freely below.</div>';
    SPOTCHECK_PROMPTS.forEach(function(p, i) {
      html += '<div style="padding:6px 0;' + (i < SPOTCHECK_PROMPTS.length-1 ? 'border-bottom:1px solid var(--bd);' : '') + 'font-size:0.78rem;color:var(--tm);">&#x2022; ' + p + '</div>';
    });

  } else if (type === 'step10') {
    html += '<div style="font-size:0.68rem;font-weight:800;color:var(--ac);text-transform:uppercase;letter-spacing:.06em;margin-bottom:6px;">&#x1F4CB; Full Step 10 â€” work through each question</div>';
    STEP10_QUESTIONS.forEach(function(p, i) {
      html += '<div style="padding:7px 0;' + (i < STEP10_QUESTIONS.length-1 ? 'border-bottom:1px solid var(--bd);' : '') + 'font-size:0.8rem;color:var(--tx);"><span style="color:var(--ac);font-weight:700;">' + (i+1) + '.</span> ' + p + '</div>';
    });

  } else if (type === 'daily') {
    var prompts = DAILY_PROMPTS.slice().sort(function(){return Math.random()-.5;}).slice(0,3);
    html += '<div style="font-size:0.68rem;font-weight:800;color:var(--ac);text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px;">&#x270D; Prompts for today</div>';
    html += '<div style="font-size:0.74rem;color:var(--tm);margin-bottom:8px;font-style:italic;">Write freely â€” these are just here to help you start.</div>';
    prompts.forEach(function(p, i) {
      html += '<div style="padding:7px 0;' + (i < prompts.length-1 ? 'border-bottom:1px solid var(--bd);' : '') + 'font-size:0.8rem;color:var(--tx);">&#x2022; ' + p + '</div>';
    });
    html += '<button onclick="renderJournalPrompts(\'daily\')" style="margin-top:10px;background:none;border:1px solid var(--bd);border-radius:8px;padding:5px 12px;font-size:0.7rem;color:var(--tm);cursor:pointer;">&#8635; New prompts</button>';
  }

  html += '</div>';
  area.innerHTML = html;
}


function usePrompt(prompt) {
  var ta = document.getElementById('j-text');
  if (!ta.value.trim()) {
    ta.value = prompt + '\n\n';
  } else {
    ta.value += '\n\n' + prompt + '\n\n';
  }
  ta.focus();
  ta.setSelectionRange(ta.value.length, ta.value.length);
}
function saveJournal() {
  var text = document.getElementById('j-text').value.trim();
  if (!text) { alert('Please write something first.'); return; }
  if (currentJournalId) {
    var idx = journalEntries.findIndex(function(e){ return e.id === currentJournalId; });
    if (idx > -1) { journalEntries[idx].text = text; }
  } else {
    journalEntries.push({ id: Date.now().toString(), date: new Date().toISOString(), type: currentJournalType, text: text });
  }
  localStorage.setItem('na_journal', JSON.stringify(journalEntries));
  toast('Entry saved \u2713');
  closeJournal();
}

function deleteJournal() {
  if (!currentJournalId) return;
  journalEntries = journalEntries.filter(function(e){ return e.id !== currentJournalId; });
  localStorage.setItem('na_journal', JSON.stringify(journalEntries));
  closeJournal();
}

function closeJournal() {
  document.getElementById('j-write').style.display = 'none';
  document.getElementById('j-home').style.display = 'block';
  renderJournalEntries();
}

function openJournalEntry(id) {
  var entry = journalEntries.find(function(e){ return e.id === id; });
  if (!entry) return;
  currentJournalId = id;
  currentJournalType = entry.type || 'daily';
  var info = JOURNAL_TYPES[currentJournalType] || JOURNAL_TYPES.daily;
  document.getElementById('j-home').style.display = 'none';
  document.getElementById('j-write').style.display = 'block';
  document.getElementById('j-write-title').innerHTML = info.emoji + ' ' + info.title;
  document.getElementById('j-write-date').textContent = new Date(entry.date).toLocaleDateString('en-GB', {weekday:'long', day:'numeric', month:'long', year:'numeric'});
  document.getElementById('j-text').value = entry.text;
  document.getElementById('j-delete-btn').style.display = 'block';
  renderJournalPrompts(currentJournalType);
}

function renderJournalEntries() {
  var c = document.getElementById('j-entries');
  if (!journalEntries.length) {
    c.innerHTML = '<div style="text-align:center;padding:20px 0;font-size:0.8rem;color:var(--tm);">No entries yet â€” choose a type above to begin.</div>';
    return;
  }
  var emojis = { gratitude:'&#x1F64F;', spotcheck:'&#x26A1;', step10:'&#x1F4CB;', daily:'&#x270D;' };
  c.innerHTML = '';
  journalEntries.slice().reverse().forEach(function(e) {
    var dt = new Date(e.date).toLocaleDateString('en-GB', {weekday:'short', day:'numeric', month:'short'});
    var emoji = emojis[e.type] || '&#x270D;';
    var info = JOURNAL_TYPES[e.type] || JOURNAL_TYPES.daily;
    var preview = e.text.slice(0, 80) + (e.text.length > 80 ? '...' : '');

    // Wrapper holds card + red delete panel
    var wrap = document.createElement('div');
    wrap.className = 'j-entry-wrap';

    // Red delete panel behind
    var delPanel = document.createElement('div');
    delPanel.className = 'j-delete-reveal';
    delPanel.textContent = 'DELETE';
    (function(id, w, card) {
      delPanel.onclick = function() {
        journalEntries = journalEntries.filter(function(x) { return x.id !== id; });
        localStorage.setItem('na_journal', JSON.stringify(journalEntries));
        renderJournalEntries();
        toast('Entry deleted');
      };
    })(e.id, wrap);

    // Card on top
    var card = document.createElement('div');
    card.className = 'j-entry-card';
    card.style.background = 'var(--sf)';
    card.style.border = '1px solid var(--bd)';
    card.style.borderRadius = 'var(--r)';
    card.style.padding = '12px 14px';

    var topRow = document.createElement('div');
    topRow.style.cssText = 'display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;';

    var dateEl = document.createElement('div');
    dateEl.style.cssText = 'font-size:0.72rem;color:var(--tm);';
    dateEl.textContent = dt;

    var tag = document.createElement('div');
    tag.style.cssText = 'font-size:0.62rem;background:rgba(232,201,122,0.1);border:1px solid var(--bd);border-radius:20px;padding:2px 8px;color:var(--ac);';
    tag.innerHTML = emoji + ' ' + info.title;

    topRow.appendChild(dateEl);
    topRow.appendChild(tag);

    var previewEl = document.createElement('div');
    previewEl.style.cssText = 'font-size:0.78rem;color:var(--tx);';
    previewEl.textContent = preview;

    card.appendChild(topRow);
    card.appendChild(previewEl);

    // Swipe logic
    var startX = 0;
    var startY = 0;
    var swiped = false;

    card.addEventListener('touchstart', function(ev) {
      startX = ev.touches[0].clientX;
      startY = ev.touches[0].clientY;
      swiped = false;
    }, {passive: true});

    card.addEventListener('touchmove', function(ev) {
      var dx = ev.touches[0].clientX - startX;
      var dy = ev.touches[0].clientY - startY;
      if (Math.abs(dy) > Math.abs(dx)) return; // vertical scroll
      if (dx < 0) {
        var x = Math.max(dx, -80);
        card.style.transition = 'none';
        card.style.transform = 'translateX(' + x + 'px)';
        swiped = true;
      } else if (dx > 0 && swiped) {
        card.style.transition = 'none';
        card.style.transform = 'translateX(0)';
      }
    }, {passive: true});

    card.addEventListener('touchend', function(ev) {
      var dx = ev.changedTouches[0].clientX - startX;
      card.style.transition = 'transform 0.2s ease';
      if (dx < -50) {
        card.style.transform = 'translateX(-80px)';
        swiped = true;
      } else {
        card.style.transform = 'translateX(0)';
        swiped = false;
        // Only open if it was a tap not a swipe
        if (Math.abs(dx) < 10) {
          (function(id){ openJournalEntry(id); })(e.id);
        }
      }
    });

    // Click to open on desktop
    card.addEventListener('click', function(ev) {
      if (!swiped) {
        (function(id){ openJournalEntry(id); })(e.id);
      }
    });

    wrap.appendChild(delPanel);
    wrap.appendChild(card);
    c.appendChild(wrap);
  });
}


// =====================
// NETWORK
// =====================
var networkContacts = JSON.parse(localStorage.getItem('na_network') || '[]');
var editingContactId = null;
var selectedRole = '';

var ROLE_EMOJIS = {
  'Sponsor': 'ğŸ’›',
  'Sponsee': 'ğŸŒ±',
  'Sponsor Sister': 'ğŸ’œ',
  'Sponsor Brother': 'ğŸ’™',
  'Friend in Recovery': 'ğŸ¤'
};

function openAddContact() {
  editingContactId = null;
  selectedRole = '';
  document.getElementById('contact-modal-title').textContent = 'Add Contact';
  document.getElementById('cn-name').value = '';
  document.getElementById('cn-phone').value = '';
  document.getElementById('cn-whatsapp').value = '';
  document.getElementById('cn-location').value = '';
  document.getElementById('cn-cleandate').value = '';
  document.querySelectorAll('.role-btn').forEach(function(b){ b.classList.remove('selected'); });
  document.getElementById('cn-delete-wrap').style.display = 'none';
  document.getElementById('contact-modal').classList.add('open');
}

function openEditContact(id) {
  var c = networkContacts.find(function(x){ return x.id === id; });
  if (!c) return;
  editingContactId = id;
  selectedRole = c.role || '';
  document.getElementById('contact-modal-title').textContent = 'Edit Contact';
  document.getElementById('cn-name').value = c.name || '';
  document.getElementById('cn-phone').value = c.phone || '';
  document.getElementById('cn-whatsapp').value = c.whatsapp || '';
  document.getElementById('cn-location').value = c.location || '';
  document.getElementById('cn-cleandate').value = c.cleandate || '';
  document.querySelectorAll('.role-btn').forEach(function(b){
    b.classList.remove('selected');
    if (b.textContent.trim().includes(selectedRole)) b.classList.add('selected');
  });
  document.getElementById('cn-delete-wrap').style.display = 'block';
  document.getElementById('contact-modal').classList.add('open');
}

function selectRole(btn, role) {
  selectedRole = role;
  document.querySelectorAll('.role-btn').forEach(function(b){ b.classList.remove('selected'); });
  btn.classList.add('selected');
}

function saveContact() {
  var name = document.getElementById('cn-name').value.trim();
  if (!name) { alert('Please enter a name.'); return; }
  var contact = {
    id: editingContactId || Date.now().toString(),
    name: name,
    role: selectedRole,
    phone: document.getElementById('cn-phone').value.trim(),
    whatsapp: document.getElementById('cn-whatsapp').value.trim(),
    location: document.getElementById('cn-location').value.trim(),
    cleandate: document.getElementById('cn-cleandate').value
  };
  if (editingContactId) {
    var idx = networkContacts.findIndex(function(x){ return x.id === editingContactId; });
    if (idx > -1) networkContacts[idx] = contact;
  } else {
    networkContacts.push(contact);
  }
  localStorage.setItem('na_network', JSON.stringify(networkContacts));
  closeContactModalDirect();
  renderNetwork();
  toast('Contact saved âœ“');
}

function deleteContact() {
  if (!editingContactId) return;
  networkContacts = networkContacts.filter(function(x){ return x.id !== editingContactId; });
  localStorage.setItem('na_network', JSON.stringify(networkContacts));
  closeContactModalDirect();
  renderNetwork();
  toast('Contact removed');
}

function closeContactModal(event) {
  document.getElementById('contact-modal').classList.remove('open');
}
function closeContactModalDirect() {
  document.getElementById('contact-modal').classList.remove('open');
}

function calcCleanTime(dateStr) {
  if (!dateStr) return null;
  var start = new Date(dateStr);
  var now = new Date();
  var days = Math.floor((now - start) / 86400000);
  if (days < 0) return null;
  if (days < 30) return days + (days === 1 ? ' day' : ' days') + ' clean';
  var months = Math.floor(days / 30.4375);
  if (months < 12) return months + (months === 1 ? ' month' : ' months') + ' clean';
  var years = Math.floor(days / 365.25);
  var remMonths = Math.floor((days % 365.25) / 30.4375);
  var str = years + (years === 1 ? ' year' : ' years');
  if (remMonths > 0) str += ' ' + remMonths + (remMonths === 1 ? ' month' : ' months');
  return str + ' clean';
}

function openMaps(location) {
  var encoded = encodeURIComponent(location);
  // Try Apple Maps first on iOS, fallback to Google Maps
  var ua = navigator.userAgent;
  if (/iPhone|iPad|iPod/.test(ua)) {
    window.open('https://maps.apple.com/?q=' + encoded, '_blank');
  } else {
    window.open('https://www.google.com/maps/search/' + encoded, '_blank');
  }
}

function renderNetwork() {
  var list = document.getElementById('net-list');
  var empty = document.getElementById('net-empty');
  if (!networkContacts.length) {
    list.innerHTML = '';
    empty.style.display = 'block';
    return;
  }
  empty.style.display = 'none';
  list.innerHTML = '';
  networkContacts.forEach(function(c) {
    var emoji = ROLE_EMOJIS[c.role] || 'ğŸ‘¤';
    var cleanTime = c.cleandate ? calcCleanTime(c.cleandate) : null;
    var phoneNum = c.whatsapp || c.phone;
    var waNum = (c.whatsapp || c.phone).replace(/\D/g, '');

    var div = document.createElement('div');
    div.className = 'net-card';
    div.innerHTML =
      '<div class="net-card-header">' +
        '<div class="net-avatar">' + emoji + '</div>' +
        '<div class="net-info">' +
          '<div class="net-name">' + c.name + '</div>' +
          (c.role ? '<div class="net-role">' + c.role + '</div>' : '') +
          (cleanTime ? '<div class="net-clean">â³ ' + cleanTime + '</div>' : '') +
          (c.location ? '<div class="net-location">ğŸ“ ' + c.location + '</div>' : '') +
        '</div>' +
        '<button onclick="openEditContact(\'' + c.id + '\')" style="background:transparent;border:none;color:var(--tm);font-size:1rem;cursor:pointer;padding:4px;">âœï¸</button>' +
      '</div>' +
      '<div class="net-actions">' +
        (c.phone ? '<a href="tel:' + c.phone.replace(/\s/g,'') + '" class="net-action-btn"><span class="net-action-icon">ğŸ“</span>Call</a>' : '') +
        (waNum ? '<a href="https://wa.me/' + waNum + '" target="_blank" class="net-action-btn"><span class="net-action-icon">ğŸ’¬</span>WhatsApp</a>' : '') +
        (c.location ? '<div class="net-action-btn" onclick="openMaps(\'' + c.location.replace(/'/g,"\\'") + '\')"><span class="net-action-icon">ğŸ—ºï¸</span>Map</div>' : '') +
      '</div>';
    list.appendChild(div);
  });
  geocodeAndPlot();
}

// =====================
// JOURNAL EXPORT
// =====================
var exportType = null;
var exportText = '';

function showExportPicker() {
  var types = ['gratitude','spotcheck','step10','daily'];
  var names = { gratitude:'Gratitude List', spotcheck:'Spot Check', step10:'Full Step 10', daily:'Daily Journal' };
  var html = '';
  types.forEach(function(t) {
    var count = journalEntries.filter(function(e){ return e.type === t; }).length;
    html += '<div onclick="doExport(\'' + t + '\')" style="display:flex;align-items:center;justify-content:space-between;background:var(--sf2);border:1px solid var(--bd);border-radius:12px;padding:13px 16px;margin-bottom:8px;cursor:pointer;">' +
      '<span style="font-size:0.86rem;">' + names[t] + '</span>' +
      '<span style="font-size:0.72rem;color:var(--tm);">' + count + ' ' + (count === 1 ? 'entry' : 'entries') + ' â€º</span>' +
    '</div>';
  });
  document.getElementById('export-type-list').innerHTML = html;
  document.getElementById('export-picker-view').style.display = 'block';
  document.getElementById('export-send-view').style.display = 'none';
  document.getElementById('export-modal').classList.add('open');
}

function doExport(type) {
  var names = { gratitude:'Gratitude List', spotcheck:'Spot Check Inventory', step10:'Full Step 10 Inventory', daily:'Daily Journal' };
  var entries = journalEntries.filter(function(e){ return e.type === type; });
  if (!entries.length) { toast('No entries for this journal'); return; }
  exportType = type;
  var lines = 'NA Recovery App â€” ' + names[type] + '\n';
  lines += 'Exported: ' + new Date().toLocaleDateString('en-GB', {weekday:'long',day:'numeric',month:'long',year:'numeric'}) + '\n';
  lines += 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n';
  entries.slice().reverse().forEach(function(e, i) {
    var dt = new Date(e.date);
    var dateStr = dt.toLocaleDateString('en-GB', {weekday:'long',day:'numeric',month:'long',year:'numeric'});
    var timeStr = dt.toLocaleTimeString('en-GB', {hour:'2-digit',minute:'2-digit'});
    lines += 'ğŸ“ Entry ' + (i+1) + ' â€” ' + dateStr + ' at ' + timeStr + '\n';
    lines += e.text + '\n\n';
  });
  exportText = lines;
  document.getElementById('export-send-title').textContent = names[type] + ' â€” ' + entries.length + (entries.length === 1 ? ' entry' : ' entries');
  document.getElementById('export-preview').textContent = lines;
  document.getElementById('export-picker-view').style.display = 'none';
  document.getElementById('export-send-view').style.display = 'block';
}

function exportEmail() {
  var names = { gratitude:'Gratitude List', spotcheck:'Spot Check', step10:'Step 10 Inventory', daily:'Daily Journal' };
  var subject = 'NA Recovery â€” ' + (names[exportType] || 'Journal') + ' Export';
  window.location.href = 'mailto:?subject=' + encodeURIComponent(subject) + '&body=' + encodeURIComponent(exportText);
}

function exportCopy() {
  if (navigator.clipboard) {
    navigator.clipboard.writeText(exportText).then(function(){ toast('Copied to clipboard âœ“'); closeExportModalDirect(); });
  } else {
    var ta = document.createElement('textarea');
    ta.value = exportText;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
    toast('Copied to clipboard âœ“');
    closeExportModalDirect();
  }
}

function closeExportModalDirect() {
  document.getElementById('export-modal').classList.remove('open');
}

// Update init to include network
function init() {
  if (cleanDate) {
    document.getElementById('clean-date-input').value = cleanDate;
    updateDaysCount();
  }
  markTodayMood();
  renderMoodHistory();
  showDailyQuote();
  renderJournalEntries();
  renderNetwork();
}

init();



function toggleBook(header) {
  const card = header.parentElement;
  card.classList.toggle('open');
}

// =====================
// SPLASH SCREEN
// =====================
(function() {
  var splash = document.getElementById('splash');
  var dismissed = false;

  function calcSplashTime() {
    var cd = localStorage.getItem('na_clean_date');
    if (!cd) return { years:0, months:0, weeks:0 };
    var start = new Date(cd);
    var now = new Date();
    var totalDays = Math.floor((now - start) / 86400000);
    if (totalDays < 0) return { years:0, months:0, weeks:0 };
    var years = Math.floor(totalDays / 365.25);
    var remDays = totalDays - Math.floor(years * 365.25);
    var months = Math.floor(remDays / 30.4375);
    remDays = remDays - Math.floor(months * 30.4375);
    var weeks = Math.floor(remDays / 7);
    return { years:years, months:months, weeks:weeks };
  }

  function dismissSplash() {
    if (dismissed) return;
    dismissed = true;
    splash.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
    splash.style.opacity = '0';
    splash.style.transform = 'translateY(-30px)';
    setTimeout(function(){ splash.style.display = 'none'; }, 500);
  }

  // Swipe up gesture
  var touchStartY = 0;
  splash.addEventListener('touchstart', function(e){ touchStartY = e.touches[0].clientY; }, {passive:true});
  splash.addEventListener('touchend', function(e){
    var dy = touchStartY - e.changedTouches[0].clientY;
    if (dy > 40) dismissSplash();
  }, {passive:true});

  // Also tap to dismiss
  splash.addEventListener('click', dismissSplash);

  // Fade in background
  setTimeout(function(){
    document.getElementById('splash-bg').style.opacity = '1';
  }, 100);

  // Set counter
  var t = calcSplashTime();
  document.getElementById('splash-years').textContent = t.years;
  document.getElementById('splash-months').textContent = t.months;
  document.getElementById('splash-weeks').textContent = t.weeks;

  // Set quote
  var splashQuotes = [
    '"Just for today, I will try to live through this day only."',
    '"We do not have to be alone anymore."',
    '"Recovery is a process, not an event."',
    '"Keep coming back â€” it works if you work it."',
    '"One day at a time."'
  ];
  document.getElementById('splash-quote').textContent = splashQuotes[new Date().getDate() % splashQuotes.length];

  // Auto-dismiss after 6 seconds
  setTimeout(dismissSplash, 6000);
})();

// =====================
// NETWORK MAP
// =====================
var netMap = null;
var netMapMarkers = [];
var geocodeCache = {};

function pinColour(role) {
  if (role === 'Sponsor') return '#e74c3c';
  if (role === 'Sponsee' || role === 'Sponsor Sister' || role === 'Sponsor Brother') return '#2ecc71';
  return '#f1c40f';
}

function makeIcon(colour) {
  var svg = encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="36" viewBox="0 0 24 36"><path d="M12 0C5.37 0 0 5.37 0 12c0 9 12 24 12 24s12-15 12-24C24 5.37 18.63 0 12 0z" fill="' + colour + '"/><circle cx="12" cy="12" r="5" fill="white" opacity="0.9"/></svg>');
  return L.divIcon({
    html: '<img src="data:image/svg+xml,' + svg + '" width="24" height="36">',
    className: '',
    iconSize: [24, 36],
    iconAnchor: [12, 36],
    popupAnchor: [0, -38]
  });
}

function initNetMap() {
  if (netMap) return;
  if (typeof L === 'undefined') return;
  var el = document.getElementById('net-map');
  if (!el) return;
  netMap = L.map('net-map', { zoomControl: true, attributionControl: false });
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
    maxZoom: 19,
    crossOrigin: true
  }).addTo(netMap);
  netMap.setView([54.5, -2], 5);
}

function geocodeAndPlot() {
  if (typeof L === 'undefined') return;
  initNetMap();
  if (!netMap) return;
  netMap.invalidateSize();

  // Clear old markers
  netMapMarkers.forEach(function(m){ netMap.removeLayer(m); });
  netMapMarkers = [];

  var contactsWithLocation = networkContacts.filter(function(c){ return c.location; });
  if (!contactsWithLocation.length) {
    // Show a default view centred on UK
    netMap.setView([54.5, -2], 5);
    return;
  }

  var bounds = [];
  var pending = contactsWithLocation.length;

  contactsWithLocation.forEach(function(c) {
    var loc = c.location.trim();
    var cleanTime = c.cleandate ? calcCleanTime(c.cleandate) : null;
    var popupHtml = '<div style="font-family:sans-serif;min-width:120px;"><div style="font-weight:700;font-size:0.9rem;margin-bottom:2px;">' + c.name + '</div><div style="font-size:0.72rem;color:#888;">' + c.role + '</div>' + (cleanTime ? '<div style="font-size:0.72rem;color:#aaa;margin-top:3px;">â³ ' + cleanTime + '</div>' : '') + '</div>';

    function placeMarker(lat, lng) {
      var marker = L.marker([lat, lng], { icon: makeIcon(pinColour(c.role)) })
        .addTo(netMap)
        .bindPopup(popupHtml, { closeButton: false, className: 'net-popup' });
      netMapMarkers.push(marker);
      bounds.push([lat, lng]);
      pending--;
      if (pending === 0 && bounds.length) {
        if (bounds.length === 1) { netMap.setView(bounds[0], 9); }
        else { netMap.fitBounds(bounds, { padding: [30, 30] }); }
        netMap.invalidateSize();
      }
    }

    if (geocodeCache[loc]) {
      placeMarker(geocodeCache[loc].lat, geocodeCache[loc].lng);
    } else {
      fetch('https://nominatim.openstreetmap.org/search?format=json&limit=1&q=' + encodeURIComponent(loc))
        .then(function(r){ return r.json(); })
        .then(function(data) {
          if (data && data.length) {
            var lat = parseFloat(data[0].lat), lng = parseFloat(data[0].lon);
            geocodeCache[loc] = { lat: lat, lng: lng };
            placeMarker(lat, lng);
          } else { pending--; }
        })
        .catch(function(){ pending--; });
    }
  });
}

</script>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

<script>
// Init map as soon as Leaflet is ready - but only if network screen is active
window.addEventListener('load', function() {
  if (typeof L !== 'undefined') {
    setTimeout(function() {
      initNetMap();
      if (netMap) {
        netMap.invalidateSize();
        netMap.setView([54.5, -2], 5);
      }
    }, 300);
  }
});
</script>

</body>
</html>

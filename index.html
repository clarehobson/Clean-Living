<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Clean Living">
<meta name="theme-color" content="#0f0f1a">
<title>Clean Living</title>
<meta name="app-version" content="2.1.0">
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;600&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0f0f1a;
  --sf: #1a1a2e;
  --sf2: #16213e;
  --ac: #e8c97a;
  --tx: #f0ead6;
  --tm: #8a8090;
  --bd: rgba(232,201,122,0.15);
  --r: 16px;
}
a { color: inherit; text-decoration: none; -webkit-text-fill-color: inherit; }
* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
html, body { height: 100%; height: 100dvh; }
body { font-family: "DM Sans", sans-serif; background: var(--bg); color: var(--tx); overflow: hidden; }
#app { display: flex; flex-direction: column; height: 100%; height: 100dvh; }
/* SCREENS */
.screen { display: none; flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; padding: 20px 16px 24px; }
.screen.active { display: block; }
/* NAV */
nav {
  flex-shrink: 0;
  display: flex;
  background: rgba(15,15,26,0.97);
  border-top: 1px solid var(--bd);
  padding-bottom: env(safe-area-inset-bottom, 0);
}
.nav-item {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 2px;
  padding: 8px 1px 6px;
  cursor: pointer;
  color: var(--tm);
  font-size: 0.38rem;
  letter-spacing: 0.03em;
  text-transform: uppercase;
  -webkit-user-select: none;
  user-select: none;
}
.nav-item.active { color: var(--ac); }
.nav-icon { font-size: 1.1rem; line-height: 1; }
/* CARDS */
.card {
  background: var(--sf);
  border: 1px solid rgba(232,201,122,0.35);
  border-radius: var(--r);
  padding: 16px;
  margin-bottom: 10px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.25);
}
.label {
  font-size: 0.62rem;
  font-weight: 800;
  color: var(--ac);
  text-transform: uppercase;
  letter-spacing: 0.08em;
  margin-bottom: 8px;
}
.btn {
  width: 100%;
  padding: 13px;
  border: none;
  border-radius: var(--r);
  background: var(--ac);
  color: #1a1208;
  font-size: 0.86rem;
  font-weight: 700;
  cursor: pointer;
  margin-top: 8px;
}
.input {
  width: 100%;
  background: var(--sf2);
  border: 1px solid var(--bd);
  border-radius: 10px;
  color: var(--tx);
  font-size: 0.84rem;
  padding: 10px 12px;
  outline: none;
}
.input:focus { border-color: var(--ac); }
/* MOOD BUTTONS */
.mood-row { display: flex; gap: 6px; }
.mood-btn {
  flex: 1;
  background: var(--sf);
  border: 1px solid var(--bd);
  border-radius: 12px;
  padding: 10px 4px;
  cursor: pointer;
  text-align: center;
}
.mood-btn.selected { border-color: var(--ac); background: rgba(232,201,122,0.1); }
.mood-emoji { font-size: 1.3rem; }
.mood-label { font-size: 0.56rem; color: var(--tm); margin-top: 3px; }
.step-card {
  display: flex;
  align-items: center;
  gap: 14px;
  background: var(--sf);
  border: 1px solid var(--bd);
  border-radius: var(--r);
  padding: 14px 16px;
  margin-bottom: 8px;
  text-decoration: none;
  color: var(--tx);
}
.step-num {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  border: 1px solid var(--ac);
  background: rgba(232,201,122,0.08);
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: 'Cormorant Garamond', serif;
  font-size: 1rem;
  font-weight: 400;
  color: var(--ac);
  flex-shrink: 0;
}
.step-body { flex: 1; min-width: 0; }
.step-title { font-size: 0.86rem; font-weight: 600; color: var(--tx); }
.step-sub { font-size: 0.7rem; color: var(--tm); margin-top: 2px; }
.step-arrow { color: var(--tm); font-size: 0.9rem; }
.bt-ch {
  display: flex;
  flex-direction: column;
  gap: 5px;
  padding: 9px 0;
  border-bottom: 1px solid var(--bd);
}
.bt-ch:last-child { border-bottom: none; }
.bt-ch span { font-size: 0.78rem; font-weight: 600; color: var(--tx); }
.bt-ch audio { width: 100%; height: 32px; }
.j-type-card {
  display: flex;
  align-items: center;
  gap: 14px;
  background: var(--sf);
  border: 1px solid rgba(232,201,122,0.35);
  border-radius: var(--r);
  padding: 16px 18px;
  margin-bottom: 10px;
  cursor: pointer;
  box-shadow: 0 2px 8px rgba(0,0,0,0.25);
  transition: background 0.15s;
}
.j-type-card:active { background: var(--sf2); }
.j-entry-card {
  background: var(--sf);
  border: 1px solid var(--bd);
  border-radius: var(--r);
  padding: 12px 14px;
  margin-bottom: 8px;
  cursor: pointer;
}
.j-entry-card:active { background: var(--sf2); }
.j-entry-wrap {
  position: relative;
  margin-bottom: 8px;
  overflow: hidden;
  border-radius: var(--r);
}
.j-delete-reveal {
  position: absolute;
  right: 0;
  top: 0;
  bottom: 0;
  width: 80px;
  background: #c0392b;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 0.75rem;
  font-weight: 700;
  letter-spacing: 0.05em;
  cursor: pointer;
}
.j-entry-card {
  position: relative;
  transform: translateX(0);
  transition: transform 0.2s ease;
  cursor: pointer;
  touch-action: pan-y;
}
.book-card {
  display: flex;
  align-items: center;
  gap: 12px;
  background: var(--sf);
  border: 1px solid rgba(232,201,122,0.35);
  border-radius: var(--r);
  padding: 12px 14px;
  margin-bottom: 6px;
  text-decoration: none;
  color: var(--tx);
  box-shadow: 0 2px 8px rgba(0,0,0,0.25);
}
.book-card * { color: inherit; text-decoration: none; }
.book-sub { font-size: 0.68rem; color: var(--tm) !important; margin-top: 2px; }
.book-card:active { background: var(--sf2); }
.book-icon { font-size: 1.2rem; flex-shrink: 0; }
.book-body { flex: 1; min-width: 0; }
.book-title { font-size: 0.84rem; font-weight: 600; color: var(--tx) !important; -webkit-text-fill-color: var(--tx) !important; }
.book-arr { color: var(--tm); font-size: 0.9rem; flex-shrink: 0; }
.book-expand-card {
  background: var(--sf);
  border: 1px solid rgba(232,201,122,0.35);
  border-radius: var(--r);
  margin-bottom: 10px;
  overflow: hidden;
}
.book-expand-header {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 13px 14px;
  cursor: pointer;
}
.book-expand-header:active { background: var(--sf2); }
.book-expand-chevron {
  color: var(--tm);
  font-size: 0.75rem;
  margin-left: auto;
  transition: transform 0.2s;
  flex-shrink: 0;
}
.book-expand-card.open .book-expand-chevron { transform: rotate(90deg); }
.book-expand-body {
  display: none;
  padding: 0 14px 14px 14px;
  border-top: 1px solid var(--bd);
}
.book-expand-card.open .book-expand-body { display: block; }
.book-expand-section {
  font-size: 0.6rem;
  color: var(--tm);
  letter-spacing: 0.09em;
  text-transform: uppercase;
  margin: 12px 0 6px 0;
}
.book-buy-row {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
  margin-bottom: 4px;
}
.book-buy-btn {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  padding: 7px 11px;
  border-radius: 8px;
  font-size: 0.7rem;
  font-weight: 600;
  text-decoration: none;
  white-space: nowrap;
}
.book-buy-btn.apple { background: #1c1c1e; color: #fff; border: 1px solid #3a3a3c; }
.book-buy-btn.android { background: #1a3c27; color: #5fcf80; border: 1px solid #2d6b45; }
.book-buy-btn.hardcopy { background: #2a2418; color: var(--ac); border: 1px solid #4a3f28; }
.book-buy-btn:active { opacity: 0.75; }
.book-expand-card {
  background: var(--sf);
  border: 1px solid rgba(232,201,122,0.35);
  border-radius: var(--r);
  margin-bottom: 8px;
  overflow: hidden;
}
.book-card-header {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 13px 14px;
  cursor: pointer;
}
.book-card-header:active { background: var(--sf2); }
.book-chevron {
  color: var(--tm);
  font-size: 1.2rem;
  transition: transform 0.25s;
  flex-shrink: 0;
}
.book-expand-card.open .book-chevron { transform: rotate(90deg); }
.book-card-body {
  display: none;
  padding: 0 14px 14px 14px;
  border-top: 1px solid var(--bd);
}
.book-expand-card.open .book-card-body { display: block; }
.book-section-label {
  font-size: 0.68rem;
  color: var(--tm);
  letter-spacing: 0.06em;
  text-transform: uppercase;
  margin: 12px 0 7px;
}
.book-btn-row {
  display: flex;
  gap: 8px;
}
.buy-btn {
  display: block;
  text-align: center;
  padding: 9px 10px;
  border-radius: 8px;
  font-size: 0.75rem;
  font-weight: 600;
  text-decoration: none;
  margin-bottom: 6px;
}
.book-btn-row .buy-btn { flex: 1; margin-bottom: 0; }
.apple-btn  { background: #1c1c1e; color: #fff; border: 1px solid #3a3a3c; }
.google-btn { background: #1a73e8; color: #fff; }
.world-btn  { background: var(--sf2); color: var(--tx); border: 1px solid var(--bd); }
.uk-btn     { background: #012169; color: #fff; }
.eu-btn     { background: #003399; color: #ffd700; }
.meeting-card {
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: var(--sf);
  border: 1px solid rgba(232,201,122,0.35);
  border-radius: var(--r);
  padding: 13px 14px;
  margin-bottom: 8px;
  text-decoration: none;
  color: var(--tx);
  box-shadow: 0 2px 8px rgba(0,0,0,0.25);
}
.meeting-card * { color: inherit; text-decoration: none; }
.meeting-sub { font-size: 0.68rem; color: var(--tm) !important; margin-top: 2px; line-height: 1.4; }
.meeting-card:active { background: var(--sf2); }
.meeting-left {
  display: flex;
  align-items: center;
  gap: 12px;
}
.meeting-flag { font-size: 1.4rem; flex-shrink: 0; }
.meeting-title { font-size: 0.84rem; font-weight: 600; color: var(--tx) !important; -webkit-text-fill-color: var(--tx) !important; }
.meeting-arr { color: var(--tm); font-size: 1rem; flex-shrink: 0; margin-left: 8px; }
/* NETWORK */
.net-card {
  background: var(--sf);
  border: 1px solid rgba(232,201,122,0.3);
  border-radius: var(--r);
  padding: 14px 16px;
  margin-bottom: 12px;
}
.net-card-header {
  display: flex;
  align-items: center;
  gap: 12px;
}
.net-avatar {
  width: 44px;
  height: 44px;
  border-radius: 50%;
  background: rgba(232,201,122,0.12);
  border: 1px solid var(--bd);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.2rem;
  flex-shrink: 0;
}
.net-info { flex: 1; min-width: 0; }
.net-name { font-size: 0.9rem; font-weight: 700; color: var(--tx); }
.net-role { display: inline-block; font-size: 0.6rem; font-weight: 700; letter-spacing: 0.08em; color: var(--ac); background: rgba(232,201,122,0.12); border: 1px solid rgba(232,201,122,0.3); border-radius: 20px; padding: 2px 8px; margin-top: 4px; text-transform: uppercase; }
.net-clean { font-size: 0.66rem; color: var(--tm); margin-top: 2px; }
.net-location { font-size: 0.66rem; color: var(--tm); margin-top: 1px; }
.net-actions {
  display: flex;
  gap: 8px;
  margin-top: 12px;
  padding-top: 10px;
  border-top: 1px solid var(--bd);
}
.net-action-btn {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  padding: 8px 4px;
  background: var(--sf2);
  border: 1px solid var(--bd);
  border-radius: 10px;
  cursor: pointer;
  text-decoration: none;
  color: var(--tx);
  -webkit-text-fill-color: var(--tx);
  font-size: 0.6rem;
  text-align: center;
}
.net-action-btn:active { background: rgba(232,201,122,0.1); }
.net-action-icon { font-size: 1.1rem; }
/* MODAL */
.modal-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  z-index: 9000;
  align-items: flex-end;
}
.modal-overlay.open { display: flex; }
.modal-sheet {
  background: var(--sf);
  border-radius: 20px 20px 0 0;
  padding: 20px 16px 40px;
  width: 100%;
  max-height: 85vh;
  overflow-y: auto;
}
.modal-title {
  font-family: 'Cormorant Garamond', serif;
  font-size: 1.4rem;
  font-weight: 300;
  color: var(--ac);
  margin-bottom: 16px;
  text-align: center;
}
.modal-label {
  font-size: 0.62rem;
  font-weight: 800;
  color: var(--ac);
  text-transform: uppercase;
  letter-spacing: 0.08em;
  margin-bottom: 6px;
  margin-top: 14px;
}
.role-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 7px;
  margin-bottom: 4px;
}
.role-btn {
  padding: 9px 8px;
  border: 1px solid var(--bd);
  border-radius: 10px;
  background: var(--sf2);
  color: var(--tm);
  font-size: 0.74rem;
  cursor: pointer;
  text-align: center;
}
.role-btn.selected { border-color: var(--ac); color: var(--ac); background: rgba(232,201,122,0.1); }
/* EXPORT MODAL */
.export-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  z-index: 9000;
  align-items: flex-end;
}
.export-overlay.open { display: flex; }
/* NETWORK */
.net-card {
  background: var(--sf);
  border: 1px solid var(--bd);
  border-radius: var(--r);
  padding: 14px 16px;
  margin-bottom: 10px;
  position: relative;
}
.net-card-top {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 10px;
}
.net-avatar {
  width: 42px;
  height: 42px;
  border-radius: 50%;
  background: rgba(232,201,122,0.12);
  border: 1px solid var(--bd);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.2rem;
  flex-shrink: 0;
}
.net-name { font-size: 0.92rem; font-weight: 700; color: var(--tx); }
.net-role {
  display: inline-block;
  font-size: 0.6rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.07em;
  padding: 2px 8px;
  border-radius: 20px;
  margin-top: 3px;
  background: rgba(232,201,122,0.1);
  border: 1px solid rgba(232,201,122,0.25);
  color: var(--ac);
}
.net-met
.net-actions {
  display: flex;
  gap: 8px;
}
.net-btn {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  padding: 9px;
  border-radius: 10px;
  font-size: 0.74rem;
  font-weight: 600;
  text-decoration: none;
  border: none;
  cursor: pointer;
}
.net-btn.call { background: rgba(52,199,89,0.15); color: #34c759; border: 1px solid rgba(52,199,89,0.25); }
.net-btn.whatsapp { background: rgba(37,211,102,0.12); color: #25d366; border: 1px solid rgba(37,211,102,0.25); }
.net-delete-btn {
  position: absolute;
  top: 12px;
  right: 12px;
  background: none;
  border: none;
  color: var(--tm);
  font-size: 1rem;
  cursor: pointer;
  padding: 2px 6px;
  line-height: 1;
}
/* MODAL */
.modal-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  z-index: 500;
  align-items: flex-end;
  justify-content: center;
}
.modal-overlay.open { display: flex; }
.modal-box {
  background: var(--sf);
  border: 1px solid var(--bd);
  border-radius: 20px 20px 0 0;
  padding: 24px 18px 40px;
  width: 100%;
  max-width: 500px;
  max-height: 85vh;
  overflow-y: auto;
}
.modal-title {
  font-family: 'Cormorant Garamond', serif;
  font-size: 1.4rem;
  font-weight: 300;
  color: var(--ac);
  margin-bottom: 16px;
}
.modal-label {
  font-size: 0.68rem;
  font-weight: 700;
  color: var(--tm);
  text-transform: uppercase;
  letter-spacing: 0.07em;
  margin-bottom: 5px;
  margin-top: 12px;
}
.modal-select {
  width: 100%;
  background: var(--sf2);
  border: 1px solid var(--bd);
  border-radius: 10px;
  color: var(--tx);
  font-size: 0.84rem;
  padding: 10px 12px;
  outline: none;
  -webkit-appearance: none;
}
/* EXPORT MODAL */
.export-btn {
  display: flex;
  align-items: center;
  gap: 12px;
  background: var(--sf2);
  border: 1px solid var(--bd);
  border-radius: var(--r);
  padding: 14px 16px;
  margin-bottom: 10px;
  cursor: pointer;
  width: 100%;
  text-align: left;
  color: var(--tx);
}
.export-btn:active { opacity: 0.75; }
/* WELCOME SCREEN */
#welcome-screen {
  display: none;
  position: fixed;
  inset: 0;
  z-index: 10000;
  background: var(--bg);
  flex-direction: column;
  align-items: center;
  justify-content: flex-end;
  padding: 0 24px 48px;
}
#welcome-hero {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
  width: 100%;
}
.welcome-logo {
  font-family: 'Cormorant Garamond', serif;
  font-size: 2.8rem;
  font-weight: 300;
  color: var(--ac);
  margin-bottom: 6px;
}
.welcome-sub {
  font-size: 0.65rem;
  letter-spacing: 0.18em;
  text-transform: uppercase;
  color: var(--tm);
  margin-bottom: 40px;
}
.welcome-tagline {
  font-size: 0.9rem;
  color: var(--tx);
  line-height: 1.7;
  max-width: 280px;
  margin-bottom: 40px;
}
.welcome-btn-primary {
  width: 100%;
  padding: 16px;
  background: var(--ac);
  color: #1a1208;
  border: none;
  border-radius: var(--r);
  font-size: 0.92rem;
  font-weight: 700;
  cursor: pointer;
  margin-bottom: 12px;
}
.welcome-btn-secondary {
  width: 100%;
  padding: 15px;
  background: transparent;
  color: var(--tx);
  border: 1px solid rgba(232,201,122,0.35);
  border-radius: var(--r);
  font-size: 0.88rem;
  cursor: pointer;
  margin-bottom: 12px;
}
.welcome-btn-ghost {
  background: transparent;
  border: none;
  color: var(--tm);
  font-size: 0.75rem;
  cursor: pointer;
  padding: 8px;
}
#auth-form { display: none; width: 100%; }
.auth-back {
  background: transparent;
  border: none;
  color: var(--tm);
  font-size: 0.8rem;
  cursor: pointer;
  padding: 0;
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  gap: 4px;
}
/* EVENTS */
.ef-btn {
  padding: 7px 14px;
  border: 1px solid rgba(232,201,122,0.35);
  border-radius: 20px;
  background: var(--sf);
  color: var(--tm);
  font-size: 0.72rem;
  cursor: pointer;
  white-space: nowrap;
  flex-shrink: 0;
}
.ef-btn.ef-active {
  background: var(--ac);
  color: #1a1208;
  font-weight: 700;
  border-color: var(--ac);
}
.event-card {
  background: var(--sf);
  border: 1px solid rgba(232,201,122,0.35);
  border-radius: var(--r);
  margin-bottom: 12px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0,0,0,0.25);
  cursor: pointer;
}
.event-flyer {
  width: 100%;
  height: 160px;
  object-fit: cover;
  display: block;
}
.event-flyer-placeholder {
  width: 100%;
  height: 100px;
  background: linear-gradient(135deg, #1a1a2e, #16213e);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 2.5rem;
}
.event-body { padding: 14px 16px; }
.event-title { font-weight: 700; font-size: 0.95rem; margin-bottom: 4px; }
.event-meta { font-size: 0.72rem; color: var(--tm); margin-bottom: 10px; line-height: 1.6; }
.event-type-tag {
  display: inline-block;
  background: rgba(232,201,122,0.12);
  border: 1px solid rgba(232,201,122,0.25);
  border-radius: 20px;
  padding: 2px 10px;
  font-size: 0.65rem;
  color: var(--ac);
  margin-bottom: 8px;
}
.event-going-bar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding-top: 10px;
  border-top: 1px solid var(--bd);
  margin-top: 8px;
}
.going-btn {
  padding: 7px 16px;
  border-radius: 20px;
  border: none;
  font-size: 0.75rem;
  font-weight: 700;
  cursor: pointer;
  background: var(--ac);
  color: #1a1208;
}
.going-btn.going-active {
  background: #5fcf80;
  color: #0f1a10;
}
/* LEAFLET POPUP DARK THEME */
.net-popup .leaflet-popup-content-wrapper {
  background: #1a1a2e;
  color: #f0ead6;
  border: 1px solid rgba(232,201,122,0.2);
  border-radius: 10px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.5);
}
.net-popup .leaflet-popup-tip { background: #1a1a2e; }
/* TOAST */
#toast {
  position: fixed;
  bottom: 80px;
  left: 50%;
  transform: translateX(-50%) translateY(8px);
  background: var(--ac);
  color: #1a1208;
  padding: 8px 20px;
  border-radius: 20px;
  font-size: 0.78rem;
  font-weight: 700;
  opacity: 0;
  transition: opacity 0.25s, transform 0.25s;
  pointer-events: none;
  z-index: 999;
}
#toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// Fallback if Supabase fails to load
// Set up supabase fallback immediately in case CDN fails
function setupSupabaseFallback() {
  if (!window.supabase) {
    window.supabase = { createClient: function() { return { auth: { getSession: async function() { return {data:{session:null}}; }, onAuthStateChange: function() {}, signInWithPassword: async function() { return {error:{message:'Offline mode'}}; }, signUp: async function() { return {error:{message:'Offline mode'}}; }, signInWithOAuth: async function() {}, signOut: async function() {}, resetPasswordForEmail: async function() { return {}; } }, from: function() { return { select: function() { return { eq: function() { return { single: async function() { return {data:null,error:'offline'}; } } } } }, upsert: async function() { return {}; } }; } }; } };
  }
}
window.addEventListener('error', function(e) { setupSupabaseFallback(); }, true);
</script>
</head>
<body>
<!-- SPLASH SCREEN -->
<!-- AUTH SCREEN -->
<!-- FORGOT PASSWORD SCREEN -->
<div id="app">
  <!-- HOME SCREEN -->
  <div class="screen active" id="screen-home">
    <!-- Header -->
    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:16px;">
      <div>
        <div style="font-family:'Cormorant Garamond',serif; font-size:1.6rem; font-weight:300; color:var(--ac);">Just For Today</div>
        <div style="font-size:0.62rem; color:var(--tm); letter-spacing:0.08em; text-transform:uppercase;">Clean Living</div>
      </div>
      <div style="display:flex;align-items:center;gap:8px;">
        <button id="home-signout-btn" onclick="doSignOut()" style="display:none;font-size:0.65rem;color:#e74c3c;background:transparent;border:1px solid rgba(231,76,60,0.3);border-radius:12px;padding:5px 11px;cursor:pointer;">Sign Out</button>
        <div style="position:relative;display:inline-block;">
          <button id="home-signin-btn" onclick="showScreen('account')" style="width:34px;height:34px;border-radius:50%;background:var(--sf);border:1px solid rgba(232,201,122,0.35);cursor:pointer;font-size:1rem;display:flex;align-items:center;justify-content:center;color:var(--ac);">üë§</button>
          <div id="admin-badge" style="display:none;position:absolute;top:-3px;right:-3px;width:14px;height:14px;background:#e74c3c;border-radius:50%;font-size:0.55rem;font-weight:700;color:#fff;display:none;align-items:center;justify-content:center;" id="admin-badge"></div>
        </div>
      </div>
    </div>
    <!-- Clean Date Counter -->
    <div class="card">
      <div style="display:flex; align-items:center; gap:14px;">
        <div style="text-align:center; min-width:64px;">
          <div id="days-count" style="font-family:'Cormorant Garamond',serif; font-size:2.8rem; font-weight:300; color:var(--ac); line-height:1;">0</div>
          <div style="font-size:0.54rem; font-weight:700; color:var(--tm); letter-spacing:0.1em; text-transform:uppercase;">Days Clean</div>
        </div>
        <div style="flex:1;">
          <div style="font-size:0.68rem; color:var(--tm); margin-bottom:6px;">Set your clean date</div>
          <input type="date" id="clean-date-input" class="input" onchange="saveCleanDate(this.value)">
          <div id="clean-date-label" style="font-size:0.64rem; color:var(--tm); margin-top:4px;"></div>
        </div>
      </div>
    </div>
    <!-- Mood Check-in -->
    <div class="card">
      <div class="label">Today's Check-In</div>
      <div class="mood-row">
        <div class="mood-btn" id="mood-sad" onclick="setMood('sad')">
          <div class="mood-emoji">&#x1F614;</div>
          <div class="mood-label">Low</div>
        </div>
        <div class="mood-btn" id="mood-meh" onclick="setMood('meh')">
          <div class="mood-emoji">&#x1F610;</div>
          <div class="mood-label">Okay</div>
        </div>
        <div class="mood-btn" id="mood-good" onclick="setMood('good')">
          <div class="mood-emoji">&#x1F642;</div>
          <div class="mood-label">Good</div>
        </div>
        <div class="mood-btn" id="mood-great" onclick="setMood('great')">
          <div class="mood-emoji">&#x1F60A;</div>
          <div class="mood-label">Great</div>
        </div>
        <div class="mood-btn" id="mood-wow" onclick="setMood('wow')">
          <div class="mood-emoji">&#x1F31F;</div>
          <div class="mood-label">Amazing</div>
        </div>
      </div>
      <div id="mood-history" style="font-size:0.74rem; color:var(--tm); margin-top:10px;"></div>
    </div>
    <!-- Daily Quote -->
    <div class="card" style="border-left: 3px solid var(--ac);">
      <div id="daily-quote" style="font-style:italic; font-size:0.84rem; line-height:1.6;"></div>
    </div>
    <!-- Daily Readings -->
    <div class="label" style="margin-top:4px;">Today's Readings</div>
    <a href="https://www.jftna.org/jft/" target="_blank" style="display:flex;align-items:center;gap:13px;background:var(--sf);border:1px solid rgba(232,201,122,0.35);border-radius:var(--r);padding:13px 15px;margin-bottom:8px;text-decoration:none;color:var(--tx);box-shadow:0 2px 8px rgba(0,0,0,0.25);">
      <div style="font-size:1.4rem;">&#x1F4D4;</div>
      <div style="flex:1;">
        <div style="font-weight:600;font-size:0.86rem;">Just For Today</div>
        <div style="font-size:0.7rem;color:var(--tm);margin-top:2px;">Read today's daily meditation</div>
      </div>
      <div style="color:var(--tm);">&#8250;</div>
    </a>
    <a href="https://spadna.org" target="_blank" style="display:flex;align-items:center;gap:13px;background:var(--sf);border:1px solid rgba(232,201,122,0.35);border-radius:var(--r);padding:13px 15px;margin-bottom:8px;text-decoration:none;color:var(--tx);box-shadow:0 2px 8px rgba(0,0,0,0.25);">
      <div style="font-size:1.4rem;">&#x2728;</div>
      <div style="flex:1;">
        <div style="font-weight:600;font-size:0.86rem;">Spiritual Principle a Day</div>
        <div style="font-size:0.7rem;color:var(--tm);margin-top:2px;">Read today's spiritual principle</div>
      </div>
      <div style="color:var(--tm);">&#8250;</div>
    </a>
    <!-- Quick Links -->
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:2px;">
      <div class="card" onclick="showScreen('journal')" style="text-align:center; cursor:pointer; margin-bottom:0; padding:18px 16px;">
        <div style="font-size:1.8rem;">&#x270D;</div>
        <div style="font-size:0.76rem; font-weight:600; color:var(--tx); margin-top:6px;">Journal</div>
      </div>
      <div class="card" onclick="showScreen('my-events')" style="text-align:center; cursor:pointer; margin-bottom:0; padding:18px 16px; position:relative;">
        <div style="font-size:1.8rem;">üìÖ</div>
        <div style="font-size:0.76rem; font-weight:600; color:var(--tx); margin-top:6px;">My Events</div>
        <div id="home-events-badge" style="display:none;position:absolute;top:8px;right:8px;background:var(--ac);color:#1a1208;font-size:0.55rem;font-weight:800;border-radius:20px;padding:2px 6px;"></div>
      </div>
      <div class="card" onclick="showScreen('meetings')" style="text-align:center; cursor:pointer; margin-bottom:0; padding:18px 16px;">
        <div style="font-size:1.8rem;">&#x1F5D3;</div>
        <div style="font-size:0.76rem; font-weight:600; color:var(--tx); margin-top:6px;">Meetings</div>
      </div>
    </div>
    <!-- Crisis Line -->
    <div style="background:rgba(180,60,60,0.12); border:1px solid rgba(180,60,60,0.25); border-radius:var(--r); padding:12px 14px; margin-top:10px;">
      <div style="display:flex; gap:10px; align-items:center; margin-bottom:8px;">
        <div style="font-size:1rem;">üìû</div>
        <div style="font-size:0.74rem; font-weight:700; color:var(--tx);">Helplines</div>
      </div>
      <a href="tel:03009991212" style="display:flex; align-items:center; justify-content:space-between; text-decoration:none; padding:8px 0; border-bottom:1px solid rgba(180,60,60,0.2);">
        <div>
          <div style="font-size:0.76rem; font-weight:700; color:#ff6b6b;">üá¨üáß UK Helpline</div>
          <div style="font-size:0.63rem; color:var(--tm);">0300 999 1212 ¬∑ 10am‚Äìmidnight daily</div>
        </div>
        <div style="font-size:0.7rem; color:var(--tm);">Tap to call ‚Ä∫</div>
      </a>
      <a href="tel:+18187739999" style="display:flex; align-items:center; justify-content:space-between; text-decoration:none; padding:8px 0; border-bottom:1px solid rgba(180,60,60,0.2);">
        <div>
          <div style="font-size:0.76rem; font-weight:700; color:#ff6b6b;">üåç NA World Service Office</div>
          <div style="font-size:0.63rem; color:var(--tm);">+1 818 773 9999 ¬∑ Mon‚ÄìFri, 8am‚Äì5pm PST</div>
        </div>
        <div style="font-size:0.7rem; color:var(--tm);">Tap to call ‚Ä∫</div>
      </a>
      <a href="https://www.na.org/meetingsearch" target="_blank" style="display:flex; align-items:center; justify-content:space-between; text-decoration:none; padding:8px 0;">
        <div>
          <div style="font-size:0.76rem; font-weight:700; color:#ff6b6b;">üîç Find Your Local Helpline</div>
          <div style="font-size:0.63rem; color:var(--tm);">na.org ¬∑ Search by country or region</div>
        </div>
        <div style="font-size:0.7rem; color:var(--tm);">Open ‚Ä∫</div>
      </a>
    </div>
  </div><!-- end home -->
  <!-- PLACEHOLDER SCREENS (we'll build these next) -->
  <div class="screen" id="screen-journal">
    <div style="font-family:'Cormorant Garamond',serif; font-size:1.9rem; font-weight:300; color:var(--ac); margin-bottom:2px;">Journal</div>
    <div style="font-size:0.62rem; color:var(--tm); letter-spacing:0.08em; text-transform:uppercase; margin-bottom:18px;">Your daily recovery writing</div>
    <!-- JOURNAL HOME - type selector -->
    <div id="j-home">
      <div class="label">Choose a journal type</div>
      <div onclick="openJournal('gratitude')" class="j-type-card">
        <div style="font-size:1.8rem;width:42px;text-align:center;">&#x1F64F;</div>
        <div style="flex:1;">
          <div style="font-weight:700; font-size:0.92rem;">Gratitude List</div>
          <div style="font-size:0.74rem; color:var(--tm); margin-top:3px;">Count your blessings with guided prompts</div>
        </div>
        <div style="color:var(--tm);font-size:1.1rem;">&#8250;</div>
      </div>
      <div onclick="openJournal('spotcheck')" class="j-type-card">
        <div style="font-size:1.8rem;width:42px;text-align:center;">&#x26A1;</div>
        <div style="flex:1;">
          <div style="font-weight:700; font-size:0.92rem;">Spot Check Inventory</div>
          <div style="font-size:0.74rem; color:var(--tm); margin-top:3px;">Quick nightly check-in based on Step 10</div>
        </div>
        <div style="color:var(--tm);font-size:1.1rem;">&#8250;</div>
      </div>
      <div onclick="openJournal('step10')" class="j-type-card">
        <div style="font-size:1.8rem;width:42px;text-align:center;">&#x1F4CB;</div>
        <div style="flex:1;">
          <div style="font-weight:700; font-size:0.92rem;">Full Step 10 Inventory</div>
          <div style="font-size:0.74rem; color:var(--tm); margin-top:3px;">Complete daily inventory questions</div>
        </div>
        <div style="color:var(--tm);font-size:1.1rem;">&#8250;</div>
      </div>
      <div id="j-type-guiding" onclick="openJournal('guiding')" class="j-type-card">
        <div style="font-size:1.8rem;width:42px;text-align:center;">&#x1F4D6;</div>
        <div style="flex:1;">
          <div style="font-weight:700; font-size:0.92rem;">Guiding Principles</div>
          <div style="font-size:0.74rem; color:var(--tm); margin-top:3px;">Work through your Traditions questions</div>
        </div>
        <div style="color:var(--tm);font-size:1.1rem;">&#8250;</div>
      </div>
      <div onclick="openJournal('daily')" class="j-type-card">
        <div style="font-size:1.8rem;width:42px;text-align:center;">&#x270D;</div>
        <div style="flex:1;">
          <div style="font-weight:700; font-size:0.92rem;">Daily Journal</div>
          <div style="font-size:0.74rem; color:var(--tm); margin-top:3px;">Free writing with gentle prompts</div>
        </div>
        <div style="color:var(--tm);font-size:1.1rem;">&#8250;</div>
      </div>
      <!-- Past entries -->
      <div style="display:flex;align-items:center;justify-content:space-between;margin-top:20px;margin-bottom:8px;">
        <div class="label" style="margin:0;">Recent Entries</div>
        <button onclick="showExportPicker()" style="background:var(--sf);border:1px solid var(--bd);border-radius:20px;padding:5px 12px;font-size:0.66rem;color:var(--ac);cursor:pointer;">‚Üë Export</button>
      </div>
      <div id="j-entries"></div>
    </div>
    <!-- JOURNAL WRITE VIEW -->
    <div id="j-write" style="display:none;">
      <div style="display:flex; align-items:center; gap:12px; margin-bottom:16px;">
        <button onclick="closeJournal()" style="background:var(--sf);border:1px solid var(--bd);border-radius:50%;width:34px;height:34px;color:var(--tx);font-size:1rem;cursor:pointer;flex-shrink:0;">&#8592;</button>
        <div>
          <div id="j-write-title" style="font-weight:700; font-size:0.94rem;"></div>
          <div id="j-write-date" style="font-size:0.68rem; color:var(--tm);"></div>
        </div>
      </div>
      <!-- Prompts area -->
      <div id="j-prompts"></div>
      <!-- Text area -->
      <textarea id="j-text" class="input" rows="10" placeholder="Write here..." style="resize:none; line-height:1.6; padding:12px;"></textarea>
      <div style="display:flex; gap:8px; margin-top:10px;">
        <button onclick="saveJournal()" class="btn" style="flex:1;">Save Entry</button>
        <button id="j-delete-btn" onclick="deleteJournal()" style="display:none; background:transparent; border:1px solid rgba(180,60,60,0.4); border-radius:var(--r); padding:13px 16px; color:#ff6b6b; font-size:0.8rem; cursor:pointer;">Delete</button>
      </div>
    </div>
  </div>
  <div class="screen" id="screen-steps">
    <div style="font-family:'Cormorant Garamond',serif; font-size:1.9rem; font-weight:300; color:var(--ac); margin-bottom:2px;">Worksheets</div>
    <div style="font-size:0.62rem; color:var(--tm); letter-spacing:0.08em; text-transform:uppercase; margin-bottom:18px;">Step work &amp; recovery worksheets</div>
        <!-- WORKSHEETS -->

```
<!-- CUSTOM QUESTIONS -->
<div class="label" style="margin-top:20px;"><span style="margin-right:5px;">&#x270F;</span>My Own Questions</div>
<div style="font-size:0.72rem;color:var(--tm);margin-bottom:12px;line-height:1.5;">Add your own questions from your workbook or sponsor. Once saved they'll appear in your journal automatically.</div>
<!-- Step 10 custom questions -->
<div style="background:var(--sf);border:1px solid var(--bd);border-radius:var(--r);padding:16px;margin-bottom:10px;">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;">
    <div style="font-size:0.82rem;font-weight:700;color:var(--ac);">&#x1F4CB; Step 10 Questions</div>
    <a href="https://cart-us.na.org/recovery-products/books/the-na-step-working-guides-1400" target="_blank" style="font-size:0.65rem;color:var(--tm);text-decoration:underline;">Buy the workbook ‚Ä∫</a>
  </div>
  <div style="font-size:0.7rem;color:var(--tm);margin-bottom:10px;">One question per line ‚Äî replaces the default questions in your Step 10 journal.</div>
  <textarea id="custom-step10" style="width:100%;min-height:110px;background:var(--sf2);border:1px solid var(--bd);border-radius:10px;padding:10px;color:var(--tx);font-size:0.8rem;line-height:1.6;resize:vertical;box-sizing:border-box;" placeholder="Paste your questions here, one per line..."></textarea>
  <div style="display:flex;gap:8px;margin-top:10px;">
    <button onclick="saveCustomStep10()" class="btn" style="flex:2;margin-top:0;padding:11px;">Save</button>
    <button onclick="clearCustomStep10()" style="flex:1;padding:11px;background:transparent;border:1px solid var(--bd);border-radius:var(--r);color:var(--tm);font-size:0.75rem;cursor:pointer;">Reset</button>
  </div>
  <div id="step10-saved-msg" style="display:none;margin-top:8px;font-size:0.72rem;color:#5fcf80;text-align:center;">&#x2713; Saved ‚Äî your questions will appear in the Step 10 journal</div>
</div>
<!-- Guiding Principles custom questions -->
<div style="background:var(--sf);border:1px solid var(--bd);border-radius:var(--r);padding:16px;margin-bottom:8px;">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;">
    <div style="font-size:0.82rem;font-weight:700;color:var(--ac);">&#x1F4D6; Guiding Principles Questions</div>
    <a href="javascript:buyBook('guiding-principles')" style="font-size:0.65rem;color:var(--tm);text-decoration:underline;">Buy the workbook ‚Ä∫</a>
  </div>
  <div style="font-size:0.7rem;color:var(--tm);margin-bottom:10px;">One question per line ‚Äî adds a Guiding Principles journal type once saved.</div>
  <textarea id="custom-guiding" style="width:100%;min-height:110px;background:var(--sf2);border:1px solid var(--bd);border-radius:10px;padding:10px;color:var(--tx);font-size:0.8rem;line-height:1.6;resize:vertical;box-sizing:border-box;" placeholder="Paste your questions here, one per line..."></textarea>
  <div style="display:flex;gap:8px;margin-top:10px;">
    <button onclick="saveCustomGuiding()" class="btn" style="flex:2;margin-top:0;padding:11px;">Save</button>
    <button onclick="clearCustomGuiding()" style="flex:1;padding:11px;background:transparent;border:1px solid var(--bd);border-radius:var(--r);color:var(--tm);font-size:0.75rem;cursor:pointer;">Reset</button>
  </div>
  <div id="guiding-saved-msg" style="display:none;margin-top:8px;font-size:0.72rem;color:#5fcf80;text-align:center;">&#x2713; Saved ‚Äî Guiding Principles now appears in your journal</div>
</div>
```

  </div><!-- end screen-steps -->
  <div class="screen" id="screen-meetings">
    <div style="font-family:'Cormorant Garamond',serif; font-size:1.9rem; font-weight:300; color:var(--ac); margin-bottom:2px;">Meetings</div>
    <div style="font-size:0.62rem; color:var(--tm); letter-spacing:0.08em; text-transform:uppercase; margin-bottom:20px;">Find your fellowship</div>
    <!-- IN-PERSON FINDERS -->
    <div class="label">üìç Find an In-Person Meeting</div>
    <a href="https://na.org/meetingsearch/" target="_blank" class="meeting-card">
      <div class="meeting-left">
        <div class="meeting-flag">üåç</div>
        <div>
          <div class="meeting-title">NA World Meeting Search</div>
          <div class="meeting-sub">Find meetings anywhere in the world</div>
        </div>
      </div>
      <div class="meeting-arr">‚Ä∫</div>
    </a>
    <a href="https://meetings.ukna.org/meeting/search" target="_blank" class="meeting-card">
      <div class="meeting-left">
        <div class="meeting-flag">üá¨üáß</div>
        <div>
          <div class="meeting-title">UK Meeting Finder</div>
          <div class="meeting-sub">Search by postcode, town or county</div>
        </div>
      </div>
      <div class="meeting-arr">‚Ä∫</div>
    </a>
    <a href="https://edmna.org/regions-and-events/" target="_blank" class="meeting-card">
      <div class="meeting-left">
        <div class="meeting-flag">üá™üá∫</div>
        <div>
          <div class="meeting-title">European Meeting Finder</div>
          <div class="meeting-sub">NA European Delegates Meeting ‚Äî all regions</div>
        </div>
      </div>
      <div class="meeting-arr">‚Ä∫</div>
    </a>
    <!-- ONLINE MEETINGS -->
    <div class="label" style="margin-top:20px;">üíª Online & Virtual Meetings</div>
    <div style="font-size:0.72rem; color:var(--tm); margin-bottom:12px; line-height:1.5;">Can't get to a meeting? Online meetings are available 24/7 from anywhere in the world.</div>
    <a href="https://virtual-na.org/meetings/" target="_blank" class="meeting-card">
      <div class="meeting-left">
        <div class="meeting-flag">üåê</div>
        <div>
          <div class="meeting-title">Virtual NA</div>
          <div class="meeting-sub">Worldwide online & phone meetings, sorted by language & day</div>
        </div>
      </div>
      <div class="meeting-arr">‚Ä∫</div>
    </a>
    <a href="https://meetings.ukna.org/meeting/search/online" target="_blank" class="meeting-card">
      <div class="meeting-left">
        <div class="meeting-flag">üá¨üáß</div>
        <div>
          <div class="meeting-title">UK Online Meetings</div>
          <div class="meeting-sub">450+ online UK NA meetings</div>
        </div>
      </div>
      <div class="meeting-arr">‚Ä∫</div>
    </a>
    <!-- SAVED ZOOM MEETINGS -->
    <!-- SHARED MEETINGS -->
    <div style="display:flex;align-items:center;justify-content:space-between;margin-top:20px;margin-bottom:4px;">
      <div class="label" style="margin:0;">üåê Community Meetings</div>
      <button onclick="openAddMeeting('shared')" style="background:var(--ac);border:none;border-radius:20px;padding:5px 12px;font-size:0.68rem;font-weight:700;color:#1a1208;cursor:pointer;">+ Add</button>
    </div>
    <div style="font-size:0.7rem;color:var(--tm);margin-bottom:10px;">Shared with everyone ‚Äî add your regular meetings here</div>
    <div id="shared-meetings-list"></div>
    <div id="shared-meetings-empty" style="font-size:0.76rem;color:var(--tm);text-align:center;padding:10px 0 14px;">No shared meetings yet ‚Äî be the first to add one</div>
    <!-- PERSONAL FAVOURITES -->
    <div style="display:flex;align-items:center;justify-content:space-between;margin-top:18px;margin-bottom:4px;">
      <div class="label" style="margin:0;">‚≠ê My Favourites</div>
      <button onclick="openAddMeeting('personal')" style="background:var(--sf);border:1px solid rgba(232,201,122,0.35);border-radius:20px;padding:5px 12px;font-size:0.68rem;font-weight:700;color:var(--ac);cursor:pointer;">+ Add</button>
    </div>
    <div style="font-size:0.7rem;color:var(--tm);margin-bottom:10px;">Just for you ‚Äî private, only you can see these</div>
    <div id="personal-meetings-list"></div>
    <div id="personal-meetings-empty" style="font-size:0.76rem;color:var(--tm);text-align:center;padding:10px 0 14px;">No favourites yet</div>
    <div style="margin-bottom:20px;"></div>
    <!-- HELPLINE REMINDER -->
    <div style="background:var(--sf); border:1px solid var(--bd); border-radius:var(--r); padding:14px; margin-top:0;">
      <div style="font-size:0.68rem; color:var(--tm); text-transform:uppercase; letter-spacing:0.06em; margin-bottom:12px;">üìû Helplines</div>
      <a href="tel:03009991212" style="display:flex; align-items:center; justify-content:space-between; text-decoration:none; padding:8px 0; border-bottom:1px solid var(--bd);">
        <div>
          <div style="font-size:0.82rem; font-weight:700; color:var(--ac);">üá¨üáß UK Helpline</div>
          <div style="font-size:0.68rem; color:var(--tm); margin-top:2px;">0300 999 1212 ¬∑ 10am‚Äìmidnight daily</div>
        </div>
        <div style="font-size:0.7rem; color:var(--tm);">Tap to call ‚Ä∫</div>
      </a>
      <a href="tel:+18187739999" style="display:flex; align-items:center; justify-content:space-between; text-decoration:none; padding:8px 0; border-bottom:1px solid var(--bd);">
        <div>
          <div style="font-size:0.82rem; font-weight:700; color:var(--ac);">üåç NA World Service Office</div>
          <div style="font-size:0.68rem; color:var(--tm); margin-top:2px;">+1 818 773 9999 ¬∑ Mon‚ÄìFri, 8am‚Äì5pm PST</div>
        </div>
        <div style="font-size:0.7rem; color:var(--tm);">Tap to call ‚Ä∫</div>
      </a>
      <a href="https://www.na.org/meetingsearch" target="_blank" style="display:flex; align-items:center; justify-content:space-between; text-decoration:none; padding:8px 0;">
        <div>
          <div style="font-size:0.82rem; font-weight:700; color:var(--ac);">üîç Find Your Local Helpline</div>
          <div style="font-size:0.68rem; color:var(--tm); margin-top:2px;">na.org ¬∑ Search by country or region</div>
        </div>
        <div style="font-size:0.7rem; color:var(--tm);">Open ‚Ä∫</div>
      </a>
    </div>
  </div>
  <div class="screen" id="screen-books">
    <div style="font-family:'Cormorant Garamond',serif; font-size:1.9rem; font-weight:300; color:var(--ac); margin-bottom:2px;">Books</div>
    <div style="font-size:0.62rem; color:var(--tm); letter-spacing:0.08em; text-transform:uppercase; margin-bottom:18px;">NA Literature Library</div>
    <!-- MAIN BOOKS -->
    <div class="label">üìï Main Books</div>
    <div style="font-size:0.7rem; color:var(--tm); margin-bottom:12px;">Tap a book to see purchase options</div>
    <div class="book-expand-card">
      <div class="book-card-header" onclick="toggleBook(this)">
        <div class="book-icon">üìò</div>
        <div class="book-body"><div class="book-title">Basic Text</div><div class="book-sub">Narcotics Anonymous ‚Äî 6th Edition</div></div>
        <div class="book-chevron">&#8250;</div>
      </div>
      <div class="book-card-body">
        <div class="book-section-label">üì± Digital Edition</div>
        <div class="book-btn-row">
          <a href="https://books.apple.com/us/book/narcotics-anonymous/id560639864" target="_blank" class="buy-btn apple-btn">üçé Apple Books</a>
          <a href="https://play.google.com/store/books/details/Fellowship_of_Narcotics_Anonymous_Narcotics_Anonymo?id=560639864" target="_blank" class="buy-btn google-btn">‚ñ∂ Google Play</a>
        </div>
        <div class="book-section-label" style="margin-top:12px;">üì¶ Buy Hardcopy</div>
        <a href="https://cart-us.na.org/recovery-products/books/basic-text-hardcover-1101" target="_blank" class="buy-btn world-btn">üåç NA World Store</a>
        <a href="https://ukso.biz" target="_blank" class="buy-btn uk-btn">üá¨üáß UK Service Office</a>
        <a href="https://cart-eu.na.org" target="_blank" class="buy-btn eu-btn">üá™üá∫ NA Europe Store</a>
      </div>
    </div>
    <div class="book-expand-card">
      <div class="book-card-header" onclick="toggleBook(this)">
        <div class="book-icon">üìî</div>
        <div class="book-body"><div class="book-title">Just for Today</div><div class="book-sub">Daily meditations for recovering addicts</div></div>
        <div class="book-chevron">&#8250;</div>
      </div>
      <div class="book-card-body">
        <div class="book-section-label">üì± Digital Edition</div>
        <div class="book-btn-row">
          <a href="https://books.apple.com/us/book/just-for-today/id1608426774" target="_blank" class="buy-btn apple-btn">üçé Apple Books</a>
          <a href="https://play.google.com/store/books/details?id=just-for-today-na" target="_blank" class="buy-btn google-btn">‚ñ∂ Google Play</a>
        </div>
        <div class="book-section-label" style="margin-top:12px;">üì¶ Buy Hardcopy</div>
        <a href="https://cart-us.na.org/recovery-products/books/just-for-today-daily-meditation-book-1112" target="_blank" class="buy-btn world-btn">üåç NA World Store</a>
        <a href="https://ukso.biz" target="_blank" class="buy-btn uk-btn">üá¨üáß UK Service Office</a>
        <a href="https://cart-eu.na.org" target="_blank" class="buy-btn eu-btn">üá™üá∫ NA Europe Store</a>
      </div>
    </div>
    <div class="book-expand-card">
      <div class="book-card-header" onclick="toggleBook(this)">
        <div class="book-icon">üìô</div>
        <div class="book-body"><div class="book-title">It Works: How and Why</div><div class="book-sub">The 12 Steps & 12 Traditions of NA</div></div>
        <div class="book-chevron">&#8250;</div>
      </div>
      <div class="book-card-body">
        <div class="book-section-label">üì± Digital Edition</div>
        <div class="book-btn-row">
          <a href="https://books.apple.com/us/book/it-works-how-and-why/id564200715" target="_blank" class="buy-btn apple-btn">üçé Apple Books</a>
          <a href="https://play.google.com/store/books/details/Fellowship_of_Narcotics_Anonymous_It_Works_How_and?id=564200715" target="_blank" class="buy-btn google-btn">‚ñ∂ Google Play</a>
        </div>
        <div class="book-section-label" style="margin-top:12px;">üì¶ Buy Hardcopy</div>
        <a href="https://cart-us.na.org/recovery-products/books/it-works-5-how-and-why-hardcover-1140" target="_blank" class="buy-btn world-btn">üåç NA World Store</a>
        <a href="https://ukso.biz" target="_blank" class="buy-btn uk-btn">üá¨üáß UK Service Office</a>
        <a href="https://cart-eu.na.org" target="_blank" class="buy-btn eu-btn">üá™üá∫ NA Europe Store</a>
      </div>
    </div>
    <div class="book-expand-card">
      <div class="book-card-header" onclick="toggleBook(this)">
        <div class="book-icon">üìñ</div>
        <div class="book-body"><div class="book-title">Guiding Principles</div><div class="book-sub">The Spirit of Our Traditions</div></div>
        <div class="book-chevron">&#8250;</div>
      </div>
      <div class="book-card-body">
        <div class="book-section-label">üì± Digital Edition</div>
        <div class="book-btn-row">
          <a href="https://books.apple.com/us/book/guiding-principles-the-spirit-of-our-traditions/id1478457214" target="_blank" class="buy-btn apple-btn">üçé Apple Books</a>
          <a href="https://play.google.com/store/books/details/Fellowship_of_Narcotics_Anonymous_Guiding_Principle?id=1478457214" target="_blank" class="buy-btn google-btn">‚ñ∂ Google Play</a>
        </div>
        <div class="book-section-label" style="margin-top:12px;">üì¶ Buy Hardcopy</div>
        <a href="https://cart-us.na.org/recovery-products/books" target="_blank" class="buy-btn world-btn">üåç NA World Store</a>
        <a href="https://ukso.biz" target="_blank" class="buy-btn uk-btn">üá¨üáß UK Service Office</a>
        <a href="https://cart-eu.na.org" target="_blank" class="buy-btn eu-btn">üá™üá∫ NA Europe Store</a>
      </div>
    </div>
    <div class="book-expand-card">
      <div class="book-card-header" onclick="toggleBook(this)">
        <div class="book-icon">üõ§Ô∏è</div>
        <div class="book-body"><div class="book-title">Living Clean</div><div class="book-sub">The Journey Continues</div></div>
        <div class="book-chevron">&#8250;</div>
      </div>
      <div class="book-card-body">
        <div class="book-section-label">üì± Digital Edition</div>
        <div class="book-btn-row">
          <a href="https://books.apple.com/us/book/living-clean-the-journey-continues/id733950643" target="_blank" class="buy-btn apple-btn">üçé Apple Books</a>
          <a href="https://play.google.com/store/books/details/Fellowship_of_Narcotics_Anonymous_Living_Clean_The?id=733950643" target="_blank" class="buy-btn google-btn">‚ñ∂ Google Play</a>
        </div>
        <div class="book-section-label" style="margin-top:12px;">üì¶ Buy Hardcopy</div>
        <a href="https://cart-us.na.org/recovery-products/books/living-clean-1160" target="_blank" class="buy-btn world-btn">üåç NA World Store</a>
        <a href="https://ukso.biz" target="_blank" class="buy-btn uk-btn">üá¨üáß UK Service Office</a>
        <a href="https://cart-eu.na.org" target="_blank" class="buy-btn eu-btn">üá™üá∫ NA Europe Store</a>
      </div>
    </div>
    <div class="book-expand-card">
      <div class="book-card-header" onclick="toggleBook(this)">
        <div class="book-icon">üìã</div>
        <div class="book-body"><div class="book-title">Step Working Guides</div><div class="book-sub">NA 12 Step working guides</div></div>
        <div class="book-chevron">&#8250;</div>
      </div>
      <div class="book-card-body">
        <div class="book-section-label">üì± Digital Edition</div>
        <div class="book-btn-row">
          <a href="https://books.apple.com/us/book/the-na-step-working-guides/id1036368127" target="_blank" class="buy-btn apple-btn">üçé Apple Books</a>
          <a href="https://play.google.com/store/books/details/Fellowship_of_Narcotics_Anonymous_The_NA_Step_Worki?id=1036368127" target="_blank" class="buy-btn google-btn">‚ñ∂ Google Play</a>
        </div>
        <div class="book-section-label" style="margin-top:12px;">üì¶ Buy Hardcopy</div>
        <a href="https://cart-us.na.org/recovery-products/books/the-na-step-working-guides-1400" target="_blank" class="buy-btn world-btn">üåç NA World Store</a>
        <a href="https://ukso.biz" target="_blank" class="buy-btn uk-btn">üá¨üáß UK Service Office</a>
        <a href="https://cart-eu.na.org" target="_blank" class="buy-btn eu-btn">üá™üá∫ NA Europe Store</a>
      </div>
    </div>
    <div class="book-expand-card">
      <div class="book-card-header" onclick="toggleBook(this)">
        <div class="book-icon">‚ú®</div>
        <div class="book-body"><div class="book-title">A Spiritual Principle a Day</div><div class="book-sub">Daily readings on spiritual principles</div></div>
        <div class="book-chevron">&#8250;</div>
      </div>
      <div class="book-card-body">
        <div class="book-section-label">üì± Digital Edition</div>
        <div class="book-btn-row">
          <a href="https://books.apple.com/us/book/a-spiritual-principle-a-day/id1590889673" target="_blank" class="buy-btn apple-btn">üçé Apple Books</a>
          <a href="https://play.google.com/store/books/details/Fellowship_of_Narcotics_Anonymous_A_Spiritual_Princ?id=1590889673" target="_blank" class="buy-btn google-btn">‚ñ∂ Google Play</a>
        </div>
        <div class="book-section-label" style="margin-top:12px;">üì¶ Buy Hardcopy</div>
        <a href="https://cart-us.na.org/recovery-products/books/a-spiritual-principle-a-day-1170" target="_blank" class="buy-btn world-btn">üåç NA World Store</a>
        <a href="https://ukso.biz" target="_blank" class="buy-btn uk-btn">üá¨üáß UK Service Office</a>
        <a href="https://cart-eu.na.org" target="_blank" class="buy-btn eu-btn">üá™üá∫ NA Europe Store</a>
      </div>
    </div>
    <!-- BOOKLETS -->
    <div class="label" style="margin-top:20px;">üìÑ Booklets</div>
    <a href="https://na.org/wp-content/uploads/2024/05/AN1500_LWB-Little-White-Book-English-Anglicized.pdf" target="_blank" class="book-card">
      <div class="book-icon">üìÑ</div><div class="book-body"><div class="book-title">The White Booklet</div><div class="book-sub">Free PDF ‚Äî official na.org</div></div><div class="book-arr">‚Ä∫</div>
    </a>
    <!-- INFORMATIONAL PAMPHLETS -->
    <div class="label" style="margin-top:16px;">üìÉ Informational Pamphlets</div>
    <div style="font-size:0.7rem; color:var(--tm); margin-bottom:10px;">All free official PDFs from na.org</div>
    <a href="https://na.org/wp-content/uploads/2024/05/AN3101_6-22-IP-1-English-Anglicized.pdf" target="_blank" class="book-card"><div class="book-icon">üìÉ</div><div class="book-body"><div class="book-title">IP #1: Who, What, How, and Why</div></div><div class="book-arr">‚Ä∫</div></a>
    <a href="https://na.org/wp-content/uploads/2024/05/AN3105-IP-5-English-Anglicized.pdf" target="_blank" class="book-card"><div class="book-icon">üìÉ</div><div class="book-body"><div class="book-title">IP #5: Another Look</div></div><div class="book-arr">‚Ä∫</div></a>
    <a href="https://na.org/wp-content/uploads/2024/05/AN3106-IP-6-English-Anglicized.pdf" target="_blank" class="book-card"><div class="book-icon">üìÉ</div><div class="book-body"><div class="book-title">IP #6: Recovery &amp; Relapse</div></div><div class="book-arr">‚Ä∫</div></a>
    <a href="https://na.org/wp-content/uploads/2024/05/AN3107-IP-7-English-Anglicized.pdf" target="_blank" class="book-card"><div class="book-icon">üìÉ</div><div class="book-body"><div class="book-title">IP #7: Am I an Addict?</div></div><div class="book-arr">‚Ä∫</div></a>
    <a href="https://na.org/wp-content/uploads/2024/05/AN3108-IP-8-English-Anglicized.pdf" target="_blank" class="book-card"><div class="book-icon">üìÉ</div><div class="book-body"><div class="book-title">IP #8: Just for Today</div></div><div class="book-arr">‚Ä∫</div></a>
    <a href="https://na.org/wp-content/uploads/2024/05/AN3109_10-22-IP-9-English-Anglicized.pdf" target="_blank" class="book-card"><div class="book-icon">üìÉ</div><div class="book-body"><div class="book-title">IP #9: Living the Programme</div></div><div class="book-arr">‚Ä∫</div></a>
    <a href="https://na.org/wp-content/uploads/2024/05/AN3111-IP-11-English-Anglicized.pdf" target="_blank" class="book-card"><div class="book-icon">üìÉ</div><div class="book-body"><div class="book-title">IP #11: Sponsorship</div></div><div class="book-arr">‚Ä∫</div></a>
    <a href="https://na.org/wp-content/uploads/2024/05/AN3112-IP-12-English-Anglicized.pdf" target="_blank" class="book-card"><div class="book-icon">üìÉ</div><div class="book-body"><div class="book-title">IP #12: The Triangle of Self-Obsession</div></div><div class="book-arr">‚Ä∫</div></a>
    <a href="https://na.org/wp-content/uploads/2024/05/AN3113-IP-13-English-Anglicized.pdf" target="_blank" class="book-card"><div class="book-icon">üìÉ</div><div class="book-body"><div class="book-title">IP #13: Youth and Recovery</div></div><div class="book-arr">‚Ä∫</div></a>
    <a href="https://na.org/wp-content/uploads/2024/05/AN3114-IP-14-English-Anglicized.pdf" target="_blank" class="book-card"><div class="book-icon">üìÉ</div><div class="book-body"><div class="book-title">IP #14: One Addict's Experience</div></div><div class="book-arr">‚Ä∫</div></a>
    <a href="https://na.org/wp-content/uploads/2024/05/AN3115_7-22-IP-15-English-Anglicized.pdf" target="_blank" class="book-card"><div class="book-icon">üìÉ</div><div class="book-body"><div class="book-title">IP #15: PI and the NA Member</div></div><div class="book-arr">‚Ä∫</div></a>
    <a href="https://na.org/wp-content/uploads/2024/05/AN3116-IP-16-English-Anglicized.pdf" target="_blank" class="book-card"><div class="book-icon">üìÉ</div><div class="book-body"><div class="book-title">IP #16: For the Newcomer</div></div><div class="book-arr">‚Ä∫</div></a>
    <a href="https://na.org/wp-content/uploads/2024/05/AN3119-IP-19-English-Anglicized.pdf" target="_blank" class="book-card"><div class="book-icon">üìÉ</div><div class="book-body"><div class="book-title">IP #19: Self-Acceptance</div></div><div class="book-arr">‚Ä∫</div></a>
    <a href="https://na.org/wp-content/uploads/2024/05/AN3120_7-22-IP-20-English-Anglicized.pdf" target="_blank" class="book-card"><div class="book-icon">üìÉ</div><div class="book-body"><div class="book-title">IP #20: H&amp;I Service and the NA Member</div></div><div class="book-arr">‚Ä∫</div></a>
    <a href="https://na.org/wp-content/uploads/2024/05/AN3122-IP-22-English-Anglicized.pdf" target="_blank" class="book-card"><div class="book-icon">üìÉ</div><div class="book-body"><div class="book-title">IP #22: Welcome to Narcotics Anonymous</div></div><div class="book-arr">‚Ä∫</div></a>
    <a href="https://na.org/wp-content/uploads/2024/05/AN3123-IP-23-English-Anglicized.pdf" target="_blank" class="book-card"><div class="book-icon">üìÉ</div><div class="book-body"><div class="book-title">IP #23: Staying Clean on the Inside</div></div><div class="book-arr">‚Ä∫</div></a>
    <a href="https://na.org/wp-content/uploads/2024/05/AN3124-IP-24-English-Anglicized.pdf" target="_blank" class="book-card"><div class="book-icon">üìÉ</div><div class="book-body"><div class="book-title">IP #24: Why Are We Self-Supporting?</div></div><div class="book-arr">‚Ä∫</div></a>
  </div><!-- end screen-books -->
  <div class="screen" id="screen-resources">
    <div style="font-family:'Cormorant Garamond',serif; font-size:1.9rem; font-weight:300; color:var(--ac); margin-bottom:4px;">Movement</div>
    <div style="color:var(--tm); font-size:0.84rem; margin-bottom:18px;">Gentle practices to support your recovery ‚Äî body, breath & mind</div>
    <!-- YOGA -->
    <div style="color:var(--ac); font-size:0.75rem; letter-spacing:0.12em; text-transform:uppercase; margin-bottom:10px;">üßò Yoga</div>
    <a href="https://crpf.gov.in/writereaddata/images/pdf/Yoga_Beginner.pdf" target="_blank" class="meeting-card" style="text-decoration:none; display:flex; margin-bottom:10px;">
      <div class="meeting-left">
        <div style="font-size:1.5rem;">üìÑ</div>
      </div>
      <div style="flex:1;">
        <div class="meeting-title">Breath, Movement & Stillness</div>
        <div class="meeting-sub">A complete yoga manual for beginners ‚Äî poses, safety guidance & philosophy</div>
      </div>
      <div class="meeting-arr">‚Ä∫</div>
    </a>
    <a href="https://darebee.com/pdf/programs/30-days-of-yoga.pdf" target="_blank" class="meeting-card" style="text-decoration:none; display:flex; margin-bottom:10px;">
      <div class="meeting-left">
        <div style="font-size:1.5rem;">üìÑ</div>
      </div>
      <div style="flex:1;">
        <div class="meeting-title">30 Days of Yoga</div>
        <div class="meeting-sub">A free beginner programme ‚Äî one session per day, building gently over a month</div>
      </div>
      <div class="meeting-arr">‚Ä∫</div>
    </a>
    <a href="https://tintyoga.com/wp-content/uploads/2019/11/Yoga-Class-Plans.pdf" target="_blank" class="meeting-card" style="text-decoration:none; display:flex; margin-bottom:18px;">
      <div class="meeting-left">
        <div style="font-size:1.5rem;">üìÑ</div>
      </div>
      <div style="flex:1;">
        <div class="meeting-title">Beginner Yoga Sequence</div>
        <div class="meeting-sub">A 60-minute class plan with alignment focus ‚Äî accessible for complete beginners</div>
      </div>
      <div class="meeting-arr">‚Ä∫</div>
    </a>
    <!-- BREATHWORK -->
    <div style="color:var(--ac); font-size:0.75rem; letter-spacing:0.12em; text-transform:uppercase; margin-bottom:10px;">üå¨Ô∏è Breathwork</div>
    <a href="https://uhs.berkeley.edu/sites/default/files/breathing_exercises_0.pdf" target="_blank" class="meeting-card" style="text-decoration:none; display:flex; margin-bottom:10px;">
      <div class="meeting-left">
        <div style="font-size:1.5rem;">üìÑ</div>
      </div>
      <div style="flex:1;">
        <div class="meeting-title">Breathing Exercises Guide</div>
        <div class="meeting-sub">UC Berkeley Health ‚Äî simple techniques including diaphragmatic & box breathing</div>
      </div>
      <div class="meeting-arr">‚Ä∫</div>
    </a>
    <a href="https://umsonline.org/printerfriendly/pranayama.pdf" target="_blank" class="meeting-card" style="text-decoration:none; display:flex; margin-bottom:10px;">
      <div class="meeting-left">
        <div style="font-size:1.5rem;">üìÑ</div>
      </div>
      <div style="flex:1;">
        <div class="meeting-title">Pranayama & the Art of Breathing</div>
        <div class="meeting-sub">An introduction to yogic breathwork ‚Äî what it is, how it works & techniques to try</div>
      </div>
      <div class="meeting-arr">‚Ä∫</div>
    </a>
    <a href="https://www.artofliving.org/us-en/breathwork/pranayama/breathing-exercises" target="_blank" class="meeting-card" style="text-decoration:none; display:flex; margin-bottom:18px;">
      <div class="meeting-left">
        <div style="font-size:1.5rem;">üåê</div>
      </div>
      <div style="flex:1;">
        <div class="meeting-title">Beginner's Guide to Breathwork</div>
        <div class="meeting-sub">Art of Living ‚Äî 5 techniques to try today with step-by-step instructions</div>
      </div>
      <div class="meeting-arr">‚Ä∫</div>
    </a>
    <!-- MEDITATION -->
    <div style="color:var(--ac); font-size:0.75rem; letter-spacing:0.12em; text-transform:uppercase; margin-bottom:10px;">ü™∑ Meditation</div>
    <a href="https://share.upmc.com/wp-content/uploads/2021/10/HBEAT521847_Mindfulness_MeditationPDF_FNL-1.pdf" target="_blank" class="meeting-card" style="text-decoration:none; display:flex; margin-bottom:10px;">
      <div class="meeting-left">
        <div style="font-size:1.5rem;">üìÑ</div>
      </div>
      <div style="flex:1;">
        <div class="meeting-title">A Beginner's Guide to Mindfulness</div>
        <div class="meeting-sub">UPMC Health ‚Äî what mindfulness is, breathing techniques & how to start today</div>
      </div>
      <div class="meeting-arr">‚Ä∫</div>
    </a>
    <a href="https://chloeyturner.com/wp-content/uploads/2023/04/eBook-Mindfulness-Meditation-for-Beginners-3.pdf" target="_blank" class="meeting-card" style="text-decoration:none; display:flex; margin-bottom:10px;">
      <div class="meeting-left">
        <div style="font-size:1.5rem;">üìÑ</div>
      </div>
      <div style="flex:1;">
        <div class="meeting-title">Simple Guide to Mindfulness Meditation</div>
        <div class="meeting-sub">Covers posture, breathing, attitudes & sitting meditation ‚Äî beginner-friendly eBook</div>
      </div>
      <div class="meeting-arr">‚Ä∫</div>
    </a>
    <a href="https://zenfulspirit.com/wp-content/uploads/2017/07/Meditation-for-Beginners-Book-1.pdf" target="_blank" class="meeting-card" style="text-decoration:none; display:flex; margin-bottom:10px;">
      <div class="meeting-left">
        <div style="font-size:1.5rem;">üìÑ</div>
      </div>
      <div style="flex:1;">
        <div class="meeting-title">Meditation for Beginners</div>
        <div class="meeting-sub">A comprehensive guide ‚Äî how to start, how long to sit & what to expect</div>
      </div>
      <div class="meeting-arr">‚Ä∫</div>
    </a>
    <a href="https://www.nhs.uk/mental-health/self-help/tips-and-support/mindfulness/" target="_blank" class="meeting-card" style="text-decoration:none; display:flex; margin-bottom:10px;">
      <div class="meeting-left">
        <div style="font-size:1.5rem;">üåê</div>
      </div>
      <div style="flex:1;">
        <div class="meeting-title">NHS Mindfulness Guide</div>
        <div class="meeting-sub">Trusted UK resource ‚Äî what mindfulness is, how it helps & free audio exercises</div>
      </div>
      <div class="meeting-arr">‚Ä∫</div>
    </a>
  </div>
  <!-- EVENTS SCREEN -->
  <div class="screen" id="screen-events">
    <div style="margin-bottom:2px;">
      <div style="font-family:'Cormorant Garamond',serif;font-size:1.9rem;font-weight:300;color:var(--ac);">Events</div>
    </div>
    <!-- Floating admin review button - bottom left, above nav -->
    <button id="admin-events-btn" onclick="openAdminPanel()" style="display:none;position:fixed;bottom:80px;left:16px;z-index:500;padding:10px 16px;background:rgba(231,76,60,0.9);border:none;border-radius:24px;color:#fff;font-size:0.75rem;font-weight:700;cursor:pointer;box-shadow:0 4px 16px rgba(231,76,60,0.4);">‚öôÔ∏è Review Pending</button>
    <!-- Floating add button -->
    <button onclick="openSubmitEvent()" style="position:fixed;bottom:80px;right:16px;z-index:500;width:52px;height:52px;border-radius:50%;background:var(--ac);border:none;font-size:1.5rem;color:#1a1208;cursor:pointer;box-shadow:0 4px 16px rgba(232,201,122,0.4);display:flex;align-items:center;justify-content:center;">+</button>
    <div style="font-size:0.62rem;color:var(--tm);letter-spacing:0.08em;text-transform:uppercase;margin-bottom:16px;">Global recovery events</div>
    <!-- SEARCH + MONTH/YEAR -->
    <div style="display:flex;gap:8px;margin-bottom:10px;">
      <input id="ev-search" class="input" type="text" placeholder="üîç Search events..." style="flex:1;margin:0;" oninput="renderEvents()">
      <select id="ev-month-filter" class="input" style="width:110px;margin:0;appearance:none;text-align:center;" onchange="renderEvents()">
        <option value="">Any month</option>
        <option>January</option><option>February</option><option>March</option>
        <option>April</option><option>May</option><option>June</option>
        <option>July</option><option>August</option><option>September</option>
        <option>October</option><option>November</option><option>December</option>
      </select>
      <select id="ev-year-filter" class="input" style="width:80px;margin:0;appearance:none;text-align:center;" onchange="renderEvents()">
        <option value="">Any year</option>
        <option>2025</option><option>2026</option><option>2027</option><option>2028</option>
      </select>
    </div>
    <!-- FILTERS -->
    <div style="display:flex;gap:8px;margin-bottom:16px;overflow-x:auto;padding-bottom:4px;">
      <button onclick="filterEvents('all')" id="ef-all" class="ef-btn ef-active">All</button>
      <button onclick="filterEvents('british-isles')" id="ef-british-isles" class="ef-btn">üá¨üáß British Isles</button>
      <button onclick="filterEvents('europe')" id="ef-europe" class="ef-btn">üá™üá∫ Europe</button>
      <button onclick="filterEvents('north-america')" id="ef-north-america" class="ef-btn">üåé N. America</button>
      <button onclick="filterEvents('latin-america')" id="ef-latin-america" class="ef-btn">üåé Latin America</button>
      <button onclick="filterEvents('asia')" id="ef-asia" class="ef-btn">üåè Asia</button>
      <button onclick="filterEvents('pacific')" id="ef-pacific" class="ef-btn">üåè Pacific</button>
      <button onclick="filterEvents('africa')" id="ef-africa" class="ef-btn">üåç Africa</button>
      <button onclick="filterEvents('worldwide')" id="ef-worldwide" class="ef-btn">üåê Worldwide</button>
    </div>
    <!-- EVENTS LIST -->
    <div id="events-list"></div>
    <div id="events-empty" style="display:none;text-align:center;padding:40px 0;">
      <div style="font-size:2rem;margin-bottom:10px;">üåç</div>
      <div style="font-size:0.84rem;color:var(--tm);">No events yet</div>
      <div style="font-size:0.72rem;color:var(--tm);margin-top:4px;">Be the first to submit one</div>
    </div>
    <div id="events-loading" style="text-align:center;padding:30px 0;color:var(--tm);font-size:0.8rem;">Loading events...</div>
  </div>
  <!-- SUBMIT EVENT MODAL -->
  <div class="modal-overlay" id="submit-event-modal" onclick="closeSubmitEvent(event)">
    <div class="modal-sheet" onclick="event.stopPropagation()" style="max-height:92vh;">
      <div class="modal-title">Submit an Event</div>
      <div style="font-size:0.72rem;color:var(--tm);margin-bottom:14px;">All submissions are reviewed before going live.</div>
      <!-- AI AUTOFILL -->
      <div style="background:rgba(232,201,122,0.08);border:1px solid rgba(232,201,122,0.3);border-radius:12px;padding:14px;margin-bottom:16px;">
        <div style="font-size:0.72rem;font-weight:800;color:var(--ac);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:8px;">‚ú® Auto-fill from URL or Flyer</div>
        <div style="font-size:0.7rem;color:var(--tm);margin-bottom:10px;">Paste a website link or upload a flyer image ‚Äî we'll fill in the details for you</div>
        <input id="ev-autofill-url" class="input" type="url" placeholder="https://event-website.com..." style="margin-bottom:8px;">
        <div style="display:flex;gap:8px;margin-bottom:8px;">
          <button onclick="autofillFromUrl()" style="flex:1;padding:10px;background:var(--ac);border:none;border-radius:10px;color:#1a1208;font-size:0.78rem;font-weight:700;cursor:pointer;">Fill from URL</button>
          <label style="flex:1;padding:10px;background:var(--sf);border:1px solid var(--bd);border-radius:10px;color:var(--ac);font-size:0.78rem;font-weight:700;cursor:pointer;text-align:center;">
            üì∑ Upload Flyer
            <input type="file" id="ev-flyer-upload" accept="image/*" style="display:none;" onchange="autofillFromImage(this)">
          </label>
        </div>
        <div id="ev-autofill-status" style="display:none;font-size:0.82rem;font-weight:700;text-align:center;padding:14px;border-radius:10px;background:#2a2410;border:2px solid #e8c97a;color:#e8c97a;margin-top:4px;"></div>
      </div>
      <!-- FLYER PREVIEW -->
      <div id="ev-flyer-preview-wrap" style="display:none;margin-bottom:14px;">
        <img id="ev-flyer-preview" style="width:100%;border-radius:10px;max-height:200px;object-fit:cover;">
      </div>
      <div class="modal-label">Event Name *</div>
      <input id="ev-name" class="input" type="text" placeholder="e.g. European Convention 2025">
      <div class="modal-label">Type</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px;">
        <div class="role-btn" onclick="selectEvType(this,'Convention')">üèõÔ∏è Convention</div>
        <div class="role-btn" onclick="selectEvType(this,'Marathon')">‚è±Ô∏è Marathon</div>
        <div class="role-btn" onclick="selectEvType(this,'Speaker Meeting')">üé§ Speaker</div>
        <div class="role-btn" onclick="selectEvType(this,'Workshop')">üìö Workshop</div>
        <div class="role-btn" onclick="selectEvType(this,'Other')">‚ú® Other</div>
      </div>
      <div class="modal-label">Date *</div>
      <input id="ev-date" class="input" type="date">
      <div class="modal-label">End Date (if multi-day)</div>
      <input id="ev-enddate" class="input" type="date">
      <div class="modal-label">Location / Venue *</div>
      <input id="ev-location" class="input" type="text" placeholder="e.g. Birmingham, UK">
      <div class="modal-label">Country *</div>
      <select id="ev-country" class="input" style="appearance:none;">
        <option value="">Select country...</option>
        <optgroup label="üá¨üáß British Isles">
          <option>UK</option><option>Ireland</option>
        </optgroup>
        <optgroup label="üåç Europe">
          <option>Austria</option><option>Belgium</option><option>Croatia</option>
          <option>Czech Republic</option><option>Denmark</option><option>Finland</option>
          <option>France</option><option>Germany</option><option>Greece</option>
          <option>Hungary</option><option>Iceland</option><option>Italy</option>
          <option>Luxembourg</option><option>Malta</option><option>Netherlands</option>
          <option>Norway</option><option>Poland</option><option>Portugal</option>
          <option>Romania</option><option>Russia</option><option>Serbia</option>
          <option>Slovakia</option><option>Slovenia</option><option>Spain</option>
          <option>Sweden</option><option>Switzerland</option><option>Turkey</option>
          <option>Ukraine</option>
        </optgroup>
        <optgroup label="üåé North America">
          <option>USA</option><option>Canada</option><option>Mexico</option>
        </optgroup>
        <optgroup label="üåé Latin America &amp; Caribbean">
          <option>Argentina</option><option>Brazil</option><option>Chile</option>
          <option>Colombia</option><option>Costa Rica</option><option>Cuba</option>
          <option>Ecuador</option><option>Jamaica</option><option>Panama</option>
          <option>Peru</option><option>Puerto Rico</option><option>Uruguay</option>
          <option>Venezuela</option>
        </optgroup>
        <optgroup label="üåè Asia">
          <option>Bahrain</option><option>China</option><option>Hong Kong</option>
          <option>India</option><option>Indonesia</option><option>Israel</option>
          <option>Japan</option><option>Jordan</option><option>Kuwait</option>
          <option>Lebanon</option><option>Malaysia</option><option>Nepal</option>
          <option>Oman</option><option>Pakistan</option><option>Philippines</option>
          <option>Qatar</option><option>Saudi Arabia</option><option>Singapore</option>
          <option>South Korea</option><option>Sri Lanka</option><option>Taiwan</option>
          <option>Thailand</option><option>UAE</option><option>Vietnam</option>
        </optgroup>
        <optgroup label="üåè Pacific">
          <option>Australia</option><option>Bali</option><option>Fiji</option>
          <option>New Zealand</option><option>Papua New Guinea</option>
        </optgroup>
        <optgroup label="üåç Africa">
          <option>Egypt</option><option>Ghana</option><option>Kenya</option>
          <option>Morocco</option><option>Nigeria</option><option>South Africa</option>
          <option>Tanzania</option><option>Uganda</option><option>Zimbabwe</option>
        </optgroup>
        <optgroup label="üåê Other">
          <option>Worldwide</option><option>Other</option>
        </optgroup>
      </select>
      <div class="modal-label">Website / Booking Link</div>
      <input id="ev-url" class="input" type="url" placeholder="https://...">
      <div class="modal-label">Flyer Image URL</div>
      <input id="ev-flyer" class="input" type="url" placeholder="Link to flyer image (optional)">
      <div style="font-size:0.68rem;color:var(--tm);margin-top:-8px;margin-bottom:14px;">Upload your flyer to Imgur or Google Drive and paste the link here</div>
      <div class="modal-label">Description</div>
      <textarea id="ev-desc" class="input" style="min-height:80px;resize:vertical;" placeholder="Tell people about the event..."></textarea>
      <div style="display:flex;gap:8px;margin-top:16px;">
        <button onclick="closeSubmitEventDirect()" style="flex:1;padding:13px;border:1px solid var(--bd);border-radius:var(--r);background:transparent;color:var(--tm);cursor:pointer;">Cancel</button>
        <button onclick="submitEvent()" class="btn" style="flex:2;margin-top:0;">Submit for Review</button>
      </div>
      <div id="ev-submit-msg" style="display:none;margin-top:12px;font-size:0.78rem;text-align:center;color:#5fcf80;">‚úì Submitted! We'll review it shortly.</div>
    </div>
  </div>
  <!-- EVENT DETAIL MODAL -->
  <div class="modal-overlay" id="event-detail-modal" onclick="closeEventDetail(event)">
    <div class="modal-sheet" onclick="event.stopPropagation()" style="max-height:92vh;">
      <div id="event-detail-content"></div>
      <button onclick="closeEventDetailDirect()" style="width:100%;margin-top:12px;padding:13px;border:1px solid var(--bd);border-radius:var(--r);background:transparent;color:var(--tm);cursor:pointer;">Close</button>
    </div>
  </div>
  <!-- ADMIN PANEL MODAL -->
  <div class="modal-overlay" id="admin-modal" onclick="closeAdminModal(event)">
    <div class="modal-sheet" onclick="event.stopPropagation()" style="max-height:92vh;">
      <div class="modal-title">&#x1F6E1; Admin Panel</div>
      <div style="background:rgba(232,201,122,0.08);border:1px solid rgba(232,201,122,0.2);border-radius:var(--r);padding:14px;margin-bottom:16px;">
        <div style="font-size:0.65rem;font-weight:800;color:var(--ac);text-transform:uppercase;letter-spacing:0.08em;margin-bottom:8px;">üåê Bulk Import from Website</div>
        <div style="font-size:0.75rem;color:var(--tm);margin-bottom:10px;">Paste a URL from an events calendar ‚Äî AI will extract all events at once</div>
        <input id="bulk-import-url" class="input" type="url" placeholder="https://ukna.org/events..." style="margin-bottom:8px;">
        <button onclick="bulkImportEvents()" id="bulk-import-btn" style="width:100%;padding:11px;background:var(--ac);border:none;border-radius:var(--r);color:#1a1208;font-weight:700;cursor:pointer;font-size:0.82rem;">ü§ñ Import Events with AI</button>
        <div id="bulk-import-status" style="display:none;font-size:0.82rem;font-weight:700;text-align:center;padding:14px;border-radius:10px;background:#2a2410;border:2px solid #e8c97a;color:#e8c97a;margin-top:8px;"></div>
      </div>
      <!-- DEDUPE TOOL -->
      <div style="background:#1a0a0a;border:2px solid #e74c3c;border-radius:var(--r);padding:14px;margin-bottom:16px;">
        <div style="font-size:0.65rem;font-weight:800;color:#e74c3c;text-transform:uppercase;letter-spacing:0.08em;margin-bottom:6px;">üßπ Remove Duplicates</div>
        <div style="font-size:0.72rem;color:var(--tm);margin-bottom:10px;">Find and remove duplicate events with the same name and date</div>
        <button onclick="findAndRemoveDuplicates()" id="dedupe-btn" style="width:100%;padding:11px;background:#e74c3c;border:none;border-radius:var(--r);color:#fff;font-size:0.82rem;font-weight:700;cursor:pointer;">üîç Find &amp; Remove Duplicates</button>
        <div id="dedupe-status" style="display:none;font-size:0.82rem;font-weight:700;text-align:center;padding:14px;border-radius:10px;background:#2a2410;border:2px solid #e8c97a;color:#e8c97a;margin-top:8px;"></div>
        <div id="dedupe-list" style="margin-top:10px;"></div>
      </div>
      <div style="font-size:0.65rem;font-weight:800;color:var(--ac);text-transform:uppercase;letter-spacing:0.08em;margin-bottom:10px;">‚è≥ Pending Approval</div>
      <div id="admin-pending-list"></div>
      <button onclick="closeAdminModalDirect()" style="width:100%;margin-top:12px;padding:13px;border:1px solid var(--bd);border-radius:var(--r);background:transparent;color:var(--tm);cursor:pointer;">Close</button>
    </div>
  </div>
  <!-- NETWORK SCREEN -->
  <div class="screen" id="screen-network">
    <!-- Header -->
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
      <div style="font-family:'Cormorant Garamond',serif;font-size:1.9rem;font-weight:300;color:var(--ac);">Network</div>
      <button onclick="openEditProfile()" style="padding:8px 14px;background:rgba(232,201,122,0.1);border:1px solid rgba(232,201,122,0.3);border-radius:20px;color:var(--ac);font-size:0.75rem;font-weight:600;cursor:pointer;">‚úèÔ∏è My Profile</button>
    </div>
    <!-- Tabs -->
    <div style="display:flex;gap:8px;margin-bottom:16px;">
      <button id="net-tab-discover" onclick="switchNetTab('discover')" style="flex:1;padding:9px;border-radius:20px;border:none;background:var(--ac);color:#1a1208;font-weight:700;font-size:0.78rem;cursor:pointer;">üåê Discover</button>
      <button id="net-tab-connections" onclick="switchNetTab('connections')" style="flex:1;padding:9px;border-radius:20px;border:1px solid var(--bd);background:transparent;color:var(--tm);font-size:0.78rem;cursor:pointer;">ü§ù Connections</button>
      <button id="net-tab-requests" onclick="switchNetTab('requests')" style="flex:1;padding:9px;border-radius:20px;border:1px solid var(--bd);background:transparent;color:var(--tm);font-size:0.78rem;cursor:pointer;">üì¨ Requests <span id="net-req-badge" style="display:none;background:#e74c3c;color:#fff;border-radius:10px;padding:1px 5px;font-size:0.6rem;"></span></button>
    </div>
    <div id="net-content"></div>
  </div>
  --ac);margin-bottom:4px;">My Account</div>
    <div style="font-size:0.62rem;color:var(--tm);letter-spacing:0.08em;text-transform:uppercase;margin-bottom:24px;">Profile & Settings</div>
    <div id="account-screen-content"></div>
  </div>
  <!-- NAV -->
  <nav>
    <div class="nav-item active" id="nav-home" onclick="showScreen('home')">
      <div class="nav-icon">&#x1F3E0;</div>
      <div>Home</div>
    </div>
    <div class="nav-item" id="nav-journal" onclick="showScreen('journal')">
      <div class="nav-icon">&#x270D;</div>
      <div>Journal</div>
    </div>
    <div class="nav-item" id="nav-steps" onclick="showScreen('steps')">
      <div class="nav-icon">&#x1F4D6;</div>
      <div>Worksheets</div>
    </div>
    <div class="nav-item" id="nav-books" onclick="showScreen('books')">
      <div class="nav-icon">&#x1F4DA;</div>
      <div>Books</div>
    </div>
    <div class="nav-item" id="nav-meetings" onclick="showScreen('meetings')">
      <div class="nav-icon">&#x1F5D3;</div>
      <div>Meetings</div>
    </div>
    <div class="nav-item" id="nav-network" onclick="showScreen('network')">
      <div class="nav-icon">ü§ù</div>
      <div>Network</div>
    </div>
    <div class="nav-item" id="nav-events" onclick="showScreen('events')">
      <div class="nav-icon">&#x1F30D;</div>
      <div>Events</div>
    </div>
    <div class="nav-item" id="nav-resources" onclick="showScreen('resources')">
      <div class="nav-icon">üèÉ</div>
      <div>Movement</div>
    </div>
  </nav>
</div><!-- end app -->
<div id="toast"></div>
<script>
var AI_PROXY = "https://clarelivingapp.clare-monahan.workers.dev";
var QUOTES = [
  {text: "Just for today, I will try to live through this day only.", source: "Just for Today"},
  {text: "We admitted we were powerless over our addiction.", source: "Step One"},
  {text: "The foundation of recovery is honesty.", source: "Basic Text"},
  {text: "Recovery is a process, not an event.", source: "Fellowship"},
  {text: "Keep coming back - it works if you work it.", source: "Fellowship"},
  {text: "One day at a time.", source: "Fellowship"},
  {text: "We do not have to be alone anymore.", source: "Basic Text"},
  {text: "Pain is inevitable; suffering is optional.", source: "Fellowship"},
  {text: "We will love and support you no matter what.", source: "Fellowship"},
  {text: "God, grant me the serenity to accept the things I cannot change.", source: "Serenity Prayer"}
];
// --- STATE ---
var cleanDate = localStorage.getItem('na_clean_date') || '';
var moodLog   = JSON.parse(localStorage.getItem('na_mood_log')  || '[]');
// --- NAVIGATION ---
function showScreen(name) {
  // No membership gate during testing
  document.querySelectorAll('.screen').forEach(function(s) { s.classList.remove('active'); });
  document.querySelectorAll('.nav-item').forEach(function(n) { n.classList.remove('active'); });
  document.getElementById('screen-' + name).classList.add('active');
  var navItem = document.getElementById('nav-' + name);
  if (navItem) navItem.classList.add('active');
  if (name === 'meetings') { renderSavedMeetings(); }
  if (name === 'home') { loadHomeCalendar(); }
  if (name === 'account') { renderAccountScreen(); }
  if (name === 'my-events') { renderMyEvents(); }
  if (name === 'network') {
    loadNetwork();
  }
  if (name === 'events') {
    loadEvents();
  }
  if (name === 'network') {
    loadNetwork();
  }
}
// --- CLEAN DATE ---
function saveCleanDate(val) {
  cleanDate = val;
  localStorage.setItem('na_clean_date', val);
  updateDaysCount();
}
function updateDaysCount() {
  if (!cleanDate) { document.getElementById('days-count').textContent = '0'; return; }
  var start = new Date(cleanDate);
  var today = new Date();
  var days = Math.floor((today - start) / 86400000);
  if (days < 0) days = 0;
  document.getElementById('days-count').textContent = days;
  var label = days === 1 ? '1 day clean' : days + ' days clean';
  document.getElementById('clean-date-label').textContent = label;
}
// --- MOOD ---
function setMood(mood) {
  var today = new Date().toISOString().split('T')[0];
  moodLog = moodLog.filter(function(m) { return m.date !== today; });
  moodLog.push({ date: today, mood: mood });
  if (moodLog.length > 30) moodLog = moodLog.slice(-30);
  localStorage.setItem('na_mood_log', JSON.stringify(moodLog));
  document.querySelectorAll('.mood-btn').forEach(function(b) { b.classList.remove('selected'); });
  document.getElementById('mood-' + mood).classList.add('selected');
  renderMoodHistory();
  toast('Mood saved');
}
function renderMoodHistory() {
  var emojis = { sad: '&#x1F614;', meh: '&#x1F610;', good: '&#x1F642;', great: '&#x1F60A;', wow: '&#x1F31F;' };
  var recent = moodLog.slice(-7);
  if (!recent.length) { document.getElementById('mood-history').innerHTML = ''; return; }
  var html = '<div style="font-size:0.62rem; color:var(--tm); margin-bottom:4px;">Recent</div><div style="display:flex; gap:5px;">';
  recent.forEach(function(m) {
    html += '<div style="text-align:center;"><div style="font-size:1rem;">' + (emojis[m.mood] || '') + '</div><div style="font-size:0.5rem; color:var(--tm);">' + m.date.slice(5) + '</div></div>';
  });
  html += '</div>';
  document.getElementById('mood-history').innerHTML = html;
}
function markTodayMood() {
  var today = new Date().toISOString().split('T')[0];
  var entry = moodLog.find(function(m) { return m.date === today; });
  if (entry) {
    document.getElementById('mood-' + entry.mood).classList.add('selected');
  }
}
// --- DAILY QUOTE ---
function showDailyQuote() {
  var q = QUOTES[new Date().getDate() % QUOTES.length];
  document.getElementById('daily-quote').innerHTML =
    '"' + q.text + '"<div style="font-size:0.7rem; color:var(--tm); margin-top:6px;">-- ' + q.source + '</div>';
}
// --- TOAST ---
function toast(msg) {
  var t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(function() { t.classList.remove('show'); }, 2000);
}
// --- JOURNAL DATA ---
var journalEntries = JSON.parse(localStorage.getItem('na_journal') || '[]');
var currentJournalId = null;
var currentJournalType = null;
var JOURNAL_TYPES = {
  gratitude: { title: 'Gratitude List', emoji: '&#x1F64F;' },
  spotcheck: { title: 'Spot Check Inventory', emoji: '&#x26A1;' },
  step10:    { title: 'Full Step 10 Inventory', emoji: '&#x1F4CB;' },
  guiding:   { title: 'Guiding Principles', emoji: '&#x1F4D6;' },
  daily:     { title: 'Daily Journal', emoji: '&#x270D;' }
};
var GRATITUDE_PROMPTS = [
  "What's something small that made you smile today?",
  "Who has shown up for you recently, however small?",
  "What's one thing about your body you're grateful for?",
  "Name something you often take for granted.",
  "What's a quality in yourself you appreciate?",
  "Describe a moment of peace you felt recently.",
  "What does having another clean day mean to you?",
  "Who in recovery are you grateful for, and why?",
  "What's something in your home or surroundings you appreciate?",
  "Write about a challenge that helped you grow."
];
var SPOTCHECK_PROMPTS = [
  "Have I been resentful, selfish, dishonest or afraid today?",
  "Do I owe an apology to anyone?",
  "Have I kept something to myself that I should share with my sponsor?",
  "Was I kind and loving to those around me?",
  "Am I HALT right now ‚Äî Hungry, Angry, Lonely, or Tired?",
  "Did I stay in the present, or was I in yesterday or tomorrow?",
  "What do I need to let go of before I sleep?",
  "Did I do anything today I'm proud of?"
];
var STEP10_QUESTIONS = [
  "Have I taken time today to reconnect with my Higher Power?",
  "Did I seek spiritual guidance today, and if so, how?",
  "How have I been of service to others today?",
  "What am I grateful for that my Higher Power has given me today?",
  "Do I trust that my Higher Power can guide me toward a better way of living?",
  "Have any old patterns or behaviours shown up for me today?",
  "Have I been resentful, selfish, dishonest, or afraid at any point today?",
  "Did I set myself up for disappointment or unrealistic expectations?",
  "Was I kind and loving in my interactions with others today?",
  "Have I been living in the past or the future rather than the present?",
  "Did I allow myself to become obsessed or fixated on anything today?",
  "Have I let myself get too hungry, angry, lonely, or tired today?",
  "Am I taking myself or any situation too seriously right now?",
  "Are there any physical, mental, or spiritual struggles I need to address?",
  "Is there anything I've been keeping from my sponsor that I should share?",
  "Did I experience any intense or overwhelming feelings today ‚Äî what caused them?",
  "What areas of my life are causing me difficulty right now?",
  "Which character defects showed up in my behaviour today, and how?",
  "Did fear play a role in any of my actions or thoughts today?",
  "Is there anything I did today that I regret or wish I had handled differently?",
  "Is there anything I didn't do today that I know I should have?",
  "Am I genuinely open and willing to change?",
  "Was there conflict in any of my relationships today ‚Äî what happened?",
  "Am I living with integrity in how I treat the people around me?",
  "Did I cause harm ‚Äî directly or indirectly ‚Äî to myself or anyone else today?",
  "Do I owe an apology or amends to anyone?",
  "Where did I go wrong today, and what would I do differently next time?",
  "Did I stay clean today?",
  "Was I compassionate and caring toward myself today?",
  "What feelings did I experience today, and how did I let them guide my choices?",
  "What did I do today to be of service to another person?",
  "What am I feeling good or positive about from today?",
  "What gave me a sense of meaning or satisfaction today?",
  "What did I do today that I want to make sure I repeat?",
  "Did I connect with the fellowship today ‚Äî a meeting, a phone call, a message?",
  "What do I have to be grateful for today?"
];
var DAILY_PROMPTS = [
  "How am I feeling right now ‚Äî honestly?",
  "What was the most important moment of my day?",
  "Did anything challenge me today? How did I respond?",
  "Was there a moment today I'm proud of?",
  "What emotions came up for me today, and what triggered them?",
  "Did I show up the way I wanted to today?",
  "What do I want to carry into tomorrow?",
  "How did my relationships feel today?",
  "What is something I need to let go of?",
  "What would I do differently if I could?"
];
function openJournal(type) {
  currentJournalId = null;
  currentJournalType = type;
  var info = JOURNAL_TYPES[type];
  document.getElementById('j-home').style.display = 'none';
  document.getElementById('j-write').style.display = 'block';
  document.getElementById('j-write-title').innerHTML = info.emoji + ' ' + info.title;
  document.getElementById('j-write-date').textContent = new Date().toLocaleDateString('en-GB', {weekday:'long', day:'numeric', month:'long', year:'numeric'});
  document.getElementById('j-text').value = '';
  document.getElementById('j-delete-btn').style.display = 'none';
  renderJournalPrompts(type);
  document.getElementById('j-text').focus();
}
function renderJournalPrompts(type) {
  var area = document.getElementById('j-prompts');
  var html = '<div style="background:rgba(232,201,122,0.07);border:1px solid rgba(232,201,122,0.18);border-radius:14px;padding:14px;margin-bottom:12px;">';
  if (type === 'gratitude') {
    var prompts = GRATITUDE_PROMPTS.slice().sort(function(){return Math.random()-.5;}).slice(0,3);
    html += '<div style="font-size:0.68rem;font-weight:800;color:var(--ac);text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px;">&#x1F64F; Prompts to get you started</div>';
    html += '<div style="font-size:0.74rem;color:var(--tm);margin-bottom:8px;font-style:italic;">Use one, some, or all ‚Äî or just write freely.</div>';
    prompts.forEach(function(p, i) {
      html += '<div style="padding:7px 0;' + (i < prompts.length-1 ? 'border-bottom:1px solid var(--bd);' : '') + 'font-size:0.8rem;color:var(--tx);">&#x2022; ' + p + '</div>';
    });
    html += '<button onclick="renderJournalPrompts(\'gratitude\')" style="margin-top:10px;background:none;border:1px solid var(--bd);border-radius:8px;padding:5px 12px;font-size:0.7rem;color:var(--tm);cursor:pointer;">&#8635; New prompts</button>';
  } else if (type === 'spotcheck') {
    html += '<div style="font-size:0.68rem;font-weight:800;color:var(--ac);text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px;">&#x26A1; Spot Check ‚Äî pause and be honest</div>';
    html += '<div style="font-size:0.74rem;color:var(--tm);margin-bottom:10px;font-style:italic;">Sit with these questions, then write freely below.</div>';
    SPOTCHECK_PROMPTS.forEach(function(p, i) {
      html += '<div style="padding:6px 0;' + (i < SPOTCHECK_PROMPTS.length-1 ? 'border-bottom:1px solid var(--bd);' : '') + 'font-size:0.78rem;color:var(--tm);">&#x2022; ' + p + '</div>';
    });
  } else if (type === 'step10') {
    html += '<div style="font-size:0.68rem;font-weight:800;color:var(--ac);text-transform:uppercase;letter-spacing:.06em;margin-bottom:6px;">&#x1F4CB; Full Step 10 ‚Äî work through each question</div>';
    STEP10_QUESTIONS.forEach(function(p, i) {
      html += '<div style="padding:7px 0;' + (i < STEP10_QUESTIONS.length-1 ? 'border-bottom:1px solid var(--bd);' : '') + 'font-size:0.8rem;color:var(--tx);"><span style="color:var(--ac);font-weight:700;">' + (i+1) + '.</span> ' + p + '</div>';
    });
  } else if (type === 'guiding') {
    html += '<div style="font-size:0.68rem;font-weight:800;color:var(--ac);text-transform:uppercase;letter-spacing:.06em;margin-bottom:6px;">&#x1F4D6; Guiding Principles ‚Äî work through each question</div>';
    CUSTOM_GUIDING_QUESTIONS.forEach(function(p, i) {
      html += '<div style="padding:7px 0;' + (i < CUSTOM_GUIDING_QUESTIONS.length-1 ? 'border-bottom:1px solid var(--bd);' : '') + 'font-size:0.8rem;color:var(--tx);"><span style="color:var(--ac);font-weight:700;">' + (i+1) + '.</span> ' + p + '</div>';
    });
  } else if (type === 'daily') {
    var prompts = DAILY_PROMPTS.slice().sort(function(){return Math.random()-.5;}).slice(0,3);
    html += '<div style="font-size:0.68rem;font-weight:800;color:var(--ac);text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px;">&#x270D; Prompts for today</div>';
    html += '<div style="font-size:0.74rem;color:var(--tm);margin-bottom:8px;font-style:italic;">Write freely ‚Äî these are just here to help you start.</div>';
    prompts.forEach(function(p, i) {
      html += '<div style="padding:7px 0;' + (i < prompts.length-1 ? 'border-bottom:1px solid var(--bd);' : '') + 'font-size:0.8rem;color:var(--tx);">&#x2022; ' + p + '</div>';
    });
    html += '<button onclick="renderJournalPrompts(\'daily\')" style="margin-top:10px;background:none;border:1px solid var(--bd);border-radius:8px;padding:5px 12px;font-size:0.7rem;color:var(--tm);cursor:pointer;">&#8635; New prompts</button>';
  }
  html += '</div>';
  area.innerHTML = html;
}
function usePrompt(prompt) {
  var ta = document.getElementById('j-text');
  if (!ta.value.trim()) {
    ta.value = prompt + '\n\n';
  } else {
    ta.value += '\n\n' + prompt + '\n\n';
  }
  ta.focus();
  ta.setSelectionRange(ta.value.length, ta.value.length);
}
function saveJournal() {
  var text = document.getElementById('j-text').value.trim();
  if (!text) { alert('Please write something first.'); return; }
  if (currentJournalId) {
    var idx = journalEntries.findIndex(function(e){ return e.id === currentJournalId; });
    if (idx > -1) { journalEntries[idx].text = text; }
  } else {
    journalEntries.push({ id: Date.now().toString(), date: new Date().toISOString(), type: currentJournalType, text: text });
  }
  localStorage.setItem('na_journal', JSON.stringify(journalEntries));
  toast('Entry saved \u2713');
  closeJournal();
}
function deleteJournal() {
  if (!currentJournalId) return;
  journalEntries = journalEntries.filter(function(e){ return e.id !== currentJournalId; });
  localStorage.setItem('na_journal', JSON.stringify(journalEntries));
  closeJournal();
}
function closeJournal() {
  document.getElementById('j-write').style.display = 'none';
  document.getElementById('j-home').style.display = 'block';
  renderJournalEntries();
}
function openJournalEntry(id) {
  var entry = journalEntries.find(function(e){ return e.id === id; });
  if (!entry) return;
  currentJournalId = id;
  currentJournalType = entry.type || 'daily';
  var info = JOURNAL_TYPES[currentJournalType] || JOURNAL_TYPES.daily;
  document.getElementById('j-home').style.display = 'none';
  document.getElementById('j-write').style.display = 'block';
  document.getElementById('j-write-title').innerHTML = info.emoji + ' ' + info.title;
  document.getElementById('j-write-date').textContent = new Date(entry.date).toLocaleDateString('en-GB', {weekday:'long', day:'numeric', month:'long', year:'numeric'});
  document.getElementById('j-text').value = entry.text;
  document.getElementById('j-delete-btn').style.display = 'block';
  renderJournalPrompts(currentJournalType);
}
function renderJournalEntries() {
  var c = document.getElementById('j-entries');
  if (!journalEntries.length) {
    c.innerHTML = '<div style="text-align:center;padding:20px 0;font-size:0.8rem;color:var(--tm);">No entries yet ‚Äî choose a type above to begin.</div>';
    return;
  }
  var emojis = { gratitude:'&#x1F64F;', spotcheck:'&#x26A1;', step10:'&#x1F4CB;', daily:'&#x270D;' };
  c.innerHTML = '';
  journalEntries.slice().reverse().forEach(function(e) {
    var dt = new Date(e.date).toLocaleDateString('en-GB', {weekday:'short', day:'numeric', month:'short'});
    var emoji = emojis[e.type] || '&#x270D;';
    var info = JOURNAL_TYPES[e.type] || JOURNAL_TYPES.daily;
    var preview = e.text.slice(0, 80) + (e.text.length > 80 ? '...' : '');
    // Wrapper holds card + red delete panel
    var wrap = document.createElement('div');
    wrap.className = 'j-entry-wrap';
    // Red delete panel behind
    var delPanel = document.createElement('div');
    delPanel.className = 'j-delete-reveal';
    delPanel.textContent = 'DELETE';
    (function(id, w, card) {
      delPanel.onclick = function() {
        journalEntries = journalEntries.filter(function(x) { return x.id !== id; });
        localStorage.setItem('na_journal', JSON.stringify(journalEntries));
        renderJournalEntries();
        toast('Entry deleted');
      };
    })(e.id, wrap);
    // Card on top
    var card = document.createElement('div');
    card.className = 'j-entry-card';
    card.style.background = 'var(--sf)';
    card.style.border = '1px solid var(--bd)';
    card.style.borderRadius = 'var(--r)';
    card.style.padding = '12px 14px';
    var topRow = document.createElement('div');
    topRow.style.cssText = 'display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;';
    var dateEl = document.createElement('div');
    dateEl.style.cssText = 'font-size:0.72rem;color:var(--tm);';
    dateEl.textContent = dt;
    var tag = document.createElement('div');
    tag.style.cssText = 'font-size:0.62rem;background:rgba(232,201,122,0.1);border:1px solid var(--bd);border-radius:20px;padding:2px 8px;color:var(--ac);';
    tag.innerHTML = emoji + ' ' + info.title;
    topRow.appendChild(dateEl);
    topRow.appendChild(tag);
    var previewEl = document.createElement('div');
    previewEl.style.cssText = 'font-size:0.78rem;color:var(--tx);';
    previewEl.textContent = preview;
    card.appendChild(topRow);
    card.appendChild(previewEl);
    // Swipe logic
    var startX = 0;
    var startY = 0;
    var swiped = false;
    card.addEventListener('touchstart', function(ev) {
      startX = ev.touches[0].clientX;
      startY = ev.touches[0].clientY;
      swiped = false;
    }, {passive: true});
    card.addEventListener('touchmove', function(ev) {
      var dx = ev.touches[0].clientX - startX;
      var dy = ev.touches[0].clientY - startY;
      if (Math.abs(dy) > Math.abs(dx)) return; // vertical scroll
      if (dx < 0) {
        var x = Math.max(dx, -80);
        card.style.transition = 'none';
        card.style.transform = 'translateX(' + x + 'px)';
        swiped = true;
      } else if (dx > 0 && swiped) {
        card.style.transition = 'none';
        card.style.transform = 'translateX(0)';
      }
    }, {passive: true});
    card.addEventListener('touchend', function(ev) {
      var dx = ev.changedTouches[0].clientX - startX;
      card.style.transition = 'transform 0.2s ease';
      if (dx < -50) {
        card.style.transform = 'translateX(-80px)';
        swiped = true;
      } else {
        card.style.transform = 'translateX(0)';
        swiped = false;
        // Only open if it was a tap not a swipe
        if (Math.abs(dx) < 10) {
          (function(id){ openJournalEntry(id); })(e.id);
        }
      }
    });
    // Click to open on desktop
    card.addEventListener('click', function(ev) {
      if (!swiped) {
        (function(id){ openJournalEntry(id); })(e.id);
      }
    });
    wrap.appendChild(delPanel);
    wrap.appendChild(card);
    c.appendChild(wrap);
  });
}
// =====================
// MAP
// =====================
// Uses Google Maps static embed - no external library needed
function initNetMap() {
  renderNetMap();
}
function geocodeAndPlot() {
  renderNetMap();
}
function renderNetMap() {
  var el = document.getElementById('net-map');
  if (!el) return;
  var contacts = networkContacts.filter(function(c){ return c.location; });
  if (!contacts.length) {
    el.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--tm);font-size:0.78rem;">Add contact locations to see them on the map</div>';
    return;
  }
  // Build Google Maps embed URL with multiple markers
  var roleColours = {
    'Sponsor': 'red',
    'Sponsee': 'green',
    'Sponsor Sister': 'green',
    'Sponsor Brother': 'green',
    'Friend in Recovery': 'yellow'
  };
  var markers = contacts.map(function(c) {
    var colour = roleColours[c.role] || 'blue';
    return 'markers=color:' + colour + '%7Clabel:' + encodeURIComponent((c.name || 'C')[0].toUpperCase()) + '%7C' + encodeURIComponent(c.location);
  }).join('&');
  var src = 'https://maps.googleapis.com/maps/api/staticmap?size=600x220&scale=2&maptype=roadmap&style=element:geometry%7Ccolor:0x1a1a2e&style=element:labels.text.fill%7Ccolor:0xe8c97a&' + markers + '&key=AIzaSyD-placeholder';
  // Use OpenStreetMap embed instead - no API key needed
  // Build a simple iframe with the first contact location as centre
  var firstLocation = encodeURIComponent(contacts[0].location);
  var iframeSrc = 'https://www.openstreetmap.org/export/embed.html?bbox=-10,49,2,61&layer=mapnik&marker=' + firstLocation;
  // Actually use a much simpler approach - clickable map link with contact list as pins
  el.innerHTML = '';
  // Show a styled list of contacts with location as clickable map links
  var wrap = document.createElement('div');
  wrap.style.cssText = 'padding:10px;height:220px;overflow-y:auto;';
  var title = document.createElement('div');
  title.style.cssText = 'font-size:0.62rem;font-weight:800;color:var(--ac);text-transform:uppercase;letter-spacing:0.08em;margin-bottom:8px;';
  title.textContent = 'Your Network Locations';
  wrap.appendChild(title);
  contacts.forEach(function(c) {
    var colour = { 'Sponsor':'#e74c3c','Sponsee':'#2ecc71','Sponsor Sister':'#2ecc71','Sponsor Brother':'#2ecc71','Friend in Recovery':'#f1c40f' }[c.role] || '#e8c97a';
    var row = document.createElement('div');
    row.style.cssText = 'display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.06);cursor:pointer;';
    var dot = document.createElement('div');
    dot.style.cssText = 'width:10px;height:10px;border-radius:50%;background:' + colour + ';flex-shrink:0;';
    row.appendChild(dot);
    var info = document.createElement('div');
    info.style.cssText = 'flex:1;';
    info.innerHTML = '<div style="font-size:0.8rem;font-weight:600;">' + c.name + '</div><div style="font-size:0.68rem;color:var(--tm);">' + c.location + '</div>';
    row.appendChild(info);
    var mapBtn = document.createElement('a');
    var ua = navigator.userAgent;
    if (/iPhone|iPad|iPod/.test(ua)) {
      mapBtn.href = 'https://maps.apple.com/?q=' + encodeURIComponent(c.location);
    } else {
      mapBtn.href = 'https://www.google.com/maps/search/' + encodeURIComponent(c.location);
    }
    mapBtn.target = '_blank';
    mapBtn.style.cssText = 'font-size:0.62rem;color:var(--ac);padding:4px 8px;border:1px solid rgba(232,201,122,0.3);border-radius:10px;text-decoration:none;white-space:nowrap;';
    mapBtn.textContent = 'Open Map';
    row.appendChild(mapBtn);
    wrap.appendChild(row);
  });
  el.appendChild(wrap);
}
// =====================
// NETWORK
// =====================
var myProfile = null;
var allProfiles = [];
var myConnections = [];
var pendingRequests = [];
var currentNetTab = 'discover';
async function loadNetwork() {
  if (!currentUser || !supa) return;
  await loadMyProfile();
  await Promise.all([loadMembers(), loadConnections(), loadRequests()]);
  checkProfileBanner();
  renderNetTab(currentNetTab);
}
async function loadMyProfile() {
  var res = await supa.from('profiles').select('*').eq('id', currentUser.id).single();
  myProfile = res.data || null;
}
async function loadMembers() {
  var res = await supa.from('profiles').select('*').neq('id', currentUser.id);
  allProfiles = res.data || [];
}
async function loadConnections() {
  var res = await supa.from('connections').select('*').or('requester_id.eq.' + currentUser.id + ',receiver_id.eq.' + currentUser.id).eq('status','accepted');
  myConnections = res.data || [];
}
async function loadRequests() {
  var res = await supa.from('connections').select('*').eq('receiver_id', currentUser.id).eq('status','pending');
  pendingRequests = res.data || [];
  var badge = document.getElementById('net-requests-badge');
  if (badge) {
    badge.style.display = pendingRequests.length ? 'inline' : 'none';
    badge.textContent = pendingRequests.length;
  }
}
function checkProfileBanner() {
  var banner = document.getElementById('net-profile-banner');
  if (banner) banner.style.display = !myProfile || !myProfile.username ? 'block' : 'none';
}
function netShowTab(tab) {
  currentNetTab = tab;
  ['discover','connections','requests'].forEach(function(t) {
    var btn = document.getElementById('net-tab-' + t);
    var cont = document.getElementById('net-tab-' + t + '-content');
    if (btn) {
      btn.style.background = t === tab ? 'var(--ac)' : 'transparent';
      btn.style.color = t === tab ? '#1a1208' : 'var(--tm)';
      btn.style.borderColor = t === tab ? 'var(--ac)' : 'var(--bd)';
    }
    if (cont) cont.style.display = t === tab ? 'block' : 'none';
  });
  renderNetTab(tab);
}
function renderNetTab(tab) {
  if (tab === 'discover') renderDiscover();
  if (tab === 'connections') renderConnections();
  if (tab === 'requests') renderRequests();
}
function isConnected(userId) {
  return myConnections.some(function(c) {
    return c.requester_id === userId || c.receiver_id === userId;
  });
}
function hasPendingRequest(userId) {
  // Check if I sent them a request
  return false; // will check connections table
}
function renderDiscover() {
  var list = document.getElementById('net-members-list');
  if (!list) return;
  while (list.firstChild) list.removeChild(list.firstChild);
  if (!allProfiles.length) {
    list.innerHTML = '<div style="text-align:center;padding:30px;color:var(--tm);font-size:0.82rem;">No other members yet</div>';
    return;
  }
  allProfiles.forEach(function(prof) {
    var connected = isConnected(prof.id);
    var card = document.createElement('div');
    card.style.cssText = 'background:var(--sf);border:1px solid var(--bd);border-radius:var(--r);padding:14px;margin-bottom:10px;display:flex;align-items:center;gap:12px;cursor:pointer;';
    card.onclick = function() { openMemberProfile(prof); };
    // Avatar
    var av = document.createElement('div');
    av.style.cssText = 'width:44px;height:44px;border-radius:50%;background:rgba(232,201,122,0.15);border:1px solid rgba(232,201,122,0.3);display:flex;align-items:center;justify-content:center;font-size:1.2rem;font-weight:700;color:var(--ac);flex-shrink:0;';
    av.textContent = (prof.username || '?')[0].toUpperCase();
    card.appendChild(av);
    // Info
    var info = document.createElement('div');
    info.style.cssText = 'flex:1;min-width:0;';
    var name = document.createElement('div');
    name.style.cssText = 'font-weight:700;font-size:0.88rem;';
    name.textContent = prof.username || 'Member';
    var loc = document.createElement('div');
    loc.style.cssText = 'font-size:0.7rem;color:var(--tm);';
    loc.textContent = prof.location || '';
    info.appendChild(name);
    if (prof.location) info.appendChild(loc);
    card.appendChild(info);
    // Status badge
    var badge = document.createElement('div');
    badge.style.cssText = 'font-size:0.65rem;font-weight:700;padding:4px 10px;border-radius:20px;flex-shrink:0;';
    if (connected) {
      badge.textContent = '‚úì Connected';
      badge.style.cssText += 'background:rgba(95,207,128,0.15);color:#5fcf80;border:1px solid rgba(95,207,128,0.3);';
    } else {
      badge.textContent = 'Connect';
      badge.style.cssText += 'background:rgba(232,201,122,0.15);color:var(--ac);border:1px solid rgba(232,201,122,0.3);';
      badge.onclick = function(e) { e.stopPropagation(); sendConnectionRequest(prof.id, badge); };
    }
    card.appendChild(badge);
    list.appendChild(card);
  });
}
async function sendConnectionRequest(userId, btn) {
  if (!supa || !currentUser) return;
  btn.textContent = '‚è≥';
  btn.disabled = true;
  var res = await supa.from('connections').insert({ requester_id: currentUser.id, receiver_id: userId, status: 'pending' });
  if (res.error) {
    toast('Could not send request');
    btn.textContent = 'Connect';
    btn.disabled = false;
  } else {
    btn.textContent = 'Requested';
    btn.style.color = 'var(--tm)';
    toast('Connection request sent!');
  }
}
function renderConnections() {
  var list = document.getElementById('net-connections-list');
  if (!list) return;
  while (list.firstChild) list.removeChild(list.firstChild);
  var connectedIds = myConnections.map(function(c) {
    return c.requester_id === currentUser.id ? c.receiver_id : c.requester_id;
  });
  var connectedProfiles = allProfiles.filter(function(p) { return connectedIds.indexOf(p.id) > -1; });
  if (!connectedProfiles.length) {
    list.innerHTML = '<div style="text-align:center;padding:30px;color:var(--tm);font-size:0.82rem;">No connections yet ‚Äî discover members and send requests</div>';
    return;
  }
  connectedProfiles.forEach(function(prof) {
    var card = document.createElement('div');
    card.style.cssText = 'background:var(--sf);border:1px solid rgba(95,207,128,0.25);border-radius:var(--r);padding:14px;margin-bottom:10px;cursor:pointer;';
    card.onclick = function() { openMemberProfile(prof, true); };
    var top = document.createElement('div');
    top.style.cssText = 'display:flex;align-items:center;gap:12px;margin-bottom:prof.instagram || prof.whatsapp || prof.facebook ? 10px : 0;';
    var av = document.createElement('div');
    av.style.cssText = 'width:44px;height:44px;border-radius:50%;background:rgba(232,201,122,0.15);border:1px solid rgba(232,201,122,0.3);display:flex;align-items:center;justify-content:center;font-size:1.2rem;font-weight:700;color:var(--ac);flex-shrink:0;';
    av.textContent = (prof.username || '?')[0].toUpperCase();
    var info = document.createElement('div');
    info.style.cssText = 'flex:1;';
    var name = document.createElement('div');
    name.style.cssText = 'font-weight:700;font-size:0.88rem;';
    name.textContent = prof.username || 'Member';
    var loc = document.createElement('div');
    loc.style.cssText = 'font-size:0.7rem;color:var(--tm);';
    if (prof.location) loc.textContent = 'üìç ' + prof.location;
    info.appendChild(name);
    if (prof.location) info.appendChild(loc);
    top.appendChild(av);
    top.appendChild(info);
    card.appendChild(top);
    // Social links
    if (prof.instagram || prof.whatsapp || prof.facebook) {
      var socials = document.createElement('div');
      socials.style.cssText = 'display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;';
      if (prof.instagram) {
        var ig = document.createElement('a');
        ig.href = 'https://instagram.com/' + prof.instagram;
        ig.target = '_blank';
        ig.style.cssText = 'padding:6px 12px;background:rgba(131,58,180,0.15);border:1px solid rgba(131,58,180,0.3);border-radius:20px;color:#c77dff;font-size:0.72rem;font-weight:700;text-decoration:none;';
        ig.textContent = 'üì∏ Instagram';
        ig.onclick = function(e) { e.stopPropagation(); };
        socials.appendChild(ig);
      }
      if (prof.whatsapp) {
        var wa = document.createElement('a');
        wa.href = 'https://wa.me/' + prof.whatsapp.replace(/[^0-9]/g,'');
        wa.target = '_blank';
        wa.style.cssText = 'padding:6px 12px;background:rgba(37,211,102,0.15);border:1px solid rgba(37,211,102,0.3);border-radius:20px;color:#25d366;font-size:0.72rem;font-weight:700;text-decoration:none;';
        wa.textContent = 'üí¨ WhatsApp';
        wa.onclick = function(e) { e.stopPropagation(); };
        socials.appendChild(wa);
      }
      if (prof.facebook) {
        var fb = document.createElement('a');
        var fbUrl = prof.facebook.startsWith('http') ? prof.facebook : 'https://' + prof.facebook;
        fb.href = fbUrl;
        fb.target = '_blank';
        fb.style.cssText = 'padding:6px 12px;background:rgba(66,103,178,0.15);border:1px solid rgba(66,103,178,0.3);border-radius:20px;color:#6b9cff;font-size:0.72rem;font-weight:700;text-decoration:none;';
        fb.textContent = 'üë§ Facebook';
        fb.onclick = function(e) { e.stopPropagation(); };
        socials.appendChild(fb);
      }
      card.appendChild(socials);
    }
    list.appendChild(card);
  });
}
function renderRequests() {
  var list = document.getElementById('net-requests-list');
  if (!list) return;
  while (list.firstChild) list.removeChild(list.firstChild);
  if (!pendingRequests.length) {
    list.innerHTML = '<div style="text-align:center;padding:30px;color:var(--tm);font-size:0.82rem;">No pending requests</div>';
    return;
  }
  pendingRequests.forEach(function(req) {
    var prof = allProfiles.find(function(p) { return p.id === req.requester_id; });
    var card = document.createElement('div');
    card.style.cssText = 'background:var(--sf);border:1px solid rgba(232,201,122,0.3);border-radius:var(--r);padding:14px;margin-bottom:10px;';
    var top = document.createElement('div');
    top.style.cssText = 'display:flex;align-items:center;gap:12px;margin-bottom:12px;';
    var av = document.createElement('div');
    av.style.cssText = 'width:44px;height:44px;border-radius:50%;background:rgba(232,201,122,0.15);border:1px solid rgba(232,201,122,0.3);display:flex;align-items:center;justify-content:center;font-size:1.2rem;font-weight:700;color:var(--ac);flex-shrink:0;';
    av.textContent = prof ? (prof.username || '?')[0].toUpperCase() : '?';
    var name = document.createElement('div');
    name.style.cssText = 'font-weight:700;font-size:0.88rem;';
    name.textContent = (prof && prof.username) ? prof.username : 'A member';
    top.appendChild(av);
    top.appendChild(name);
    card.appendChild(top);
    var btns = document.createElement('div');
    btns.style.cssText = 'display:flex;gap:8px;';
    var accept = document.createElement('button');
    accept.style.cssText = 'flex:1;padding:10px;background:var(--ac);border:none;border-radius:var(--r);color:#1a1208;font-weight:700;cursor:pointer;';
    accept.textContent = '‚úì Accept';
    accept.onclick = async function() {
      await supa.from('connections').update({ status:'accepted' }).eq('id', req.id);
      toast('Connected!');
      await loadConnections();
      await loadRequests();
      renderNetTab('requests');
    };
    var decline = document.createElement('button');
    decline.style.cssText = 'flex:1;padding:10px;background:transparent;border:1px solid var(--bd);border-radius:var(--r);color:var(--tm);cursor:pointer;';
    decline.textContent = '‚úï Decline';
    decline.onclick = async function() {
      await supa.from('connections').delete().eq('id', req.id);
      toast('Request declined');
      await loadRequests();
      renderNetTab('requests');
    };
    btns.appendChild(accept);
    btns.appendChild(decline);
    card.appendChild(btns);
    list.appendChild(card);
  });
}
function openMemberProfile(prof, isConnected) {
  var modal = document.getElementById('member-profile-modal');
  var content = document.getElementById('member-profile-content');
  while (content.firstChild) content.removeChild(content.firstChild);
  var av = document.createElement('div');
  av.style.cssText = 'width:64px;height:64px;border-radius:50%;background:rgba(232,201,122,0.15);border:2px solid rgba(232,201,122,0.3);display:flex;align-items:center;justify-content:center;font-size:1.8rem;font-weight:700;color:var(--ac);margin:0 auto 12px;';
  av.textContent = (prof.username || '?')[0].toUpperCase();
  content.appendChild(av);
  var name = document.createElement('div');
  name.style.cssText = 'font-family:"Cormorant Garamond",serif;font-size:1.5rem;text-align:center;color:var(--ac);margin-bottom:4px;';
  name.textContent = prof.username || 'Member';
  content.appendChild(name);
  if (prof.location) {
    var loc = document.createElement('div');
    loc.style.cssText = 'text-align:center;font-size:0.75rem;color:var(--tm);margin-bottom:12px;';
    loc.textContent = 'üìç ' + prof.location;
    content.appendChild(loc);
  }
  if (prof.bio) {
    var bio = document.createElement('div');
    bio.style.cssText = 'font-size:0.82rem;color:var(--tx);text-align:center;margin-bottom:16px;padding:0 8px;line-height:1.6;';
    bio.textContent = prof.bio;
    content.appendChild(bio);
  }
  if (isConnected && (prof.instagram || prof.whatsapp || prof.facebook)) {
    var socTitle = document.createElement('div');
    socTitle.style.cssText = 'font-size:0.65rem;font-weight:800;color:var(--ac);text-transform:uppercase;letter-spacing:0.08em;margin-bottom:10px;text-align:center;';
    socTitle.textContent = 'Connect on social';
    content.appendChild(socTitle);
    // Social buttons added inline
  }
  modal.classList.add('open');
}
function closeMemberProfileModal(e) { if (e.target === document.getElementById('member-profile-modal')) closeMemberProfileModalDirect(); }
function closeMemberProfileModalDirect() { document.getElementById('member-profile-modal').classList.remove('open'); }
// My Profile
function openMyProfile() {
  if (myProfile) {
    var u = document.getElementById('prof-username'); if(u) u.value = myProfile.username || '';
    var b = document.getElementById('prof-bio'); if(b) b.value = myProfile.bio || '';
    var l = document.getElementById('prof-location'); if(l) l.value = myProfile.location || '';
    var ig = document.getElementById('prof-instagram'); if(ig) ig.value = myProfile.instagram || '';
    var wa = document.getElementById('prof-whatsapp'); if(wa) wa.value = myProfile.whatsapp || '';
    var fb = document.getElementById('prof-facebook'); if(fb) fb.value = myProfile.facebook || '';
  }
  document.getElementById('my-profile-modal').classList.add('open');
}
async function saveMyProfile() {
  var username = (document.getElementById('prof-username').value || '').trim();
  if (!username) { toast('Please enter a username'); return; }
  var data = {
    id: currentUser.id,
    username: username,
    bio: document.getElementById('prof-bio').value.trim() || null,
    location: document.getElementById('prof-location').value.trim() || null,
    instagram: document.getElementById('prof-instagram').value.trim() || null,
    whatsapp: document.getElementById('prof-whatsapp').value.trim() || null,
    facebook: document.getElementById('prof-facebook').value.trim() || null
  };
  var res = await supa.from('profiles').upsert(data);
  if (res.error) { toast('Save failed: ' + res.error.message); return; }
  myProfile = data;
  toast('Profile saved ‚úì');
  closeMyProfileModalDirect();
  checkProfileBanner();
}
function closeMyProfileModal(e) { if (e.target === document.getElementById('my-profile-modal')) closeMyProfileModalDirect(); }
function closeMyProfileModalDirect() { document.getElementById('my-profile-modal').classList.remove('open'); }
// =====================
// EVENTS
// =====================
var allEvents = [];
var currentFilter = 'all';
var selectedEvType = '';
var eventsLoaded = false;
var ADMIN_EMAILS = ['clarehobson@icloud.com','monahan.c78@gmail.com'];
function isAdmin() {
  return currentUser && ADMIN_EMAILS.indexOf(currentUser.email) > -1;
}
async function loadEvents() {
  if (!supa) { showEventsEmpty(); return; }
  try {
    document.getElementById('events-loading').style.display = 'block';
    document.getElementById('events-list').innerHTML = '';
    document.getElementById('events-empty').style.display = 'none';
    var today = new Date();
    today.setHours(0,0,0,0);
    var todayStr = today.toISOString().split('T')[0];
    var result = await supa
      .from('events')
      .select('*')
      .eq('approved', true)
      .gte('date', todayStr)
      .order('date', { ascending: true });
    document.getElementById('events-loading').style.display = 'none';
    if (result.error || !result.data) { showEventsEmpty(); return; }
    allEvents = result.data;
    renderEvents();
    eventsLoaded = true;
    // Show admin review button if admin
    var adminEvBtn = document.getElementById('admin-events-btn');
    if (adminEvBtn) adminEvBtn.style.display = isAdmin() ? 'inline' : 'none';
    // Check for pending events and show badge
    if (isAdmin()) checkPendingBadge();
  } catch(e) {
    document.getElementById('events-loading').style.display = 'none';
    showEventsEmpty();
  }
}
function showEventsEmpty() {
  document.getElementById('events-empty').style.display = 'block';
  document.getElementById('events-loading').style.display = 'none';
}
var REGIONS = {
  'british-isles': ['UK','Ireland'],
  'europe': ['Austria','Belgium','Croatia','Czech Republic','Denmark','Finland','France','Germany','Greece','Hungary','Iceland','Italy','Luxembourg','Malta','Netherlands','Norway','Poland','Portugal','Romania','Russia','Serbia','Slovakia','Slovenia','Spain','Sweden','Switzerland','Turkey','Ukraine'],
  'north-america': ['USA','Canada','Mexico'],
  'latin-america': ['Argentina','Brazil','Chile','Colombia','Costa Rica','Cuba','Ecuador','Jamaica','Panama','Peru','Puerto Rico','Uruguay','Venezuela'],
  'asia': ['Bahrain','China','Hong Kong','India','Indonesia','Israel','Japan','Jordan','Kuwait','Lebanon','Malaysia','Nepal','Oman','Pakistan','Philippines','Qatar','Saudi Arabia','Singapore','South Korea','Sri Lanka','Taiwan','Thailand','UAE','Vietnam'],
  'pacific': ['Australia','Bali','Fiji','New Zealand','Papua New Guinea'],
  'africa': ['Egypt','Ghana','Kenya','Morocco','Nigeria','South Africa','Tanzania','Uganda','Zimbabwe'],
  'worldwide': ['Worldwide','worldwide','Other']
};
function filterEvents(filter) {
  currentFilter = filter;
  document.querySelectorAll('.ef-btn').forEach(function(b){ b.classList.remove('ef-active'); });
  var btn = document.getElementById('ef-' + filter);
  if (btn) btn.classList.add('ef-active');
  renderEvents();
}
function renderEvents() {
  var list = document.getElementById('events-list');
  var searchEl = document.getElementById('ev-search');
  var monthEl = document.getElementById('ev-month-filter');
  var yearEl = document.getElementById('ev-year-filter');
  var searchTerm = searchEl ? searchEl.value.toLowerCase() : '';
  var monthFilter = monthEl ? monthEl.value : '';
  var yearFilter = yearEl ? yearEl.value : '';
  var MONTHS = ['January','February','March','April','May','June','July','August','September','October','November','December'];
  var filtered = allEvents.filter(function(ev) {
    // Region filter
    if (currentFilter !== 'all') {
      var regionCountries = REGIONS[currentFilter];
      if (regionCountries) {
        if (regionCountries.indexOf(ev.country) === -1) return false;
      } else {
        if (ev.country !== currentFilter) return false;
      }
    }
    // Search filter
    if (searchTerm) {
      var haystack = ((ev.name || '') + ' ' + (ev.location || '') + ' ' + (ev.country || '') + ' ' + (ev.description || '')).toLowerCase();
      if (haystack.indexOf(searchTerm) === -1) return false;
    }
    // Month filter
    if (monthFilter) {
      var evDate = new Date(ev.date);
      if (MONTHS[evDate.getMonth()] !== monthFilter) return false;
    }
    // Year filter
    if (yearFilter) {
      var evDate = new Date(ev.date);
      if (evDate.getFullYear().toString() !== yearFilter) return false;
    }
    return true;
  });
  if (!filtered.length) {
    list.innerHTML = '<div style="text-align:center;padding:30px 0;color:var(--tm);font-size:0.8rem;">No events found for this filter</div>';
    return;
  }
  list.innerHTML = '';
  var grouped = {};
  filtered.forEach(function(ev) {
    var d = new Date(ev.date);
    var key = d.toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });
    if (!grouped[key]) grouped[key] = [];
    grouped[key].push(ev);
  });
  Object.keys(grouped).forEach(function(month) {
    var header = document.createElement('div');
    header.style.cssText = 'font-size:0.65rem;font-weight:800;color:var(--ac);text-transform:uppercase;letter-spacing:0.1em;margin:16px 0 8px;';
    header.textContent = month;
    list.appendChild(header);
    grouped[month].forEach(function(ev) {
      list.appendChild(buildEventCard(ev));
    });
  });
}
function buildEventCard(ev) {
  var card = document.createElement('div');
  card.className = 'event-card';
  var dateStr = new Date(ev.date).toLocaleDateString('en-GB', {weekday:'short',day:'numeric',month:'short',year:'numeric'});
  if (ev.end_date) dateStr += ' - ' + new Date(ev.end_date).toLocaleDateString('en-GB', {day:'numeric',month:'short'});
  var goingCount = ev.going_users ? ev.going_users.length : 0;
  var userGoing = currentUser && ev.going_users && ev.going_users.includes(currentUser.id);
  var goingNames = ev.going_names ? ev.going_names.slice(0,3).join(', ') : '';
  if (ev.going_names && ev.going_names.length > 3) goingNames += ' +' + (ev.going_names.length - 3) + ' more';
  if (ev.flyer_url) {
    var img = document.createElement('img');
    img.className = 'event-flyer';
    img.src = ev.flyer_url;
    img.onerror = function(){ this.style.display = 'none'; };
    card.appendChild(img);
  } else {
    var ph = document.createElement('div');
    ph.className = 'event-flyer-placeholder';
    ph.textContent = 'Event';
    card.appendChild(ph);
  }
  var body = document.createElement('div');
  body.className = 'event-body';
  var tag = document.createElement('div');
  tag.className = 'event-type-tag';
  tag.textContent = ev.type || 'Event';
  body.appendChild(tag);
  var ttl = document.createElement('div');
  ttl.className = 'event-title';
  ttl.textContent = ev.name;
  body.appendChild(ttl);
  var meta = document.createElement('div');
  meta.className = 'event-meta';
  meta.innerHTML = 'Date: ' + dateStr + '<br>Location: ' + ev.location + (ev.country ? ', ' + ev.country : '');
  if (ev.url) {
    var a = document.createElement('a');
    a.href = ev.url;
    a.target = '_blank';
    a.style.color = 'var(--ac)';
    a.textContent = 'Book / Info';
    meta.appendChild(document.createElement('br'));
    meta.appendChild(a);
  }
  body.appendChild(meta);
  var bar = document.createElement('div');
  bar.className = 'event-going-bar';
  var info = document.createElement('div');
  info.style.cssText = 'font-size:0.72rem;color:var(--tm);';
  info.textContent = goingCount > 0 ? (goingCount + ' going' + (goingNames ? ': ' + goingNames : '')) : 'Be the first going';
  bar.appendChild(info);
  var gbtn = document.createElement('button');
  gbtn.className = 'going-btn' + (userGoing ? ' going-active' : '');
  gbtn.textContent = userGoing ? 'Going' : '+ Going';
  gbtn.addEventListener('click', function(e) { toggleGoing(e, ev.id); });
  bar.appendChild(gbtn);
  body.appendChild(bar);
  card.appendChild(body);
  card.addEventListener('click', function(e) {
    if (e.target.tagName !== 'A' && e.target.tagName !== 'BUTTON') openEventDetail(ev);
  });
  return card;
}
function openEventDetail(ev) {
  var dateStr = new Date(ev.date).toLocaleDateString('en-GB', {weekday:'long',day:'numeric',month:'long',year:'numeric'});
  if (ev.end_date) dateStr += ' - ' + new Date(ev.end_date).toLocaleDateString('en-GB', {weekday:'long',day:'numeric',month:'long'});
  var goingCount = ev.going_users ? ev.going_users.length : 0;
  var userGoing = currentUser && ev.going_users && ev.going_users.includes(currentUser.id);
  var goingNames = ev.going_names ? ev.going_names.join(', ') : '';
  var c = document.getElementById('event-detail-content');
  c.innerHTML = '';
  if (ev.flyer_url) {
    var img = document.createElement('img');
    img.src = ev.flyer_url;
    img.style.cssText = 'width:100%;border-radius:12px;margin-bottom:16px;';
    img.onerror = function(){ this.style.display = 'none'; };
    c.appendChild(img);
  }
  var tag = document.createElement('div');
  tag.className = 'event-type-tag';
  tag.textContent = ev.type || 'Event';
  c.appendChild(tag);
  var ttl = document.createElement('div');
  ttl.style.cssText = 'font-size:1.5rem;font-weight:300;color:var(--ac);margin-bottom:8px;';
  ttl.textContent = ev.name;
  c.appendChild(ttl);
  var meta = document.createElement('div');
  meta.style.cssText = 'font-size:0.8rem;color:var(--tm);line-height:1.8;margin-bottom:12px;';
  meta.innerHTML = 'Date: ' + dateStr + '<br>Location: ' + ev.location + (ev.country ? ', ' + ev.country : '');
  c.appendChild(meta);
  if (ev.description) {
    var desc = document.createElement('div');
    desc.style.cssText = 'font-size:0.82rem;color:var(--tx);line-height:1.7;margin-bottom:14px;';
    desc.textContent = ev.description;
    c.appendChild(desc);
  }
  if (ev.url) {
    var lnk = document.createElement('a');
    lnk.href = ev.url;
    lnk.target = '_blank';
    lnk.className = 'btn';
    lnk.style.cssText = 'display:block;text-align:center;margin-bottom:14px;text-decoration:none;';
    lnk.textContent = 'Book / More Info';
    c.appendChild(lnk);
  }
  var gbox = document.createElement('div');
  gbox.style.cssText = 'background:var(--sf2);border:1px solid var(--bd);border-radius:12px;padding:12px;margin-bottom:12px;';
  var gtitle = document.createElement('div');
  gtitle.style.cssText = 'font-size:0.68rem;font-weight:800;color:var(--ac);text-transform:uppercase;margin-bottom:6px;';
  gtitle.textContent = "Who's Going (" + goingCount + ")";
  gbox.appendChild(gtitle);
  var glist = document.createElement('div');
  glist.style.cssText = goingNames ? 'font-size:0.78rem;color:var(--tx);' : 'font-size:0.75rem;color:var(--tm);';
  glist.textContent = goingNames || 'Nobody yet - be the first!';
  gbox.appendChild(glist);
  c.appendChild(gbox);
  var goBtn = document.createElement('button');
  goBtn.className = 'going-btn' + (userGoing ? ' going-active' : '');
  goBtn.style.cssText = 'width:100%;padding:13px;';
  goBtn.textContent = userGoing ? 'Going' : '+ Going';
  var evId = ev.id;
  goBtn.addEventListener('click', function(e) { toggleGoing(e, evId); });
  c.appendChild(goBtn);
  document.getElementById('event-detail-modal').classList.add('open');
}
async function toggleGoing(e, eventId) {
  e.stopPropagation();
  if (!currentUser) { toast('Sign in to mark yourself as going'); return; }
  if (!supa) return;
  try {
    var ev = allEvents.find(function(x){ return x.id === eventId; });
    if (!ev) return;
    var going = ev.going_users ? ev.going_users.slice() : [];
    var names = ev.going_names ? ev.going_names.slice() : [];
    var username = currentUser.email.split('@')[0];
    var idx = going.indexOf(currentUser.id);
    if (idx > -1) {
      going.splice(idx, 1);
      names.splice(idx, 1);
    } else {
      going.push(currentUser.id);
      names.push(username);
    }
    await supa.from('events').update({ going_users: going, going_names: names }).eq('id', eventId);
    ev.going_users = going;
    ev.going_names = names;
    renderEvents();
    closeEventDetailDirect();
    toast(idx > -1 ? 'Removed from going' : 'Added to your calendar!');
    loadHomeCalendar();
  } catch(e2) { toast('Could not update - try again'); }
}
function selectEvType(btn, type) {
  selectedEvType = type;
  document.querySelectorAll('#submit-event-modal .role-btn').forEach(function(b){ b.classList.remove('selected'); });
  if (btn) btn.classList.add('selected');
  // If called with null btn (e.g. from autofill), find and highlight the matching button
  if (!btn) {
    document.querySelectorAll('#submit-event-modal .role-btn').forEach(function(b){
      if (b.textContent.toLowerCase().indexOf(type.toLowerCase()) > -1) b.classList.add('selected');
    });
  }
}
function openSubmitEvent() {
  if (!currentUser) { showWelcomeScreen(); return; }
  document.getElementById('ev-name').value = '';
  document.getElementById('ev-date').value = '';
  document.getElementById('ev-enddate').value = '';
  document.getElementById('ev-location').value = '';
  document.getElementById('ev-country').value = '';
  document.getElementById('ev-url').value = '';
  document.getElementById('ev-flyer').value = '';
  document.getElementById('ev-desc').value = '';
  document.getElementById('ev-submit-msg').style.display = 'none';
  document.getElementById('ev-autofill-status').style.display = 'none';
  document.getElementById('ev-autofill-url').value = '';
  document.getElementById('ev-flyer-preview-wrap').style.display = 'none';
  selectedEvType = '';
  document.querySelectorAll('#submit-event-modal .role-btn').forEach(function(b){ b.classList.remove('selected'); });
  document.getElementById('submit-event-modal').classList.add('open');
}
async function submitEvent() {
  var name = document.getElementById('ev-name').value.trim();
  var date = document.getElementById('ev-date').value;
  var location = document.getElementById('ev-location').value.trim();
  var country = document.getElementById('ev-country').value;
  if (!name || !date || !location || !country) { toast('Please fill in all required fields'); return; }
  if (!supa) { toast('No connection - try again'); return; }
  // Check for duplicate events - same name and within 3 days of same date
  try {
    var existing = await supa.from('events').select('id, name, date, location').ilike('name', '%' + name.substring(0, 10) + '%');
    if (existing.data && existing.data.length) {
      var submittedDate = new Date(date);
      var duplicates = existing.data.filter(function(ev) {
        var evDate = new Date(ev.date);
        var dayDiff = Math.abs((evDate - submittedDate) / (1000 * 60 * 60 * 24));
        return dayDiff <= 3;
      });
      if (duplicates.length) {
        var dup = duplicates[0];
        var confirmed = confirm('‚ö†Ô∏è A similar event already exists:\n\n"' + dup.name + '"\n' + new Date(dup.date).toLocaleDateString('en-GB', {day:'numeric',month:'long',year:'numeric'}) + ' ¬∑ ' + dup.location + '\n\nIs this a different event? Tap OK to submit anyway, or Cancel to go back.');
        if (!confirmed) return;
      }
    }
  } catch(e) { /* duplicate check failed silently, continue */ }
  try {
    await supa.from('events').insert({
      name: name,
      type: selectedEvType || 'Other',
      date: date,
      end_date: document.getElementById('ev-enddate').value || null,
      location: location,
      country: country,
      url: document.getElementById('ev-url').value.trim() || null,
      flyer_url: document.getElementById('ev-flyer').value.trim() || (document.getElementById('ev-flyer-preview').src && document.getElementById('ev-flyer-preview').src.startsWith('data:') ? document.getElementById('ev-flyer-preview').src : null),
      description: document.getElementById('ev-desc').value.trim() || null,
      approved: false,
      submitted_by: currentUser ? currentUser.email : 'anonymous',
      going_users: [],
      going_names: []
    });
    document.getElementById('ev-submit-msg').style.display = 'block';
    setTimeout(closeSubmitEventDirect, 2500);
  } catch(e) { toast('Submission failed - try again'); }
}
function closeSubmitEvent(event) { document.getElementById('submit-event-modal').classList.remove('open'); }
function closeSubmitEventDirect() { document.getElementById('submit-event-modal').classList.remove('open'); }
function closeEventDetail(event) { document.getElementById('event-detail-modal').classList.remove('open'); }
function closeEventDetailDirect() { document.getElementById('event-detail-modal').classList.remove('open'); }
function closeAdminModal(event) { document.getElementById('admin-modal').classList.remove('open'); }
function closeAdminModalDirect() { document.getElementById('admin-modal').classList.remove('open'); }
async function openAdminPanel() {
  if (!isAdmin() || !supa) return;
  try {
    var result = await supa.from('events').select('*').eq('approved', false).order('created_at', { ascending: false });
    var pending = result.data || [];
    var container = document.getElementById('admin-pending-list');
    container.innerHTML = '';
    if (!pending.length) {
      container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--tm);">No pending events</div>';
    } else {
      pending.forEach(function(ev) {
        var card = document.createElement('div');
        card.style.cssText = 'background:var(--sf2);border:1px solid var(--bd);border-radius:12px;padding:12px;margin-bottom:10px;';
        var title = document.createElement('div');
        title.style.cssText = 'font-weight:700;font-size:0.88rem;margin-bottom:4px;';
        title.textContent = ev.name;
        card.appendChild(title);
        var info = document.createElement('div');
        info.style.cssText = 'font-size:0.72rem;color:var(--tm);margin-bottom:8px;';
        info.textContent = ev.date + ' - ' + ev.location + ' - ' + (ev.submitted_by || '');
        card.appendChild(info);
        var btns = document.createElement('div');
        btns.style.cssText = 'display:flex;gap:8px;';
        var approveBtn = document.createElement('button');
        approveBtn.style.cssText = 'flex:1;padding:9px;background:#5fcf80;color:#0f1a10;border:none;border-radius:10px;font-weight:700;cursor:pointer;';
        approveBtn.textContent = 'Approve';
        (function(id){ approveBtn.addEventListener('click', function(){ approveEvent(id); }); })(ev.id);
        var rejectBtn = document.createElement('button');
        rejectBtn.style.cssText = 'flex:1;padding:9px;background:rgba(192,57,43,0.3);color:#e74c3c;border:1px solid rgba(192,57,43,0.4);border-radius:10px;cursor:pointer;';
        rejectBtn.textContent = 'Reject';
        (function(id){ rejectBtn.addEventListener('click', function(){ rejectEvent(id); }); })(ev.id);
        btns.appendChild(approveBtn);
        btns.appendChild(rejectBtn);
        card.appendChild(btns);
        container.appendChild(card);
      });
    }
    document.getElementById('admin-modal').classList.add('open');
    loadEventSources();
  } catch(e) { toast('Could not load admin panel: ' + e.message); }
}
async function approveEvent(id) {
  await supa.from('events').update({ approved: true }).eq('id', id);
  toast('Event approved');
  openAdminPanel();
  loadEvents();
}
async function rejectEvent(id) {
  await supa.from('events').delete().eq('id', id);
  toast('Event rejected and removed');
  openAdminPanel();
}
// =====================
// SIGN IN / AUTH
// =====================
function openSigninModal() {
  var isSignedIn = currentUser !== null;
  document.getElementById('signin-password-wrap').style.display = isSignedIn ? 'none' : 'block';
  document.getElementById('signin-email').style.display = isSignedIn ? 'none' : 'block';
  document.querySelector('#signin-modal .modal-title').textContent = isSignedIn ? 'Account' : 'Sign In';
  document.getElementById('signin-msg').style.display = 'none';
  var btns = document.querySelectorAll('#signin-modal button:not(#home-signin-btn)');
  if (isSignedIn) {
    document.getElementById('signin-user-wrap').style.display = 'block';
    document.getElementById('signin-user-email').textContent = currentUser.email;
    // Hide sign in / create / forgot buttons
    document.querySelectorAll('#signin-modal .btn, #signin-modal button').forEach(function(b){
      if (b.textContent === 'Sign In' || b.textContent === 'Create Account' || b.textContent === 'Forgot password?') {
        b.style.display = 'none';
      }
    });
  } else {
    document.getElementById('signin-user-wrap').style.display = 'none';
    document.querySelectorAll('#signin-modal .btn, #signin-modal button').forEach(function(b){
      b.style.display = '';
    });
  }
  document.getElementById('signin-modal').classList.add('open');
}
function closeSigninModal(event) {
  document.getElementById('signin-modal').classList.remove('open');
}
function showSigninMsg(msg, colour) {
  var el = document.getElementById('signin-msg');
  el.textContent = msg;
  el.style.color = colour || 'var(--tm)';
  el.style.display = 'block';
}
async function doSignIn() {
  if (!supa) { showSigninMsg('No connection - try again'); return; }
  var email = document.getElementById('signin-email').value.trim();
  var password = document.getElementById('signin-password').value;
  if (!email || !password) { showSigninMsg('Please enter email and password'); return; }
  showSigninMsg('Signing in...');
  try {
    var result = await supa.auth.signInWithPassword({ email: email, password: password });
    if (result.error) { showSigninMsg(result.error.message, '#e74c3c'); return; }
    currentUser = result.data.user;
    pullFromCloud();
    updateSigninBtn();
    hideWelcomeScreen();
    document.getElementById('signin-modal').classList.remove('open');
    toast('Welcome back ' + currentUser.email.split('@')[0]);
    setTimeout(loadHomeCalendar, 500);
    eventsLoaded = false;
    // Check pending events for admins
    setTimeout(function() { checkPendingBadge(); }, 1000);
  } catch(e) { showSigninMsg('Sign in failed - try again', '#e74c3c'); }
}
async function doSignUp() {
  if (!supa) { showSigninMsg('No connection - try again'); return; }
  var email = document.getElementById('signin-email').value.trim();
  var password = document.getElementById('signin-password').value;
  if (!email || !password) { showSigninMsg('Please enter email and password'); return; }
  if (password.length < 6) { showSigninMsg('Password must be at least 6 characters'); return; }
  showSigninMsg('Creating account...');
  try {
    var result = await supa.auth.signUp({ email: email, password: password });
    if (result.error) { showSigninMsg(result.error.message, '#e74c3c'); return; }
    showSigninMsg('Account created! Check your email to confirm, then sign in.', '#5fcf80');
  } catch(e) { showSigninMsg('Sign up failed - try again', '#e74c3c'); }
}
async function doResetPassword() {
  if (!supa) return;
  var email = document.getElementById('signin-email').value.trim();
  if (!email) { showSigninMsg('Enter your email address first'); return; }
  try {
    await supa.auth.resetPasswordForEmail(email);
    showSigninMsg('Password reset email sent!', '#5fcf80');
  } catch(e) { showSigninMsg('Could not send reset email', '#e74c3c'); }
}
// =====================
// AUTH & MEMBERSHIP
// =====================
var membershipTier = null; // null = not checked, 'free', 'basic', 'member'
// Tier definitions
// Membership tiers removed for testing
var BETA_CODE = 'CLEANLIVING2025';
function getUserTier() { return "member"; }
// ---- WELCOME / AUTH SCREEN ----
function showWelcomeScreen() {
  document.getElementById('app').style.display = 'none';
  document.getElementById('welcome-screen').style.display = 'flex';
}
function hideWelcomeScreen() {
  document.getElementById('welcome-screen').style.display = 'none';
  document.getElementById('app').style.display = 'block';
}
function showAuthForm(mode) {
  document.getElementById('welcome-hero').style.display = 'none';
  document.getElementById('auth-form').style.display = 'block';
  document.getElementById('auth-mode').dataset.mode = mode;
  document.getElementById('auth-title').textContent = mode === 'signin' ? 'Welcome back' : 'Create account';
  document.getElementById('auth-submit-btn').textContent = mode === 'signin' ? 'Sign In' : 'Create Account';
  document.getElementById('auth-switch-text').textContent = mode === 'signin' ? "Don't have an account?" : 'Already have an account?';
  document.getElementById('auth-switch-btn').textContent = mode === 'signin' ? 'Sign up' : 'Sign in';
  document.getElementById('auth-msg').style.display = 'none';
  document.getElementById('auth-forgot').style.display = mode === 'signin' ? 'block' : 'none';
}
function switchAuthMode() {
  var current = document.getElementById('auth-mode').dataset.mode;
  showAuthForm(current === 'signin' ? 'signup' : 'signin');
}
function showAuthMsg(msg, colour) {
  var el = document.getElementById('auth-msg');
  el.textContent = msg;
  el.style.color = colour || 'var(--tm)';
  el.style.display = 'block';
}
async function doAuth() {
  if (!supa) { showAuthMsg('No connection ‚Äî please check your internet'); return; }
  var mode = document.getElementById('auth-mode').dataset.mode;
  var email = document.getElementById('auth-email').value.trim();
  var password = document.getElementById('auth-password').value;
  if (!email || !password) { showAuthMsg('Please enter your email and password'); return; }
  if (mode === 'signup' && password.length < 6) { showAuthMsg('Password must be at least 6 characters'); return; }
  document.getElementById('auth-submit-btn').textContent = 'Please wait...';
  document.getElementById('auth-submit-btn').disabled = true;
  try {
    var result;
    if (mode === 'signin') {
      result = await supa.auth.signInWithPassword({ email: email, password: password });
    } else {
      result = await supa.auth.signUp({ email: email, password: password });
    }
    document.getElementById('auth-submit-btn').disabled = false;
    document.getElementById('auth-submit-btn').textContent = mode === 'signin' ? 'Sign In' : 'Create Account';
    if (result.error) { showAuthMsg(result.error.message, '#e74c3c'); return; }
    if (mode === 'signup') {
      showAuthMsg('Account created! Check your email to confirm, then sign in.', '#5fcf80');
      return;
    }
    currentUser = result.data.user;
    pullFromCloud();
    updateSigninBtn();
    showAdminBtnIfNeeded();
    hideWelcomeScreen();
    eventsLoaded = false;
  } catch(e) {
    document.getElementById('auth-submit-btn').disabled = false;
    showAuthMsg('Something went wrong ‚Äî try again', '#e74c3c');
  }
}
async function doAuthReset() {
  if (!supa) return;
  var email = document.getElementById('auth-email').value.trim();
  if (!email) { showAuthMsg('Enter your email address first'); return; }
  try {
    await supa.auth.resetPasswordForEmail(email, { redirectTo: 'https://cleanliving.app' });
    showAuthMsg('Password reset email sent!', '#5fcf80');
  } catch(e) { showAuthMsg('Could not send reset email', '#e74c3c'); }
}
function continueAsGuest() {
  hideWelcomeScreen();
}
// ---- PAYWALL ----
function closePaywall(e) {
  document.getElementById('paywall-modal').classList.remove('open');
}
function checkPendingBadge() {
  if (!supa || !isAdmin()) return;
  supa.from('events').select('id').eq('approved', false).then(function(r) {
    var badge = document.getElementById('admin-badge');
    if (!badge) return;
    var count = (r.data && r.data.length) || 0;
    if (count > 0) {
      badge.textContent = count;
      badge.style.display = 'flex';
    } else {
      badge.style.display = 'none';
    }
  });
}
// =====================
// ACCOUNT SCREEN
// =====================
function renderAccountScreen() {
  var el = document.getElementById('account-screen-content');
  if (!el) return;
  while (el.firstChild) el.removeChild(el.firstChild);
  if (!currentUser) {
    var signInWrap = document.createElement('div');
    signInWrap.style.cssText = 'text-align:center;padding:40px 0;';
    var icon = document.createElement('div');
    icon.style.cssText = 'font-size:3rem;margin-bottom:16px;';
    icon.textContent = 'Sign in to your account';
    var signInBtn = document.createElement('button');
    signInBtn.style.cssText = 'padding:13px 24px;background:var(--ac);border:none;border-radius:var(--r);color:#1a1208;font-weight:700;cursor:pointer;font-size:0.9rem;';
    signInBtn.textContent = 'Sign In';
    signInBtn.onclick = function() { showWelcomeScreen(); };
    signInWrap.appendChild(icon);
    signInWrap.appendChild(signInBtn);
    el.appendChild(signInWrap);
    return;
  }
  var email = currentUser.email || '';
  var name = email.split('@')[0];
  var tier = getUserTier();
  // Profile card
  var card = document.createElement('div');
  card.className = 'card';
  card.style.cssText = 'text-align:center;margin-bottom:16px;padding:20px;';
  var avatar = document.createElement('div');
  avatar.style.cssText = 'width:64px;height:64px;border-radius:50%;background:linear-gradient(135deg,var(--ac),#b8965a);display:flex;align-items:center;justify-content:center;font-size:1.8rem;font-weight:700;color:#1a1208;margin:0 auto 12px;';
  avatar.textContent = name[0].toUpperCase();
  card.appendChild(avatar);
  var nameEl = document.createElement('div');
  nameEl.style.cssText = 'font-weight:700;font-size:1rem;margin-bottom:4px;';
  nameEl.textContent = name;
  card.appendChild(nameEl);
  var emailEl = document.createElement('div');
  emailEl.style.cssText = 'font-size:0.72rem;color:var(--tm);margin-bottom:10px;';
  emailEl.textContent = email;
  card.appendChild(emailEl);
  var badge = document.createElement('span');
  badge.style.cssText = 'padding:4px 12px;border-radius:20px;font-size:0.65rem;font-weight:800;text-transform:uppercase;' + (tier==='member' ? 'background:rgba(232,201,122,0.2);color:var(--ac);border:1px solid rgba(232,201,122,0.4);' : 'background:rgba(255,255,255,0.08);color:var(--tm);border:1px solid var(--bd);');
  badge.textContent = tier.charAt(0).toUpperCase() + tier.slice(1);
  card.appendChild(badge);
  el.appendChild(card);
  // Admin section
  if (isAdmin()) {
    var adminCard = document.createElement('div');
    adminCard.style.cssText = 'background:rgba(231,76,60,0.1);border:1px solid rgba(231,76,60,0.3);border-radius:var(--r);padding:16px;margin-bottom:16px;';
    var adminTitle = document.createElement('div');
    adminTitle.style.cssText = 'font-size:0.72rem;font-weight:800;color:#e74c3c;text-transform:uppercase;letter-spacing:0.06em;margin-bottom:10px;';
    adminTitle.textContent = 'Admin';
    adminCard.appendChild(adminTitle);
    var reviewBtn = document.createElement('button');
    reviewBtn.style.cssText = 'width:100%;padding:12px;background:rgba(231,76,60,0.2);border:1px solid rgba(231,76,60,0.4);border-radius:10px;color:#e74c3c;font-size:0.82rem;font-weight:600;cursor:pointer;';
    reviewBtn.textContent = 'Review Pending Events';
    reviewBtn.onclick = function() { openAdminPanel(); };
    adminCard.appendChild(reviewBtn);
    el.appendChild(adminCard);
  }
  // Beta code section (only show if not already member)
  if (tier !== 'member') {
    var betaWrap = document.createElement('div');
    betaWrap.style.cssText = 'background:rgba(232,201,122,0.08);border:1px solid rgba(232,201,122,0.2);border-radius:var(--r);padding:14px;margin-bottom:12px;';
    var betaTitle = document.createElement('div');
    betaTitle.style.cssText = 'font-size:0.72rem;font-weight:800;color:var(--ac);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:8px;';
    betaTitle.textContent = 'Have a Beta Code?';
    betaWrap.appendChild(betaTitle);
    var betaRow = document.createElement('div');
    betaRow.style.cssText = 'display:flex;gap:8px;';
    var betaInput = document.createElement('input');
    betaInput.id = 'beta-code-input';
    betaInput.className = 'input';
    betaInput.placeholder = 'Enter code...';
    betaInput.style.cssText = 'flex:1;margin:0;text-transform:uppercase;';
    var betaBtn = document.createElement('button');
    betaBtn.style.cssText = 'padding:10px 14px;background:var(--ac);border:none;border-radius:var(--r);color:#1a1208;font-weight:700;cursor:pointer;font-size:0.82rem;';
    betaBtn.textContent = 'Apply';
    betaBtn.onclick = function() {
      var code = (document.getElementById('beta-code-input').value || '').trim().toUpperCase();
      if (code === BETA_CODE) {
        localStorage.setItem('cl_beta_code', code);
        toast('Beta code applied ‚Äî full access unlocked!');
        renderAccountScreen();
      } else {
        toast('Invalid code ‚Äî try again');
      }
    };
    betaRow.appendChild(betaInput);
    betaRow.appendChild(betaBtn);
    betaWrap.appendChild(betaRow);
    el.appendChild(betaWrap);
  }
  // Sign out button
  var signOutBtn = document.createElement('button');
  signOutBtn.style.cssText = 'width:100%;padding:13px;border:1px solid rgba(192,57,43,0.3);border-radius:var(--r);background:transparent;color:#e74c3c;cursor:pointer;font-size:0.85rem;margin-top:8px;';
  signOutBtn.textContent = 'Sign Out';
  signOutBtn.onclick = function() { doSignOut(); };
  el.appendChild(signOutBtn);
}
// =====================
// ACCOUNT SHEET
// =====================
function openAccountSheet() {
  var sheet = document.getElementById('account-sheet');
  if (!sheet) return;
  if (!currentUser) {
    document.getElementById('account-signedout').style.display = 'block';
    document.getElementById('account-signedin').style.display = 'none';
  } else {
    document.getElementById('account-signedout').style.display = 'none';
    document.getElementById('account-signedin').style.display = 'block';
    var email = currentUser.email || '';
    var name = email.split('@')[0];
    var tier = getUserTier();
    document.getElementById('account-avatar').textContent = name[0].toUpperCase();
    document.getElementById('account-name').textContent = name;
    document.getElementById('account-email').textContent = email;
    var badge = document.getElementById('account-tier-badge');
    if (tier === 'member') {
      badge.textContent = 'Member';
      badge.style.cssText = 'margin-left:auto;padding:4px 10px;border-radius:20px;font-size:0.62rem;font-weight:800;text-transform:uppercase;background:rgba(232,201,122,0.2);color:var(--ac);border:1px solid rgba(232,201,122,0.4);';
    } else if (tier === 'basic') {
      badge.textContent = 'Basic';
      badge.style.cssText = 'margin-left:auto;padding:4px 10px;border-radius:20px;font-size:0.62rem;font-weight:800;text-transform:uppercase;background:rgba(94,164,207,0.2);color:#5ea4cf;border:1px solid rgba(94,164,207,0.4);';
    } else {
      badge.textContent = 'Free';
      badge.style.cssText = 'margin-left:auto;padding:4px 10px;border-radius:20px;font-size:0.62rem;font-weight:800;text-transform:uppercase;background:rgba(255,255,255,0.08);color:var(--tm);border:1px solid var(--bd);';
    }
    var detail = document.getElementById('account-membership-detail');
    if (tier === 'member') {
      detail.textContent = 'Full access ‚Äî Journal, Events, Movement, Network, Community';
    } else if (tier === 'basic') {
      detail.textContent = 'Basic access ‚Äî Network and Worksheets included';
    } else {
      detail.textContent = 'Free plan ‚Äî meetings, books and daily readings';
    }
    document.getElementById('account-admin-section').style.display = isAdmin() ? 'block' : 'none';
  }
  sheet.classList.add('open');
}
function closeAccountSheet(event) {
  document.getElementById('account-sheet').classList.remove('open');
}
function updateSigninBtn() {
  var btn = document.getElementById('home-signin-btn');
  var outBtn = document.getElementById('home-signout-btn');
  if (!btn) return;
  if (currentUser) {
    var initial = (currentUser.email.split('@')[0][0] || 'A').toUpperCase();
    btn.textContent = initial;
    btn.style.background = 'linear-gradient(135deg,var(--ac),#b8965a)';
    btn.style.color = '#1a1208';
    btn.style.fontWeight = '700';
    if (outBtn) outBtn.style.display = 'block';
  } else {
    btn.textContent = 'üë§';
    btn.style.background = 'var(--sf)';
    btn.style.color = 'var(--ac)';
    btn.style.fontWeight = 'normal';
    if (outBtn) outBtn.style.display = 'none';
  }
}
function showAdminBtnIfNeeded() {
  // Admin access is inside the account sheet - no floating button needed
}
async function doSignOut() {
  if (!supa) return;
  try {
    await supa.auth.signOut();
  } catch(e) {}
  currentUser = null;
  updateSigninBtn();
  var sheet = document.getElementById('account-sheet');
  if (sheet) sheet.classList.remove('open');
  showWelcomeScreen();
  toast('Signed out');
}
// =====================
// HOME EVENTS CALENDAR
// =====================
function loadHomeCalendar() {
  if (!currentUser || !supa) return;
  supa.from('events')
    .select('id, going_users, date')
    .eq('approved', true)
    .then(function(result) {
      if (!result.data) return;
      var userId = currentUser.id;
      var today = new Date();
      today.setHours(0,0,0,0);
      var myEvents = result.data.filter(function(ev) {
        if (!ev.going_users) return false;
        if (ev.going_users.indexOf(userId) === -1) return false;
        return new Date(ev.date) >= today;
      });
      var badge = document.getElementById('home-events-badge');
      if (!badge) return;
      if (myEvents.length > 0) {
        badge.textContent = myEvents.length;
        badge.style.display = 'block';
      } else {
        badge.style.display = 'none';
      }
    });
}
// =====================
// EVENTS AI AUTOFILL
// =====================
function showAutofillStatus(msg, type) {
  var el = document.getElementById('ev-autofill-status');
  if (!el) return;
  el.textContent = msg;
  el.style.display = 'block';
  el.style.background = type === 'error' ? '#3a0a0a' : '#2a2410';
  el.style.color = type === 'error' ? '#ff6b6b' : '#e8c97a';
  el.style.border = '2px solid ' + (type === 'error' ? '#e74c3c' : '#e8c97a');
}
function fillEventForm(data) {
  if (data.name) document.getElementById('ev-name').value = data.name;
  if (data.date) document.getElementById('ev-date').value = data.date;
  if (data.end_date) document.getElementById('ev-enddate').value = data.end_date;
  if (data.location) document.getElementById('ev-location').value = data.location;
  if (data.url) document.getElementById('ev-url').value = data.url;
  if (data.description) document.getElementById('ev-desc').value = data.description;
  if (data.country) {
    var sel = document.getElementById('ev-country');
    for (var i = 0; i < sel.options.length; i++) {
      if (sel.options[i].value.toLowerCase() === (data.country || '').toLowerCase()) {
        sel.selectedIndex = i; break;
      }
    }
  }
  if (data.type) {
    var typeMap = { 'convention':'Convention','marathon':'Marathon','speaker':'Speaker Meeting','workshop':'Workshop','other':'Other' };
    var t = (data.type || '').toLowerCase();
    for (var key in typeMap) {
      if (t.indexOf(key) > -1) { selectEvType(null, typeMap[key]); break; }
    }
  }
}
async function autofillFromUrl() {
  var url = document.getElementById('ev-autofill-url').value.trim();
  if (!url) { showAutofillStatus('Please paste a website URL first', 'error'); return; }
  showAutofillStatus('Reading page... this may take a moment', 'ok');
  try {
    var response = await fetch(AI_PROXY, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 800,
        system: 'Extract event details from URLs or web content. Respond ONLY with valid JSON. Fields: name (string), date (YYYY-MM-DD), end_date (YYYY-MM-DD or null), location (string), country (use the exact country name from this list: UK, Ireland, Austria, Belgium, Croatia, Czech Republic, Denmark, Finland, France, Germany, Greece, Hungary, Iceland, Italy, Luxembourg, Malta, Netherlands, Norway, Poland, Portugal, Romania, Russia, Serbia, Slovakia, Slovenia, Spain, Sweden, Switzerland, Turkey, Ukraine, USA, Canada, Mexico, Argentina, Brazil, Chile, Colombia, Costa Rica, Cuba, Ecuador, Jamaica, Panama, Peru, Puerto Rico, Uruguay, Venezuela, Bahrain, China, Hong Kong, India, Indonesia, Israel, Japan, Jordan, Kuwait, Lebanon, Malaysia, Nepal, Oman, Pakistan, Philippines, Qatar, Saudi Arabia, Singapore, South Korea, Sri Lanka, Taiwan, Thailand, UAE, Vietnam, Australia, Bali, Fiji, New Zealand, Papua New Guinea, Egypt, Ghana, Kenya, Morocco, Nigeria, South Africa, Tanzania, Uganda, Zimbabwe, Worldwide, Other), url (string), description (max 150 chars), type (Convention/Marathon/Speaker Meeting/Workshop/Other). Use null for unknown fields.',
        messages: [{ role: 'user', content: 'Extract event details from: ' + url }]
      })
    });
    var data = await response.json();
    if (data.error) { showAutofillStatus('Could not read URL ‚Äî please fill in manually', 'error'); return; }
    var text = (data.content && data.content[0]) ? data.content[0].text : '';
    var clean = text.replace(/```json|```/g, '').trim();
    var event = JSON.parse(clean);
    fillEventForm(event);
    showAutofillStatus('‚úì Details filled in ‚Äî please check and edit as needed', 'ok');
  } catch(e) {
    showAutofillStatus('Could not read URL ‚Äî please fill in the details manually', 'error');
  }
}
async function autofillFromImage(input) {
  var file = input.files[0];
  if (!file) return;
  // Always show preview
  var reader = new FileReader();
  reader.onload = function(e) {
    var preview = document.getElementById('ev-flyer-preview');
    var wrap = document.getElementById('ev-flyer-preview-wrap');
    if (preview) { preview.src = e.target.result; }
    if (wrap) wrap.style.display = 'block';
  };
  reader.readAsDataURL(file);
  showAutofillStatus('Reading flyer... ‚ú®', 'ok');
  // Read as base64 for API
  var b64reader = new FileReader();
  b64reader.onload = async function(e) {
    var base64 = e.target.result.split(',')[1];
    var mediaType = file.type || 'image/jpeg';
    try {
      var response = await fetch(AI_PROXY, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          model: 'claude-sonnet-4-20250514',
          max_tokens: 800,
          system: 'Extract event details from flyer images. Respond ONLY with valid JSON. Fields: name, date (YYYY-MM-DD), end_date (YYYY-MM-DD or null), location, country (use the exact country name from this list: UK, Ireland, Austria, Belgium, Croatia, Czech Republic, Denmark, Finland, France, Germany, Greece, Hungary, Iceland, Italy, Luxembourg, Malta, Netherlands, Norway, Poland, Portugal, Romania, Russia, Serbia, Slovakia, Slovenia, Spain, Sweden, Switzerland, Turkey, Ukraine, USA, Canada, Mexico, Argentina, Brazil, Chile, Colombia, Costa Rica, Cuba, Ecuador, Jamaica, Panama, Peru, Puerto Rico, Uruguay, Venezuela, Bahrain, China, Hong Kong, India, Indonesia, Israel, Japan, Jordan, Kuwait, Lebanon, Malaysia, Nepal, Oman, Pakistan, Philippines, Qatar, Saudi Arabia, Singapore, South Korea, Sri Lanka, Taiwan, Thailand, UAE, Vietnam, Australia, Bali, Fiji, New Zealand, Papua New Guinea, Egypt, Ghana, Kenya, Morocco, Nigeria, South Africa, Tanzania, Uganda, Zimbabwe, Worldwide, Other), url, description (max 150 chars), type (Convention/Marathon/Speaker Meeting/Workshop/Other). Use null for unknown fields.',
          messages: [{
            role: 'user',
            content: [
              { type: 'image', source: { type: 'base64', media_type: mediaType, data: base64 }},
              { type: 'text', text: 'Extract all event details from this flyer. Return JSON only.' }
            ]
          }]
        })
      });
      var data = await response.json();
      if (data.error) { showAutofillStatus('API error: ' + JSON.stringify(data.error), 'error'); return; }
      var text = (data.content && data.content[0]) ? data.content[0].text : '';
      var clean = text.replace(/```json|```/g, '').trim();
      var event = JSON.parse(clean);
      fillEventForm(event);
      showAutofillStatus('‚úì Flyer read ‚Äî please check and complete the details', 'ok');
    } catch(e) {
      showAutofillStatus('Error: ' + (e.message || JSON.stringify(e)), 'error');
    }
  };
  b64reader.readAsDataURL(file);
}
// =====================
// SAVED MEETINGS
// =====================
var personalMeetings = JSON.parse(localStorage.getItem('na_personal_meetings') || '[]');
var editingMeetingId = null;
var editingMeetingType = null;
function buildZoomLink(meetingId, password) {
  // Clean the meeting ID - remove spaces and dashes
  var id = (meetingId || '').replace(/[\s\-]/g, '');
  if (!id) return null;
  // Use zoommtg:// deep link to open Zoom app directly
  var link = 'zoommtg://zoom.us/join?confno=' + id;
  if (password) link += '&pwd=' + encodeURIComponent(password);
  return link;
}
function renderMeetingCard(m, type) {
  var card = document.createElement('div');
  card.style.cssText = 'background:var(--sf);border:1px solid rgba(232,201,122,0.35);border-radius:var(--r);padding:14px 16px;margin-bottom:10px;box-shadow:0 2px 8px rgba(0,0,0,0.25);';
  var top = document.createElement('div');
  top.style.cssText = 'display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:6px;';
  var nameEl = document.createElement('div');
  nameEl.style.cssText = 'font-weight:700;font-size:0.88rem;flex:1;';
  nameEl.textContent = m.name;
  top.appendChild(nameEl);
  var editBtn = document.createElement('button');
  editBtn.textContent = '‚úèÔ∏è';
  editBtn.style.cssText = 'background:transparent;border:none;font-size:0.9rem;cursor:pointer;padding:0 0 0 8px;flex-shrink:0;';
  editBtn.onclick = function() { openEditMeeting(m.id, type, m); };
  top.appendChild(editBtn);
  card.appendChild(top);
  if (m.time) {
    var timeEl = document.createElement('div');
    timeEl.style.cssText = 'font-size:0.72rem;color:var(--tm);margin-bottom:8px;';
    timeEl.textContent = 'üïê ' + m.time;
    card.appendChild(timeEl);
  }
  // Build join button
  var joinBtn = document.createElement('a');
  var zid = m.meetingId || m.meeting_id;
  var zoomLink = zid ? buildZoomLink(zid, m.password) : null;
  joinBtn.href = zoomLink || m.url || '#';
  if (!zoomLink) joinBtn.target = '_blank';
  joinBtn.style.cssText = 'display:flex;align-items:center;justify-content:center;gap:8px;padding:11px;background:var(--ac);color:#1a1208;border-radius:10px;font-size:0.82rem;font-weight:700;text-decoration:none;';
  joinBtn.innerHTML = '<span>‚ñ∂</span><span>Join on Zoom</span>';
  // If using URL instead of ID, adjust label
  if (!zid && m.url) {
    joinBtn.innerHTML = '<span>‚ñ∂</span><span>Join Meeting</span>';
  }
  // Show meeting ID and password info
  if (zid) {
    var idRow = document.createElement('div');
    idRow.style.cssText = 'display:flex;gap:12px;margin-bottom:8px;font-size:0.7rem;color:var(--tm);';
    idRow.innerHTML = '<span>ID: <b style="color:var(--tx);">' + zid + '</b></span>' +
      (m.password ? '<span>Password: <b style="color:var(--tx);">' + m.password + '</b></span>' : '');
    card.appendChild(idRow);
  }
  card.appendChild(joinBtn);
  return card;
}
function renderSavedMeetings() {
  // Personal meetings (localStorage)
  var pList = document.getElementById('personal-meetings-list');
  var pEmpty = document.getElementById('personal-meetings-empty');
  if (pList) {
    pList.innerHTML = '';
    if (!personalMeetings.length) {
      if (pEmpty) pEmpty.style.display = 'block';
    } else {
      if (pEmpty) pEmpty.style.display = 'none';
      personalMeetings.forEach(function(m) {
        pList.appendChild(renderMeetingCard(m, 'personal'));
      });
    }
  }
  // Shared meetings (Supabase)
  loadSharedMeetings();
}
async function loadSharedMeetings() {
  var sList = document.getElementById('shared-meetings-list');
  var sEmpty = document.getElementById('shared-meetings-empty');
  if (!sList) return;
  if (!supa) { if (sEmpty) sEmpty.style.display = 'block'; return; }
  // Show loading state
  sList.innerHTML = '<div style="font-size:0.76rem;color:var(--tm);text-align:center;padding:10px;">Loading...</div>';
  if (sEmpty) sEmpty.style.display = 'none';
  try {
    var result = await supa.from('shared_meetings').select('*').order('created_at', { ascending: true });
    sList.innerHTML = '';
    if (result.error) {
      console.log('Shared meetings error:', result.error);
      if (sEmpty) sEmpty.style.display = 'block';
      return;
    }
    if (!result.data || !result.data.length) {
      if (sEmpty) sEmpty.style.display = 'block';
      return;
    }
    if (sEmpty) sEmpty.style.display = 'none';
    result.data.forEach(function(m) {
      sList.appendChild(renderMeetingCard(m, 'shared'));
    });
  } catch(e) {
    console.log('Shared meetings catch:', e);
    sList.innerHTML = '';
    if (sEmpty) sEmpty.style.display = 'block';
  }
}
var selectedMeetingDays = [];
function toggleMeetingDay(btn, day) {
  if (day === 'Daily') {
    // Clear all others and select only Daily
    selectedMeetingDays = ['Daily'];
    document.querySelectorAll('#add-meeting-modal .role-btn').forEach(function(b){ b.classList.remove('active'); });
    btn.classList.add('active');
    return;
  }
  // Remove Daily if selecting individual days
  selectedMeetingDays = selectedMeetingDays.filter(function(d){ return d !== 'Daily'; });
  document.querySelectorAll('#add-meeting-modal .role-btn').forEach(function(b){
    if (b.textContent === 'Every Day') b.classList.remove('active');
  });
  var idx = selectedMeetingDays.indexOf(day);
  if (idx > -1) {
    selectedMeetingDays.splice(idx, 1);
    btn.classList.remove('active');
  } else {
    selectedMeetingDays.push(day);
    btn.classList.add('active');
  }
}
function clearMeetingDays() {
  selectedMeetingDays = [];
  document.querySelectorAll('#add-meeting-modal .role-btn').forEach(function(b){ b.classList.remove('active'); });
}
function setMeetingDays(daysStr) {
  clearMeetingDays();
  if (!daysStr) return;
  var days = daysStr.split(',').map(function(d){ return d.trim(); });
  days.forEach(function(day) {
    selectedMeetingDays.push(day);
    document.querySelectorAll('#add-meeting-modal .role-btn').forEach(function(b){
      if (b.textContent === day || (day === 'Daily' && b.textContent === 'Every Day')) {
        b.classList.add('active');
      }
    });
  });
}
function openAddMeeting(type) {
  editingMeetingId = null;
  editingMeetingType = type || 'personal';
  document.getElementById('zm-name').value = '';
  document.getElementById('zm-time').value = '';
  document.getElementById('zm-id').value = '';
  document.getElementById('zm-password').value = '';
  document.getElementById('zm-url').value = '';
  document.getElementById('zm-delete-wrap').style.display = 'none';
  clearMeetingDays();
  document.getElementById('zm-modal-title').textContent = editingMeetingType === 'shared' ? 'Add Community Meeting' : 'Add to My Favourites';
  document.getElementById('zm-modal-subtitle').textContent = editingMeetingType === 'shared' ? 'Visible to everyone on the app' : 'Only visible to you';
  document.getElementById('add-meeting-modal').classList.add('open');
}
function openEditMeeting(id, type, sharedData) {
  editingMeetingType = type;
  editingMeetingId = id;
  var m;
  if (type === 'personal') {
    m = personalMeetings.find(function(x){ return x.id === id; });
  } else if (type === 'shared' && sharedData) {
    m = sharedData;
  }
  if (!m) return;
  document.getElementById('zm-name').value = m.name || '';
  // Parse days from time string
  var timeParts = (m.time || '').split(' ¬∑ ');
  var daysStr = timeParts.length > 1 ? timeParts[0] : '';
  var timeOnly = timeParts.length > 1 ? timeParts[1] : m.time || '';
  document.getElementById('zm-time').value = timeOnly;
  setMeetingDays(daysStr);
  document.getElementById('zm-id').value = m.meetingId || m.meeting_id || '';
  document.getElementById('zm-password').value = m.password || '';
  document.getElementById('zm-url').value = m.url || '';
  document.getElementById('zm-delete-wrap').style.display = 'block';
  document.getElementById('zm-modal-title').textContent = 'Edit Meeting';
  document.getElementById('zm-modal-subtitle').textContent = type === 'shared' ? 'Shared with everyone ‚Äî changes visible to all' : 'Your personal favourite';
  document.getElementById('add-meeting-modal').classList.add('open');
}
async function saveMeeting() {
  var name = document.getElementById('zm-name').value.trim();
  var meetingId = document.getElementById('zm-id').value.trim();
  var password = document.getElementById('zm-password').value.trim();
  var url = document.getElementById('zm-url').value.trim();
  var timeInput = document.getElementById('zm-time').value.trim();
  var time = selectedMeetingDays.length ? selectedMeetingDays.join(', ') + (timeInput ? ' ¬∑ ' + timeInput : '') : timeInput;
  if (!name) { toast('Please enter a meeting name'); return; }
  if (!meetingId && !url) { toast('Please enter a Zoom ID or meeting link'); return; }
  // meetingData uses snake_case for Supabase, camelCase for localStorage
  var meetingData = { name: name, time: time, meeting_id: meetingId, password: password, url: url };
  var personalMeetingData = { name: name, time: time, meetingId: meetingId, password: password, url: url };
  if (editingMeetingType === 'shared') {
    // Save to Supabase
    if (!supa || !currentUser) { toast('Sign in to add shared meetings'); return; }
    try {
      if (editingMeetingId) {
        await supa.from('shared_meetings').update(meetingData).eq('id', editingMeetingId);
      } else {
        meetingData.created_by = currentUser.email;
        await supa.from('shared_meetings').insert(meetingData);
      }
      toast(editingMeetingId ? 'Meeting updated' : 'Meeting added for everyone');
    } catch(e) { toast('Could not save ‚Äî check your connection'); return; }
  } else {
    // Save to localStorage
    if (editingMeetingId) {
      var m = personalMeetings.find(function(x){ return x.id === editingMeetingId; });
      if (m) { Object.assign(m, personalMeetingData); }
    } else {
      personalMeetingData.id = Date.now().toString();
      personalMeetings.push(personalMeetingData);
    }
    localStorage.setItem('na_personal_meetings', JSON.stringify(personalMeetings));
    toast(editingMeetingId ? 'Favourite updated' : 'Added to favourites');
  }
  closeAddMeetingDirect();
  renderSavedMeetings();
}
async function deleteMeeting() {
  if (editingMeetingType === 'shared') {
    if (!supa) return;
    try {
      await supa.from('shared_meetings').delete().eq('id', editingMeetingId);
      toast('Meeting removed');
    } catch(e) { toast('Could not delete'); return; }
  } else {
    personalMeetings = personalMeetings.filter(function(x){ return x.id !== editingMeetingId; });
    localStorage.setItem('na_personal_meetings', JSON.stringify(personalMeetings));
    toast('Removed from favourites');
  }
  closeAddMeetingDirect();
  renderSavedMeetings();
}
function closeAddMeeting(event) {
  document.getElementById('add-meeting-modal').classList.remove('open');
}
function closeAddMeetingDirect() {
  document.getElementById('add-meeting-modal').classList.remove('open');
}
// =====================
// SUPABASE SILENT SYNC
// =====================
const SUPA_URL = 'https://gencdhyxlyekpjvuwvpu.supabase.co';
const SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdlbmNkaHl4bHlla3BqdnV3dnB1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5NzEyNDEsImV4cCI6MjA4NzU0NzI0MX0.BR9biMN2K8Vj6SBbfBrEChppsuIMp2lSL3WOW7Z-1Ss';
var supa = null;
var currentUser = null;
try { supa = supabase.createClient(SUPA_URL, SUPA_KEY); } catch(e) {}
async function pushToCloud() {
  if (!supa || !currentUser) return;
  try {
    await supa.from('user_data').upsert({
      user_id: currentUser.id,
      clean_date: cleanDate,
      mood_log: moodLog,
      journal: journalEntries,
      network: networkContacts,
      updated_at: new Date().toISOString()
    }, { onConflict: 'user_id' });
  } catch(e) {}
}
async function pullFromCloud() {
  if (!supa || !currentUser) return;
  try {
    var result = await supa.from('user_data').select('*').eq('user_id', currentUser.id).single();
    var data = result.data;
    if (!data) return;
    if (data.clean_date) { cleanDate = data.clean_date; localStorage.setItem('na_clean_date', cleanDate); updateDaysCount(); }
    if (data.mood_log && data.mood_log.length) { moodLog = data.mood_log; localStorage.setItem('na_mood_log', JSON.stringify(moodLog)); markTodayMood(); renderMoodHistory(); }
    if (data.journal && data.journal.length) { journalEntries = data.journal; localStorage.setItem('na_journal', JSON.stringify(journalEntries)); renderJournalEntries(); }
    if (data.network && data.network.length) { networkContacts = data.network; localStorage.setItem('na_network', JSON.stringify(networkContacts)); renderNetwork(); }
  } catch(e) {}
}
// On load - wrapped in DOMContentLoaded so all functions exist first
document.addEventListener('DOMContentLoaded', function() {
  // Check session - show welcome if not signed in, go straight to app if signed in
  if (supa) {
    supa.auth.getSession().then(function(r) {
      if (r && r.data && r.data.session && r.data.session.user && r.data.session.user.email) {
        // Already signed in - go straight to app
        currentUser = r.data.session.user;
        pullFromCloud();
        updateSigninBtn();
        setTimeout(function() { checkPendingBadge(); loadHomeCalendar(); }, 1500);
        // app is already visible, welcome screen is hidden
      } else {
        // Not signed in - show welcome screen
        showWelcomeScreen();
      }
    }).catch(function(){
      // Can't reach Supabase - show app anyway
      console.log('Session check failed - showing app');
    });
  } else {
    showWelcomeScreen();
  }
});
var _origSaveCleanDate = saveCleanDate; saveCleanDate = function() { _origSaveCleanDate.apply(this,arguments); pushToCloud(); };
var _origSaveJournal = saveJournal; saveJournal = function() { _origSaveJournal.apply(this,arguments); pushToCloud(); };
var _origSaveContact = saveContact; saveContact = function() { _origSaveContact.apply(this,arguments); pushToCloud(); };
var _origDeleteContact = deleteContact; deleteContact = function(id) { _origDeleteContact(id); pushToCloud(); };
var _origDeleteJournal = deleteJournal; deleteJournal = function(id) { _origDeleteJournal(id); pushToCloud(); };
var _origSetMood = setMood; setMood = function(m) { _origSetMood(m); pushToCloud(); };
// =====================
// MY EVENTS SCREEN
// =====================
function renderMyEvents() {
  var list = document.getElementById('my-events-list');
  if (!list) return;
  while (list.firstChild) list.removeChild(list.firstChild);
  if (!currentUser) {
    list.innerHTML = '<div style="text-align:center;padding:40px;color:var(--tm);">Sign in to see your events</div>';
    return;
  }
  function doRender(events) {
    var userId = currentUser.id;
    var today = new Date(); today.setHours(0,0,0,0);
    var myEvents = events.filter(function(ev) {
      return ev.going_users && ev.going_users.indexOf(userId) > -1;
    });
    while (list.firstChild) list.removeChild(list.firstChild);
    if (!myEvents.length) {
      var emptyDiv = document.createElement('div');
      emptyDiv.style.cssText = 'text-align:center;padding:50px 20px;';
      var icon = document.createElement('div');
      icon.style.cssText = 'font-size:3rem;margin-bottom:12px;';
      icon.textContent = 'üìÖ';
      var msg = document.createElement('div');
      msg.style.cssText = 'font-size:0.88rem;color:var(--tm);margin-bottom:16px;';
      msg.textContent = "You haven't marked any events as going yet";
      var btn = document.createElement('button');
      btn.style.cssText = 'padding:11px 22px;background:var(--ac);border:none;border-radius:var(--r);color:#1a1208;font-weight:700;cursor:pointer;';
      btn.textContent = 'Browse Events';
      btn.onclick = function(){ showScreen('events'); };
      emptyDiv.appendChild(icon);
      emptyDiv.appendChild(msg);
      emptyDiv.appendChild(btn);
      list.appendChild(emptyDiv);
      return;
    }
    var upcoming = myEvents.filter(function(ev){ return new Date(ev.date) >= today; });
    var past = myEvents.filter(function(ev){ return new Date(ev.date) < today; });
    function buildCard(ev) {
      var d = new Date(ev.date);
      var isPast = d < today;
      var card = document.createElement('div');
      card.style.cssText = 'background:var(--sf);border:1px solid ' + (isPast ? 'var(--bd)' : 'rgba(232,201,122,0.35)') + ';border-radius:var(--r);padding:14px;margin-bottom:10px;display:flex;gap:12px;opacity:' + (isPast ? '0.55' : '1') + ';';
      var dateBadge = document.createElement('div');
      dateBadge.style.cssText = 'flex-shrink:0;width:46px;text-align:center;background:rgba(232,201,122,0.1);border:1px solid rgba(232,201,122,0.25);border-radius:10px;padding:8px 4px;';
      var dayEl = document.createElement('div');
      dayEl.style.cssText = 'font-size:1.2rem;font-weight:800;color:var(--ac);line-height:1;';
      dayEl.textContent = d.getDate();
      var monEl = document.createElement('div');
      monEl.style.cssText = 'font-size:0.58rem;text-transform:uppercase;color:var(--tm);margin-top:2px;';
      monEl.textContent = d.toLocaleDateString('en-GB',{month:'short'});
      var yrEl = document.createElement('div');
      yrEl.style.cssText = 'font-size:0.58rem;color:var(--tm);';
      yrEl.textContent = d.getFullYear();
      dateBadge.appendChild(dayEl);
      dateBadge.appendChild(monEl);
      dateBadge.appendChild(yrEl);
      card.appendChild(dateBadge);
      var info = document.createElement('div');
      info.style.cssText = 'flex:1;min-width:0;';
      var nameEl = document.createElement('div');
      nameEl.style.cssText = 'font-weight:700;font-size:0.88rem;margin-bottom:3px;';
      nameEl.textContent = ev.name;
      var locEl = document.createElement('div');
      locEl.style.cssText = 'font-size:0.72rem;color:var(--tm);margin-bottom:8px;';
      locEl.textContent = 'üìç ' + (ev.location || '') + (ev.country ? ', ' + ev.country : '');
      var removeBtn = document.createElement('button');
      removeBtn.style.cssText = 'font-size:0.68rem;color:var(--tm);background:transparent;border:1px solid var(--bd);border-radius:20px;padding:3px 10px;cursor:pointer;';
      removeBtn.textContent = '‚úï Remove';
      removeBtn.onclick = function(e) {
        e.stopPropagation();
        toggleGoing(e, ev.id);
        setTimeout(function(){ renderMyEvents(); loadHomeCalendar(); }, 600);
      };
      info.appendChild(nameEl);
      info.appendChild(locEl);
      info.appendChild(removeBtn);
      card.appendChild(info);
      return card;
    }
    function addSection(title, evList) {
      var hdr = document.createElement('div');
      hdr.style.cssText = 'font-size:0.65rem;font-weight:800;text-transform:uppercase;letter-spacing:0.1em;color:var(--ac);margin:16px 0 10px;';
      hdr.textContent = title;
      list.appendChild(hdr);
      var grouped = {};
      evList.forEach(function(ev) {
        var key = new Date(ev.date).toLocaleDateString('en-GB',{month:'long',year:'numeric'});
        if (!grouped[key]) grouped[key] = [];
        grouped[key].push(ev);
      });
      Object.keys(grouped).forEach(function(month) {
        var mh = document.createElement('div');
        mh.style.cssText = 'font-size:0.72rem;color:var(--tm);margin:10px 0 6px;padding-bottom:4px;border-bottom:1px solid var(--bd);';
        mh.textContent = month;
        list.appendChild(mh);
        grouped[month].forEach(function(ev){ list.appendChild(buildCard(ev)); });
      });
    }
    if (upcoming.length) addSection('Upcoming ¬∑ ' + upcoming.length + ' event' + (upcoming.length !== 1 ? 's' : ''), upcoming);
    if (past.length) addSection('Past events', past);
  }
  if (allEvents && allEvents.length) {
    doRender(allEvents);
  } else if (supa) {
    list.innerHTML = '<div style="text-align:center;padding:30px;color:var(--tm);">Loading...</div>';
    supa.from('events').select('*').eq('approved',true).order('date',{ascending:true}).then(function(r){
      if (r.data) { allEvents = r.data; }
      doRender(allEvents || []);
    });
  }
}
// =====================
// EVENT SOURCES
// =====================
async function loadEventSources() {
  if (!supa || !isAdmin()) return;
  var list = document.getElementById('sources-list');
  if (!list) return;
  while (list.firstChild) list.removeChild(list.firstChild);
  var res = await supa.from('event_sources').select('*').order('created_at', { ascending: true });
  var sources = res.data || [];
  if (!sources.length) {
    var empty = document.createElement('div');
    empty.style.cssText = 'font-size:0.72rem;color:var(--tm);margin-bottom:6px;';
    empty.textContent = 'No saved sources yet ‚Äî add one below';
    list.appendChild(empty);
    return;
  }
  sources.forEach(function(src) {
    var row = document.createElement('div');
    row.style.cssText = 'background:var(--sf2);border:1px solid var(--bd);border-radius:10px;padding:10px 12px;margin-bottom:8px;';
    var top = document.createElement('div');
    top.style.cssText = 'display:flex;align-items:center;gap:8px;margin-bottom:6px;';
    var label = document.createElement('div');
    label.style.cssText = 'flex:1;font-size:0.82rem;font-weight:700;';
    label.textContent = src.label || src.url;
    top.appendChild(label);
    var deleteBtn = document.createElement('button');
    deleteBtn.style.cssText = 'font-size:0.65rem;color:#e74c3c;background:transparent;border:1px solid rgba(231,76,60,0.3);border-radius:20px;padding:3px 8px;cursor:pointer;';
    deleteBtn.textContent = '‚úï';
    deleteBtn.onclick = async function() {
      if (confirm('Remove this source?')) {
        await supa.from('event_sources').delete().eq('id', src.id);
        loadEventSources();
      }
    };
    top.appendChild(deleteBtn);
    row.appendChild(top);
    var urlEl = document.createElement('div');
    urlEl.style.cssText = 'font-size:0.65rem;color:var(--tm);margin-bottom:6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;';
    urlEl.textContent = src.url;
    row.appendChild(urlEl);
    var lastSync = document.createElement('div');
    lastSync.style.cssText = 'font-size:0.65rem;color:var(--tm);margin-bottom:8px;';
    lastSync.textContent = src.last_synced
      ? 'Last synced: ' + new Date(src.last_synced).toLocaleDateString('en-GB', { day:'numeric', month:'short', year:'numeric', hour:'2-digit', minute:'2-digit' })
      : 'Never synced';
    row.appendChild(lastSync);
    var syncBtn = document.createElement('button');
    syncBtn.style.cssText = 'width:100%;padding:8px;background:var(--ac);border:none;border-radius:8px;color:#1a1208;font-weight:700;font-size:0.75rem;cursor:pointer;';
    syncBtn.textContent = 'üîÑ Sync Now';
    syncBtn.onclick = function() {
      document.getElementById('bulk-import-url').value = src.url;
      bulkImportEvents(src.id);
    };
    row.appendChild(syncBtn);
    list.appendChild(row);
  });
}
async function addEventSource() {
  var url = (document.getElementById('bulk-import-url').value || '').trim();
  var label = (document.getElementById('bulk-import-label').value || '').trim();
  if (!url) { toast('Please enter a URL first'); return; }
  if (!url.startsWith('http')) url = 'https://' + url;
  var res = await supa.from('event_sources').insert({ url: url, label: label || null });
  if (res.error) {
    if (res.error.code === '23505') {
      toast('This URL is already saved');
    } else {
      toast('Could not save: ' + res.error.message);
    }
    return;
  }
  document.getElementById('bulk-import-label').value = '';
  toast('Source saved! ‚úì');
  loadEventSources();
}
// =====================
// BULK EVENT IMPORT
// =====================
async function bulkImportEvents() {
  var urlEl = document.getElementById('bulk-import-url');
  var btn = document.getElementById('bulk-import-btn');
  var status = document.getElementById('bulk-import-status');
  var url = urlEl ? urlEl.value.trim() : '';
  if (!url) { toast('Please enter a URL'); return; }
  if (!url.startsWith('http')) { toast('Please enter a full URL starting with https://'); return; }
  btn.textContent = 'Fetching page...';
  btn.disabled = true;
  status.textContent = 'Step 1/3 ‚Äî Fetching page content...';
  try {
    // Fetch page via CORS proxy
    var proxyUrl = 'https://api.allorigins.win/get?url=' + encodeURIComponent(url);
    var pageRes = await fetch(proxyUrl);
    if (!pageRes.ok) throw new Error('Could not reach the page');
    var pageData = await pageRes.json();
    var html = pageData.contents || '';
    if (!html) throw new Error('Page returned no content ‚Äî it may block external access');
    // Strip HTML to plain text
    var plainText = html
      .replace(new RegExp('<sty'+'le[^>]*>[\s\S]*?<\/sty'+'le>', 'gi'), '')
      .replace(new RegExp('<scr'+'ipt[^>]*>[\s\S]*?<\/scr'+'ipt>', 'gi'), '')
      .replace(/<[^>]+>/g, ' ')
      .replace(/\s+/g, ' ')
      .trim()
      .substring(0, 12000);
    status.textContent = 'Step 2/3 ‚Äî AI is reading the page...';
    // Send to AI
    var aiRes = await fetch(AI_PROXY, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 4000,
        messages: [{
          role: 'user',
          content: 'Extract ALL events from this webpage text. Return ONLY a valid JSON array, no markdown, no explanation, no code blocks. Each event object must have: name (string), date (YYYY-MM-DD format), end_date (YYYY-MM-DD or null), location (city/venue), country (full country name), type (Convention/Workshop/Meeting/Conference/Retreat/Festival/Marathon/Other), description (brief summary or null), url (event link or null). Skip any items that are not events. If no events found return empty array []. Page text: ' + plainText
        }]
      })
    });
    var aiData = await aiRes.json();
    if (aiData.error) throw new Error('AI: ' + aiData.error.message);
    var raw = (aiData.content[0].text || '').trim();
    raw = raw.replace(/^```[a-z]*\n?/,'').replace(/\n?```$/,'').trim();
    var events;
    try { events = JSON.parse(raw); }
    catch(e) { throw new Error('AI returned unexpected format ‚Äî try a different page'); }
    if (!Array.isArray(events)) throw new Error('No event list returned');
    var valid = events.filter(function(ev){ return ev.name && ev.date; });
    if (!valid.length) throw new Error('No events with dates found on this page');
    status.textContent = 'Step 3/3 ‚Äî Saving ' + valid.length + ' events...';
    var rows = valid.map(function(ev) {
      return {
        name: ev.name,
        date: ev.date,
        end_date: ev.end_date || null,
        location: ev.location || 'TBC',
        country: ev.country || 'Other',
        type: ev.type || 'Other',
        description: ev.description || null,
        url: ev.url || url,
        approved: false,
        submitted_by: 'bulk-import: ' + url,
        going_users: [],
        going_names: []
      };
    });
    // Insert in batches of 10
    var batchSize = 10;
    var saved = 0;
    for (var i = 0; i < rows.length; i += batchSize) {
      var batch = rows.slice(i, i + batchSize);
      status.textContent = '‚è≥ Saving ' + Math.min(i + batchSize, rows.length) + ' of ' + rows.length + '...';
      var bRes = await supa.from('events').insert(batch);
      if (bRes.error) throw new Error('Save failed: ' + bRes.error.message);
      saved += batch.length;
    }
    status.textContent = '‚úÖ ' + valid.length + ' events imported! Review them below.';
    btn.textContent = 'ü§ñ Import Events with AI';
    btn.disabled = false;
    urlEl.value = '';
    openAdminPanel(); // refresh pending list
  } catch(err) {
    status.textContent = '‚ùå ' + (err.message || 'Import failed');
    btn.textContent = 'ü§ñ Import Events with AI';
    btn.disabled = false;
  }
}
// =====================
// DUPLICATE REMOVAL
// =====================
async function findAndRemoveDuplicates() {
  var btn = document.getElementById('dedupe-btn');
  var status = document.getElementById('dedupe-status');
  var list = document.getElementById('dedupe-list');
  btn.disabled = true;
  btn.textContent = '‚è≥ Scanning...';
  status.style.display = 'block';
  status.textContent = 'Loading all events...';
  status.style.background = '#2a2410';
  status.style.color = '#e8c97a';
  status.style.border = '2px solid #e8c97a';
  while (list.firstChild) list.removeChild(list.firstChild);
  try {
    var res = await supa.from('events').select('id, name, date, location, approved').order('created_at', { ascending: true });
    var events = res.data || [];
    var groups = {};
    events.forEach(function(ev) {
      var key = ev.name.toLowerCase().trim() + '|' + ev.date;
      if (!groups[key]) groups[key] = [];
      groups[key].push(ev);
    });
    var dupeGroups = Object.keys(groups).filter(function(k){ return groups[k].length > 1; });
    if (!dupeGroups.length) {
      status.textContent = '‚úÖ No duplicates found ‚Äî all clean!';
      btn.textContent = 'üîç Find & Remove Duplicates';
      btn.disabled = false;
      return;
    }
    var toRemoveIds = [];
    dupeGroups.forEach(function(key) {
      var group = groups[key];
      var keep = group[0];
      var remove = group.slice(1);
      remove.forEach(function(ev){ toRemoveIds.push(ev.id); });
      var card = document.createElement('div');
      card.style.cssText = 'background:var(--sf2);border:1px solid var(--bd);border-radius:10px;padding:10px;margin-bottom:8px;font-size:0.75rem;';
      var nameEl = document.createElement('div');
      nameEl.style.cssText = 'font-weight:700;margin-bottom:4px;';
      nameEl.textContent = keep.name;
      var dateEl = document.createElement('div');
      dateEl.style.cssText = 'color:var(--tm);margin-bottom:4px;';
      dateEl.textContent = new Date(keep.date).toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'});
      var dupEl = document.createElement('div');
      dupEl.style.cssText = 'color:#e74c3c;';
      dupEl.textContent = remove.length + ' duplicate' + (remove.length > 1 ? 's' : '') + ' will be removed';
      card.appendChild(nameEl);
      card.appendChild(dateEl);
      card.appendChild(dupEl);
      list.appendChild(card);
    });
    status.textContent = 'Found ' + toRemoveIds.length + ' duplicates across ' + dupeGroups.length + ' events';
    var removeBtn = document.createElement('button');
    removeBtn.style.cssText = 'width:100%;padding:12px;background:#e74c3c;border:none;border-radius:var(--r);color:#fff;font-weight:700;cursor:pointer;font-size:0.85rem;margin-top:8px;';
    removeBtn.textContent = 'üóëÔ∏è Remove All ' + toRemoveIds.length + ' Duplicates';
    removeBtn.onclick = async function() {
      removeBtn.disabled = true;
      removeBtn.textContent = '‚è≥ Removing...';
      var batchSize = 20;
      for (var i = 0; i < toRemoveIds.length; i += batchSize) {
        await supa.from('events').delete().in('id', toRemoveIds.slice(i, i + batchSize));
      }
      status.textContent = '‚úÖ Removed ' + toRemoveIds.length + ' duplicates!';
      while (list.firstChild) list.removeChild(list.firstChild);
      btn.textContent = 'üîç Find & Remove Duplicates';
      btn.disabled = false;
      loadEvents();
    };
    list.appendChild(removeBtn);
    btn.textContent = 'üîç Find & Remove Duplicates';
    btn.disabled = false;
  } catch(e) {
    status.textContent = '‚ùå Error: ' + e.message;
    status.style.background = '#3a0a0a';
    status.style.color = '#ff6b6b';
    status.style.border = '2px solid #e74c3c';
    btn.textContent = 'üîç Find & Remove Duplicates';
    btn.disabled = false;
  }
}
</script>
  <!-- WELCOME / AUTH SCREEN -->
  <div id="welcome-screen" style="display:none;">
    <!-- Hero -->
    <div id="welcome-hero">
      <div style="font-size:3.5rem;margin-bottom:16px;">üåø</div>
      <div class="welcome-logo">Clean Living</div>
      <div class="welcome-sub">Recovery ¬∑ Community ¬∑ Growth</div>
      <div class="welcome-tagline">"We do not have to be alone anymore."<br><span style="font-size:0.75rem;color:var(--tm);">‚Äî Basic Text</span></div>
      <button class="welcome-btn-primary" onclick="showAuthForm('signin')">Sign In</button>
      <button class="welcome-btn-secondary" onclick="showAuthForm('signup')">Create Account</button>
      <button class="welcome-btn-ghost" onclick="continueAsGuest()">Browse as guest</button>
    </div>
    <!-- Auth Form -->
    <div id="auth-form">
      <button class="auth-back" onclick="document.getElementById('welcome-hero').style.display='flex';document.getElementById('auth-form').style.display='none';">&#8592; Back</button>
      <div id="auth-mode" data-mode="signin"></div>
      <div style="font-family:'Cormorant Garamond',serif;font-size:1.8rem;font-weight:300;color:var(--ac);margin-bottom:6px;" id="auth-title">Welcome back</div>
      <div style="font-size:0.72rem;color:var(--tm);margin-bottom:24px;">Sign in to access your recovery tools</div>
      <div class="modal-label">Email</div>
      <input id="auth-email" class="input" type="email" placeholder="your@email.com" autocomplete="email" style="margin-bottom:14px;">
      <div class="modal-label">Password</div>
      <input id="auth-password" class="input" type="password" placeholder="Password" autocomplete="current-password" style="margin-bottom:6px;">
      <div id="auth-msg" style="display:none;font-size:0.75rem;margin-bottom:12px;text-align:center;padding:8px;border-radius:8px;background:rgba(0,0,0,0.2);"></div>
      <button id="auth-submit-btn" class="btn" style="width:100%;margin-bottom:12px;" onclick="doAuth()">Sign In</button>
      <button id="auth-forgot" onclick="doAuthReset()" style="width:100%;padding:8px;border:none;background:transparent;color:var(--tm);cursor:pointer;font-size:0.72rem;display:block;">Forgot password?</button>
      <div style="text-align:center;margin-top:16px;">
        <span id="auth-switch-text" style="font-size:0.75rem;color:var(--tm);">Don't have an account?</span>
        <button id="auth-switch-btn" onclick="switchAuthMode()" style="background:transparent;border:none;color:var(--ac);font-size:0.75rem;cursor:pointer;padding:0 0 0 4px;">Sign up</button>
      </div>
    </div>
  </div>
  <!-- ADD MEETING MODAL -->
  <div class="modal-overlay" id="add-meeting-modal" onclick="closeAddMeeting(event)">
    <div class="modal-sheet" onclick="event.stopPropagation()">
      <div class="modal-title" id="zm-modal-title">Add a Meeting</div>
      <div id="zm-modal-subtitle" style="font-size:0.72rem;color:var(--tm);margin-bottom:16px;"></div>
      <div class="modal-label">Meeting Name</div>
      <input id="zm-name" class="input" type="text" placeholder="e.g. Monday Night Step Study">
      <div class="modal-label">Day / Time</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px;">
        <div class="role-btn" onclick="toggleMeetingDay(this,'Mon')">Mon</div>
        <div class="role-btn" onclick="toggleMeetingDay(this,'Tue')">Tue</div>
        <div class="role-btn" onclick="toggleMeetingDay(this,'Wed')">Wed</div>
        <div class="role-btn" onclick="toggleMeetingDay(this,'Thu')">Thu</div>
        <div class="role-btn" onclick="toggleMeetingDay(this,'Fri')">Fri</div>
        <div class="role-btn" onclick="toggleMeetingDay(this,'Sat')">Sat</div>
        <div class="role-btn" onclick="toggleMeetingDay(this,'Sun')">Sun</div>
        <div class="role-btn" onclick="toggleMeetingDay(this,'Daily')" style="grid-column:span 2;">Every Day</div>
      </div>
      <input id="zm-time" class="input" type="text" placeholder="Time e.g. 7pm GMT">
      <div class="modal-label">Zoom Meeting ID</div>
      <input id="zm-id" class="input" type="text" placeholder="e.g. 123 456 7890" inputmode="numeric">
      <div class="modal-label">Zoom Password <span style="color:var(--tm);font-weight:400;">(if required)</span></div>
      <input id="zm-password" class="input" type="text" placeholder="e.g. recovery">
      <div class="modal-label" style="margin-top:4px;">
        <span style="font-size:0.68rem;color:var(--tm);">‚Äî or paste a full link instead ‚Äî</span>
      </div>
      <input id="zm-url" class="input" type="url" placeholder="https://zoom.us/j/... or Teams/Google Meet link">
      <div style="display:flex;gap:8px;margin-top:16px;">
        <button onclick="closeAddMeetingDirect()" style="flex:1;padding:13px;border:1px solid var(--bd);border-radius:var(--r);background:transparent;color:var(--tm);cursor:pointer;">Cancel</button>
        <button onclick="saveMeeting()" class="btn" style="flex:2;margin-top:0;">Save Meeting</button>
      </div>
      <div id="zm-delete-wrap" style="display:none;margin-top:10px;">
        <button onclick="deleteMeeting()" style="width:100%;padding:12px;border:1px solid rgba(180,60,60,0.4);border-radius:var(--r);background:transparent;color:#ff6b6b;font-size:0.8rem;cursor:pointer;">Remove Meeting</button>
      </div>
    </div>
  </div>
  <!-- PAYWALL MODAL -->

  <!-- ACCOUNT SHEET -->

  <div class="modal-overlay" id="account-sheet" onclick="closeAccountSheet(event)">
    <div class="modal-sheet" onclick="event.stopPropagation()" style="max-height:90vh;">
      <!-- Signed Out View -->
      <div id="account-signedout">
        <div style="text-align:center;margin-bottom:20px;">
          <div style="font-size:2.5rem;margin-bottom:8px;">üë§</div>
          <div style="font-size:1.1rem;font-weight:600;color:var(--tx);">Sign in to Clean Living</div>
          <div style="font-size:0.75rem;color:var(--tm);margin-top:4px;">Access your recovery tools across all devices</div>
        </div>
        <button class="btn" style="width:100%;margin-bottom:10px;" onclick="closeAccountSheet(event);showWelcomeScreen();">Sign In / Create Account</button>
      </div>
      <!-- Signed In View -->
      <div id="account-signedin" style="display:none;">
        <!-- Profile -->
        <div style="display:flex;align-items:center;gap:14px;padding:4px 0 20px;border-bottom:1px solid var(--bd);margin-bottom:16px;">
          <div style="width:48px;height:48px;border-radius:50%;background:linear-gradient(135deg,var(--ac),#b8965a);display:flex;align-items:center;justify-content:center;font-size:1.3rem;font-weight:700;color:#1a1208;" id="account-avatar">C</div>
          <div>
            <div style="font-weight:700;font-size:0.95rem;" id="account-name">Clare</div>
            <div style="font-size:0.72rem;color:var(--tm);" id="account-email"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="bcdfd0ddced9d4d3decfd3d2fcd5dfd0d3c9d892dfd3d1">[email&#160;protected]</a></div>
          </div>
          <div id="account-tier-badge" style="margin-left:auto;padding:4px 10px;border-radius:20px;font-size:0.62rem;font-weight:800;text-transform:uppercase;"></div>
        </div>
        <!-- Membership -->
        <div style="background:var(--sf2);border:1px solid rgba(232,201,122,0.35);border-radius:var(--r);padding:14px 16px;margin-bottom:12px;">
          <div style="font-size:0.62rem;font-weight:800;color:var(--ac);text-transform:uppercase;letter-spacing:0.08em;margin-bottom:8px;">Membership</div>
          <div id="account-membership-detail" style="font-size:0.8rem;color:var(--tx);line-height:1.6;"></div>
        </div>
        <!-- Admin Section (iCloud only) -->
        <div id="account-admin-section" style="display:none;background:rgba(231,76,60,0.1);border:1px solid rgba(231,76,60,0.3);border-radius:var(--r);padding:14px 16px;margin-bottom:12px;">
          <div style="font-size:0.62rem;font-weight:800;color:#e74c3c;text-transform:uppercase;letter-spacing:0.08em;margin-bottom:10px;">Admin</div>
          <button onclick="closeAccountSheet(event);openAdminPanel();" style="width:100%;padding:11px;background:rgba(231,76,60,0.2);border:1px solid rgba(231,76,60,0.4);border-radius:10px;color:#e74c3c;font-size:0.8rem;font-weight:600;cursor:pointer;">Review Pending Events</button>
        </div>
        <!-- Sign Out -->
        <button onclick="doSignOut();" style="width:100%;padding:13px;border:1px solid rgba(192,57,43,0.3);border-radius:var(--r);background:transparent;color:#e74c3c;cursor:pointer;">Sign Out</button>
      </div>
    </div>
  </div>
</body>
</html// NETWORK
// =====================
var currentNetTab = 'discover';
var netProfiles = [];
var netConnections = [];
var netPendingRequests = [];
var myProfile = null;
async function loadNetwork() {
  if (!currentUser) return;
  await loadMyProfile();
  switchNetTab('discover');
  checkConnectionRequests();
}
async function loadMyProfile() {
  if (!supa || !currentUser) return;
  var res = await supa.from('profiles').select('*').eq('id', currentUser.id).single();
  myProfile = (res.data) ? res.data : null;
}
function switchNetTab(tab) {
  currentNetTab = tab;
  ['discover','connections','requests'].forEach(function(t) {
    var btn = document.getElementById('net-tab-' + t);
    if (!btn) return;
    if (t === tab) {
      btn.style.background = 'var(--ac)';
      btn.style.color = '#1a1208';
      btn.style.border = 'none';
      btn.style.fontWeight = '700';
    } else {
      btn.style.background = 'transparent';
      btn.style.color = 'var(--tm)';
      btn.style.border = '1px solid var(--bd)';
      btn.style.fontWeight = '400';
    }
  });
  if (tab === 'discover') renderDiscover();
  if (tab === 'connections') renderConnections();
  if (tab === 'requests') renderRequests();
}
async function renderDiscover() {
  var c = document.getElementById('net-content');
  c.innerHTML = '<div style="text-align:center;padding:20px;color:var(--tm);">Loading members...</div>';
  if (!supa) return;
  var res = await supa.from('profiles').select('*').neq('id', currentUser.id);
  var profiles = res.data || [];
  // Get my connections to know status
  var connRes = await supa.from('connections').select('*').or('requester_id.eq.' + currentUser.id + ',receiver_id.eq.' + currentUser.id);
  var conns = connRes.data || [];
  c.innerHTML = '';
  if (!profiles.length) {
    c.innerHTML = '<div style="text-align:center;padding:40px;color:var(--tm);font-size:0.85rem;">No other members yet ‚Äî invite your friends!</div>';
    return;
  }
  profiles.forEach(function(p) {
    var conn = conns.find(function(c) {
      return (c.requester_id === currentUser.id && c.receiver_id === p.id) ||
             (c.receiver_id === currentUser.id && c.requester_id === p.id);
    });
    var status = conn ? conn.status : null;
    var iRequested = conn && conn.requester_id === currentUser.id;
    var card = document.createElement('div');
    card.style.cssText = 'background:var(--sf);border:1px solid var(--bd);border-radius:var(--r);padding:14px 16px;margin-bottom:10px;display:flex;align-items:center;gap:12px;';
    // Avatar
    var av = document.createElement('div');
    av.style.cssText = 'width:44px;height:44px;border-radius:50%;background:rgba(232,201,122,0.15);border:1px solid rgba(232,201,122,0.3);display:flex;align-items:center;justify-content:center;font-size:1.2rem;font-weight:700;color:var(--ac);flex-shrink:0;';
    av.textContent = (p.username || '?')[0].toUpperCase();
    card.appendChild(av);
    // Info
    var info = document.createElement('div');
    info.style.cssText = 'flex:1;min-width:0;';
    var name = document.createElement('div');
    name.style.cssText = 'font-weight:700;font-size:0.88rem;';
    name.textContent = p.username || 'Member';
    var loc = document.createElement('div');
    loc.style.cssText = 'font-size:0.72rem;color:var(--tm);';
    loc.textContent = p.location || '';
    info.appendChild(name);
    if (p.location) info.appendChild(loc);
    // If connected - show socials
    if (status === 'accepted') {
      var socials = document.createElement('div');
      socials.style.cssText = 'display:flex;gap:6px;margin-top:6px;flex-wrap:wrap;';
      if (p.instagram) {
        var ig = document.createElement('a');
        ig.href = 'https://instagram.com/' + p.instagram.replace('@','');
        ig.target = '_blank';
        ig.style.cssText = 'font-size:0.65rem;padding:3px 8px;background:rgba(232,201,122,0.1);border:1px solid rgba(232,201,122,0.25);border-radius:20px;color:var(--ac);text-decoration:none;';
        ig.textContent = 'üì∏ Instagram';
        socials.appendChild(ig);
      }
      if (p.whatsapp) {
        var wa = document.createElement('a');
        wa.href = 'https://wa.me/' + p.whatsapp.replace(/[^0-9]/g,'');
        wa.target = '_blank';
        wa.style.cssText = 'font-size:0.65rem;padding:3px 8px;background:rgba(37,211,102,0.1);border:1px solid rgba(37,211,102,0.25);border-radius:20px;color:#25d366;text-decoration:none;';
        wa.textContent = 'üí¨ WhatsApp';
        socials.appendChild(wa);
      }
      if (p.facebook) {
        var fb = document.createElement('a');
        fb.href = 'https://facebook.com/' + p.facebook;
        fb.target = '_blank';
        fb.style.cssText = 'font-size:0.65rem;padding:3px 8px;background:rgba(24,119,242,0.1);border:1px solid rgba(24,119,242,0.25);border-radius:20px;color:#1877f2;text-decoration:none;';
        fb.textContent = 'üë§ Facebook';
        socials.appendChild(fb);
      }
      if (socials.children.length) info.appendChild(socials);
    }
    card.appendChild(info);
    // Action button
    var btn = document.createElement('button');
    btn.style.cssText = 'flex-shrink:0;padding:8px 12px;border-radius:20px;font-size:0.72rem;font-weight:600;cursor:pointer;border:none;';
    if (status === 'accepted') {
      btn.textContent = '‚úì Connected';
      btn.style.background = 'rgba(95,207,128,0.15)';
      btn.style.color = '#5fcf80';
      btn.style.border = '1px solid rgba(95,207,128,0.3)';
      btn.disabled = true;
    } else if (status === 'pending' && iRequested) {
      btn.textContent = 'Pending';
      btn.style.background = 'rgba(232,201,122,0.1)';
      btn.style.color = 'var(--tm)';
      btn.style.border = '1px solid var(--bd)';
      btn.disabled = true;
    } else if (status === 'pending' && !iRequested) {
      btn.textContent = '‚úì Accept';
      btn.style.background = 'var(--ac)';
      btn.style.color = '#1a1208';
      (function(pid){ btn.onclick = function(){ acceptConnection(pid); }; })(p.id);
    } else {
      btn.textContent = '+ Connect';
      btn.style.background = 'var(--ac)';
      btn.style.color = '#1a1208';
      (function(pid){ btn.onclick = function(){ sendConnectionRequest(pid); }; })(p.id);
    }
    card.appendChild(btn);
    c.appendChild(card);
  });
}
async function renderConnections() {
  var c = document.getElementById('net-content');
  c.innerHTML = '<div style="text-align:center;padding:20px;color:var(--tm);">Loading...</div>';
  var res = await supa.from('connections').select('*').eq('status','accepted').or('requester_id.eq.' + currentUser.id + ',receiver_id.eq.' + currentUser.id);
  var conns = res.data || [];
  c.innerHTML = '';
  if (!conns.length) {
    c.innerHTML = '<div style="text-align:center;padding:40px;color:var(--tm);font-size:0.85rem;">No connections yet ‚Äî go to Discover to connect with members</div>';
    return;
  }
  // Get profiles of connected users
  var ids = conns.map(function(conn) {
    return conn.requester_id === currentUser.id ? conn.receiver_id : conn.requester_id;
  });
  var profRes = await supa.from('profiles').select('*').in('id', ids);
  var profiles = profRes.data || [];
  var hdr = document.createElement('div');
  hdr.style.cssText = 'font-size:0.65rem;font-weight:800;color:var(--ac);text-transform:uppercase;letter-spacing:0.1em;margin-bottom:12px;';
  hdr.textContent = conns.length + ' connection' + (conns.length !== 1 ? 's' : '');
  c.appendChild(hdr);
  profiles.forEach(function(p) {
    var card = document.createElement('div');
    card.style.cssText = 'background:var(--sf);border:1px solid rgba(232,201,122,0.35);border-radius:var(--r);padding:14px 16px;margin-bottom:10px;';
    var top = document.createElement('div');
    top.style.cssText = 'display:flex;align-items:center;gap:12px;margin-bottom:10px;';
    var av = document.createElement('div');
    av.style.cssText = 'width:44px;height:44px;border-radius:50%;background:rgba(232,201,122,0.15);border:1px solid rgba(232,201,122,0.3);display:flex;align-items:center;justify-content:center;font-size:1.2rem;font-weight:700;color:var(--ac);flex-shrink:0;';
    av.textContent = (p.username || '?')[0].toUpperCase();
    var info = document.createElement('div');
    info.style.cssText = 'flex:1;';
    var name = document.createElement('div');
    name.style.cssText = 'font-weight:700;font-size:0.88rem;';
    name.textContent = p.username || 'Member';
    var loc = document.createElement('div');
    loc.style.cssText = 'font-size:0.72rem;color:var(--tm);';
    loc.textContent = p.location || '';
    info.appendChild(name);
    if (p.location) info.appendChild(loc);
    top.appendChild(av);
    top.appendChild(info);
    card.appendChild(top);
    // Socials
    var socials = document.createElement('div');
    socials.style.cssText = 'display:flex;gap:8px;flex-wrap:wrap;';
    if (p.instagram) {
      var ig = document.createElement('a');
      ig.href = 'https://instagram.com/' + p.instagram.replace('@','');
      ig.target = '_blank';
      ig.style.cssText = 'font-size:0.72rem;padding:6px 12px;background:rgba(232,201,122,0.1);border:1px solid rgba(232,201,122,0.25);border-radius:20px;color:var(--ac);text-decoration:none;';
      ig.textContent = 'üì∏ @' + p.instagram.replace('@','');
      socials.appendChild(ig);
    }
    if (p.whatsapp) {
      var wa = document.createElement('a');
      wa.href = 'https://wa.me/' + p.whatsapp.replace(/[^0-9]/g,'');
      wa.target = '_blank';
      wa.style.cssText = 'font-size:0.72rem;padding:6px 12px;background:rgba(37,211,102,0.1);border:1px solid rgba(37,211,102,0.25);border-radius:20px;color:#25d366;text-decoration:none;';
      wa.textContent = 'üí¨ ' + p.whatsapp;
      socials.appendChild(wa);
    }
    if (p.facebook) {
      var fb = document.createElement('a');
      fb.href = 'https://facebook.com/' + p.facebook;
      fb.target = '_blank';
      fb.style.cssText = 'font-size:0.72rem;padding:6px 12px;background:rgba(24,119,242,0.1);border:1px solid rgba(24,119,242,0.25);border-radius:20px;color:#1877f2;text-decoration:none;';
      fb.textContent = 'üë§ ' + p.facebook;
      socials.appendChild(fb);
    }
    if (!p.instagram && !p.whatsapp && !p.facebook) {
      var noSocial = document.createElement('div');
      noSocial.style.cssText = 'font-size:0.72rem;color:var(--tm);';
      noSocial.textContent = 'No social links added yet';
      socials.appendChild(noSocial);
    }
    card.appendChild(socials);
    c.appendChild(card);
  });
}
async function renderRequests() {
  var c = document.getElementById('net-content');
  c.innerHTML = '<div style="text-align:center;padding:20px;color:var(--tm);">Loading...</div>';
  var res = await supa.from('connections').select('*').eq('receiver_id', currentUser.id).eq('status','pending');
  var requests = res.data || [];
  c.innerHTML = '';
  if (!requests.length) {
    c.innerHTML = '<div style="text-align:center;padding:40px;color:var(--tm);font-size:0.85rem;">No pending requests</div>';
    document.getElementById('net-req-badge').style.display = 'none';
    return;
  }
  var ids = requests.map(function(r){ return r.requester_id; });
  var profRes = await supa.from('profiles').select('*').in('id', ids);
  var profiles = profRes.data || [];
  var hdr = document.createElement('div');
  hdr.style.cssText = 'font-size:0.65rem;font-weight:800;color:var(--ac);text-transform:uppercase;letter-spacing:0.1em;margin-bottom:12px;';
  hdr.textContent = requests.length + ' pending request' + (requests.length !== 1 ? 's' : '');
  c.appendChild(hdr);
  requests.forEach(function(req) {
    var p = profiles.find(function(x){ return x.id === req.requester_id; }) || {};
    var card = document.createElement('div');
    card.style.cssText = 'background:var(--sf);border:1px solid rgba(232,201,122,0.35);border-radius:var(--r);padding:14px 16px;margin-bottom:10px;display:flex;align-items:center;gap:12px;';
    var av = document.createElement('div');
    av.style.cssText = 'width:44px;height:44px;border-radius:50%;background:rgba(232,201,122,0.15);border:1px solid rgba(232,201,122,0.3);display:flex;align-items:center;justify-content:center;font-size:1.2rem;font-weight:700;color:var(--ac);flex-shrink:0;';
    av.textContent = (p.username || '?')[0].toUpperCase();
    var info = document.createElement('div');
    info.style.cssText = 'flex:1;';
    var name = document.createElement('div');
    name.style.cssText = 'font-weight:700;font-size:0.88rem;';
    name.textContent = (p.username || 'Member') + ' wants to connect';
    info.appendChild(name);
    var btns = document.createElement('div');
    btns.style.cssText = 'display:flex;gap:6px;';
    var acceptBtn = document.createElement('button');
    acceptBtn.style.cssText = 'padding:7px 12px;background:var(--ac);border:none;border-radius:20px;color:#1a1208;font-size:0.72rem;font-weight:700;cursor:pointer;';
    acceptBtn.textContent = '‚úì Accept';
    (function(rid){ acceptBtn.onclick = function(){ acceptConnection(rid); }; })(req.requester_id);
    var declineBtn = document.createElement('button');
    declineBtn.style.cssText = 'padding:7px 12px;background:transparent;border:1px solid var(--bd);border-radius:20px;color:var(--tm);font-size:0.72rem;cursor:pointer;';
    declineBtn.textContent = '‚úï Decline';
    (function(rid){ declineBtn.onclick = function(){ declineConnection(rid); }; })(req.requester_id);
    btns.appendChild(acceptBtn);
    btns.appendChild(declineBtn);
    card.appendChild(av);
    card.appendChild(info);
    card.appendChild(btns);
    c.appendChild(card);
  });
}
async function sendConnectionRequest(userId) {
  if (!supa || !currentUser) return;
  // Check profile exists first
  if (!myProfile) {
    toast('Please set up your profile first');
    openEditProfile();
    return;
  }
  var res = await supa.from('connections').insert({ requester_id: currentUser.id, receiver_id: userId, status: 'pending' });
  if (res.error) { toast('Could not send request'); return; }
  toast('Connection request sent! ‚úì');
  renderDiscover();
}
async function acceptConnection(userId) {
  if (!supa || !currentUser) return;
  await supa.from('connections').update({ status: 'accepted' }).eq('requester_id', userId).eq('receiver_id', currentUser.id);
  toast('Connected! ‚úì');
  checkConnectionRequests();
  switchNetTab('connections');
}
async function declineConnection(userId) {
  if (!supa || !currentUser) return;
  await supa.from('connections').delete().eq('requester_id', userId).eq('receiver_id', currentUser.id);
  toast('Request declined');
  renderRequests();
}
async function checkConnectionRequests() {
  if (!supa || !currentUser) return;
  var res = await supa.from('connections').select('id').eq('receiver_id', currentUser.id).eq('status','pending');
  var count = (res.data || []).length;
  var badge = document.getElementById('net-req-badge');
  if (badge) {
    if (count > 0) { badge.textContent = count; badge.style.display = 'inline'; }
    else { badge.style.display = 'none'; }
  }
}
function openEditProfile() {
  // Build profile edit modal
  var existing = myProfile || {};
  var overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:9000;display:flex;align-items:flex-end;';
  var sheet = document.createElement('div');
  sheet.style.cssText = 'background:var(--bg);border-radius:20px 20px 0 0;padding:24px 20px 40px;width:100%;max-height:90vh;overflow-y:auto;';
  var title = document.createElement('div');
  title.style.cssText = 'font-family:"Cormorant Garamond",serif;font-size:1.5rem;color:var(--ac);margin-bottom:16px;';
  title.textContent = 'My Profile';
  sheet.appendChild(title);
  function addField(label, id, placeholder, val) {
    var l = document.createElement('div');
    l.style.cssText = 'font-size:0.65rem;font-weight:800;color:var(--ac);text-transform:uppercase;letter-spacing:0.08em;margin-bottom:4px;margin-top:12px;';
    l.textContent = label;
    var inp = document.createElement('input');
    inp.className = 'input';
    inp.id = 'prof-' + id;
    inp.placeholder = placeholder;
    inp.value = val || '';
    inp.style.marginBottom = '0';
    sheet.appendChild(l);
    sheet.appendChild(inp);
  }
  addField('Username', 'username', 'How others will see you', existing.username);
  addField('Location', 'location', 'City or country (optional)', existing.location);
  addField('Bio', 'bio', 'A little about you (optional)', existing.bio);
  addField('Instagram', 'instagram', '@username', existing.instagram);
  addField('WhatsApp', 'whatsapp', '+44... (connected members only)', existing.whatsapp);
  addField('Facebook', 'facebook', 'profile name or URL', existing.facebook);
  var note = document.createElement('div');
  note.style.cssText = 'font-size:0.7rem;color:var(--tm);margin-top:12px;margin-bottom:16px;line-height:1.5;';
  note.textContent = 'üîí Your social links are only visible to members you have connected with';
  sheet.appendChild(note);
  var saveBtn = document.createElement('button');
  saveBtn.className = 'btn';
  saveBtn.style.width = '100%';
  saveBtn.textContent = 'Save Profile';
  saveBtn.onclick = async function() {
    var username = document.getElementById('prof-username').value.trim();
    if (!username) { toast('Please enter a username'); return; }
    var data = {
      id: currentUser.id,
      username: username,
      location: document.getElementById('prof-location').value.trim() || null,
      bio: document.getElementById('prof-bio').value.trim() || null,
      instagram: document.getElementById('prof-instagram').value.trim() || null,
      whatsapp: document.getElementById('prof-whatsapp').value.trim() || null,
      facebook: document.getElementById('prof-facebook').value.trim() || null
    };
    var res = await supa.from('profiles').upsert(data);
    if (res.error) { toast('Could not save: ' + res.error.message); return; }
    myProfile = data;
    toast('Profile saved ‚úì');
    document.body.removeChild(overlay);
    renderDiscover();
  };
  sheet.appendChild(saveBtn);
  var cancelBtn = document.createElement('button');
  cancelBtn.style.cssText = 'width:100%;margin-top:8px;padding:12px;border:1px solid var(--bd);border-radius:var(--r);background:transparent;color:var(--tm);cursor:pointer;';
  cancelBtn.textContent = 'Cancel';
  cancelBtn.onclick = function(){ document.body.removeChild(overlay); };
  sheet.appendChild(cancelBtn);
  overlay.appendChild(sheet);
  overlay.onclick = function(e){ if(e.target===overlay) document.body.removeChild(overlay); };
  document.body.appendChild(overlay);
}
>
